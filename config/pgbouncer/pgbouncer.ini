;; PgBouncer Configuration for BMMS Phase 8 Full Rollout
;; Connection pooling for 44 MOAs, 700-1100 users
;; Target: 500 max connections with efficient pooling

[databases]
;; Database connection strings
;; Format: dbname = host=hostname port=5432 dbname=database user=user password=password
obcms = host=db port=5432 dbname=obcms user=obcms_user

;; Read replica for SELECT queries (optional - uncomment when read replicas are set up)
; obcms_replica = host=db-replica1 port=5432 dbname=obcms user=obcms_user

[pgbouncer]
;; Connection pooling mode
;; session = client gets dedicated server connection (default)
;; transaction = server connection returns to pool after transaction
;; statement = server connection returns to pool after each statement
pool_mode = transaction

;; Listen address and port
listen_addr = 0.0.0.0
listen_port = 6432

;; Authentication
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

;; Connection limits (Phase 8: 44 MOAs, 700-1100 users)
;; Max client connections (should be >= expected concurrent users)
max_client_conn = 1000

;; Database connections (pool size per database)
;; This is the actual PostgreSQL connection limit
default_pool_size = 50

;; Minimum pool size (keep this many connections open)
min_pool_size = 10

;; Reserve pool (extra connections for emergencies)
reserve_pool_size = 10

;; If all pooled connections are busy, queue clients
;; Max time client can wait in queue (seconds)
reserve_pool_timeout = 5

;; Max prepared statements per connection (0 = unlimited)
max_prepared_statements = 100

;; Server connection settings
;; How long server connection can be idle (seconds)
server_idle_timeout = 600

;; How long to wait for new server connection (seconds)
server_connect_timeout = 15

;; Server lifetime (seconds) - kill connection after this time
server_lifetime = 3600

;; Check query for server health
server_check_query = SELECT 1

;; Client connection settings
;; How long client connection can be idle (seconds)
client_idle_timeout = 0

;; Client login timeout (seconds)
client_login_timeout = 60

;; Query timeout (0 = disabled)
query_timeout = 0

;; Wait timeout if no server connections available
query_wait_timeout = 120

;; DNS settings
;; How often to check DNS (seconds)
dns_max_ttl = 15
dns_zone_check_period = 0

;; Logging
;; Log level: 0=quiet, 1=critical, 2=error, 3=warning, 4=info, 5=debug
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

;; Syslog settings (optional - useful for centralized logging)
; syslog = 1
; syslog_ident = pgbouncer
; syslog_facility = daemon

;; Admin database (for monitoring)
admin_users = obcms_admin
stats_users = obcms_stats

;; TCP settings
;; Enable TCP keepalive
tcp_keepalive = 1
tcp_keepidle = 60
tcp_keepintvl = 10
tcp_keepcnt = 5

;; Buffer sizes (bytes)
pkt_buf = 4096
listen_backlog = 128

;; Statement timeout (seconds) - prevent long-running queries
; statement_timeout = 0

;; Disable SSL between PgBouncer and PostgreSQL (use if on same network)
server_tls_sslmode = prefer

;; Client SSL (between application and PgBouncer)
;; Uncomment if SSL is required
; client_tls_sslmode = require
; client_tls_key_file = /etc/pgbouncer/server-key.pem
; client_tls_cert_file = /etc/pgbouncer/server-cert.pem
; client_tls_ca_file = /etc/pgbouncer/root-cert.pem

;; Performance tuning
;; Application name for tracking connections
application_name_add_host = 1

;; Disable server_reset_query for better performance
;; WARNING: Only safe in transaction pooling mode
server_reset_query = DISCARD ALL

;; Stats collection
stats_period = 60

;; Maintenance
;; Pause all queries during maintenance (send PAUSE; command)
; pause_at_exit = 0

;; Process ID file
pidfile = /var/run/pgbouncer/pgbouncer.pid

;; Unix socket directory
unix_socket_dir = /var/run/pgbouncer

;; User to run as (when started as root)
; user = pgbouncer

;; Verbose logging (for debugging)
; verbose = 0
