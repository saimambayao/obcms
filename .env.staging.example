# OBCMS Staging Environment Configuration
# Copy this file to .env for staging deployment
# Based on production settings with reduced resources

# ============================================================================
# ENVIRONMENT IDENTIFICATION
# ============================================================================

# Django Settings Module - MUST BE production for staging
# Staging uses production settings to match production behavior
DJANGO_SETTINGS_MODULE=obc_management.settings.production

# ============================================================================
# DJANGO CORE SETTINGS
# ============================================================================

# Secret Key - Generate with: python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"
# CRITICAL: Must be 50+ characters, cryptographically random
# IMPORTANT: Use a DIFFERENT key than production
SECRET_KEY=django-insecure-staging-change-this-minimum-50-characters

# Debug Mode - MUST be 0 (False) for staging
DEBUG=0

# Allowed Hosts (comma-separated, no spaces)
# REQUIRED: Explicit list of domains that can serve this application
# Example: staging.obcms.gov.ph,staging-obcms.gov.ph
ALLOWED_HOSTS=staging.yourdomain.com,staging-www.yourdomain.com

# CSRF Trusted Origins (comma-separated, MUST include https:// scheme)
# CRITICAL: Required to prevent 403 CSRF errors on ALL form submissions
# FORMAT REQUIREMENTS:
# - MUST include scheme (https:// or http://)
# - NO trailing slashes
# - Include ALL domains that will serve this app
#
# Examples:
# Single domain:     CSRF_TRUSTED_ORIGINS=https://staging.obcms.gov.ph
# Multiple domains:  CSRF_TRUSTED_ORIGINS=https://staging.obcms.gov.ph,https://staging-www.obcms.gov.ph
CSRF_TRUSTED_ORIGINS=https://staging.yourdomain.com,https://staging-www.yourdomain.com

# CORS Allowed Origins (comma-separated, MUST include https:// scheme)
CORS_ALLOWED_ORIGINS=https://staging.yourdomain.com

# ============================================================================
# DATABASE CONFIGURATION
# ============================================================================

# PostgreSQL Connection URL
# Format: postgres://USER:PASSWORD@HOST:PORT/DATABASE
# Staging: Use pgbouncer for connection pooling
DATABASE_URL=postgres://obcms_staging:staging-database-password@pgbouncer:6432/obcms_staging

# PostgreSQL Credentials (used by docker-compose.staging.yml)
POSTGRES_DB=obcms_staging
POSTGRES_USER=obcms_staging
POSTGRES_PASSWORD=staging-database-password-change-me

# Database Connection Pool Settings
DB_CONN_MAX_AGE=600
DB_CONN_HEALTH_CHECKS=true

# ============================================================================
# REDIS & CELERY CONFIGURATION
# ============================================================================

# Redis Connection URL (single instance for staging)
REDIS_URL=redis://redis:6379/0

# Celery Broker (same as Redis)
CELERY_BROKER_URL=redis://redis:6379/0

# Celery Result Backend (optional, defaults to broker URL)
CELERY_RESULT_BACKEND=redis://redis:6379/0

# Celery Worker Configuration
CELERY_WORKER_MAX_TASKS_PER_CHILD=1000
CELERY_WORKER_PREFETCH_MULTIPLIER=4
CELERY_TASK_TIME_LIMIT=300
CELERY_TASK_SOFT_TIME_LIMIT=240
CELERY_TASK_ACKS_LATE=true

# ============================================================================
# EMAIL CONFIGURATION
# ============================================================================

# Email Backend - Use console for testing or SMTP for real emails
# Testing: django.core.mail.backends.console.EmailBackend
# SMTP: django.core.mail.backends.smtp.EmailBackend
EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend

# SMTP Settings (if using EMAIL_BACKEND=smtp)
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=1
EMAIL_HOST_USER=staging-noreply@yourdomain.com
EMAIL_HOST_PASSWORD=your-staging-email-app-password

# Default From Email
DEFAULT_FROM_EMAIL=OBCMS Staging <staging-noreply@yourdomain.com>

# Pilot Support Email (for staging notifications)
PILOT_SUPPORT_EMAIL=support@staging.yourdomain.com

# ============================================================================
# SECURITY HEADERS (Staging)
# ============================================================================

# Force HTTPS redirects (disable if reverse proxy handles this)
SECURE_SSL_REDIRECT=1

# HSTS - Reduced time for staging (7 days instead of 1 year)
SECURE_HSTS_SECONDS=604800
SECURE_HSTS_INCLUDE_SUBDOMAINS=true
SECURE_HSTS_PRELOAD=true

# Session and CSRF Cookie Security
SESSION_COOKIE_SECURE=true
CSRF_COOKIE_SECURE=true

# ============================================================================
# GUNICORN TUNING (Staging - Reduced)
# ============================================================================

# Worker processes: Formula = (2 Ã— CPU cores) + 1
# Staging: 4 workers (reduced from 17 in production)
GUNICORN_WORKERS=4

# Threads per worker
GUNICORN_THREADS=2

# Logging level
GUNICORN_LOG_LEVEL=info

# ============================================================================
# APPLICATION CONFIGURATION
# ============================================================================

# Base URL (used for absolute links in emails)
BASE_URL=https://staging.yourdomain.com

# Site Configuration
SITE_NAME=OBCMS Staging Environment
SITE_DESCRIPTION=Other Bangsamoro Communities Management System - Staging

# Logging Level (DEBUG, INFO, WARNING, ERROR, CRITICAL)
LOG_LEVEL=INFO

# ============================================================================
# STAGING-SPECIFIC SETTINGS
# ============================================================================

# Feature Flags
FEATURE_PILOT_MODE=true
FEATURE_ALLOW_PILOT_SIGNUPS=false

# Pilot Organizations
PILOT_ORGANIZATION_CODES=MOH,MOLE,MAFAR

# Pilot Default Password Length
PILOT_DEFAULT_PASSWORD_LENGTH=16

# Backup Configuration
BACKUP_DIRECTORY=/app/backups/staging
BACKUP_RETENTION_DAYS=7

# ============================================================================
# MEDIA STORAGE CONFIGURATION
# ============================================================================

# Staging uses filesystem storage (same as development)
USE_S3=0

# ============================================================================
# MONITORING CONFIGURATION (Optional)
# ============================================================================

# Grafana Admin Credentials (if enabling monitoring profile)
GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=staging-grafana-password

# ============================================================================
# WORK HIERARCHY SYSTEM
# ============================================================================

# WorkItem Unified Model (enabled for staging)
USE_WORKITEM_MODEL=1
USE_UNIFIED_CALENDAR=1
DUAL_WRITE_ENABLED=0
LEGACY_MODELS_READONLY=1

# ============================================================================
# OPTIONAL: EXTERNAL SERVICES
# ============================================================================

# Sentry DSN for error tracking (optional)
# SENTRY_DSN=https://your-sentry-dsn@sentry.io/project-id

# New Relic license key (optional)
# NEW_RELIC_LICENSE_KEY=your-license-key

# AWS S3 for media storage (optional, set USE_S3=1 above)
# AWS_ACCESS_KEY_ID=your-access-key
# AWS_SECRET_ACCESS_KEY=your-secret-key
# AWS_STORAGE_BUCKET_NAME=obcms-staging-media
# AWS_S3_REGION_NAME=ap-southeast-1

# ============================================================================
# RESOURCE LIMITS SUMMARY (for reference)
# ============================================================================
#
# Total Memory Allocation: ~2GB
# - PostgreSQL: 512MB
# - PgBouncer: 128MB
# - Redis: 256MB
# - Web Servers (2x): 512MB each = 1024MB
# - Celery Worker: 512MB
# - Celery Beat: 256MB
# - Nginx: 256MB
# - Monitoring (optional): ~1GB additional
#
# Total CPU Allocation: ~5.5 cores
# - PostgreSQL: 1.0 core
# - PgBouncer: 0.5 core
# - Redis: 0.5 core
# - Web Servers (2x): 1.0 core each = 2.0 cores
# - Celery Worker: 1.0 core
# - Celery Beat: 0.5 core
# - Nginx: 0.5 core
#
# ============================================================================
