# OBCMS Dependency Vulnerability Audit - Action Plan

**Generated:** October 20, 2025
**Based On:** [DEPENDENCY_VULNERABILITY_AUDIT_REPORT.md](./DEPENDENCY_VULNERABILITY_AUDIT_REPORT.md)

---

## Executive Summary

This action plan provides specific, actionable steps to address findings from the October 2025 dependency vulnerability audit. The overall security posture is **GOOD**, with a few specific configurations needed.

**Key Finding:** PyTorch is NOT loading models in the codebase (no torch.load/torch.save calls found), significantly reducing risk.

---

## Priority 1: CRITICAL (Complete This Week)

### 1.1 Redis Server Security (CRITICAL)

**Status:** Redis Python client is secure, but server needs verification
**CVE:** CVE-2025-49844 (CVSS 10.0), CVE-2025-21605 (CVSS 7.5)
**Risk:** Remote Code Execution on Redis server

#### Development Environment
```bash
# Check Redis server version
redis-cli INFO server | grep redis_version

# If version is older than 6.2.20, 7.2.11, 7.4.6, 8.0.4, or 8.2.2:
# Update Redis server via Homebrew (macOS):
brew upgrade redis
brew services restart redis

# Or via apt (Linux):
sudo apt update
sudo apt upgrade redis-server
sudo systemctl restart redis
```

#### Production Environment
```bash
# SSH to production server
ssh user@production-server

# Check Redis version
redis-cli INFO server | grep redis_version

# If using Docker:
docker exec redis-container redis-cli INFO server | grep redis_version

# Update based on your deployment method:
# - Coolify: Update Redis service to latest image
# - Docker Compose: Update redis image tag in docker-compose.yml
# - Native: apt/yum upgrade redis-server
```

#### Required Configuration (Add to Redis config)
```redis
# /etc/redis/redis.conf (or your Redis config location)

# 1. Require authentication
requirepass <STRONG_PASSWORD_HERE>

# 2. Configure output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# 3. Bind to specific interface (not 0.0.0.0)
bind 127.0.0.1  # For local development
# bind 10.0.0.5  # For production, use internal IP

# 4. Disable dangerous commands (optional but recommended)
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG ""
```

#### Update OBCMS Settings
```python
# src/obc_management/settings/production.py or base.py

# Update Celery broker URL with authentication
CELERY_BROKER_URL = env(
    'CELERY_BROKER_URL',
    default='redis://:YOUR_REDIS_PASSWORD@127.0.0.1:6379/0'
)

# Update Django cache with authentication
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.redis.RedisCache',
        'LOCATION': 'redis://:YOUR_REDIS_PASSWORD@127.0.0.1:6379/1',
    }
}
```

#### Update .env Files
```bash
# Add to .env (development) and production environment variables
CELERY_BROKER_URL=redis://:YOUR_DEV_PASSWORD@127.0.0.1:6379/0
REDIS_URL=redis://:YOUR_DEV_PASSWORD@127.0.0.1:6379/1
```

#### Verification Steps
```bash
# 1. Verify Redis requires authentication
redis-cli PING  # Should fail with "NOAUTH"
redis-cli -a YOUR_PASSWORD PING  # Should return "PONG"

# 2. Verify Celery can connect
cd src
python manage.py shell
>>> from celery import Celery
>>> app = Celery()
>>> app.config_from_object('django.conf:settings', namespace='CELERY')
>>> # Should connect without errors

# 3. Verify Django cache works
cd src
python manage.py shell
>>> from django.core.cache import cache
>>> cache.set('test', 'value')
>>> print(cache.get('test'))
>>> # Should print: value
```

**Priority:** CRITICAL - Complete by October 27, 2025
**Assigned To:** DevOps Team / System Administrator
**Estimated Time:** 2-4 hours

---

### 1.2 Configure reportlab Security (HIGH)

**Status:** RCE vulnerability patched, but SSRF needs configuration
**Risk:** Server-Side Request Forgery via untrusted image URLs in PDFs
**Files Affected:**
- /Users/saidamenmambayao/apps/obcms/src/mana/facilitator_views.py (line 30-31)
- /Users/saidamenmambayao/apps/obcms/src/communities/views.py (line 20-24)
- /Users/saidamenmambayao/apps/obcms/src/communities/data_utils.py (line 18-22)

#### Step 1: Create Security Configuration
```python
# Create: src/obc_management/reportlab_config.py

"""
reportlab Security Configuration

Configures trusted schemes and hosts for image loading in PDF generation.
This prevents SSRF attacks via malicious image URLs.
"""

from reportlab.lib.utils import ImageReader


def configure_reportlab_security():
    """
    Configure reportlab security settings to prevent SSRF attacks.

    This should be called early in application startup (in apps.py or __init__.py).
    """
    # Only allow data URLs (base64 encoded images)
    # This is the most secure option if you don't need external images
    ImageReader.trusted_schemes = ['data']

    # If you need to allow external images, uncomment and configure:
    # ImageReader.trusted_schemes = ['http', 'https', 'data']
    # ImageReader.trusted_hosts = [
    #     'yourdomain.com',
    #     'cdn.yourdomain.com',
    #     'trusted-image-host.com',
    # ]

    print("reportlab security configured: trusted_schemes =", ImageReader.trusted_schemes)
```

#### Step 2: Apply Configuration at Startup
```python
# Edit: src/obc_management/__init__.py

# Add at the top of the file:
from .reportlab_config import configure_reportlab_security

# Call during application startup
configure_reportlab_security()

# Rest of existing code...
```

#### Step 3: Audit PDF Generation Code

**File: src/mana/facilitator_views.py**
```python
# Line 772 area - verify error handling
# Current code should be checked for:
# 1. Are user-provided URLs used in PDFs? (HIGH RISK)
# 2. Are user-provided HTML converted to PDFs? (HIGH RISK)
# 3. Are only system-generated images used? (LOW RISK)

# If user input is involved, add validation:
from django.core.validators import URLValidator
from urllib.parse import urlparse

def validate_image_url(url):
    """Validate image URL before using in PDF."""
    if not url:
        return None

    # Only allow data URLs (safest)
    if url.startswith('data:image/'):
        return url

    # If allowing external URLs, validate domain
    parsed = urlparse(url)
    allowed_hosts = ['yourdomain.com', 'cdn.yourdomain.com']

    if parsed.hostname not in allowed_hosts:
        raise ValueError(f"Image URL from untrusted host: {parsed.hostname}")

    return url
```

**File: src/communities/views.py & src/communities/data_utils.py**
```python
# Check lines 20-24 in both files
# Verify:
# 1. What data sources feed into PDF generation?
# 2. Are there any user-uploaded images included?
# 3. Are there any external image URLs included?

# Add input validation if needed (same as above)
```

#### Step 4: Test PDF Generation
```bash
# Test that PDFs still generate correctly
cd src
python manage.py shell

# Test PDF generation functions
>>> from communities.views import export_communities_pdf  # or similar
>>> # Test with sample data
>>> # Verify PDFs generate without errors
```

#### Step 5: Document PDF Security
```python
# Add docstring to PDF generation functions:

def generate_pdf_report(data):
    """
    Generate PDF report from data.

    Security Notes:
    - Only data URLs are allowed for images (configured in reportlab_config.py)
    - No external image URLs are loaded to prevent SSRF attacks
    - User input is sanitized before inclusion in PDF

    Args:
        data: Validated data for PDF generation

    Returns:
        PDF file as bytes
    """
    pass
```

**Priority:** HIGH - Complete by October 27, 2025
**Assigned To:** Backend Development Team
**Estimated Time:** 2-3 hours

---

### 1.3 Verify PyTorch Security (COMPLETED - NO ACTION NEEDED)

**Status:** ✅ NO PYTORCH MODEL LOADING FOUND
**Finding:** Grep search found zero instances of `torch.load()` or `torch.save()` in codebase
**Risk Level:** NONE - PyTorch is used for inference only via sentence-transformers

**Verification Completed:**
```bash
# Command run:
grep -rn "torch.load" src/
grep -rn "torch.save" src/

# Result: No matches found
```

**Conclusion:**
- PyTorch (torch 2.9.0) is installed as a dependency for sentence-transformers
- OBCMS does not directly load or save PyTorch models
- CVE-2025-32434 (RCE via torch.load) does NOT apply to OBCMS
- No action required

**Documentation:**
- PyTorch is used indirectly via sentence-transformers for semantic search
- sentence-transformers handles model loading internally
- Models are downloaded from HuggingFace (trusted source)
- No user-uploaded models are processed

**Priority:** NONE - Already verified safe
**Status:** ✅ COMPLETE

---

## Priority 2: MEDIUM (Complete This Month)

### 2.1 Update Outdated Packages (Safe Minor Updates)

**Status:** 5 packages have safe minor version updates available
**Risk:** None - maintenance updates
**Priority:** MEDIUM

#### Step 1: Backup Current Environment
```bash
# Create backup of current working environment
source venv/bin/activate
pip freeze > requirements/backup-2025-10-20.txt
```

#### Step 2: Update Packages
```bash
source venv/bin/activate

# Update PostgreSQL driver
pip install --upgrade "psycopg[binary]>=3.2.11"

# Update Google AI package
pip install --upgrade "google-ai-generativelanguage>=0.8.0"

# Update gRPC status (should match grpcio version)
pip install --upgrade "grpcio-status>=1.75.1"

# Update pytest config tool
pip install --upgrade "iniconfig>=2.3.0"

# Update pip itself
pip install --upgrade pip
```

#### Step 3: Run Tests
```bash
cd src

# Run full test suite
python manage.py test

# Run pytest if configured
pytest

# Check for any deprecation warnings
python manage.py check --deploy
```

#### Step 4: Update Requirements Files
```bash
# Update requirements/base.txt with new versions
source venv/bin/activate
cd requirements

# Update specific package versions in base.txt:
# psycopg[binary]>=3.2.11
# google-ai-generativelanguage>=0.8.0
# grpcio-status>=1.75.1

# Optionally freeze all versions
pip freeze > frozen-2025-10-20.txt
```

#### Step 5: Test in Development
```bash
# Run development server
cd src
python manage.py runserver

# Test key features:
# - User authentication
# - Database queries
# - Celery tasks
# - Google AI features (if used)
# - PDF generation
```

**Priority:** MEDIUM - Complete by November 15, 2025
**Assigned To:** Backend Development Team
**Estimated Time:** 1-2 hours

---

### 2.2 Plan protobuf 6.x Migration

**Status:** Current version (5.29.5) works but is one major version behind
**Target:** protobuf 6.33.0
**Breaking Changes:** YES - requires careful testing
**Priority:** MEDIUM (plan now, execute in Q1 2026)

#### Research Phase (Week 1)
```bash
# Read breaking changes documentation
# URL: https://protobuf.dev/news/v30/

# Key breaking changes to review:
# 1. Python 3.9+ required (OBCMS uses 3.12 - OK)
# 2. Descriptor return types changed to absl::string_view
# 3. Closed enum validation changes
# 4. Legacy bazel aliases removed
```

#### Testing Phase (Week 2)
```bash
# Create test branch
git checkout -b feature/protobuf-6-migration

# Update in test environment
source venv/bin/activate
pip install "protobuf>=6.33.0"

# Run comprehensive tests
cd src
python manage.py test
pytest

# Test Google Cloud integrations specifically
python manage.py shell
>>> from google.cloud import aiplatform
>>> # Test basic operations
```

#### Compatibility Check (Week 2)
```python
# Check if any code directly uses protobuf
grep -rn "import google.protobuf" src/
grep -rn "from google.protobuf" src/

# Check for enum usage
grep -rn "\.enum\." src/

# Check for descriptor access
grep -rn "\.descriptor\." src/
```

#### Rollout Phase (Week 3-4)
1. Update development environment
2. Deploy to staging
3. Monitor for 1 week
4. Deploy to production

**Priority:** MEDIUM - Plan by November 30, 2025, Execute Q1 2026
**Assigned To:** DevOps + Backend Team
**Estimated Time:** 8-12 hours (planning + testing + deployment)

---

### 2.3 Update google-cloud-storage to 3.x

**Status:** Current version (2.19.0) is functional but missing features
**Target:** google-cloud-storage 3.4.1
**Breaking Changes:** Possible API changes
**Priority:** MEDIUM

#### Step 1: Research Breaking Changes
```bash
# Review changelog
# URL: https://github.com/googleapis/python-storage/releases

# Focus on releases:
# - 3.0.0 (breaking changes)
# - 3.1.0 - 3.4.1 (features and fixes)
```

#### Step 2: Find Cloud Storage Usage
```bash
# Find all google-cloud-storage usage in codebase
grep -rn "from google.cloud import storage" src/
grep -rn "import google.cloud.storage" src/
grep -rn "storage.Client" src/
grep -rn "storage.Bucket" src/
```

#### Step 3: Test in Development
```bash
# Create test branch
git checkout -b feature/gcs-3-migration

# Update package
source venv/bin/activate
pip install "google-cloud-storage>=3.4.1"

# Run tests
cd src
python manage.py test

# Test file upload/download if GCS is used
```

#### Step 4: Rollout (if compatible)
1. Update requirements/base.txt: `google-cloud-storage>=3.4.1`
2. Deploy to development
3. Deploy to staging
4. Monitor for 1 week
5. Deploy to production

**Priority:** MEDIUM - Complete by December 15, 2025
**Assigned To:** Backend Development Team
**Estimated Time:** 4-6 hours

---

## Priority 3: LOW (Nice to Have)

### 3.1 Verify axe-playwright-python License

**Status:** Development-only dependency with UNKNOWN license
**Risk:** Low (not in production)
**Priority:** LOW

#### Action
```bash
# Check GitHub repository for license
# Package: axe-playwright-python
# URL: https://github.com/

# If license is compatible: Document it
# If license is incompatible: Find alternative accessibility testing tool
```

**Priority:** LOW - Complete by December 31, 2025
**Assigned To:** QA Team
**Estimated Time:** 30 minutes

---

## Continuous Monitoring Setup

### Install Security Scanning Tools
```bash
# Already installed in venv:
source venv/bin/activate
pip show pip-audit  # Should show version 2.9.0

# Add to development requirements if not present
echo "pip-audit>=2.9.0" >> requirements/development.txt
```

### Create Monthly Security Check Script
```bash
# Create: scripts/security-audit.sh

#!/bin/bash
# Monthly Security Audit Script

echo "=== OBCMS Security Audit ==="
echo "Date: $(date)"
echo ""

# Activate virtual environment
source venv/bin/activate

# Run pip-audit
echo "1. Running pip-audit..."
pip-audit --requirement requirements/base.txt --format json > /tmp/audit-base.json
pip-audit --requirement requirements/development.txt --format json > /tmp/audit-dev.json

# Check for outdated packages
echo ""
echo "2. Checking for outdated packages..."
pip list --outdated

# Check for security issues
echo ""
echo "3. Running Django security check..."
cd src
python manage.py check --deploy

echo ""
echo "=== Audit Complete ==="
echo "Review /tmp/audit-*.json for detailed results"
```

### Schedule in Crontab (Optional)
```bash
# Run monthly on the 1st of each month
0 9 1 * * /path/to/scripts/security-audit.sh | mail -s "OBCMS Monthly Security Audit" security@yourdomain.com
```

### Subscribe to Security Advisories
1. Django: https://groups.google.com/g/django-announce
2. PyTorch: https://github.com/pytorch/pytorch/security/advisories
3. Redis: https://redis.io/blog/
4. Python Security: https://github.com/pypa/advisory-database

---

## Testing & Verification

### Development Environment Testing
```bash
# Full test suite
cd src
python manage.py test

# Check for deprecation warnings
python -Wd manage.py test

# Run with coverage
coverage run manage.py test
coverage report
```

### Staging Environment Testing
```bash
# Deploy to staging
git push staging main

# Run production checks
cd src
python manage.py check --deploy

# Test critical workflows:
# 1. User login/logout
# 2. PDF generation
# 3. Data import/export
# 4. Celery tasks
# 5. Redis caching
# 6. Database queries
```

### Production Deployment Checklist
- [ ] All CRITICAL priority actions completed
- [ ] All HIGH priority actions completed
- [ ] Redis server updated and authenticated
- [ ] reportlab security configured
- [ ] pip-audit shows 0 vulnerabilities
- [ ] Tests pass in staging
- [ ] DEBUG=False in production
- [ ] SECRET_KEY is unique
- [ ] Backups are current
- [ ] Rollback plan documented

---

## Rollback Plan

If any update causes issues:

### Immediate Rollback
```bash
# Restore from backup
source venv/bin/activate
pip install -r requirements/backup-2025-10-20.txt

# Restart services
sudo systemctl restart gunicorn
sudo systemctl restart celery
```

### Investigation
```bash
# Check logs
tail -f /var/log/obcms/error.log
tail -f /var/log/celery/worker.log

# Check for specific errors
grep -i "error" /var/log/obcms/*.log
```

### Report Issue
1. Document the error
2. Check package changelog for breaking changes
3. File issue on package repository if needed
4. Stay on previous version until fixed

---

## Timeline Summary

| Priority | Action | Deadline | Estimate |
|----------|--------|----------|----------|
| CRITICAL | Redis server security | Oct 27, 2025 | 2-4 hours |
| HIGH | reportlab security config | Oct 27, 2025 | 2-3 hours |
| ✅ COMPLETE | PyTorch verification | Complete | N/A |
| MEDIUM | Update minor packages | Nov 15, 2025 | 1-2 hours |
| MEDIUM | Plan protobuf 6.x | Nov 30, 2025 | 8-12 hours |
| MEDIUM | Update GCS to 3.x | Dec 15, 2025 | 4-6 hours |
| LOW | Verify axe license | Dec 31, 2025 | 30 min |

**Total Estimated Effort:** 18-28 hours over 2.5 months

---

## Success Criteria

The security audit implementation will be considered successful when:

- [ ] Redis server is updated to patched version (6.2.20+, 7.2.11+, etc.)
- [ ] Redis authentication is enabled and configured
- [ ] reportlab security configuration is applied
- [ ] reportlab usage is audited and documented
- [ ] All safe minor package updates are applied
- [ ] pip-audit shows 0 vulnerabilities
- [ ] All tests pass in development and staging
- [ ] Security monitoring is configured (monthly audits)
- [ ] Team is subscribed to security advisories
- [ ] Documentation is updated

---

## Questions or Issues

**Report Issues To:**
- Security Team: security@obcms.local
- DevOps Team: devops@obcms.local

**Documentation:**
- Full Audit Report: [DEPENDENCY_VULNERABILITY_AUDIT_REPORT.md](./DEPENDENCY_VULNERABILITY_AUDIT_REPORT.md)
- Executive Summary: [VULNERABILITY_AUDIT_EXECUTIVE_SUMMARY.md](./VULNERABILITY_AUDIT_EXECUTIVE_SUMMARY.md)

**Last Updated:** October 20, 2025
**Next Review:** January 20, 2026
