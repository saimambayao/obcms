# OBCMS Malware Scanning Integration Guide (ClamAV)

**Version:** 1.0
**Date:** January 2025
**Status:** Future Enhancement - Month 2

---

## Overview

This guide integrates ClamAV malware scanning for file uploads in OBCMS.

**Protection Against:**
- Malware disguised as documents/images
- Trojan horses
- Viruses in uploaded files
- Ransomware
- Zero-day malware (with signature updates)

---

## Installation

### Ubuntu/Debian

```bash
# Install ClamAV
sudo apt update
sudo apt install clamav clamav-daemon python3-pyclamd

# Start ClamAV daemon
sudo systemctl enable clamav-daemon
sudo systemctl start clamav-daemon

# Update virus definitions
sudo freshclam
```

### Docker (Recommended for Production)

```yaml
# docker-compose.yml
services:
  clamav:
    image: clamav/clamav:latest
    container_name: clamav
    ports:
      - "3310:3310"
    volumes:
      - clamav_db:/var/lib/clamav
    environment:
      - CLAMD_TIMEOUT=300
    healthcheck:
      test: ["CMD", "clamdscan", "--ping", "3"]
      interval: 60s
      retries: 5

volumes:
  clamav_db:
```

---

## Python Integration

### Install pyclamd

```bash
pip install pyclamd
```

Add to `requirements/base.txt`:
```
pyclamd>=0.4.0
```

### Update File Validators

Edit `src/common/validators.py`:

```python
import pyclamd
from django.core.exceptions import ValidationError

# Initialize ClamAV connection
try:
    CLAMAV = pyclamd.ClamdNetworkSocket(host='localhost', port=3310)
    CLAMAV.ping()  # Test connection
    CLAMAV_AVAILABLE = True
except Exception:
    CLAMAV_AVAILABLE = False
    print("⚠️  ClamAV not available. Malware scanning disabled.")


def scan_file_for_malware(file):
    """
    Scan uploaded file for malware using ClamAV.

    Args:
        file: UploadedFile object

    Raises:
        ValidationError: If malware detected
    """
    if not CLAMAV_AVAILABLE:
        # Log warning but don't block upload
        print(f"⚠️  Malware scan skipped for {file.name} (ClamAV unavailable)")
        return

    try:
        # Read file content
        file.seek(0)
        file_data = file.read()
        file.seek(0)  # Reset file pointer

        # Scan with ClamAV
        result = CLAMAV.scan_stream(file_data)

        if result:
            # Malware detected
            virus_name = result['stream'][1]
            raise ValidationError(
                f"Malware detected in uploaded file: {virus_name}. "
                f"Upload blocked for security."
            )

    except ValidationError:
        raise  # Re-raise validation errors
    except Exception as e:
        # Log error but don't block upload
        print(f"⚠️  Malware scan error for {file.name}: {e}")


# Update existing validators to include malware scanning
def validate_image_file(file):
    """Enhanced image validation with malware scanning."""
    validate_file_size(file, max_size_mb=5)
    validate_file_extension(file, allowed_extensions=['.jpg', '.jpeg', '.png', '.gif', '.webp'])
    validate_file_content_type(file)
    scan_file_for_malware(file)  # ✅ NEW
    file.name = sanitize_filename(file.name)


def validate_document_file(file):
    """Enhanced document validation with malware scanning."""
    validate_file_size(file, max_size_mb=10)
    validate_file_extension(file, allowed_extensions=['.pdf', '.doc', '.docx', '.xls', '.xlsx'])
    validate_file_content_type(file)
    scan_file_for_malware(file)  # ✅ NEW
    file.name = sanitize_filename(file.name)
```

---

## Configuration

### ClamAV Settings

Edit `/etc/clamav/clamd.conf`:

```conf
# Maximum file size to scan (50MB)
MaxFileSize 50M

# Maximum scan size (100MB)
MaxScanSize 100M

# Enable heuristic scanning
HeuristicScanPrecedence yes

# Enable OLE2 scanning (MS Office files)
ScanOLE2 yes

# Enable PDF scanning
ScanPDF yes

# Enable archive scanning
ScanArchive yes
```

### Django Settings

Add to `src/obc_management/settings/base.py`:

```python
# ClamAV Configuration
CLAMAV_ENABLED = env.bool("CLAMAV_ENABLED", default=True)
CLAMAV_HOST = env("CLAMAV_HOST", default="localhost")
CLAMAV_PORT = env.int("CLAMAV_PORT", default=3310)
CLAMAV_TIMEOUT = env.int("CLAMAV_TIMEOUT", default=60)  # seconds
```

Environment variables (`.env`):

```env
CLAMAV_ENABLED=1
CLAMAV_HOST=clamav  # Docker service name
CLAMAV_PORT=3310
CLAMAV_TIMEOUT=60
```

---

## Testing

### Test Malware Detection

```python
# Django shell
python manage.py shell

from django.core.files.uploadedfile import SimpleUploadedFile
from common.validators import scan_file_for_malware

# EICAR test file (harmless malware signature)
eicar = b'X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*'

test_file = SimpleUploadedFile("virus.txt", eicar, content_type="text/plain")

try:
    scan_file_for_malware(test_file)
    print("❌ FAIL: Malware not detected")
except Exception as e:
    print(f"✅ PASS: Malware detected - {e}")
```

### Manual Scan

```bash
# Scan a file
clamdscan /path/to/file.pdf

# Scan entire media directory
clamdscan -r /path/to/obcms/src/media/

# Verbose output
clamdscan -v /path/to/file.pdf
```

---

## Monitoring

### Scan Logs

View ClamAV logs:

```bash
# System logs
sudo tail -f /var/log/clamav/clamav.log

# Scan results
grep "FOUND" /var/log/clamav/clamav.log

# Update logs
grep "Database updated" /var/log/clamav/freshclam.log
```

### Update Virus Definitions

Automatic updates via `freshclam`:

```bash
# Check update status
sudo freshclam

# Configure auto-updates
sudo systemctl enable clamav-freshclam
sudo systemctl start clamav-freshclam
```

Manual update:

```bash
sudo freshclam --verbose
```

---

## Performance Optimization

### For High-Traffic Sites

**1. Async Scanning with Celery:**

```python
# tasks.py
from celery import shared_task
import pyclamd

@shared_task
def scan_uploaded_file(file_path):
    """Scan file asynchronously."""
    cd = pyclamd.ClamdNetworkSocket()
    result = cd.scan_file(file_path)

    if result:
        # Malware found - delete file and notify admin
        os.remove(file_path)
        send_security_alert(f"Malware detected: {result}")
```

**2. Cache Scan Results:**

```python
from django.core.cache import cache
import hashlib

def scan_file_for_malware(file):
    # Calculate file hash
    file_hash = hashlib.sha256(file.read()).hexdigest()
    file.seek(0)

    # Check cache
    cached_result = cache.get(f"virus_scan:{file_hash}")
    if cached_result == "clean":
        return  # Skip scan

    # Perform scan...
    # If clean, cache result
    cache.set(f"virus_scan:{file_hash}", "clean", timeout=86400)  # 24 hours
```

---

## Troubleshooting

### ClamAV Not Responding

```bash
# Check service status
sudo systemctl status clamav-daemon

# Restart service
sudo systemctl restart clamav-daemon

# Check socket permissions
ls -l /var/run/clamav/clamd.ctl
```

### High Memory Usage

ClamAV can use 500MB-1GB RAM. Optimize:

```conf
# /etc/clamav/clamd.conf
MaxThreads 10  # Reduce from 12
MaxQueue 100   # Reduce queue size
```

### Scan Timeouts

Increase timeout in Django:

```python
CLAMAV_TIMEOUT = 120  # 2 minutes
```

---

## Security Best Practices

1. ✅ **Always update virus definitions daily**
2. ✅ **Monitor scan logs for patterns**
3. ✅ **Quarantine suspicious files, don't delete immediately**
4. ✅ **Alert security team on malware detection**
5. ✅ **Scan existing uploads periodically** (monthly)

---

**Document Version:** 1.0
**Next Steps:** Deploy in Month 2 after file upload features stabilize
