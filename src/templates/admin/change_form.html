{% extends "admin/base.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block bodyclass %}{{ block.super }} app-{{ opts.app_label }} model-{{ opts.model_name }} change-form{% endblock %}

{% if not is_popup %}
{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
&rsaquo; <a href="{% url opts|admin_urlname:'changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
&rsaquo; {% if add %}{% blocktrans with name=opts.verbose_name %}Add {{ name }}{% endblocktrans %}{% else %}{{ original|truncatewords:"18" }}{% endif %}
</div>
{% endblock %}
{% endif %}

{% block content %}
<div class="change-form-wrapper">
    <!-- Header Section -->
    <div class="change-form-header bg-white rounded-lg shadow-lg border border-gray-200 p-6 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                    {% if opts.app_label == 'common' %}
                        <i class="fas fa-cog text-blue-600 mr-3"></i>
                    {% elif opts.app_label == 'communities' %}
                        <i class="fas fa-users text-green-600 mr-3"></i>
                    {% elif opts.app_label == 'mana' %}
                        <i class="fas fa-map text-purple-600 mr-3"></i>
                    {% elif opts.app_label == 'coordination' %}
                        <i class="fas fa-handshake text-orange-600 mr-3"></i>
                    {% elif opts.app_label == 'policy_tracking' %}
                        <i class="fas fa-gavel text-red-600 mr-3"></i>
                    {% elif opts.app_label == 'documents' %}
                        <i class="fas fa-file-alt text-yellow-600 mr-3"></i>
                    {% else %}
                        <i class="fas fa-edit text-gray-600 mr-3"></i>
                    {% endif %}
                    {% if add %}
                        {% blocktrans with name=opts.verbose_name %}Add {{ name }}{% endblocktrans %}
                    {% else %}
                        {% trans "Change" %} {{ opts.verbose_name }}
                    {% endif %}
                </h1>
                {% if not add and original %}
                    <p class="text-gray-600 mt-2">{{ original }}</p>
                {% endif %}
            </div>
            
            <div class="flex items-center space-x-3">
                {% if not add and has_view_permission %}
                    <a href="{% url opts|admin_urlname:'changelist' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        <i class="fas fa-list mr-2"></i>
                        {% trans "View List" %}
                    </a>
                {% endif %}
                
                {% if not add and has_add_permission %}
                    <a href="{% url opts|admin_urlname:'add' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                        <i class="fas fa-plus mr-2"></i>
                        {% blocktrans with name=opts.verbose_name %}Add another {{ name }}{% endblocktrans %}
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Form Section -->
    <form method="post" id="{{ opts.model_name }}_form" class="space-y-6" {% if has_file_field %}enctype="multipart/form-data"{% endif %}>
        {% csrf_token %}
        
        <!-- Form Errors -->
        {% if errors %}
        <div class="form-errors bg-red-50 border-l-4 border-red-400 p-4 rounded-r-md">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-red-400 text-lg"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">{% trans "Please correct the errors below." %}</h3>
                    <div class="mt-2 text-sm text-red-700">
                        {% for field, error_list in errors.items %}
                            {% for error in error_list %}
                                <p>{{ field|capfirst }}: {{ error }}</p>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Non-field errors -->
        {% if adminform.form.non_field_errors %}
        <div class="non-field-errors bg-red-50 border-l-4 border-red-400 p-4 rounded-r-md">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-red-400 text-lg"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">{% trans "Form Errors" %}</h3>
                    <div class="mt-2 text-sm text-red-700">
                        {{ adminform.form.non_field_errors }}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Main Form Fields -->
        <div class="form-content bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
            <div class="form-header bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-edit text-blue-600 mr-2"></i>
                    {% trans "Form Details" %}
                </h2>
            </div>
            
            <div class="form-body p-6">
                {% if adminform %}
                    <fieldset class="module aligned">
                        {% for fieldset in adminform %}
                            {% include "admin/includes/fieldset.html" %}
                        {% endfor %}
                    </fieldset>
                {% endif %}
            </div>
        </div>

        <!-- Inline Related Objects -->
        {% if inline_admin_formsets %}
        <div class="inline-formsets space-y-6">
            {% for inline_admin_formset in inline_admin_formsets %}
                {% include inline_admin_formset.opts.template %}
            {% endfor %}
        </div>
        {% endif %}

        <!-- Submit Section -->
        <div class="submit-section bg-white rounded-lg shadow-lg border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    {% if show_save %}
                        <button type="submit" name="_save" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 hover:-translate-y-1 hover:shadow-lg">
                            <i class="fas fa-save mr-2"></i>
                            {% trans 'Save' %}
                        </button>
                    {% endif %}
                    
                    {% if show_save_and_add_another %}
                        <button type="submit" name="_addanother" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                            <i class="fas fa-plus mr-2"></i>
                            {% trans 'Save and add another' %}
                        </button>
                    {% endif %}
                    
                    {% if show_save_and_continue %}
                        <button type="submit" name="_continue" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                            <i class="fas fa-edit mr-2"></i>
                            {% trans 'Save and continue editing' %}
                        </button>
                    {% endif %}
                </div>
                
                <div class="flex items-center space-x-4">
                    {% if show_delete_link %}
                        <a href="{% url opts|admin_urlname:'delete' original.pk|admin_urlquote %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all duration-200 hover:-translate-y-1 hover:shadow-lg">
                            <i class="fas fa-trash mr-2"></i>
                            {% trans "Delete" %}
                        </a>
                    {% endif %}
                    
                    <a href="{% url opts|admin_urlname:'changelist' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        <i class="fas fa-times mr-2"></i>
                        {% trans "Cancel" %}
                    </a>
                </div>
            </div>
        </div>
    </form>

    <!-- Object History (if not adding) -->
    {% if not add and has_change_permission %}
        <div class="history-section bg-white rounded-lg shadow-lg border border-gray-200 p-6 mt-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-history text-purple-600 mr-2"></i>
                {% trans "History" %}
            </h2>
            <div class="history-content">
                {% if history %}
                    <ul class="space-y-3">
                        {% for action in history %}
                            <li class="flex items-start space-x-3 p-3 bg-gray-50 rounded-md">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mt-2"></div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-900">{{ action.action_text }}</p>
                                    <p class="text-xs text-gray-500">
                                        {{ action.action_time|date:"M d, Y H:i" }} by {{ action.user.get_full_name|default:action.user.username }}
                                    </p>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-gray-500 text-sm">{% trans "No history available for this object." %}</p>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>

<style>
/* Custom styles for change form */
.change-form-wrapper {
    padding: 0 !important;
}

/* Hide default Django admin elements */
#content h1 {
    display: none !important;
}

.object-tools {
    display: none !important;
}

/* Form field styling */
.form-row {
    background: transparent !important;
    border: none !important;
    padding: 1rem 0 !important;
    margin-bottom: 0 !important;
    border-bottom: 1px solid #f3f4f6 !important;
}

.form-row:last-child {
    border-bottom: none !important;
}

.form-row label {
    color: #374151 !important;
    font-weight: 600 !important;
    margin-bottom: 0.5rem !important;
    display: block !important;
    font-size: 0.875rem !important;
}

.form-row .help {
    color: #6b7280 !important;
    font-size: 0.75rem !important;
    margin-top: 0.25rem !important;
    font-style: italic !important;
}

/* Input field styling */
.form-row input, 
.form-row select, 
.form-row textarea {
    width: 100% !important;
    max-width: 500px !important;
    border: 1px solid #d1d5db !important;
    border-radius: 0.375rem !important;
    padding: 0.75rem !important;
    transition: all 0.2s !important;
    font-size: 0.875rem !important;
    background: white !important;
}

.form-row input:focus, 
.form-row select:focus, 
.form-row textarea:focus {
    border-color: #3b82f6 !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
    outline: none !important;
}

.form-row input[type="checkbox"] {
    width: auto !important;
    max-width: none !important;
    margin-right: 0.5rem !important;
    transform: scale(1.2) !important;
}

/* File input styling */
.form-row input[type="file"] {
    border: 2px dashed #d1d5db !important;
    border-radius: 0.5rem !important;
    padding: 1rem !important;
    background: #f9fafb !important;
    transition: all 0.2s !important;
}

.form-row input[type="file"]:hover {
    border-color: #3b82f6 !important;
    background: #eff6ff !important;
}

/* Error field styling */
.form-row.errors input,
.form-row.errors select,
.form-row.errors textarea {
    border-color: #ef4444 !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
}

.errorlist {
    margin: 0.5rem 0 0 0 !important;
    padding: 0 !important;
    list-style: none !important;
}

.errorlist li {
    color: #ef4444 !important;
    font-size: 0.75rem !important;
    font-weight: 500 !important;
    margin-bottom: 0.25rem !important;
}

/* Fieldset styling */
fieldset.module {
    border: none !important;
    margin: 0 !important;
    padding: 0 !important;
}

fieldset h2 {
    background: #f8fafc !important;
    color: #374151 !important;
    padding: 1rem !important;
    margin: 0 0 1rem 0 !important;
    font-weight: 600 !important;
    border-radius: 0.375rem !important;
    border: 1px solid #e5e7eb !important;
}

/* Inline formset styling */
.inline-group {
    background: white !important;
    border: 1px solid #e5e7eb !important;
    border-radius: 0.5rem !important;
    margin-bottom: 1.5rem !important;
    overflow: hidden !important;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1) !important;
}

.inline-group .module h2 {
    background: #f8fafc !important;
    color: #374151 !important;
    padding: 1rem 1.5rem !important;
    margin: 0 !important;
    font-weight: 600 !important;
    border-bottom: 1px solid #e5e7eb !important;
    border-radius: 0 !important;
    border: none !important;
}

/* Date/time widget styling */
.datetime input {
    display: inline-block !important;
    width: auto !important;
    margin-right: 0.5rem !important;
}

/* Calendar and time widgets */
.calendarbox, .clockbox {
    background: white !important;
    border: 1px solid #d1d5db !important;
    border-radius: 0.5rem !important;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
}

/* Related object lookup */
.related-lookup {
    margin-left: 0.5rem !important;
}

.related-lookup a {
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 2rem !important;
    height: 2rem !important;
    background: #3b82f6 !important;
    color: white !important;
    border-radius: 0.375rem !important;
    text-decoration: none !important;
    transition: all 0.2s !important;
}

.related-lookup a:hover {
    background: #2563eb !important;
    transform: scale(1.05) !important;
}

/* Loading states */
.form-row.loading input,
.form-row.loading select,
.form-row.loading textarea {
    opacity: 0.7 !important;
    cursor: wait !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .change-form-header .flex {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 1rem !important;
    }
    
    .submit-section .flex {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 1rem !important;
    }
    
    .form-row input,
    .form-row select,
    .form-row textarea {
        max-width: none !important;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form validation and enhancement
    const form = document.getElementById('{{ opts.model_name }}_form');
    const submitButtons = form.querySelectorAll('button[type="submit"]');
    
    // Add loading state to submit buttons
    submitButtons.forEach(button => {
        button.addEventListener('click', function() {
            this.disabled = true;
            this.style.opacity = '0.7';
            this.style.cursor = 'wait';
            const icon = this.querySelector('i');
            if (icon) {
                icon.className = 'fas fa-spinner fa-spin mr-2';
            }
            const text = this.textContent.trim();
            this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        });
    });
    
    // Auto-resize textareas
    const textareas = form.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        
        // Initial resize
        textarea.style.height = 'auto';
        textarea.style.height = (textarea.scrollHeight) + 'px';
    });
    
    // Form field focus effects
    const formInputs = form.querySelectorAll('input, select, textarea');
    formInputs.forEach(input => {
        input.addEventListener('focus', function() {
            this.closest('.form-row').style.background = '#f8fafc';
            this.closest('.form-row').style.borderRadius = '0.5rem';
            this.closest('.form-row').style.padding = '1rem';
            this.closest('.form-row').style.transition = 'all 0.2s';
        });
        
        input.addEventListener('blur', function() {
            this.closest('.form-row').style.background = 'transparent';
            this.closest('.form-row').style.padding = '1rem 0';
        });
    });
    
    // File input enhancement
    const fileInputs = form.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
        input.addEventListener('change', function() {
            const fileName = this.files[0]?.name;
            if (fileName) {
                let label = this.parentElement.querySelector('.file-label');
                if (!label) {
                    label = document.createElement('p');
                    label.className = 'file-label text-sm text-gray-600 mt-2';
                    this.parentElement.appendChild(label);
                }
                label.textContent = `Selected: ${fileName}`;
            }
        });
    });
    
    // Auto-save functionality (commented out by default)
    /*
    let autoSaveTimeout;
    formInputs.forEach(input => {
        input.addEventListener('input', function() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                // Auto-save logic here
                console.log('Auto-saving...');
            }, 5000);
        });
    });
    */
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+S or Cmd+S to save
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            const saveButton = form.querySelector('button[name="_save"]');
            if (saveButton) {
                saveButton.click();
            }
        }
        
        // Escape to cancel
        if (e.key === 'Escape') {
            const cancelLink = form.querySelector('a[href*="changelist"]');
            if (cancelLink) {
                window.location.href = cancelLink.href;
            }
        }
    });
    
    // Unsaved changes warning
    let formChanged = false;
    formInputs.forEach(input => {
        input.addEventListener('change', function() {
            formChanged = true;
        });
    });
    
    window.addEventListener('beforeunload', function(e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
    
    // Reset form changed flag on submit
    form.addEventListener('submit', function() {
        formChanged = false;
    });
});
</script>
{% endblock %}