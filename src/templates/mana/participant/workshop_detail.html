{% extends "base.html" %}
{% load static %}

{% block title %}{{ workshop.title }} Â· {{ assessment.title }}{% endblock %}

{% block content %}
<div class="bg-neutral-50 min-h-screen py-10">
    <div class="max-w-5xl mx-auto space-y-8">
        <div id="workshop-nav"
             class="bg-white border border-gray-100 rounded-3xl shadow-sm p-6"
             data-task-id="{{ assessment.id }}"
             hx-get="{% url 'mana:participant_dashboard' assessment.id %}"
             hx-trigger="refresh-workshop-nav from:body"
             hx-target="this"
             hx-swap="outerHTML swap:300ms">
            {% include "mana/participant/partials/workshop_nav.html" %}
        </div>

        <main class="bg-white border border-gray-100 rounded-3xl shadow-xl p-8 space-y-8" data-task-id="{{ workshop.id }}">
            <header class="space-y-3">
                <p class="text-sm uppercase tracking-wide text-gray-400">{{ workshop.get_workshop_type_display }}</p>
                <h1 class="text-2xl font-bold text-gray-900">{{ workshop.title }}</h1>
                <p class="text-gray-600">{{ workshop.description }}</p>
            </header>

            <div id="autosave-status" class="flex items-center gap-2 text-sm text-gray-500">
                <span class="inline-flex w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
                Changes auto-save while you type. Submit once you're confident with your responses.
            </div>

            <form id="workshop-response-form"
                  method="post"
                  hx-post="{% url 'mana:participant_workshop_detail' assessment.id workshop.workshop_type %}"
                  hx-trigger="change delay:1200ms, keyup changed delay:1200ms from:.hx-field"
                  hx-target="#autosave-status"
                  hx-swap="outerHTML swap:200ms"
                  hx-include="#workshop-response-form"
                  hx-sync="closest form:queue">
                {% csrf_token %}
                <div class="space-y-6">
                    {% for pair in question_field_pairs %}
                        {% with question=pair.question field=pair.field %}
                            {% if question.type == 'repeater' or question.type == 'structured' %}
                                {% include "mana/participant/partials/question_dynamic.html" with question=question field=field %}
                            {% else %}
                                <div class="bg-neutral-50 border border-gray-100 rounded-2xl p-6">
                                    {% include "components/form_field.html" with field=field label=field.label placeholder=field.help_text %}
                                </div>
                            {% endif %}
                        {% endwith %}
                    {% endfor %}
                </div>

                <div class="flex flex-wrap items-center justify-between gap-3 mt-8">
                    <button type="submit"
                            name="action"
                            value="save_draft"
                            class="inline-flex items-center gap-2 px-5 py-3 rounded-xl border border-gray-200 text-sm font-medium text-gray-600 hover:bg-gray-100 transition">
                        <i class="fas fa-save"></i>
                        Save Draft
                    </button>
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-gray-400">Submitting will lock this workshop and unlock the next session.</span>
                        <button type="submit"
                                name="action"
                                value="submit"
                                class="btn-primary px-6 py-3 rounded-xl text-white font-semibold shadow-lg hover:shadow-xl transition">
                            <i class="fas fa-paper-plane mr-2"></i> Submit Workshop
                        </button>
                    </div>
                </div>
            </form>
        </main>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super }}
<script>
(function() {
    const structuredConfig = new Map();

    document.querySelectorAll('script[id^="question-config-"]').forEach((scriptEl) => {
        try {
            const questionId = scriptEl.id.replace('question-config-', '');
            structuredConfig.set(questionId, JSON.parse(scriptEl.textContent));
        } catch (error) {
            console.warn('Unable to parse workshop question schema', error);
        }
    });

    function syncStructured(container, storage, fields) {
        const payload = {};
        fields.forEach((field) => {
            const input = container.querySelector(`[data-structured-input="${field.name}"]`);
            if (!input) { return; }
            if (field.type === 'number') {
                payload[field.name] = input.value ? Number(input.value) : null;
            } else {
                payload[field.name] = input.value;
            }
        });
        storage.value = JSON.stringify(payload);
    }

    function syncRepeater(container, storage, fields) {
        const rows = container.querySelectorAll('[data-repeater-row]');
        const payload = [];
        rows.forEach((row) => {
            const rowData = {};
            fields.forEach((field) => {
                const input = row.querySelector(`[data-repeater-input="${field.name}"]`);
                if (!input) { return; }
                if (field.type === 'number') {
                    rowData[field.name] = input.value ? Number(input.value) : null;
                } else {
                    rowData[field.name] = input.value;
                }
            });
            payload.push(rowData);
        });
        storage.value = JSON.stringify(payload);
    }

    document.querySelectorAll('[data-structured-field]').forEach((container) => {
        const storage = container.querySelector('[data-repeater-storage]');
        const questionId = container.dataset.questionId;
        const config = structuredConfig.get(questionId) || {};
        const fields = config.fields || [];

        const existing = storage.value ? JSON.parse(storage.value) : {};
        fields.forEach((field) => {
            const input = container.querySelector(`[data-structured-input="${field.name}"]`);
            if (input && existing[field.name] !== undefined) {
                input.value = existing[field.name];
            }
        });

        const sync = () => syncStructured(container, storage, fields);
        container.addEventListener('change', sync);
        container.addEventListener('input', sync);
        sync();
    });

    document.querySelectorAll('[data-repeater-field]').forEach((container) => {
        const storage = container.querySelector('[data-repeater-storage]');
        const questionId = container.dataset.questionId;
        const config = structuredConfig.get(questionId) || {};
        const fields = config.fields || [];
        const list = container.querySelector('[data-repeater-items]');

        function createRow(initial = {}) {
            const row = document.createElement('div');
            row.className = 'grid gap-3 md:grid-cols-' + Math.max(1, fields.length) + ' bg-white border border-gray-100 rounded-2xl p-4 relative';
            row.setAttribute('data-repeater-row', 'true');

            fields.forEach((field) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex flex-col gap-2';
                const label = document.createElement('span');
                label.className = 'text-xs uppercase tracking-wide text-gray-500';
                label.innerText = field.label || field.name;
                wrapper.appendChild(label);

                let input;
                if (field.type === 'select' && Array.isArray(field.options)) {
                    input = document.createElement('select');
                    input.className = 'px-4 py-2 rounded-lg border border-gray-200 focus:ring-emerald-500 focus:border-emerald-500 text-sm bg-white';
                    const placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.textContent = 'Select option';
                    input.appendChild(placeholder);
                    field.options.forEach((option) => {
                        const opt = document.createElement('option');
                        if (typeof option === 'object') {
                            opt.value = option.value;
                            opt.textContent = option.label || option.value;
                        } else {
                            opt.value = option;
                            opt.textContent = option;
                        }
                        input.appendChild(opt);
                    });
                    input.value = initial[field.name] || '';
                } else {
                    input = document.createElement('input');
                    input.type = field.type === 'number' ? 'number' : 'text';
                    input.className = 'px-4 py-2 rounded-lg border border-gray-200 focus:ring-emerald-500 focus:border-emerald-500 text-sm';
                    input.value = initial[field.name] || '';
                    if (field.min !== undefined) {
                        input.min = field.min;
                    }
                    if (field.max !== undefined) {
                        input.max = field.max;
                    }
                }
                input.setAttribute('data-repeater-input', field.name);
                wrapper.appendChild(input);
                row.appendChild(wrapper);
            });

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'absolute top-3 right-3 text-xs text-rose-500 hover:text-rose-600';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.addEventListener('click', () => {
                row.remove();
                syncRepeater(container, storage, fields);
            });
            row.appendChild(removeBtn);
            list.appendChild(row);
        }

        const initial = storage.value ? JSON.parse(storage.value) : [];
        if (Array.isArray(initial) && initial.length) {
            initial.forEach((item) => createRow(item));
        } else {
            createRow();
        }

        container.querySelector('[data-repeater-add]').addEventListener('click', (event) => {
            event.preventDefault();
            createRow();
            syncRepeater(container, storage, fields);
        });

        const sync = () => syncRepeater(container, storage, fields);
        container.addEventListener('input', sync);
        container.addEventListener('change', sync);
        sync();
    });
})();
</script>
{% endblock %}
