{% extends 'base.html' %}
{% block title %}Regional MANA Overview{% endblock %}

{% block breadcrumb %}
<li>
    <a href="{% url 'common:dashboard' %}" class="text-neutral-500 hover:text-neutral-700">Dashboard</a>
</li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li>
    <a href="{% url 'common:mana_home' %}" class="text-neutral-500 hover:text-neutral-700">MANA</a>
</li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li class="text-neutral-800 font-semibold">Regional MANA</li>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-8">
    <header class="space-y-2">
        <h1 class="text-3xl font-bold text-gray-900">Regional MANA</h1>
        <p class="text-lg text-gray-600 max-w-3xl">
            Monitor Mapping and Needs Assessment (MANA) activity across regions and launch the tools needed to execute upcoming deployments.
        </p>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <article class="relative overflow-hidden bg-gradient-to-br from-blue-500 via-blue-600 to-blue-700 rounded-xl shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300">
            <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent"></div>
            <div class="relative p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm font-medium">Total Assessments</p>
                        <p class="text-3xl font-bold">{{ global_stats.total_assessments|default:0 }}</p>
                        <p class="mt-1 text-xs text-blue-100/80">Completed: {{ global_stats.completed|default:0 }} • In progress: {{ global_stats.in_progress|default:0 }}</p>
                    </div>
                    <div class="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
                        <i class="fas fa-map-marked-alt text-2xl"></i>
                    </div>
                </div>
            </div>
        </article>
        <article class="relative overflow-hidden bg-gradient-to-br from-emerald-500 via-emerald-600 to-emerald-700 rounded-xl shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300">
            <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent"></div>
            <div class="relative p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-emerald-100 text-sm font-medium">Planning & Reporting</p>
                        <p class="text-3xl font-bold">{{ global_stats.planning|default:0 }}</p>
                        <p class="mt-1 text-xs text-emerald-100/80">Reporting: {{ global_stats.reporting|default:0 }}</p>
                    </div>
                    <div class="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
                        <i class="fas fa-project-diagram text-2xl"></i>
                    </div>
                </div>
            </div>
        </article>
        <article class="relative overflow-hidden bg-gradient-to-br from-purple-500 via-purple-600 to-purple-700 rounded-xl shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300">
            <div class="absolute inset-0 bg-gradient-to-br from.white/10 to-transparent"></div>
            <div class="relative p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-100 text-sm font-medium">Needs Logged</p>
                        <p class="text-3xl font-bold">{{ global_stats.needs_identified|default:0 }}</p>
                        <p class="mt-1 text-xs text-purple-100/80">Validated: {{ global_stats.needs_validated|default:0 }}</p>
                    </div>
                    <div class="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
                        <i class="fas fa-hands-helping text-2xl"></i>
                    </div>
                </div>
            </div>
        </article>
        <article class="relative overflow-hidden bg-gradient-to-br from-amber-500 via-amber-600 to-amber-700 rounded-xl shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition-all.duration-300">
            <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent"></div>
            <div class="relative p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-amber-100 text-sm font-medium">Reports</p>
                        <p class="text-3xl font-bold">{{ reports_summary.total|default:0 }}</p>
                        <p class="mt-1 text-xs text-amber-100/80">Final/Sub: {{ reports_summary.finalized|default:0 }} • Validation: {{ reports_summary.validation|default:0 }}</p>
                    </div>
                    <div class="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
                        <i class="fas fa-file-alt text-2xl"></i>
                    </div>
                </div>
            </div>
        </article>
    </section>



<!-- Regional Workshop Setup Form - Only show if NO assessments exist -->
{% if not regional_workshop_assessments %}
<section class="bg-white rounded-xl shadow-xl border border-gray-200 mb-8">
    <div class="p-6 lg:p-8">
        <!-- Setup Form Header -->
        <div class="flex items-center mb-6">
            <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center mr-4">
                <i class="fas fa-rocket text-white text-xl"></i>
            </div>
            <div>
                <h2 class="text-2xl font-bold text-gray-900">Initialize Regional Workshop</h2>
                <p class="mt-1 text-sm text-gray-600">Create a new regional assessment to start capturing the 5 mandated workshop responses.</p>
            </div>
        </div>

        <!-- Setup Form -->
        <div class="bg-gray-50 rounded-lg p-6">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="form_name" value="regional_setup">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% for field in regional_setup_form.visible_fields %}
                        <div class="{% if field.name == 'objectives' or field.name == 'description' %}md:col-span-2{% endif %}">
                            {% include "components/form_field.html" with field=field label=field.label %}
                        </div>
                    {% endfor %}
                </div>

                <div class="flex items-center justify-end pt-6 border-t border-gray-200 mt-6">
                    <button type="submit" class="inline-flex items-center gap-2 px-6 py-3 rounded-lg bg-green-600 text-white text-base font-semibold hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200 shadow-sm">
                        <i class="fas fa-rocket"></i>
                        <span>Initialize Regional Workshop</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>
{% endif %}

<!-- Regional Workshop Forms -->
<section class="bg-white rounded-xl shadow-xl border border-gray-200 mb-8">
    <div class="p-6 lg:p-8">
        <!-- Form Header matching Barangay OBC style -->
        <div class="flex items-center mb-6">
            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-4">
                <i class="fas fa-clipboard-list text-white text-xl"></i>
            </div>
            <div class="flex-1">
                <h2 class="text-2xl font-bold text-gray-900">Regional Workshop Forms</h2>
                <p class="mt-1 text-sm text-gray-600">Complete the 5 mandated workshops for regional MANA assessment. Each tab contains specific prompts and captures responses.</p>
            </div>
            {% if regional_workshop_assessments %}
            <form method="get" class="flex flex-col md:flex-row md:items-center gap-3">
                <label for="regional_assessment_select" class="text-sm font-semibold text-gray-700">Regional Assessment</label>
                <select id="regional_assessment_select" name="assessment" class="block w-full md:w-80 py-3 px-4 text-base rounded-lg border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 min-h-[48px] transition-all duration-200" onchange="this.form.submit()">
                    <option value="">-- Select an assessment --</option>
                    {% for assessment in regional_workshop_assessments %}
                    <option value="{{ assessment.id }}" {% if selected_assessment and assessment.id == selected_assessment.id %}selected{% endif %}>
                        {{ assessment.title }} •
                        {% if assessment.community %}
                            {{ assessment.community.barangay.name }}, {{ assessment.community.barangay.municipality.name }}
                        {% elif assessment.province %}
                            {{ assessment.province.name }} ({{ assessment.province.region.name }})
                        {% else %}
                            Coverage pending assignment
                        {% endif %}
                        — {{ assessment.planned_start_date|date:'M d, Y' }}
                    </option>
                    {% endfor %}
                </select>
                {% if active_workshop_tab %}
                <input type="hidden" name="active_tab" value="{{ active_workshop_tab }}">
                {% endif %}
            </form>
            {% endif %}
        </div>

        {% if selected_assessment %}
        <!-- Tab Navigation matching Barangay OBC style -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-8" aria-label="Workshops">
                {% for item in workshop_forms %}
                <button type="button" onclick="showWorkshopTab('{{ item.type }}')" id="{{ item.type }}-tab" class="workshop-tab-button border-b-2 {% if item.type == active_workshop_tab %}border-blue-500 text-blue-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} py-2 px-1 text-sm font-medium transition-colors">
                    <i class="fas fa-{{ forloop.counter }} mr-2"></i>Workshop {{ forloop.counter }}
                    {% if item.completed %}
                        <i class="fas fa-check-circle text-green-500 ml-2"></i>
                    {% endif %}
                </button>
                {% endfor %}
            </nav>
        </div>

        <!-- Workshop Content -->
        <div class="space-y-6">
            {% for item in workshop_forms %}
            <div id="{{ item.type }}-content" class="workshop-tab-pane {% if item.type != active_workshop_tab %}hidden{% endif %}">
                {% if item.form %}
                <form method="post" class="workshop-form space-y-6">
                    {% csrf_token %}
                    <input type="hidden" name="workshop_id" value="{{ item.activity.id }}">
                    <input type="hidden" name="assessment" value="{{ selected_assessment.id }}">
                    <input type="hidden" name="active_tab" value="{{ item.type }}">

                    <!-- Workshop Header -->
                    <div class="bg-blue-50 rounded-lg p-6 border border-blue-200">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="text-xl font-semibold text-blue-900 mb-2">{{ item.activity.title|default:item.label }}</h3>
                                <p class="text-sm text-blue-700">
                                    {% if item.completed %}
                                        ✅ This workshop has been completed. You can update the responses below if needed.
                                    {% else %}
                                        📝 Complete the prompts below to document this workshop's findings and recommendations.
                                    {% endif %}
                                </p>
                            </div>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold {% if item.completed %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {% if item.completed %}Completed{% else %}In Progress{% endif %}
                            </span>
                        </div>
                    </div>

                    <!-- Workshop Details Section -->
                    {% if item.general_fields %}
                    <div class="bg-gray-50 rounded-lg p-6 space-y-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                            <i class="fas fa-cog text-blue-500"></i>
                            Workshop Details
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {% for field in item.form.visible_fields %}
                                {% if field.name in item.general_fields %}
                                    {% include "components/form_field.html" with field=field label=field.label %}
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Workshop Prompts Section -->
                    {% if item.question_fields %}
                    <div class="bg-gray-50 rounded-lg p-6 space-y-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                            <i class="fas fa-question-circle text-blue-500"></i>
                            Workshop Prompts & Responses
                        </h4>
                        <div class="space-y-6">
                            {% for field in item.form.visible_fields %}
                                {% if field.name in item.question_fields %}
                                    <div class="bg-white border border-gray-200 rounded-lg p-5">
                                        {% include "components/form_field.html" with field=field label=field.label %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Synthesis Section -->
                    {% if item.synthesis_fields %}
                    <div class="bg-gray-50 rounded-lg p-6 space-y-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                            <i class="fas fa-lightbulb text-blue-500"></i>
                            Key Findings & Recommendations
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {% for field in item.form.visible_fields %}
                                {% if field.name in item.synthesis_fields %}
                                    {% include "components/form_field.html" with field=field label=field.label %}
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Submit Button -->
                    <div class="flex items-center justify-end pt-6 border-t border-gray-200">
                        <button type="submit" class="inline-flex items-center gap-2 px-6 py-3 rounded-lg bg-blue-600 text-white text-base font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 shadow-sm">
                            <i class="fas fa-save"></i>
                            <span>Save Workshop {{ forloop.counter }}</span>
                        </button>
                    </div>
                </form>
                {% else %}
                <!-- Preview Mode -->
                <div class="bg-gray-50 rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">{{ item.label }}</h3>
                    <div class="space-y-4">
                        {% for prompt in item.question_prompts %}
                        <div class="p-4 border border-dashed border-gray-300 rounded-lg bg-white">
                            <p class="text-sm font-semibold text-gray-700 mb-2">{{ prompt.label }}</p>
                            <p class="text-xs text-gray-500">Response will be captured here once you initialize a regional assessment.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- Assessment Selection Required State -->
        <div class="p-12 text-center">
            <div class="max-w-md mx-auto">
                <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-hand-pointer text-2xl text-blue-500"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Select an Assessment</h3>
                <p class="text-sm text-gray-600 mb-6">
                    Choose a regional assessment from the dropdown above to start working on the workshop forms.
                </p>
                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <button onclick="document.getElementById('regional_assessment_select').focus()" class="inline-flex items-center gap-2 rounded-lg bg-blue-600 text-white text-sm font-semibold px-4 py-2 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200">
                        <i class="fas fa-arrow-up"></i>
                        <span>Use Dropdown Above</span>
                    </button>
                    <a href="{% url 'common:mana_new_assessment' %}?assessment_level=regional&primary_methodology=workshop" class="inline-flex items-center gap-2 rounded-lg bg-green-600 text-white text-sm font-semibold px-4 py-2 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200">
                        <i class="fas fa-plus"></i>
                        <span>Create New Assessment</span>
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</section>



    <section class="bg-white rounded-lg shadow-lg border border-gray-200">
        <div class="p-6 border-b border-gray-100">
            <h2 class="text-xl font-semibold text-gray-900">Quick Actions</h2>
            <p class="mt-1 text-sm text-gray-600">Launch planning, logging, processing, or open the detailed MANA playbook.</p>
        </div>
        <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <a href="{% url 'common:mana_activity_planner' %}" class="group bg-white rounded-lg shadow-lg border border-gray-200 hover-lift transition-all.duration-200">
                <div class="p-6">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-calendar-plus text-white text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 group-hover:text-blue-600 transition-colors">Plan MANA Activity</h3>
                    <p class="mt-2 text-sm text-gray-600">Build activity plans, secure approvals, and organise logistics guided by OOBC standards.</p>
                    <div class="mt-4 flex items-center text-blue-600 text-sm font-medium">
                        <span>Open Planner</span>
                        <i class="fas fa-arrow-right ml-2 transform group-hover:translate-x-1 transition-transform"></i>
                    </div>
                </div>
            </a>
            <a href="{% url 'common:mana_activity_log' %}" class="group bg-white rounded-lg shadow-lg border border-gray-200 hover-lift transition-all.duration-200">
                <div class="p-6">
                    <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-clipboard-check text-white text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 group-hover:text-emerald-600 transition-colors">Log Daily Activities</h3>
                    <p class="mt-2 text-sm text-gray-600">Capture attendance, workshop outputs, issues, and action points per field day.</p>
                    <div class="mt-4 flex items-center text-emerald-600 text-sm font-medium">
                        <span>Open Activity Log</span>
                        <i class="fas fa-arrow-right ml-2 transform group-hover:translate-x-1 transition-transform"></i>
                    </div>
                </div>
            </a>
            <a href="{% url 'common:mana_activity_processing' %}" class="group bg-white rounded-lg shadow-lg border border-gray-200 hover-lift transition-all.duration-200">
                <div class="p-6">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-chart-line text-white text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 group-hover:text-purple-600 transition-colors">Process Outputs</h3>
                    <p class="mt-2 text-sm text-gray-600">Compile datasets, draft reports, and set MEL follow-through after deployment.</p>
                    <div class="mt-4.flex items-center text-purple-600 text-sm font-medium">
                        <span>Open Processing Hub</span>
                        <i class="fas fa-arrow-right ml-2 transform group-hover:translate-x-1 transition-transform"></i>
                    </div>
                </div>
            </a>
            <a href="{% url 'common:mana_playbook' %}" class="group bg-white rounded-lg shadow-lg border border-gray-200 hover-lift transition-all.duration-200">
                <div class="p-6">
                    <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-amber-600 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-route text-white text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 group-hover:text-amber-600 transition-colors">MANA Playbook</h3>
                    <p class="mt-2 text-sm text-gray-600">Review the full step-by-step guide for regional MANA implementation.</p>
                    <div class="mt-4 flex items-center text-amber-600 text-sm font-medium">
                        <span>View Playbook</span>
                        <i class="fas fa-arrow-right ml-2 transform group-hover:translate-x-1 transition-transform"></i>
                    </div>
                </div>
            </a>
        </div>
    </section>
</div>

{{ location_data|json_script:"location-data" }}
<script>
// Workshop tab functionality matching Barangay OBC Form style
function showWorkshopTab(tabId) {
    // Hide all tab content
    const allTabPanes = document.querySelectorAll('.workshop-tab-pane');
    allTabPanes.forEach(pane => pane.classList.add('hidden'));

    // Remove active state from all tab buttons
    const allTabButtons = document.querySelectorAll('.workshop-tab-button');
    allTabButtons.forEach(button => {
        button.classList.remove('border-blue-500', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-500');
    });

    // Show the selected tab content
    const activeTabPane = document.getElementById(tabId + '-content');
    if (activeTabPane) {
        activeTabPane.classList.remove('hidden');
    }

    // Add active state to the selected tab button
    const activeTabButton = document.getElementById(tabId + '-tab');
    if (activeTabButton) {
        activeTabButton.classList.remove('border-transparent', 'text-gray-500');
        activeTabButton.classList.add('border-blue-500', 'text-blue-600');
    }

    // Update hidden inputs
    const hiddenInputs = document.querySelectorAll('input[name="active_tab"]');
    hiddenInputs.forEach(input => {
        input.value = tabId;
    });
}

// Initialize tabs when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Check if we have workshop forms
    const workshopForms = document.querySelectorAll('.workshop-tab-pane');
    if (workshopForms.length > 0) {
        // Get the active tab from the template context or default to first tab
        const activeTab = '{{ active_workshop_tab }}' || 'workshop_1';
        showWorkshopTab(activeTab);
    }

    // Cascading location selection for Regional Workshop Setup Form
    const dataElement = document.getElementById('location-data');
    if (!dataElement) {
        return;
    }

    let locationData;
    try {
        locationData = JSON.parse(dataElement.textContent);
    } catch (error) {
        console.error('Unable to parse location data.', error);
        return;
    }

    const regionSelect = document.querySelector('select[name="region"]');
    const provinceSelect = document.querySelector('select[name="province"]');

    if (!regionSelect || !provinceSelect) {
        return;
    }

    // Build province lookup by region
    const provincesByRegion = new Map();
    (locationData.provinces || []).forEach(province => {
        const key = String(province.region_id);
        if (!provincesByRegion.has(key)) {
            provincesByRegion.set(key, []);
        }
        provincesByRegion.get(key).push(province);
    });

    // Populate province dropdown based on selected region
    const populateProvinces = (regionId, preserveValue) => {
        const normalizedId = regionId ? String(regionId) : "";
        const filtered = normalizedId
            ? (provincesByRegion.get(normalizedId) || [])
            : (locationData.provinces || []);

        const previousValue = preserveValue || provinceSelect.value || "";

        provinceSelect.innerHTML = "";
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "---------";
        provinceSelect.appendChild(defaultOption);

        filtered.forEach((province) => {
            const opt = document.createElement("option");
            opt.value = province.id;
            opt.textContent = province.name;
            provinceSelect.appendChild(opt);
        });

        // Restore previously selected value if it's still valid
        if (previousValue && filtered.some((p) => String(p.id) === String(previousValue))) {
            provinceSelect.value = previousValue;
        }
    };

    // Initialize province dropdown on page load
    const initialRegion = regionSelect.value || "";
    const initialProvince = provinceSelect.dataset.initial || provinceSelect.value || "";
    populateProvinces(initialRegion, initialProvince);

    // Update provinces when region changes
    regionSelect.addEventListener('change', () => {
        populateProvinces(regionSelect.value, '');
    });
});
</script>
{% endblock %}
