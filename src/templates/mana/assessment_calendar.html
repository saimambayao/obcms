{% extends 'base.html' %}
{% load static %}

{% block title %}{{ assessment.title }} Â· Calendar{% endblock %}

{% block breadcrumb %}
<li>
    <a href="{% url 'common:dashboard' %}" class="text-neutral-500 hover:text-neutral-700">Dashboard</a>
</li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li>
    <a href="{% url 'common:mana_home' %}" class="text-neutral-500 hover:text-neutral-700">MANA</a>
</li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li>
    <a href="{% url 'common:mana_assessment_detail' assessment.id %}" class="text-neutral-500 hover:text-neutral-700">{{ assessment.title|truncatechars:30 }}</a>
</li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li class="text-neutral-800 font-semibold">Calendar</li>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">
    <!-- Header -->
    <header class="bg-white rounded-2xl shadow-xl border border-gray-200 p-6 flex flex-col md:flex-row gap-6 md:items-start">
        <div class="flex-1">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white text-xl">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 leading-tight">Assessment Calendar</h1>
                    <p class="text-sm text-gray-600">{{ assessment.title }}</p>
                </div>
            </div>
            <div class="flex flex-wrap gap-2 mt-3">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">
                    <i class="fas fa-flag mr-1"></i>
                    Milestones
                </span>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                    <i class="fas fa-tasks mr-1"></i>
                    Tasks
                </span>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-orange-100 text-orange-800">
                    <i class="fas fa-calendar-check mr-1"></i>
                    Events
                </span>
            </div>
        </div>
        <div class="flex flex-col sm:flex-row gap-3">
            <a href="{% url 'common:mana_assessment_detail' assessment.id %}"
               class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-lg border border-gray-300 text-gray-700 text-sm font-semibold hover:bg-gray-50 transition-all duration-200">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Assessment</span>
            </a>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white rounded-xl border border-gray-200 shadow-sm px-6 py-4">
        <div class="flex items-center gap-4 overflow-x-auto">
            <a href="{% url 'mana:mana_assessment_tasks_board' assessment.id %}"
               class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-gray-700 text-sm font-semibold hover:bg-gray-100 transition-colors">
                <i class="fas fa-tasks"></i>
                <span>Task Board</span>
            </a>
            <a href="{% url 'mana:mana_assessment_calendar' assessment.id %}"
               class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-100 text-blue-700 text-sm font-semibold">
                <i class="fas fa-calendar-alt"></i>
                <span>Calendar</span>
            </a>
        </div>
    </nav>

    <!-- Legend -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
        <div class="flex items-center gap-6 flex-wrap">
            <h3 class="text-sm font-semibold text-gray-700">Legend:</h3>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                <span class="text-sm text-gray-600">Milestones (Phase completions)</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-green-500"></div>
                <span class="text-sm text-gray-600">Tasks (Due dates)</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                <span class="text-sm text-gray-600">Events (Workshops, consultations)</span>
            </div>
        </div>
    </div>

    <!-- Calendar Container -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
        <div id="assessment-calendar"></div>
    </div>
</div>

<!-- Event Modal Container -->
<div id="event-modal-container" class="fixed inset-0 hidden z-50 flex items-center justify-center px-4 sm:px-6" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-gray-900 bg-opacity-50" onclick="document.getElementById('event-modal-container').classList.add('hidden');"></div>
    <div class="relative max-h-[90vh] w-full max-w-2xl overflow-y-auto bg-white rounded-2xl shadow-2xl p-6">
        <div class="flex items-start justify-between mb-4">
            <h2 class="text-2xl font-bold text-gray-900" id="modal-event-title">Event Details</h2>
            <button onclick="document.getElementById('event-modal-container').classList.add('hidden');"
                    class="text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div id="modal-event-content" class="space-y-4">
            <!-- Event content will be dynamically loaded here -->
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'common/vendor/fullcalendar/main.min.css' %}">
<style>
    /* FullCalendar Custom Styling */
    .fc {
        font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, sans-serif;
    }

    .fc-event {
        cursor: pointer;
        border-radius: 4px;
        padding: 2px 4px;
        font-size: 0.875rem;
    }

    .fc-event:hover {
        opacity: 0.9;
    }

    .fc-daygrid-day-number {
        font-weight: 500;
    }

    .fc-col-header-cell-cushion {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
    }

    .fc-button {
        border-radius: 0.5rem !important;
        font-weight: 600 !important;
        text-transform: capitalize !important;
    }

    .fc-button-primary {
        background-color: #3b82f6 !important;
        border-color: #3b82f6 !important;
    }

    .fc-button-primary:hover:not(:disabled) {
        background-color: #2563eb !important;
        border-color: #2563eb !important;
    }

    .fc-toolbar-title {
        font-size: 1.5rem !important;
        font-weight: 700 !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'common/vendor/fullcalendar/index.global.min.js' %}"></script>
<script>
(function() {
    'use strict';

    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('assessment-calendar');

        if (!calendarEl) {
            console.error('Calendar element not found');
            return;
        }

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            buttonText: {
                today: 'Today',
                month: 'Month',
                week: 'Week',
                list: 'List'
            },
            height: 'auto',
            eventSources: [
                {
                    url: '{% url "mana:mana_assessment_calendar_feed" assessment.id %}',
                    failure: function(error) {
                        console.error('Error loading events:', error);
                        alert('Failed to load calendar events. Please refresh the page.');
                    }
                }
            ],
            eventClick: function(info) {
                // Prevent default navigation
                info.jsEvent.preventDefault();

                // Get event data
                const event = info.event;
                const eventData = {
                    id: event.id,
                    title: event.title,
                    start: event.start,
                    end: event.end,
                    allDay: event.allDay,
                    type: event.extendedProps.type || 'unknown',
                    editable: event.extendedProps.editable !== false
                };

                // Show modal with event details
                showEventModal(eventData);
            },
            eventDidMount: function(info) {
                // Add custom tooltips
                const tooltip = document.createElement('div');
                tooltip.className = 'hidden absolute z-50 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 shadow-xl';
                tooltip.textContent = info.event.title;

                info.el.addEventListener('mouseenter', function() {
                    document.body.appendChild(tooltip);
                    const rect = info.el.getBoundingClientRect();
                    tooltip.style.left = rect.left + 'px';
                    tooltip.style.top = (rect.bottom + 5) + 'px';
                    tooltip.classList.remove('hidden');
                });

                info.el.addEventListener('mouseleave', function() {
                    tooltip.classList.add('hidden');
                    if (tooltip.parentNode) {
                        tooltip.parentNode.removeChild(tooltip);
                    }
                });
            },
            eventDrop: function(info) {
                // Handle drag-and-drop reschedule
                if (!info.event.extendedProps.editable) {
                    info.revert();
                    alert('This event cannot be rescheduled.');
                    return;
                }

                // Update task due date on server
                if (info.event.extendedProps.type === 'task') {
                    updateTaskDueDate(info.event.id, info.event.start);
                } else {
                    info.revert();
                    alert('Only tasks can be rescheduled via drag-and-drop.');
                }
            },
            editable: true,
            droppable: false,
            navLinks: true,
            dayMaxEvents: 3,
            moreLinkClick: 'popover',
            nowIndicator: true
        });

        calendar.render();

        // Show event modal
        function showEventModal(eventData) {
            const modal = document.getElementById('event-modal-container');
            const titleEl = document.getElementById('modal-event-title');
            const contentEl = document.getElementById('modal-event-content');

            titleEl.textContent = eventData.title;

            let content = '';
            const startDate = new Date(eventData.start);
            const endDate = eventData.end ? new Date(eventData.end) : null;

            // Format dates
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit' };

            let dateString = startDate.toLocaleDateString('en-US', dateOptions);
            if (!eventData.allDay) {
                dateString += ' at ' + startDate.toLocaleTimeString('en-US', timeOptions);
            }
            if (endDate && endDate.getTime() !== startDate.getTime()) {
                dateString += ' - ' + (eventData.allDay ? endDate.toLocaleDateString('en-US', dateOptions) : endDate.toLocaleTimeString('en-US', timeOptions));
            }

            // Build content based on event type
            if (eventData.type === 'milestone') {
                content = `
                    <div class="space-y-4">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-flag text-blue-500 text-lg"></i>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">Milestone</span>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 font-semibold">Date</p>
                            <p class="text-base text-gray-900">${dateString}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">This milestone marks the completion of a key assessment phase.</p>
                        </div>
                    </div>
                `;
            } else if (eventData.type === 'task') {
                content = `
                    <div class="space-y-4">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-tasks text-green-500 text-lg"></i>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">Task</span>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 font-semibold">Due Date</p>
                            <p class="text-base text-gray-900">${dateString}</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="window.location.href='/oobc-management/staff/tasks/${eventData.id}/';"
                                    class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors">
                                <i class="fas fa-eye"></i>
                                View Task
                            </button>
                        </div>
                    </div>
                `;
            } else if (eventData.type === 'event') {
                content = `
                    <div class="space-y-4">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-calendar-check text-orange-500 text-lg"></i>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-orange-100 text-orange-800">Event</span>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 font-semibold">Date & Time</p>
                            <p class="text-base text-gray-900">${dateString}</p>
                        </div>
                    </div>
                `;
            }

            contentEl.innerHTML = content;
            modal.classList.remove('hidden');
        }

        // Update task due date
        function updateTaskDueDate(taskId, newDate) {
            const formattedDate = newDate.toISOString().split('T')[0];

            fetch(`/oobc-management/staff/tasks/${taskId}/update-field/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    field: 'due_date',
                    value: formattedDate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Task due date updated successfully');
                } else {
                    alert('Failed to update task: ' + (data.error || 'Unknown error'));
                    calendar.refetchEvents();
                }
            })
            .catch(error => {
                console.error('Error updating task:', error);
                alert('Failed to update task. Please try again.');
                calendar.refetchEvents();
            });
        }

        // Cookie helper
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                return parts.pop().split(';').shift();
            }
            return null;
        }
    });
})();
</script>
{% endblock %}
