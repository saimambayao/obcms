{% extends "project_central/base.html" %}
{% load static humanize %}

{% block title %}Portfolio Dashboard - PPA Management{% endblock %}

{% block project_central_content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
    <section class="relative overflow-hidden rounded-3xl border border-emerald-200/60 bg-gradient-to-r from-emerald-600 via-teal-500 to-sky-500 text-white shadow-xl">
        <div class="absolute inset-0 bg-white/10 opacity-20 mix-blend-overlay"></div>
        <div class="relative px-6 sm:px-10 py-8 sm:py-10 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-8">
            <div class="space-y-4 max-w-2xl">
                <div class="inline-flex items-center rounded-full bg-white/15 px-3 py-1 text-sm font-semibold backdrop-blur">
                    <i class="fa-solid fa-chart-simple mr-2"></i>
                    PPA Management
                </div>
                <h1 class="text-3xl sm:text-4xl font-semibold leading-tight">
                    Integrated project lifecycle, budget, and alert monitoring for FY {{ current_year }}
                </h1>
                <p class="text-white/80 text-base sm:text-lg">
                    Track how community needs mature into funded PPAs, see where budgets concentrate, and respond to system alerts without leaving PPA Management.
                </p>
            </div>
            <div class="w-full max-w-sm">
                <div class="rounded-2xl bg-white/10 backdrop-blur-sm border border-white/20 p-6 shadow-lg">
                    <h2 class="text-sm font-semibold uppercase tracking-wide text-white/70 mb-3">Quick Snapshot</h2>
                    <dl class="space-y-3 text-white">
                        <div class="flex items-center justify-between text-sm">
                            <dt class="flex items-center gap-2"><i class="fa-solid fa-money-bill-wave"></i> Budget Allocation</dt>
                            <dd class="text-base font-semibold">₱{{ total_budget|default:0|floatformat:0|intcomma }}</dd>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <dt class="flex items-center gap-2"><i class="fa-solid fa-diagram-project"></i> Active PPAs</dt>
                            <dd class="text-base font-semibold">{{ active_projects|default:0|intcomma }}</dd>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <dt class="flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> Unfunded Needs</dt>
                            <dd class="text-base font-semibold">{{ unfunded_needs|default:0|intcomma }}</dd>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <dt class="flex items-center gap-2"><i class="fa-solid fa-circle-info"></i> Active Alerts</dt>
                            <dd class="text-base font-semibold">{{ recent_alerts|length }}</dd>
                        </div>
                    </dl>
                    <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <a href="{% url 'project_central:alert_list' %}"
                           class="inline-flex items-center justify-center rounded-xl bg-white text-emerald-600 font-semibold px-4 py-2.5 shadow hover:bg-emerald-50 transition-all duration-200">
                            <i class="fa-solid fa-bell mr-2"></i>
                            Review Alerts
                        </a>
                        <a href="{% url 'project_central:project_list' %}"
                           class="inline-flex items-center justify-center rounded-xl bg-emerald-500/70 hover:bg-emerald-500 text-white font-semibold px-4 py-2.5 transition-all duration-200">
                            <i class="fa-solid fa-route mr-2"></i>
                            View Workflows
                        </a>
                    </div>
                    <div class="mt-3">
                        <a href="{% url 'project_central:create_project_workflow' %}"
                           class="inline-flex items-center justify-center w-full rounded-xl bg-gradient-to-r from-blue-600 to-teal-500 text-white font-semibold px-4 py-2.5 shadow-lg hover:shadow-xl hover:from-blue-700 hover:to-teal-600 transition-all duration-200">
                            <i class="fa-solid fa-plus mr-2"></i>
                            Create New Workflow
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section>
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
            {% for card in summary_cards %}
            <article class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-[#FEFDFB] to-[#F8F5EE] transition-transform duration-300 hover:-translate-y-1"
                     style="box-shadow: 0 16px 35px rgba(20,85,80,0.12), 0 6px 12px rgba(20,85,80,0.08), inset 0 1px 0 rgba(255,255,255,0.7);">
                <div class="absolute inset-0 pointer-events-none bg-[radial-gradient(circle_at_top,rgba(255,255,255,0.85),transparent_60%)]"></div>
                <div class="relative p-6 flex flex-col gap-5 h-full">
                    <div class="flex items-start justify-between gap-4">
                        <div>
                            <p class="text-xs font-semibold uppercase tracking-wide text-gray-600">{{ card.title }}</p>
                            <p class="mt-3 text-3xl font-extrabold text-gray-900">
                                {% if card.value_type == 'currency' %}
                                    ₱{{ card.value|default:0|floatformat:0|intcomma }}
                                {% else %}
                                    {{ card.value|default:0|intcomma }}
                                {% endif %}
                            </p>
                            {% if card.subtitle %}
                            <p class="mt-2 text-sm text-gray-600">{{ card.subtitle }}</p>
                            {% endif %}
                        </div>
                        <span class="inline-flex h-14 w-14 items-center justify-center rounded-2xl bg-white shadow-inner">
                            <i class="fa-solid {{ card.icon }} text-2xl {{ card.icon_color|default:'text-emerald-600' }}"></i>
                        </span>
                    </div>
                    {% if card.pill %}
                    <span class="inline-flex items-center rounded-full bg-emerald-50 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-emerald-700">
                        {{ card.pill }}
                    </span>
                    {% endif %}
                </div>
            </article>
            {% endfor %}
        </div>
    </section>

    <section class="grid grid-cols-1 xl:grid-cols-3 gap-6">
        <div class="xl:col-span-2 rounded-2xl bg-white border border-gray-200 shadow-xl">
            <header class="px-6 py-5 border-b border-gray-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                        <i class="fa-solid fa-timeline text-emerald-600"></i>
                        Project Pipeline
                    </h2>
                    <p class="text-sm text-gray-500">Lifecycle stages from community identification through completion</p>
                </div>
                <a href="{% url 'project_central:project_list' %}"
                   class="inline-flex items-center gap-2 rounded-xl border border-emerald-200 bg-emerald-50 px-3 py-1.5 text-sm font-semibold text-emerald-700 hover:bg-emerald-100 transition-all duration-200">
                    Manage Workflows
                    <i class="fa-solid fa-arrow-right"></i>
                </a>
            </header>
            <div class="px-6 pt-4 pb-3 border-b border-gray-100">
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-xs font-medium text-gray-600">Quick Filter:</span>
                    <a href="{% url 'project_central:project_list' %}?stage=community_identification"
                       class="inline-flex items-center rounded-full bg-blue-50 px-3 py-1 text-xs font-semibold text-blue-700 hover:bg-blue-100 transition-colors">
                        <i class="fa-solid fa-users text-xs mr-1.5"></i>
                        Community ID
                    </a>
                    <a href="{% url 'project_central:project_list' %}?stage=needs_assessment"
                       class="inline-flex items-center rounded-full bg-purple-50 px-3 py-1 text-xs font-semibold text-purple-700 hover:bg-purple-100 transition-colors">
                        <i class="fa-solid fa-clipboard-list text-xs mr-1.5"></i>
                        Needs Assessment
                    </a>
                    <a href="{% url 'project_central:project_list' %}?stage=policy_recommendation"
                       class="inline-flex items-center rounded-full bg-amber-50 px-3 py-1 text-xs font-semibold text-amber-700 hover:bg-amber-100 transition-colors">
                        <i class="fa-solid fa-file-alt text-xs mr-1.5"></i>
                        Policy Rec
                    </a>
                    <a href="{% url 'project_central:project_list' %}?stage=budget_planning"
                       class="inline-flex items-center rounded-full bg-emerald-50 px-3 py-1 text-xs font-semibold text-emerald-700 hover:bg-emerald-100 transition-colors">
                        <i class="fa-solid fa-calculator text-xs mr-1.5"></i>
                        Budget Planning
                    </a>
                    <a href="{% url 'project_central:project_list' %}?stage=project_execution"
                       class="inline-flex items-center rounded-full bg-teal-50 px-3 py-1 text-xs font-semibold text-teal-700 hover:bg-teal-100 transition-colors">
                        <i class="fa-solid fa-rocket text-xs mr-1.5"></i>
                        Execution
                    </a>
                    <a href="{% url 'project_central:project_list' %}?stage=monitoring_evaluation"
                       class="inline-flex items-center rounded-full bg-cyan-50 px-3 py-1 text-xs font-semibold text-cyan-700 hover:bg-cyan-100 transition-colors">
                        <i class="fa-solid fa-chart-line text-xs mr-1.5"></i>
                        M&E
                    </a>
                    <a href="{% url 'project_central:project_list' %}?stage=completed"
                       class="inline-flex items-center rounded-full bg-gray-100 px-3 py-1 text-xs font-semibold text-gray-700 hover:bg-gray-200 transition-colors">
                        <i class="fa-solid fa-check-circle text-xs mr-1.5"></i>
                        Completed
                    </a>
                </div>
            </div>
            <div class="px-6 py-5 space-y-5">
                {% for step in pipeline_steps %}
                <div class="flex gap-4 items-start">
                    <div class="mt-1 flex h-12 w-12 items-center justify-center rounded-xl bg-emerald-50 text-emerald-600 shadow-sm">
                        <i class="fa-solid {{ step.icon }} text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-semibold text-gray-900">{{ step.label }}</p>
                            <p class="text-sm font-semibold text-gray-600">{{ step.count|default:0|intcomma }}</p>
                        </div>
                        <div class="mt-2 h-2.5 w-full overflow-hidden rounded-full bg-gray-200">
                            <div class="h-full rounded-full transition-all duration-300 {{ step.bar_class }}" style="width: {{ step.percentage }}%;"></div>
                        </div>
                        <p class="mt-2 text-xs text-gray-500">{{ step.description }}</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-sm text-gray-500">No pipeline data available yet.</p>
                {% endfor %}
            </div>
        </div>

        <aside class="rounded-2xl bg-white border border-gray-200 shadow-xl p-6 space-y-5">
            <header class="flex items-center gap-3">
                <div class="shrink-0 rounded-xl bg-emerald-100 text-emerald-600 p-3">
                    <i class="fa-solid fa-bolt text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Action Center</h3>
                    <p class="text-sm text-gray-500">Quick jumps into the most active modules</p>
                </div>
            </header>
            <ul class="space-y-3">
                <li>
                    <a href="{% url 'project_central:alert_list' %}"
                       class="group flex items-center justify-between rounded-xl border border-gray-100 bg-gray-50 px-4 py-3 text-sm font-semibold text-gray-700 hover:border-emerald-200 hover:bg-emerald-50 transition-all duration-200">
                        <div class="flex items-center gap-3">
                            <span class="flex h-9 w-9 items-center justify-center rounded-lg bg-rose-100 text-rose-600">
                                <i class="fa-solid fa-bell-exclamation"></i>
                            </span>
                            <div>
                                <p>Active alerts</p>
                                <p class="text-xs font-normal text-gray-500">{{ recent_alerts|length }} awaiting review</p>
                            </div>
                        </div>
                        <i class="fa-solid fa-arrow-right text-gray-400 group-hover:text-emerald-600"></i>
                    </a>
                </li>
                <li>
                    <a href="{% url 'project_central:project_list' %}"
                       class="group flex items-center justify-between rounded-xl border border-gray-100 bg-gray-50 px-4 py-3 text-sm font-semibold text-gray-700 hover:border-emerald-200 hover:bg-emerald-50 transition-all duration-200">
                        <div class="flex items-center gap-3">
                            <span class="flex h-9 w-9 items-center justify-center rounded-lg bg-emerald-100 text-emerald-600">
                                <i class="fa-solid fa-diagram-project"></i>
                            </span>
                            <div>
                                <p>Tracked workflows</p>
                                <p class="text-xs font-normal text-gray-500">{{ recent_workflows|length }} recent updates</p>
                            </div>
                        </div>
                        <i class="fa-solid fa-arrow-right text-gray-400 group-hover:text-emerald-600"></i>
                    </a>
                </li>
                <li>
                    <a href="{% url 'project_central:budget_approval_dashboard' %}"
                       class="group flex items-center justify-between rounded-xl border border-gray-100 bg-gray-50 px-4 py-3 text-sm font-semibold text-gray-700 hover:border-emerald-200 hover:bg-emerald-50 transition-all duration-200">
                        <div class="flex items-center gap-3">
                            <span class="flex h-9 w-9 items-center justify-center rounded-lg bg-blue-100 text-blue-600">
                                <i class="fa-solid fa-calculator"></i>
                            </span>
                            <div>
                                <p>Budget approvals</p>
                                <p class="text-xs font-normal text-gray-500">Check ceiling allocations and routes</p>
                            </div>
                        </div>
                        <i class="fa-solid fa-arrow-right text-gray-400 group-hover:text-emerald-600"></i>
                    </a>
                </li>
            </ul>
        </aside>
    </section>

    <section class="grid grid-cols-1 xl:grid-cols-2 gap-6">
        <article class="rounded-2xl bg-white border border-gray-200 shadow-xl p-6">
            <header class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Budget Allocation by Sector</h2>
                    <p class="text-sm text-gray-500">Identifying where FY {{ current_year }} funds concentrate</p>
                </div>
                <a href="{% url 'project_central:budget_planning_dashboard' %}"
                   class="inline-flex items-center gap-1 text-sm font-semibold text-emerald-600 hover:text-emerald-700 transition-colors">
                    View All Budgets
                    <i class="fa-solid fa-arrow-right text-xs"></i>
                </a>
            </header>
            {% if budget_by_sector %}
            <div class="mt-6" style="height: 280px;">
                <canvas id="sectorChart"></canvas>
            </div>
            {% else %}
            <div class="mt-6 flex flex-col items-center justify-center text-center text-sm text-gray-500" style="height: 280px;">
                <i class="fa-solid fa-chart-pie text-2xl mb-3 text-gray-400"></i>
                No budget records available yet.
            </div>
            {% endif %}
        </article>

        <article class="rounded-2xl bg-white border border-gray-200 shadow-xl p-6">
            <header class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Budget Allocation by Funding Source</h2>
                    <p class="text-sm text-gray-500">Compare support from BARMM, LGUs, partners, and others</p>
                </div>
            </header>
            {% if budget_by_source %}
            <div class="mt-6" style="height: 280px;">
                <canvas id="sourceChart"></canvas>
            </div>
            {% else %}
            <div class="mt-6 flex flex-col items-center justify-center text-center text-sm text-gray-500" style="height: 280px;">
                <i class="fa-solid fa-chart-column text-2xl mb-3 text-gray-400"></i>
                Funding source data will appear once budgets are loaded.
            </div>
            {% endif %}
        </article>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <article class="lg:col-span-2 rounded-2xl bg-white border border-gray-200 shadow-xl p-6">
            <header class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Strategic Goal Progress</h2>
                    <p class="text-sm text-gray-500">Alignment of PPAs to Bangsamoro strategic pillars</p>
                </div>
            </header>
            <div class="mt-6 space-y-4">
                {% for goal in strategic_goals %}
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm font-medium text-gray-700">
                        <span>{{ goal.name }}</span>
                        <span>{{ goal.progress }}%</span>
                    </div>
                    <div class="h-3 overflow-hidden rounded-full bg-gray-200">
                        <div class="h-full rounded-full bg-gradient-to-r from-emerald-500 via-teal-500 to-sky-500 transition-all duration-300" style="width: {{ goal.progress }}%;"></div>
                    </div>
                    <p class="text-xs text-gray-500">Target: {{ goal.target }}%</p>
                </div>
                {% empty %}
                <p class="text-sm text-gray-500">Strategic goals are not yet configured.</p>
                {% endfor %}
            </div>
        </article>

        <article class="rounded-2xl bg-white border border-gray-200 shadow-xl p-6">
            <header class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Alerts Overview</h2>
                    <p class="text-sm text-gray-500">Recent signals requiring attention</p>
                </div>
                <a href="{% url 'project_central:alert_list' %}" class="text-sm font-semibold text-emerald-600 hover:text-emerald-700 transition-colors">View all →</a>
            </header>
            <div class="mt-6 space-y-4">
                {% for alert in recent_alerts %}
                <div class="rounded-xl border border-gray-100 bg-gray-50 px-4 py-3 hover:border-emerald-200 hover:bg-emerald-50 transition-all duration-200">
                    <div class="flex items-start justify-between">
                        <div class="space-y-1">
                            <p class="text-sm font-semibold text-gray-900">{{ alert.title }}</p>
                            <p class="text-xs text-gray-500">{{ alert.description|default:"No description"|truncatewords:16 }}</p>
                        </div>
                        <span class="ml-3 inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold uppercase tracking-wide {% if alert.severity == 'critical' %}bg-rose-100 text-rose-700{% elif alert.severity == 'high' %}bg-orange-100 text-orange-700{% elif alert.severity == 'medium' %}bg-amber-100 text-amber-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                            {{ alert.get_severity_display }}
                        </span>
                    </div>
                    <a href="{% url 'project_central:alert_detail' alert.id %}"
                       class="mt-3 inline-flex items-center gap-2 text-sm font-semibold text-emerald-600 hover:text-emerald-700 transition-colors">
                        Inspect alert
                        <i class="fa-solid fa-arrow-right"></i>
                    </a>
                </div>
                {% empty %}
                <div class="flex h-40 flex-col items-center justify-center text-center text-sm text-gray-500">
                    <i class="fa-solid fa-circle-check text-2xl mb-3 text-emerald-500"></i>
                    All clear—no active alerts.
                </div>
                {% endfor %}
            </div>
        </article>
    </section>

    <section class="rounded-2xl bg-white border border-gray-200 shadow-xl p-6">
        <header class="flex items-center justify-between">
            <div>
                <h2 class="text-lg font-semibold text-gray-900">Recent Project Workflows</h2>
                <p class="text-sm text-gray-500">Latest lifecycle updates from field operations</p>
            </div>
            <a href="{% url 'project_central:project_list' %}" class="text-sm font-semibold text-emerald-600 hover:text-emerald-700 transition-colors">View all →</a>
        </header>
        <div class="mt-6 space-y-4">
            {% for workflow in recent_workflows %}
            <div class="flex flex-wrap items-center justify-between gap-3 rounded-xl border border-gray-100 bg-gray-50 px-4 py-3 hover:border-emerald-200 hover:bg-emerald-50 transition-all duration-200">
                <div>
                    <p class="text-sm font-semibold text-gray-900">{{ workflow.primary_need.title }}</p>
                    <p class="text-xs text-gray-500">Current stage: {{ workflow.get_current_stage_display }}</p>
                </div>
                <div class="flex items-center gap-3">
                    {% if workflow.primary_need and workflow.primary_need.priority_score %}
                    <span class="inline-flex items-center rounded-full bg-slate-200 px-3 py-1 text-xs font-semibold text-slate-700">
                        Priority {{ workflow.primary_need.priority_score|floatformat:1 }}
                    </span>
                    {% endif %}
                    {% if workflow.work_item_id %}
                    <a href="{% url 'common:work_item_detail' pk=workflow.work_item_id %}"
                       class="inline-flex items-center gap-2 rounded-xl border border-emerald-200 bg-white px-3 py-1.5 text-sm font-semibold text-emerald-600 hover:bg-emerald-50 transition-all duration-200">
                        Open
                        <i class="fa-solid fa-arrow-right"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="flex h-32 flex-col items-center justify-center text-center text-sm text-gray-500">
                <i class="fa-solid fa-clipboard-list text-2xl mb-3 text-gray-400"></i>
                No workflows in the system yet. <a href="{% url 'project_central:create_project_workflow' %}" class="text-emerald-600 hover:text-emerald-700 font-semibold">Create one</a>
            </div>
            {% endfor %}
        </div>
    </section>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const sectorLabels = JSON.parse('{{ sector_labels_json|safe }}');
    const sectorValues = JSON.parse('{{ sector_values_json|safe }}');
    const sourceLabels = JSON.parse('{{ source_labels_json|safe }}');
    const sourceValues = JSON.parse('{{ source_values_json|safe }}');

    const chartDefaults = {
        type: 'doughnut',
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: { size: 12 },
                        padding: 16,
                    },
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed || 0;
                            return `${context.label}: ₱${value.toLocaleString()}`;
                        }
                    }
                }
            },
            cutout: '65%',
        }
    };

    const emeraldPalette = ['#047857', '#059669', '#10b981', '#34d399', '#6ee7b7', '#a7f3d0'];
    const tealPalette = ['#0ea5e9', '#22d3ee', '#22c55e', '#14b8a6', '#2dd4bf', '#38bdf8'];

    const sectorCanvas = document.getElementById('sectorChart');
    if (sectorCanvas && sectorLabels.length) {
        new Chart(sectorCanvas, {
            ...chartDefaults,
            data: {
                labels: sectorLabels,
                datasets: [
                    {
                        data: sectorValues,
                        backgroundColor: emeraldPalette,
                        borderColor: '#ffffff',
                        borderWidth: 2,
                    }
                ]
            }
        });
    }

    const sourceCanvas = document.getElementById('sourceChart');
    if (sourceCanvas && sourceLabels.length) {
        new Chart(sourceCanvas, {
            ...chartDefaults,
            data: {
                labels: sourceLabels,
                datasets: [
                    {
                        data: sourceValues,
                        backgroundColor: tealPalette,
                        borderColor: '#ffffff',
                        borderWidth: 2,
                    }
                ]
            },
        });
    }
});
</script>
{% endblock %}
