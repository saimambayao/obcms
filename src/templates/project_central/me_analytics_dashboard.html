{% extends "base.html" %}
{% load static humanize text_extras %}

{% block title %}M&E Analytics Dashboard - PPA Management{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Budget by Sector Pie Chart
    const sectorCtx = document.getElementById('sectorChart').getContext('2d');
    new Chart(sectorCtx, {
        type: 'pie',
        data: {
            labels: [{% for sector in budget_by_sector.sectors %}'{{ sector.sector }}',{% endfor %}],
            datasets: [{
                data: [{% for sector in budget_by_sector.sectors %}{{ sector.total_budget }},{% endfor %}],
                backgroundColor: [
                    '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
                    '#06b6d4', '#ec4899', '#14b8a6', '#f97316'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right' },
                title: { display: true, text: 'Budget Allocation by Sector' }
            }
        }
    });

    // Budget by Source Bar Chart
    const sourceCtx = document.getElementById('sourceChart').getContext('2d');
    new Chart(sourceCtx, {
        type: 'bar',
        data: {
            labels: [{% for source in budget_by_source.sources %}'{{ source.funding_source }}',{% endfor %}],
            datasets: [{
                label: 'Budget Allocation',
                data: [{% for source in budget_by_source.sources %}{{ source.total_budget }},{% endfor %}],
                backgroundColor: '#10b981'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: { display: true, text: 'Budget by Funding Source' }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₱' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Utilization Gauge
    const utilCtx = document.getElementById('utilizationChart').getContext('2d');
    new Chart(utilCtx, {
        type: 'doughnut',
        data: {
            labels: ['Disbursed', 'Remaining'],
            datasets: [{
                data: [
                    {{ utilization_rates.ppa_utilization.disbursement_rate }},
                    {{ 100|add:utilization_rates.ppa_utilization.disbursement_rate|floatformat:2|cut:"-" }}
                ],
                backgroundColor: ['#10b981', '#e5e7eb']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                title: { display: true, text: 'Budget Utilization Rate' },
                legend: { display: false }
            }
        }
    });

    // Workflow Performance
    const workflowCtx = document.getElementById('workflowChart').getContext('2d');
    new Chart(workflowCtx, {
        type: 'bar',
        data: {
            labels: ['On Track', 'Blocked', 'Total'],
            datasets: [{
                label: 'Workflows',
                data: [
                    {{ workflow_performance.on_track }},
                    {{ workflow_performance.blocked }},
                    {{ workflow_performance.total_workflows }}
                ],
                backgroundColor: ['#10b981', '#ef4444', '#3b82f6']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: { display: true, text: 'Workflow Performance' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
});
</script>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1"><i class="fas fa-chart-line text-emerald-600"></i> M&E Analytics Dashboard</h1>
            <p class="text-muted mb-0">Comprehensive monitoring and evaluation metrics</p>
        </div>
        <div>
            <form method="get" class="d-inline-block">
                <select name="fiscal_year" class="form-select" onchange="this.form.submit()">
                    {% for year in "2023,2024,2025,2026"|split:"," %}
                    <option value="{{ year }}" {% if year|add:"0" == fiscal_year %}selected{% endif %}>
                        FY {{ year }}
                    </option>
                    {% endfor %}
                </select>
            </form>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="relative overflow-hidden bg-gradient-to-br from-[#FEFDFB] to-[#FBF9F5] rounded-2xl transform hover:-translate-y-2 transition-all duration-300 h-100"
                 style="box-shadow: 0 8px 20px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.06), inset 0 -2px 4px rgba(0,0,0,0.02), inset 0 2px 4px rgba(255,255,255,0.9);">
                <div class="absolute inset-0 bg-gradient-to-br from-white/60 via-transparent to-gray-100/20"></div>
                <div class="relative p-4 d-flex flex-column h-100">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <p class="text-gray-600 text-sm font-semibold uppercase tracking-wide">Total Budget</p>
                            <p class="text-4xl font-extrabold text-gray-800 mt-1">₱{{ budget_by_sector.totals.total_budget|floatformat:0|intcomma }}</p>
                        </div>
                        <div class="w-16 h-16 rounded-2xl flex items-center justify-center flex-shrink-0"
                             style="background: linear-gradient(135deg, #FFFFFF 0%, #F5F3F0 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 4px rgba(0,0,0,0.05), inset 0 2px 4px rgba(255,255,255,0.8);">
                            <i class="fas fa-money-bill-wave text-2xl text-amber-600"></i>
                        </div>
                    </div>
                    <div class="mt-auto">
                        <p class="text-sm text-gray-500">{{ budget_by_sector.totals.project_count }} projects</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="relative overflow-hidden bg-gradient-to-br from-[#FEFDFB] to-[#FBF9F5] rounded-2xl transform hover:-translate-y-2 transition-all duration-300 h-100"
                 style="box-shadow: 0 8px 20px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.06), inset 0 -2px 4px rgba(0,0,0,0.02), inset 0 2px 4px rgba(255,255,255,0.9);">
                <div class="absolute inset-0 bg-gradient-to-br from-white/60 via-transparent to-gray-100/20"></div>
                <div class="relative p-4 d-flex flex-column h-100">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <p class="text-gray-600 text-sm font-semibold uppercase tracking-wide">Disbursement Rate</p>
                            <p class="text-4xl font-extrabold text-gray-800 mt-1">{{ utilization_rates.ppa_utilization.disbursement_rate|floatformat:1 }}%</p>
                        </div>
                        <div class="w-16 h-16 rounded-2xl flex items-center justify-center flex-shrink-0"
                             style="background: linear-gradient(135deg, #FFFFFF 0%, #F5F3F0 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 4px rgba(0,0,0,0.05), inset 0 2px 4px rgba(255,255,255,0.8);">
                            <i class="fas fa-chart-line text-2xl text-emerald-600"></i>
                        </div>
                    </div>
                    <div class="mt-auto">
                        <p class="text-sm text-gray-500">₱{{ utilization_rates.ppa_utilization.total_disbursed|floatformat:0|intcomma }} disbursed</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="relative overflow-hidden bg-gradient-to-br from-[#FEFDFB] to-[#FBF9F5] rounded-2xl transform hover:-translate-y-2 transition-all duration-300 h-100"
                 style="box-shadow: 0 8px 20px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.06), inset 0 -2px 4px rgba(0,0,0,0.02), inset 0 2px 4px rgba(255,255,255,0.9);">
                <div class="absolute inset-0 bg-gradient-to-br from-white/60 via-transparent to-gray-100/20"></div>
                <div class="relative p-4 d-flex flex-column h-100">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <p class="text-gray-600 text-sm font-semibold uppercase tracking-wide">Active Workflows</p>
                            <p class="text-4xl font-extrabold text-gray-800 mt-1">{{ workflow_performance.total_workflows }}</p>
                        </div>
                        <div class="w-16 h-16 rounded-2xl flex items-center justify-center flex-shrink-0"
                             style="background: linear-gradient(135deg, #FFFFFF 0%, #F5F3F0 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 4px rgba(0,0,0,0.05), inset 0 2px 4px rgba(255,255,255,0.8);">
                            <i class="fas fa-diagram-project text-2xl text-blue-600"></i>
                        </div>
                    </div>
                    <div class="mt-auto">
                        <p class="text-sm text-gray-500">{{ workflow_performance.on_track_pct|floatformat:1 }}% on track</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="relative overflow-hidden bg-gradient-to-br from-[#FEFDFB] to-[#FBF9F5] rounded-2xl transform hover:-translate-y-2 transition-all duration-300 h-100"
                 style="box-shadow: 0 8px 20px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.06), inset 0 -2px 4px rgba(0,0,0,0.02), inset 0 2px 4px rgba(255,255,255,0.9);">
                <div class="absolute inset-0 bg-gradient-to-br from-white/60 via-transparent to-gray-100/20"></div>
                <div class="relative p-4 d-flex flex-column h-100">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <p class="text-gray-600 text-sm font-semibold uppercase tracking-wide">Cost Effectiveness</p>
                            <p class="text-4xl font-extrabold text-gray-800 mt-1">₱{{ cost_effectiveness.overall.overall_cost_per_beneficiary|floatformat:0|intcomma }}</p>
                        </div>
                        <div class="w-16 h-16 rounded-2xl flex items-center justify-center flex-shrink-0"
                             style="background: linear-gradient(135deg, #FFFFFF 0%, #F5F3F0 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 4px rgba(0,0,0,0.05), inset 0 2px 4px rgba(255,255,255,0.8);">
                            <i class="fas fa-bullseye text-2xl text-orange-600"></i>
                        </div>
                    </div>
                    <div class="mt-auto">
                        <p class="text-sm text-gray-500">per beneficiary</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="sectorChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="sourceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="utilizationChart"></canvas>
                    </div>
                    <div class="text-center mt-3">
                        <h3 class="text-emerald-600 mb-0">{{ utilization_rates.ppa_utilization.disbursement_rate|floatformat:1 }}%</h3>
                        <small class="text-muted">Disbursement Rate</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="workflowChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Tables -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Budget by Sector</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Sector</th>
                                    <th class="text-end">Budget</th>
                                    <th class="text-end">Projects</th>
                                    <th class="text-end">Utilization</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sector in budget_by_sector.sectors %}
                                <tr>
                                    <td>{{ sector.sector }}</td>
                                    <td class="text-end">₱{{ sector.total_budget|floatformat:0|intcomma }}</td>
                                    <td class="text-end">{{ sector.project_count }}</td>
                                    <td class="text-end">{{ sector.utilization_pct|floatformat:1 }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Budget Ceiling Utilization</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Ceiling</th>
                                    <th class="text-end">Limit</th>
                                    <th class="text-end">Allocated</th>
                                    <th class="text-end">Utilization</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ceiling in utilization_rates.ceiling_utilization %}
                                <tr>
                                    <td>{{ ceiling.name }}</td>
                                    <td class="text-end">₱{{ ceiling.ceiling_amount|floatformat:0|intcomma }}</td>
                                    <td class="text-end">₱{{ ceiling.allocated_amount|floatformat:0|intcomma }}</td>
                                    <td class="text-end">
                                        <span class="badge {% if ceiling.utilization_pct >= 90 %}bg-danger{% elif ceiling.utilization_pct >= 75 %}bg-warning{% else %}bg-success{% endif %}">
                                            {{ ceiling.utilization_pct|floatformat:1 }}%
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
