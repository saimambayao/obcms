{% extends 'base.html' %}
{% load humanize %}

{% block title %}Manage Municipal OBC - OBC Management System{% endblock %}

{% block breadcrumb %}
<li class="flex items-center space-x-2">
    <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
    <span class="text-gray-900 font-medium">Municipal OBCs</span>
</li>
<li class="flex items-center space-x-2">
    <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
    <span class="text-gray-500 font-medium">Manage Municipal OBC</span>
</li>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-10">
    {% if hero_config %}
    <header class="relative overflow-hidden rounded-3xl bg-bangsamoro-gradient text-white shadow-2xl">
        <div class="absolute inset-0 opacity-20" style="background-image: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.35), transparent 55%), radial-gradient(circle at 80% 0%, rgba(255,255,255,0.25), transparent 60%);"></div>
        <div class="relative flex flex-col lg:flex-row">
            <div class="flex-1 p-8 space-y-6">
                <div class="inline-flex items-center gap-2 bg-white/15 backdrop-blur px-3 py-1 rounded-full text-sm font-semibold uppercase tracking-wide">
                    <i class="{{ hero_config.badge_icon }}"></i>
                    <span>{{ hero_config.badge_text }}</span>
                </div>
                <div class="flex items-start gap-4">
                    <span class="inline-flex h-16 w-16 items-center justify-center rounded-2xl bg-white/15 text-3xl">
                        <i class="{{ hero_config.icon }}"></i>
                    </span>
                    <div>
                        <h1 class="text-3xl font-bold leading-tight">{{ hero_config.title }}</h1>
                        {% if show_archived %}
                        <span class="mt-2 inline-flex items-center gap-2 rounded-full bg-amber-100/90 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-amber-800">Archived view</span>
                        {% endif %}
                        <p class="mt-3 text-white/80 text-lg max-w-2xl">{{ hero_config.subtitle }}</p>
                    </div>
                </div>
                {% if hero_config.level_summary %}
                <p class="text-white/80 text-base max-w-3xl">{{ hero_config.level_summary }}</p>
                {% endif %}
                {% if hero_config.meta_cards %}
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {% for card in hero_config.meta_cards %}
                    <div class="flex items-start gap-3 rounded-2xl bg-white/12 px-5 py-4 backdrop-blur-sm border border-white/10">
                        {% if card.icon %}
                        <span class="inline-flex h-12 w-12 items-center justify-center rounded-xl bg-white/20 text-xl">
                            <i class="{{ card.icon }}"></i>
                        </span>
                        {% endif %}
                        <div>
                            <p class="text-white/70 text-xs font-semibold uppercase tracking-wide">{{ card.label }}</p>
                            <p class="text-white font-semibold text-sm sm:text-base">{{ card.value }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% if hero_config.actions %}
            <div class="lg:w-80 xl:w-96 bg-white/10 border-t border-white/15 lg:border-t-0 lg:border-l rounded-b-3xl lg:rounded-b-none lg:rounded-r-3xl p-6 flex flex-col gap-5 justify-center backdrop-blur">
                <div class="space-y-1">
                    <p class="text-sm font-semibold uppercase tracking-wide text-white/70">Quick actions</p>
                    <p class="text-white/80 text-sm">Keep municipal coverage up to date.</p>
                </div>
                <div class="flex flex-col gap-3">
                    {% for action in hero_config.actions %}
                    <a href="{{ action.href }}"
                       class="inline-flex items-center justify-center gap-2 rounded-2xl px-5 py-3 font-semibold transition-all duration-200 {% if action.variant == 'primary' %}bg-white text-emerald-600 hover:bg-emerald-50 shadow-lg shadow-emerald-900/25{% elif action.variant == 'secondary' %}bg-white/10 border border-white/30 hover:bg-white/20{% else %}bg-transparent border border-white/20 hover:bg-white/10{% endif %}">
                        {% if action.icon %}<i class="{{ action.icon }}"></i>{% endif %}
                        <span>{{ action.label }}</span>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </header>
    {% endif %}

    {% if stat_cards %}
    <section class="{{ stat_cards_grid_class|default:'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6' }}">
        {% for card in stat_cards %}
        <article class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-[#FEFDFB] to-[#F8F5EE] transition-transform duration-300 hover:-translate-y-1"
                 style="box-shadow: 0 16px 35px rgba(20,85,80,0.12), 0 6px 12px rgba(20,85,80,0.08), inset 0 1px 0 rgba(255,255,255,0.7);">
            <div class="absolute inset-0 pointer-events-none bg-[radial-gradient(circle_at_top,rgba(255,255,255,0.85),transparent_60%)]"></div>
            <div class="relative p-6 flex flex-col h-full gap-5">
                <div class="flex items-start justify-between gap-4">
                    <div>
                        <p class="text-xs font-semibold uppercase tracking-wide text-gray-600">{{ card.title }}</p>
                        <p class="mt-3 text-3xl font-extrabold text-gray-900">{{ card.value|default:0|intcomma }}</p>
                    </div>
                    <span class="inline-flex h-14 w-14 items-center justify-center rounded-2xl bg-white shadow-inner">
                        <i class="{{ card.icon|default:'fas fa-chart-bar' }} text-2xl {{ card.icon_color|default:'text-emerald-600' }}"></i>
                    </span>
                </div>
                {% if card.subtitle or card.description %}
                <p class="text-sm text-gray-600">{{ card.subtitle|default:card.description }}</p>
                {% endif %}
                <div class="flex-grow"></div>
            </div>
        </article>
        {% endfor %}
    </section>
    {% endif %}

    <div class="bg-white rounded-xl shadow-xl border border-gray-200 mb-8 overflow-hidden">
        <div class="bg-gradient-to-r from-gray-700 to-gray-800 px-6 py-4">
            <h2 class="text-xl font-bold text-white flex items-center">
                <i class="fas fa-filter mr-3 text-2xl"></i>
                Filters & Search
            </h2>
        </div>
        <div class="p-6">
            <form id="municipal-filter-form"
                  method="get"
                  hx-get="{% url 'common:communities_manage_municipal' %}"
                  hx-target="#municipal-results-container"
                  hx-swap="innerHTML transition:true"
                  hx-trigger="change from:select, submit"
                  hx-indicator="#municipal-filter-loading"
                  class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-4">
                {% if show_archived %}
                <input type="hidden" name="archived" value="1">
                {% endif %}
                <div class="lg:col-span-3">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Region</label>
                    <div class="relative">
                        <select name="region" data-initial="{{ current_region|default:'' }}"
                                class="block w-full appearance-none rounded-xl border border-gray-200 bg-white py-3 pl-4 pr-12 text-base shadow-sm focus:border-emerald-500 focus:ring-emerald-500 min-h-[48px] transition-all duration-200">
                            <option value="">All Regions</option>
                            {% for region in regions %}
                            <option value="{{ region.id }}" {% if current_region == region.id|stringformat:"s" %}selected{% endif %}>{{ region.name }}</option>
                            {% endfor %}
                        </select>
                        <span class="pointer-events-none absolute inset-y-0 right-4 flex items-center text-gray-400">
                            <i class="fas fa-chevron-down text-sm"></i>
                        </span>
                    </div>
                </div>
                <div class="lg:col-span-3">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Province</label>
                    <div class="relative">
                        <select name="province" data-initial="{{ current_province|default:'' }}"
                                class="block w-full appearance-none rounded-xl border border-gray-200 bg-white py-3 pl-4 pr-12 text-base shadow-sm focus:border-emerald-500 focus:ring-emerald-500 min-h-[48px] transition-all duration-200">
                            <option value="">All Provinces</option>
                            {% for province in provinces %}
                            <option value="{{ province.id }}" {% if current_province == province.id|stringformat:"s" %}selected{% endif %}>{{ province.name }}</option>
                            {% endfor %}
                        </select>
                        <span class="pointer-events-none absolute inset-y-0 right-4 flex items-center text-gray-400">
                            <i class="fas fa-chevron-down text-sm"></i>
                        </span>
                    </div>
                </div>
                <div class="lg:col-span-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Search</label>
                    <input type="text" name="search" value="{{ search_query }}"
                           placeholder="Search municipality, province, or region..."
                           class="block w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-base shadow-sm focus:border-emerald-500 focus:ring-emerald-500 min-h-[48px] transition-all duration-200 placeholder:text-gray-400">
                </div>
                <div class="lg:col-span-2 flex flex-col sm:flex-row gap-3 lg:items-end">
                    <button type="submit" class="w-full sm:flex-1 inline-flex items-center justify-center rounded-xl bg-emerald-600 px-6 py-3 font-semibold text-white shadow-sm transition-all duration-200 hover:bg-emerald-700">
                        <span class="htmx-indicator hidden" id="municipal-filter-loading">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                            Updating...
                        </span>
                        <span class="htmx-indicator-shown">Apply</span>
                    </button>
                    <a href="{% url 'common:communities_manage_municipal' %}"
                       class="w-full sm:flex-1 inline-flex items-center justify-center rounded-xl border border-emerald-200 bg-white px-6 py-3 font-semibold text-emerald-600 transition-all duration-200 hover:bg-emerald-50">
                        Clear
                    </a>
                </div>
            </form>
        </div>
    </div>

    <div id="municipal-results-container">
        {% include "communities/partials/municipal_manage_results.html" %}
    </div>

    <div class="mt-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Quick Actions</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {% if can_manage_communities %}
            <a href="{% url 'common:communities_add_municipality' %}" class="group bg-white rounded-xl shadow-lg border border-gray-200 hover-lift transition-all duration-200">
                <div class="p-6">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-emerald-500 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-plus text-white text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 group-hover:text-emerald-600 transition-colors">
                        Add Municipal OBC
                    </h3>
                    <p class="mt-2 text-sm text-gray-600">
                        Register municipality-wide Bangsamoro coverage data.
                    </p>
                    <div class="mt-4 flex items-center text-emerald-600 text-sm font-medium">
                        <span>Add Municipality</span>
                        <i class="fas fa-arrow-right ml-2 transform group-hover:translate-x-1 transition-transform"></i>
                    </div>
                </div>
            </a>
            {% endif %}

            <a href="{% url 'common:communities_stakeholders' %}" class="group bg-white rounded-xl shadow-lg border border-gray-200 hover-lift transition-all duration-200">
                <div class="p-6">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-emerald-500 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-users text-white text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 group-hover:text-emerald-600 transition-colors">
                        Manage Stakeholders
                    </h3>
                    <p class="mt-2 text-sm text-gray-600">
                        Coordinate with municipal partners and focal persons.
                    </p>
                    <div class="mt-4 flex items-center text-emerald-600 text-sm font-medium">
                        <span>Open Stakeholder Registry</span>
                        <i class="fas fa-arrow-right ml-2 transform group-hover:translate-x-1 transition-transform"></i>
                    </div>
                </div>
            </a>

            <a href="{% url 'common:communities_home' %}" class="group bg-white rounded-xl shadow-lg border border-gray-200 hover-lift transition-all duration-200">
                <div class="p-6">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-emerald-500 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-chart-line text-white text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 group-hover:text-emerald-600 transition-colors">
                        View Dashboard
                    </h3>
                    <p class="mt-2 text-sm text-gray-600">
                        Return to communities insights and KPIs.
                    </p>
                    <div class="mt-4 flex items-center text-emerald-600 text-sm font-medium">
                        <span>Open Dashboard</span>
                        <i class="fas fa-arrow-right ml-2 transform group-hover:translate-x-1 transition-transform"></i>
                    </div>
                </div>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script>
        const initializeMunicipalDeleteButtons = () => {
            document.querySelectorAll('[data-delete-view]:not([data-delete-bound])').forEach((button) => {
                button.dataset.deleteBound = '1';
                button.addEventListener('click', (event) => {
                    event.preventDefault();
                    const viewUrl = button.getAttribute('data-delete-view');
                    if (!viewUrl) {
                        return;
                    }
                    const confirmationMessage =
                        button.getAttribute('data-confirm') ||
                        'Are you sure you want to delete this record?';
                    if (window.confirm(confirmationMessage)) {
                        const separator = viewUrl.includes('?') ? '&' : '?';
                        window.location.href = `${viewUrl}${separator}review_delete=1`;
                    }
                });
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            initializeMunicipalDeleteButtons();
        });

        document.body.addEventListener('htmx:afterSwap', (event) => {
            if (!(event.target instanceof Element)) {
                return;
            }
            if (event.target.closest('#municipal-results-container')) {
                initializeMunicipalDeleteButtons();
            }
        });
    </script>
    <script id="municipal-province-options" type="application/json">{{ province_options_json|default:"[]"|safe }}</script>
    <script>
        (function() {
            console.log('[Municipal OBC] Script loaded');

            function initializeFilters() {
                console.log('[Municipal OBC] Initializing filters...');

                const dataElement = document.getElementById("municipal-province-options");
                if (!dataElement) {
                    console.warn('[Municipal OBC] ⚠️ Province data element not found');
                    return;
                }

                let provinceOptions = [];
                try {
                    provinceOptions = JSON.parse(dataElement.textContent);
                    console.log('[Municipal OBC] ✅ Loaded province options:', provinceOptions.length);
                    console.log('[Municipal OBC] First province:', provinceOptions[0]);
                } catch (error) {
                    console.error('[Municipal OBC] ❌ Failed to parse province options:', error);
                }

                const filterForm = document.getElementById('municipal-filter-form');
                if (!filterForm) {
                    console.warn('[Municipal OBC] ⚠️ Filter form not found');
                    return;
                }

                const regionSelect = filterForm.querySelector('select[name="region"]');
                const provinceSelect = filterForm.querySelector('select[name="province"]');
                if (!regionSelect || !provinceSelect) {
                    console.warn('[Municipal OBC] ⚠️ One or more select elements not found');
                    console.log('Region:', regionSelect, 'Province:', provinceSelect);
                    return;
                }

                const populateProvinces = (regionId, preserveValue) => {
                    console.log('[Municipal OBC] 🔧 populateProvinces called:', { regionId, type: typeof regionId, preserveValue });

                    const normalizedId = regionId ? String(regionId) : "";
                    const previousValue = preserveValue ? String(preserveValue) : "";

                    console.log('[Municipal OBC] 🔧 Normalized:', { normalizedId, willFilter: !!normalizedId, totalOptions: provinceOptions.length });

                    // Debug filter logic
                    if (normalizedId && provinceOptions.length > 0) {
                        console.log('[Municipal OBC] 🔍 Sample filter test:');
                        provinceOptions.slice(0, 3).forEach(opt => {
                            const match = String(opt.region_id) === normalizedId;
                            console.log(`  ${opt.name}: region_id="${opt.region_id}" ${match ? '✅ MATCH' : '❌ no match'}`);
                        });
                    }

                    const filtered = normalizedId
                        ? provinceOptions.filter((option) => String(option.region_id) === normalizedId)
                        : provinceOptions;

                    console.log(`[Municipal OBC] 🔄 Filter result: ${filtered.length}/${provinceOptions.length} provinces`);
                    if (filtered.length > 0 && filtered.length <= 10) {
                        console.log('[Municipal OBC] ✅ ALL filtered provinces:', filtered.map(p => `${p.name} (${p.region_id})`));
                    }

                    provinceSelect.innerHTML = "";
                    const defaultOption = document.createElement("option");
                    defaultOption.value = "";
                    defaultOption.textContent = "All Provinces";
                    provinceSelect.appendChild(defaultOption);

                    filtered.forEach((option) => {
                        const opt = document.createElement("option");
                        opt.value = option.id;
                        opt.textContent = option.name;
                        provinceSelect.appendChild(opt);
                    });

                    if (previousValue && filtered.some((option) => String(option.id) === previousValue)) {
                        provinceSelect.value = previousValue;
                        console.log('[Municipal OBC] ✅ Restored selection:', previousValue);
                    }

                    console.log('[Municipal OBC] ✅ Dropdown updated:', provinceSelect.options.length, 'total options');
                };

                const initialRegion = regionSelect.dataset.initial || regionSelect.value || "";
                const initialProvince = provinceSelect.dataset.initial || provinceSelect.value || "";

                console.log('[Municipal OBC] 📊 Initial state:');
                console.log('  Region:', initialRegion, '(from', regionSelect.dataset.initial ? 'data-initial' : 'value', ')');
                console.log('  Province:', initialProvince, '(from', provinceSelect.dataset.initial ? 'data-initial' : 'value', ')');

                populateProvinces(initialRegion, initialProvince);

                regionSelect.addEventListener("change", () => {
                    console.log('[Municipal OBC] 👉 Region changed to:', regionSelect.value);
                    populateProvinces(regionSelect.value, "");
                });

                console.log('[Municipal OBC] ✅ Initialization complete');
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeFilters);
            } else {
                initializeFilters();
            }
        })();
    </script>
{% endblock %}
