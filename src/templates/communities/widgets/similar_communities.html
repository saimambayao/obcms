{% load static %}

<div class="bg-white rounded-xl shadow border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold flex items-center">
            <i class="fas fa-search-location text-blue-600 mr-2"></i>
            Similar Communities
        </h3>
        <span class="text-xs text-gray-500 bg-gray-50 px-2 py-1 rounded">
            <i class="fas fa-network-wired"></i> {{ similar_communities|length }} matches
        </span>
    </div>

    {% if similar_communities %}
    <div class="space-y-2">
        {% for item in similar_communities %}
        <a href="{% url 'communities:barangay_detail' item.community.id %}"
           class="block p-4 rounded-lg hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 border border-gray-100 hover:border-blue-200 transition-all duration-200 group">

            <!-- Community Name and Location -->
            <div class="flex justify-between items-start mb-2">
                <div class="flex-1">
                    <p class="font-medium text-gray-900 group-hover:text-blue-700 transition-colors">
                        {{ item.community.name|default:item.community.community_names }}
                    </p>
                    <p class="text-xs text-gray-500 mt-0.5">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        {{ item.community.municipality.name }}, {{ item.community.province.name }}
                    </p>
                </div>

                <!-- Similarity Score Badge -->
                <div class="ml-4 flex-shrink-0">
                    <div class="text-right">
                        <span class="inline-block px-3 py-1 rounded-full text-xs font-bold
                                     {% if item.similarity_score >= 0.8 %}bg-emerald-100 text-emerald-700
                                     {% elif item.similarity_score >= 0.6 %}bg-blue-100 text-blue-700
                                     {% else %}bg-gray-100 text-gray-700{% endif %}">
                            {{ item.similarity_score|floatformat:0 }}% similar
                        </span>
                    </div>
                </div>
            </div>

            <!-- Matching Features -->
            {% if item.matching_features %}
            <div class="mb-2">
                <div class="flex flex-wrap gap-1">
                    {% for feature in item.matching_features|slice:":4" %}
                    <span class="inline-block px-2 py-0.5 bg-blue-50 text-blue-700 rounded text-xs">
                        <i class="fas fa-check text-blue-500 mr-1"></i>
                        {{ feature|title|truncatewords:2 }}
                    </span>
                    {% endfor %}
                    {% if item.matching_features|length > 4 %}
                    <span class="inline-block px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-xs">
                        +{{ item.matching_features|length|add:"-4" }} more
                    </span>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Quick Stats Comparison -->
            <div class="grid grid-cols-3 gap-2 text-xs text-gray-600 mt-3 pt-3 border-t border-gray-100">
                <div>
                    <i class="fas fa-users text-gray-400 mr-1"></i>
                    {% if item.community.estimated_obc_population %}
                        {{ item.community.estimated_obc_population|floatformat:0 }}
                    {% else %}
                        N/A
                    {% endif %}
                </div>
                <div>
                    <i class="fas fa-home text-gray-400 mr-1"></i>
                    {% if item.community.households %}
                        {{ item.community.households }} HH
                    {% else %}
                        N/A
                    {% endif %}
                </div>
                <div class="truncate">
                    <i class="fas fa-language text-gray-400 mr-1"></i>
                    {{ item.community.primary_ethnolinguistic_group|default:"N/A" }}
                </div>
            </div>

            <!-- Rationale (if provided) -->
            {% if item.rationale %}
            <div class="mt-3 pt-3 border-t border-gray-100">
                <p class="text-xs text-gray-600 italic leading-relaxed">
                    <i class="fas fa-quote-left text-gray-300 mr-1"></i>
                    {{ item.rationale|truncatewords:20 }}
                </p>
            </div>
            {% endif %}

            <!-- Hover Indicator -->
            <div class="mt-2 text-xs text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity">
                <i class="fas fa-arrow-right mr-1"></i>
                View full profile
            </div>
        </a>
        {% endfor %}
    </div>

    <!-- Actions Section -->
    <div class="mt-6 pt-4 border-t border-gray-200 space-y-2">
        <button type="button"
                class="w-full px-4 py-2 text-sm text-blue-700 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors"
                onclick="showPeerLearningModal()">
            <i class="fas fa-users-cog mr-2"></i>
            Suggest Peer Learning Groups
        </button>

        <button type="button"
                class="w-full px-4 py-2 text-sm text-purple-700 bg-purple-50 rounded-lg hover:bg-purple-100 transition-colors"
                onclick="showBestPracticesModal()">
            <i class="fas fa-trophy mr-2"></i>
            Find Best Practice Examples
        </button>
    </div>

    {% else %}
    <!-- No Similar Communities Found -->
    <div class="text-center py-8 text-gray-500">
        <i class="fas fa-search text-4xl mb-3 opacity-20"></i>
        <p class="text-sm font-medium">No similar communities found</p>
        <p class="text-xs mt-2">
            This may be a unique community profile, or there may be insufficient data
            in the system for comparison.
        </p>
    </div>
    {% endif %}

    <!-- Info Footer -->
    <div class="mt-6 pt-4 border-t border-gray-200">
        <p class="text-xs text-gray-500 flex items-start">
            <i class="fas fa-info-circle mr-2 mt-0.5 flex-shrink-0"></i>
            <span>
                AI-powered similarity analysis based on demographics, infrastructure access,
                ethnolinguistic background, and geographic proximity. Use these connections
                for peer learning and best practice sharing.
            </span>
        </p>
    </div>
</div>

<!-- Modal Templates (Add these to your base template or page) -->
<script>
function showPeerLearningModal() {
    // TODO: Implement peer learning groups modal
    alert('Peer Learning Groups feature coming soon!');
}

function showBestPracticesModal() {
    // TODO: Implement best practices finder modal
    alert('Best Practices Finder feature coming soon!');
}
</script>

{% comment %}
This widget requires similar_communities list in context.

Example context:
similar_communities = [
    {
        'community': <OBCCommunity object>,
        'similarity_score': 0.92,
        'matching_features': ['population_size', 'ethnolinguistic_group', 'livelihoods'],
        'differences': ['access_to_electricity'],
        'rationale': 'Similar demographics and cultural background'
    },
    ...
]
{% endcomment %}
