{# Unified Work Item Sidebar Component #}
{# This is the CANONICAL sidebar implementation - used across all work item pages #}
{# Based on the perfect work-items sidebar from http://localhost:8000/oobc-management/work-items/ #}
{# Includes self-contained scrollbar styling #}

<!-- Sidebar Scrollbar Styling -->
<style>
    .sidebar-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f8fafc;
    }

    .sidebar-scrollbar::-webkit-scrollbar {
        width: 8px;
    }

    .sidebar-scrollbar::-webkit-scrollbar-track {
        background: #f8fafc;
    }

    .sidebar-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
    }

    .sidebar-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
</style>

<aside id="work-item-sidebar"
       class="fixed top-0 right-0 h-full w-96 bg-white border-l border-gray-200 shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50">
    <div class="h-full flex flex-col">
        <!-- Sidebar Content (HTMX target) -->
        <div id="sidebar-content" class="flex-1 overflow-y-scroll overflow-x-hidden sidebar-scrollbar p-6">
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-tasks text-4xl mb-3"></i>
                <p>Click an action button to view details</p>
            </div>
        </div>
    </div>
</aside>

<!-- Sidebar Backdrop -->
<div id="sidebar-backdrop"
     class="fixed inset-0 bg-black/50 z-40 opacity-0 pointer-events-none transition-opacity duration-300"
     onclick="closeSidebar()"></div>

<!-- Sidebar Initialization Script -->
<script>
(function() {
    'use strict';

    // ============================================================================
    // SIDEBAR PANEL FUNCTIONALITY
    // ============================================================================

    window.openSidebar = function() {
        const sidebar = document.getElementById('work-item-sidebar');
        const backdrop = document.getElementById('sidebar-backdrop');

        if (sidebar && backdrop) {
            sidebar.classList.remove('translate-x-full');
            backdrop.classList.remove('opacity-0', 'pointer-events-none');
            backdrop.classList.add('opacity-100', 'pointer-events-auto');
            console.log('[Sidebar] Opened');
        }
    };

    window.openSidebarAndLoad = function(button) {
        openSidebar();

        const url = button.getAttribute('data-hx-get');
        const target = button.getAttribute('data-hx-target');

        if (!url || !target) {
            console.error('[Sidebar] Missing data-hx-get or data-hx-target attribute');
            return;
        }

        setTimeout(() => {
            htmx.ajax('GET', url, {
                target: target,
                swap: 'innerHTML'
            });
        }, 50);
    };

    window.closeSidebar = function() {
        const sidebar = document.getElementById('work-item-sidebar');
        const backdrop = document.getElementById('sidebar-backdrop');

        if (sidebar && backdrop) {
            sidebar.classList.add('translate-x-full');
            backdrop.classList.remove('opacity-100', 'pointer-events-auto');
            backdrop.classList.add('opacity-0', 'pointer-events-none');
            console.log('[Sidebar] Closed');
        }
    };

    // HTMX event handlers for proper sidebar content management
    document.body.addEventListener('htmx:afterSwap', function(event) {
        const target = event.detail.target;
        if (!target) {
            return;
        }

        if (target.id === 'sidebar-content') {
            console.log('[Sidebar] Content loaded');
            htmx.process(target);
        }
    });

    document.body.addEventListener('htmx:beforeSwap', function(event) {
        const target = event.detail.target;
        if (!target) {
            return;
        }

        if (target.id !== 'sidebar-content') {
            return;
        }

        const status = event.detail.xhr.status;

        // Handle 204 No Content response (successful form submission with no content)
        if (status === 204) {
            const formEl = target.querySelector('form[data-close-action]');
            const closeAction = formEl ? formEl.dataset.closeAction : null;

            // Execute close action if specified, otherwise close sidebar
            if (closeAction === 'close' || !closeAction) {
                closeSidebar();
            }

            event.detail.shouldSwap = false;
            return;
        }

        // Handle error responses
        if (status >= 400) {
            console.error('[Sidebar] HTMX request failed', {
                status,
                statusText: event.detail.xhr.statusText
            });
            return;
        }
    });

    // Prevent duplicate initialization
    if (!window.unifiedSidebarInitialized) {
        window.unifiedSidebarInitialized = true;
        console.log('[Sidebar] Unified sidebar component initialized');
    }
})();
</script>
