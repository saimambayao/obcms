{% load static %}
{# Modal Component: modal_id, title, size, content/content_template, footer, closeable, backdrop_dismiss #}

{# Generate unique modal ID if not provided #}
{% now "U" as timestamp %}
{% firstof modal_id "modal-"|add:timestamp as use_modal_id %}

<div id="{{ use_modal_id }}"
     class="modal-backdrop fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4"
     data-modal-backdrop="true"
     data-backdrop-dismiss="{% if backdrop_dismiss|default:True %}true{% else %}false{% endif %}"
     x-data="{ show: true }"
     x-show="show"
     x-transition:enter="transition ease-out duration-200"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-150"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     {% if backdrop_dismiss|default:True %}@click.self="show = false; setTimeout(() => { const root = $el.closest('.modal-backdrop'); if (root) { root.remove(); } }, 200)"{% endif %}
     @keydown.escape.window="show = false; setTimeout(() => { const root = $el.closest('.modal-backdrop'); if (root) { root.remove(); } }, 200)"
     role="dialog"
     aria-modal="true"
     aria-labelledby="{{ use_modal_id }}-title">

    <div class="modal-content bg-white rounded-xl shadow-2xl
                {% if size == 'sm' %}max-w-md
                {% elif size == 'lg' %}max-w-4xl
                {% elif size == 'xl' %}max-w-6xl
                {% elif size == 'full' %}max-w-[95vw]
                {% else %}max-w-2xl{% endif %}
                w-full max-h-[90vh] flex flex-col"
         x-show="show"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         @click.stop
         x-trap.inert.noscroll="show">

        {# Modal Header #}
        <div class="modal-header flex items-center justify-between px-6 py-4 border-b border-gray-200 flex-shrink-0">
            <h2 id="{{ use_modal_id }}-title" class="text-xl font-semibold text-gray-900">
                {{ title }}
            </h2>
            {% if closeable|default:True %}
            <button type="button"
                    data-modal-dismiss
                    @click="show = false; setTimeout(() => { const root = $el.closest('.modal-backdrop'); if (root) { root.remove(); } }, 200)"
                    class="text-gray-400 hover:text-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 rounded-lg p-1"
                    aria-label="Close modal">
                <i class="fas fa-times text-xl" aria-hidden="true"></i>
            </button>
            {% endif %}
        </div>

        {# Modal Body #}
        <div class="modal-body px-6 py-4 overflow-y-auto flex-1">
            {% if content_template %}
                {% include content_template %}
            {% elif content %}
                {{ content|safe }}
            {% else %}
                <p class="text-gray-500 text-sm">No content provided.</p>
            {% endif %}
        </div>

        {# Modal Footer #}
        {% if show_footer or footer_template or footer_html %}
        <div class="modal-footer px-6 py-4 border-t border-gray-200 flex items-center justify-end space-x-3 flex-shrink-0 bg-gray-50">
            {% if footer_template %}
                {% include footer_template %}
            {% elif footer_html %}
                {{ footer_html|safe }}
            {% else %}
                <button type="button"
                        data-modal-dismiss
                        @click="show = false; setTimeout(() => { const root = $el.closest('.modal-backdrop'); if (root) { root.remove(); } }, 200)"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                    Close
                </button>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

{# Modal behaviour fallback (vanilla JS) #}
<script>
(function() {
    const modalBackdrop = document.getElementById('{{ use_modal_id }}');
    if (!modalBackdrop) {
        return;
    }

    const modalContent = modalBackdrop.querySelector('.modal-content');
    const shouldDismissOnBackdrop = modalBackdrop.dataset.backdropDismiss !== 'false';
    const dismissButtons = Array.from(modalBackdrop.querySelectorAll('[data-modal-dismiss]'));
    const CLOSE_DELAY = 200;
    let isCleanedUp = false;
    let removalObserver;
    let bodyObserver;

    const syncBodyScroll = () => {
        const openModals = document.querySelectorAll('.modal-backdrop');
        if (openModals.length > 0) {
            document.body.style.overflow = 'hidden';
        } else {
            document.body.style.overflow = '';
        }
    };

    const handleKeydown = (event) => {
        if (event.key === 'Escape') {
            event.preventDefault();
            closeModal();
        }
    };

    const handleBackdropClick = (event) => {
        if (!shouldDismissOnBackdrop) {
            return;
        }
        if (event.target === modalBackdrop) {
            closeModal();
        }
    };

    const handleDismissClick = (event) => {
        event.preventDefault();
        closeModal();
    };

    const cleanup = () => {
        if (isCleanedUp) {
            return;
        }
        isCleanedUp = true;

        document.removeEventListener('keydown', handleKeydown);

        if (shouldDismissOnBackdrop) {
            modalBackdrop.removeEventListener('click', handleBackdropClick);
        }

        dismissButtons.forEach((btn) => {
            btn.removeEventListener('click', handleDismissClick);
        });

        if (removalObserver) {
            removalObserver.disconnect();
        }

        if (bodyObserver) {
            bodyObserver.disconnect();
        }

        syncBodyScroll();
    };

    const closeModal = () => {
        if (modalBackdrop.dataset.modalClosing === 'true') {
            return;
        }

        modalBackdrop.dataset.modalClosing = 'true';
        modalBackdrop.classList.add('modal-closing');

        if (modalContent) {
            modalContent.classList.add('modal-closing');
        }

        setTimeout(() => {
            if (modalBackdrop.parentNode) {
                modalBackdrop.parentNode.removeChild(modalBackdrop);
            }
            cleanup();
        }, CLOSE_DELAY);
    };

    dismissButtons.forEach((btn) => {
        btn.addEventListener('click', handleDismissClick);
    });

    if (shouldDismissOnBackdrop) {
        modalBackdrop.addEventListener('click', handleBackdropClick);
    }

    document.addEventListener('keydown', handleKeydown);

    removalObserver = new MutationObserver(() => {
        if (!document.body.contains(modalBackdrop)) {
            cleanup();
        }
    });
    removalObserver.observe(document.body, { childList: true, subtree: true });

    bodyObserver = new MutationObserver(syncBodyScroll);
    bodyObserver.observe(document.body, { childList: true, subtree: true });

    syncBodyScroll();

    const focusableSelectors = [
        'a[href]',
        'button:not([disabled])',
        'textarea:not([disabled])',
        'input:not([disabled])',
        'select:not([disabled])',
        '[tabindex]:not([tabindex="-1"])'
    ];
    const focusableElements = modalBackdrop.querySelectorAll(focusableSelectors.join(','));
    const activeElement = document.activeElement;

    if (focusableElements.length && (!activeElement || !modalBackdrop.contains(activeElement))) {
        const firstFocusable = focusableElements[0];
        if (typeof firstFocusable.focus === 'function') {
            firstFocusable.focus({ preventScroll: true });
        }
    }

    if (typeof Alpine === 'undefined') {
        console.debug(`Modal "{{ use_modal_id }}" running in vanilla mode (Alpine.js not detected).`);
    }
})();
</script>

<style>
/* Modal animations */
.modal-backdrop {
    animation: fadeIn 200ms ease-out;
    transition: opacity 200ms ease-in-out;
}

.modal-backdrop.modal-closing {
    opacity: 0;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* Ensure modals appear above other content */
.modal-backdrop {
    z-index: 9999;
}

.modal-content {
    transition: opacity 200ms ease-in-out, transform 200ms ease-in-out;
}

.modal-content.modal-closing {
    opacity: 0;
    transform: scale(0.95);
}

/* Scrollbar styling for modal body */
.modal-body::-webkit-scrollbar {
    width: 8px;
}

.modal-body::-webkit-scrollbar-track {
    background: #f7fafc;
    border-radius: 4px;
}

.modal-body::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 4px;
}

.modal-body::-webkit-scrollbar-thumb:hover {
    background: #a0aec0;
}

/* Mobile responsiveness */
@media (max-width: 640px) {
    .modal-content {
        max-height: 95vh;
        margin: 0.5rem;
        border-radius: 0.75rem;
    }

    .modal-header,
    .modal-body,
    .modal-footer {
        padding-left: 1rem;
        padding-right: 1rem;
    }
}
</style>
