{#
Reusable Kanban Board Component

Expected context:
- board_id: unique identifier for the board (string)
- columns: list of dicts with:
    {
        'id': 'column-slug',
        'title': 'Column Title',
        'items': [...],
        'add_url': optional URL for "Add Item" button
    }
- item_template: path to template for rendering individual items (string)
- move_endpoint: URL name or full URL for moving items between columns (string)
- editable: boolean, enable drag-and-drop (default: True)
- height_class: optional Tailwind class for board height (default: 'min-h-[600px]')
- column_class: optional additional classes for columns (default: '')

Usage:
{% include "components/kanban_board.html" with
    board_id="assessment-tasks"
    columns=status_columns
    item_template="components/task_card.html"
    move_endpoint="tasks_move"
    editable=True
%}
#}
{% load static %}

<div id="{{ board_id }}"
     class="kanban-board {{ height_class|default:'min-h-[600px]' }}"
     data-board-id="{{ board_id }}"
     data-move-endpoint="{{ move_endpoint }}"
     role="region"
     aria-label="Kanban board">

    <div class="grid gap-4 auto-cols-fr"
         style="grid-template-columns: repeat({{ columns|length }}, minmax(280px, 1fr)); grid-auto-flow: column;">

        {% for column in columns %}
        <div class="kanban-column bg-gray-50 rounded-xl p-4 {{ column_class }} flex flex-col"
             data-column-id="{{ column.id }}"
             {% if editable|default:True %}
             ondrop="handleKanbanDrop(event)"
             ondragover="allowDrop(event)"
             ondragleave="removeDropIndicator(event)"
             {% endif %}
             role="list"
             aria-label="{{ column.title }} column">

            {# Column Header #}
            <div class="column-header flex items-center justify-between mb-4 flex-shrink-0">
                <h3 class="text-lg font-semibold text-gray-900" id="column-{{ column.id }}-title">
                    {{ column.title }}
                </h3>
                <span class="badge inline-flex items-center justify-center rounded-full bg-gray-200 text-gray-700 px-3 py-1 text-sm font-medium min-w-[2rem]"
                      data-column-count="{{ column.id }}"
                      aria-label="Item count">
                    {{ column.items|length }}
                </span>
            </div>

            {# Items Container #}
            <div class="items-container space-y-2 flex-1 overflow-y-auto"
                 data-items-container="{{ column.id }}"
                 style="max-height: calc(100vh - 300px);">
                {% for item in column.items %}
                <div class="kanban-item bg-white rounded-lg shadow-sm border border-gray-200 p-3 transition-all duration-200 hover:shadow-md"
                     {% if editable|default:True %}
                     draggable="true"
                     ondragstart="dragKanbanStart(event)"
                     ondragend="dragKanbanEnd(event)"
                     {% endif %}
                     data-item-id="{{ item.id }}"
                     data-column-id="{{ column.id }}"
                     tabindex="0"
                     role="listitem"
                     aria-labelledby="item-{{ item.id }}-title">

                    {% include item_template with item=item %}
                </div>
                {% empty %}
                <div class="empty-state text-center text-gray-400 py-8" role="status">
                    <i class="fas fa-inbox text-3xl mb-2" aria-hidden="true"></i>
                    <p class="text-sm">No items</p>
                </div>
                {% endfor %}
            </div>

            {# Add Button #}
            {% if editable|default:True and column.add_url %}
            <div class="mt-3 flex-shrink-0">
                <button type="button"
                        class="btn-add-item w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-emerald-500 hover:text-emerald-600 hover:bg-emerald-50 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2"
                        hx-get="{{ column.add_url }}"
                        hx-target="#modal-container"
                        hx-swap="innerHTML"
                        aria-label="Add item to {{ column.title }}">
                    <i class="fas fa-plus mr-2" aria-hidden="true"></i>Add Item
                </button>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

{# Drag-and-Drop JavaScript #}
<script>
(function() {
    // Prevent duplicate initialization
    if (window.__kanbanBoardInitialized) return;
    window.__kanbanBoardInitialized = true;

    let draggedKanbanItem = null;
    let draggedItemOriginalColumn = null;

    window.dragKanbanStart = function(event) {
        draggedKanbanItem = event.currentTarget;
        draggedItemOriginalColumn = event.currentTarget.dataset.columnId;

        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', event.currentTarget.dataset.itemId);
        event.dataTransfer.setData('item_id', event.currentTarget.dataset.itemId);
        event.dataTransfer.setData('old_column', draggedItemOriginalColumn);

        // Visual feedback
        setTimeout(() => {
            if (draggedKanbanItem) {
                draggedKanbanItem.classList.add('opacity-50', 'scale-95');
            }
        }, 0);
    };

    window.dragKanbanEnd = function(event) {
        if (draggedKanbanItem) {
            draggedKanbanItem.classList.remove('opacity-50', 'scale-95');
        }

        // Remove all drop indicators
        document.querySelectorAll('.kanban-column').forEach(col => {
            col.classList.remove('ring-2', 'ring-emerald-500', 'bg-emerald-50');
        });
    };

    window.allowDrop = function(event) {
        event.preventDefault();

        // Visual drop indicator
        const column = event.currentTarget;
        if (column.classList.contains('kanban-column')) {
            column.classList.add('ring-2', 'ring-emerald-500', 'bg-emerald-50');
        }
    };

    window.removeDropIndicator = function(event) {
        const column = event.currentTarget;
        if (column.classList.contains('kanban-column')) {
            column.classList.remove('ring-2', 'ring-emerald-500', 'bg-emerald-50');
        }
    };

    window.handleKanbanDrop = function(event) {
        event.preventDefault();

        const column = event.currentTarget;
        column.classList.remove('ring-2', 'ring-emerald-500', 'bg-emerald-50');

        if (!draggedKanbanItem) return;

        const itemId = event.dataTransfer.getData('item_id');
        const oldColumn = event.dataTransfer.getData('old_column');
        const newColumn = column.dataset.columnId;

        // Remove opacity immediately for smooth UX
        draggedKanbanItem.classList.remove('opacity-50', 'scale-95');

        if (oldColumn === newColumn) {
            // Same column, no action needed
            draggedKanbanItem = null;
            return;
        }

        // Get the board's move endpoint
        const board = document.getElementById(column.closest('.kanban-board').id);
        const moveEndpoint = board.dataset.moveEndpoint;

        if (!moveEndpoint) {
            console.error('No move endpoint configured for kanban board');
            draggedKanbanItem = null;
            return;
        }

        // Move element in DOM with smooth animation
        const targetContainer = column.querySelector('[data-items-container]');
        const itemToMove = draggedKanbanItem;

        // Update data attribute
        itemToMove.dataset.columnId = newColumn;

        // Animate move
        itemToMove.style.transition = 'all 300ms ease-out';
        targetContainer.appendChild(itemToMove);

        // Update counters immediately (optimistic update)
        updateKanbanCounters(board.id);

        // Send update to server
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                          document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        fetch(moveEndpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                item_id: itemId,
                old_column: oldColumn,
                new_column: newColumn
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Server returned error: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            // Success feedback
            if (window.showToast) {
                window.showToast(data.message || 'Item moved successfully', 'success');
            }

            // Trigger HTMX event for other components to react
            if (typeof htmx !== 'undefined') {
                htmx.trigger(board, 'kanban:itemMoved', {
                    itemId: itemId,
                    oldColumn: oldColumn,
                    newColumn: newColumn
                });
            }
        })
        .catch(error => {
            console.error('Failed to move item:', error);

            // Revert on error
            const originalContainer = document.querySelector(`[data-column-id="${oldColumn}"] [data-items-container]`);
            if (originalContainer) {
                originalContainer.appendChild(itemToMove);
                itemToMove.dataset.columnId = oldColumn;
                updateKanbanCounters(board.id);
            }

            if (window.showToast) {
                window.showToast('Failed to move item. Please try again.', 'error');
            }
        });

        draggedKanbanItem = null;
    };

    window.updateKanbanCounters = function(boardId) {
        const board = document.getElementById(boardId);
        if (!board) return;

        board.querySelectorAll('.kanban-column').forEach(column => {
            const columnId = column.dataset.columnId;
            const count = column.querySelectorAll('.kanban-item').length;
            const badge = column.querySelector(`[data-column-count="${columnId}"]`);
            if (badge) {
                badge.textContent = count;
                badge.setAttribute('aria-label', `${count} item${count !== 1 ? 's' : ''}`);
            }
        });
    };

    // Keyboard navigation support
    document.addEventListener('keydown', function(event) {
        const item = event.target.closest('.kanban-item');
        if (!item) return;

        // Enter or Space to open item details
        if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            // Trigger click on the item's first link or button
            const actionButton = item.querySelector('a, button');
            if (actionButton) {
                actionButton.click();
            }
        }
    });
})();
</script>

<style>
/* Kanban board scrollbar styling */
.kanban-board .items-container::-webkit-scrollbar {
    width: 6px;
}

.kanban-board .items-container::-webkit-scrollbar-track {
    background: transparent;
}

.kanban-board .items-container::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 3px;
}

.kanban-board .items-container::-webkit-scrollbar-thumb:hover {
    background: #a0aec0;
}

/* Mobile responsive adjustments */
@media (max-width: 768px) {
    .kanban-board > div {
        grid-template-columns: 1fr !important;
        grid-auto-flow: row !important;
    }

    .kanban-column {
        max-height: 400px;
    }
}
</style>
