{% extends "base.html" %}

{% block title %}{{ page_title|default:"Edit Event Instance" }}{% endblock %}

{% block breadcrumb %}
<li>
    <a href="{% url 'common:dashboard' %}" class="text-neutral-500 hover:text-neutral-700">Dashboard</a>
</li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li>
    <a href="{% url 'common:coordination_home' %}" class="text-neutral-500 hover:text-neutral-700">Coordination</a>
</li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li>
    <a href="{% url 'common:coordination_events' %}" class="text-neutral-500 hover:text-neutral-700">Events</a>
</li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li class="text-neutral-800 font-semibold">{{ page_heading|default:page_title }}</li>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                <i class="fas fa-edit text-blue-600 mr-4"></i>
                {{ page_heading|default:"Edit Event Instance" }}
            </h1>
            {% if is_recurring_instance %}
            <p class="mt-2 text-gray-600 max-w-2xl">
                <i class="fas fa-sync-alt text-emerald-600 mr-1"></i>
                This is part of a recurring series. Choose whether to edit just this instance or multiple events.
            </p>
            {% elif is_recurring_parent %}
            <p class="mt-2 text-gray-600 max-w-2xl">
                <i class="fas fa-sync-alt text-emerald-600 mr-1"></i>
                This is the parent event of a recurring series. Changes will affect future occurrences.
            </p>
            {% else %}
            <p class="mt-2 text-gray-600 max-w-2xl">
                Edit the details for this one-time event.
            </p>
            {% endif %}

            <!-- Context Badges -->
            <div class="flex flex-wrap gap-2 mt-3">
                {% if object.is_project_activity %}
                <span class="inline-flex items-center gap-1 px-3 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-700">
                    <i class="fas fa-project-diagram"></i>
                    Project Activity
                </span>
                {% endif %}
            </div>
        </div>

        <!-- Action Buttons Group -->
        <div class="flex flex-wrap gap-2">
            {% if object.is_project_activity and object.related_project %}
            <a href="{% url 'common:work_item_detail' pk=object.related_project.work_item_id %}"
               class="inline-flex items-center px-4 py-2 text-sm font-medium text-purple-700 bg-purple-50 border border-purple-200 rounded-lg shadow-sm hover:bg-purple-100">
                <i class="fas fa-project-diagram mr-2"></i>
                View Project
            </a>
            {% endif %}

            <button type="button"
                    onclick="document.getElementById('delete-confirmation').classList.remove('hidden')"
                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-red-700 bg-red-50 border border-red-200 rounded-lg shadow-sm hover:bg-red-100">
                <i class="fas fa-trash mr-2"></i>
                Delete Event
            </button>

            <a href="{{ return_url }}" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to events
            </a>
        </div>
    </div>

    {% if scope_options %}
    <section class="bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200 rounded-2xl shadow-sm p-6">
        <h2 class="text-xl font-bold text-emerald-900 mb-4 flex items-center">
            <i class="fas fa-question-circle mr-2"></i>
            Which events do you want to update?
        </h2>
        <p class="text-gray-700 mb-4">
            Since this is part of a recurring series, you can choose the scope of your changes:
        </p>
        <div class="space-y-3" id="scope-selector">
            {% for option in scope_options %}
            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-emerald-400 hover:bg-white transition-all group">
                <input
                    type="radio"
                    name="edit_scope"
                    value="{{ option.value }}"
                    {% if forloop.first %}checked{% endif %}
                    class="mt-1 h-5 w-5 text-emerald-600 border-gray-300 focus:ring-emerald-500"
                >
                <div class="ml-3 flex-1">
                    <div class="font-semibold text-gray-900 group-hover:text-emerald-900">
                        {{ option.label }}
                    </div>
                    {% if option.description %}
                    <div class="text-sm text-gray-600 mt-1">
                        {{ option.description }}
                    </div>
                    {% endif %}
                </div>
            </label>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <form method="post" id="event-form" class="space-y-8" novalidate>
        {% csrf_token %}
        <input type="hidden" name="confirm_scope" value="1">
        <input type="hidden" name="edit_scope" id="edit_scope_hidden" value="this">

        {% if form.non_field_errors %}
        <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
            {{ form.non_field_errors|join:' ' }}
        </div>
        {% endif %}

        <section class="bg-white border border-gray-200 rounded-2xl shadow-sm">
            <header class="bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-4 rounded-t-2xl text-white">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-info-circle mr-3"></i>
                    Basic Information
                </h2>
            </header>
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% include "components/form_field.html" with field=form.title %}
                    {% include "components/form_field.html" with field=form.event_type %}
                    {% include "components/form_field.html" with field=form.status %}
                    {% include "components/form_field.html" with field=form.priority %}
                    {% include "components/form_field.html" with field=form.description wrapper_class="md:col-span-2" %}
                    {% include "components/form_field.html" with field=form.objectives wrapper_class="md:col-span-2" %}
                </div>
            </div>
        </section>

        <section class="bg-white border border-gray-200 rounded-2xl shadow-sm">
            <header class="bg-gradient-to-r from-emerald-500 to-teal-600 px-6 py-4 rounded-t-2xl text-white">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-clock mr-3"></i>
                    Schedule &amp; Venue
                </h2>
            </header>
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    {% include "components/form_field.html" with field=form.start_date wrapper_class="md:col-span-2" %}
                    {% include "components/form_field.html" with field=form.start_time %}
                    {% include "components/form_field.html" with field=form.duration_hours %}
                    {% include "components/form_field.html" with field=form.end_date wrapper_class="md:col-span-2" %}
                    {% include "components/form_field.html" with field=form.end_time %}
                    {% include "components/form_field.html" with field=form.venue wrapper_class="md:col-span-2" %}
                    {% include "components/form_field.html" with field=form.address wrapper_class="md:col-span-4" %}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {% include "components/form_field.html" with field=form.is_virtual %}
                    {% include "components/form_field.html" with field=form.virtual_platform %}
                    {% include "components/form_field.html" with field=form.virtual_link %}
                </div>
            </div>
        </section>

        <section class="bg-white border border-gray-200 rounded-2xl shadow-sm">
            <header class="bg-gradient-to-r from-purple-500 to-indigo-600 px-6 py-4 rounded-t-2xl text-white">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-users mr-3"></i>
                    Team &amp; Participants
                </h2>
            </header>
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {% include "components/form_field.html" with field=form.organizer %}
                    {% include "components/form_field.html" with field=form.co_organizers %}
                    {% include "components/form_field.html" with field=form.facilitators %}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {% include "components/form_field.html" with field=form.expected_participants %}
                    {% include "components/form_field.html" with field=form.actual_participants %}
                    {% include "components/form_field.html" with field=form.target_audience wrapper_class="md:col-span-3" %}
                </div>
            </div>
        </section>

        <section class="bg-white border border-gray-200 rounded-2xl shadow-sm">
            <header class="bg-gradient-to-r from-amber-500 to-orange-500 px-6 py-4 rounded-t-2xl text-white">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-clipboard-list mr-3"></i>
                    Content &amp; Documentation
                </h2>
            </header>
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% include "components/form_field.html" with field=form.agenda %}
                    {% include "components/form_field.html" with field=form.materials_needed %}
                    {% include "components/form_field.html" with field=form.minutes %}
                    {% include "components/form_field.html" with field=form.outcomes %}
                    {% include "components/form_field.html" with field=form.decisions_made %}
                    {% include "components/form_field.html" with field=form.key_discussions %}
                </div>
            </div>
        </section>

        <div class="flex items-center justify-end space-x-3">
            <a href="{{ return_url }}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                Cancel
            </a>
            <button type="submit" class="px-4 py-2 text-sm font-semibold text-white rounded-lg shadow btn-primary">
                <i class="fas fa-save mr-2"></i>
                {{ submit_label|default:"Save Changes" }}
            </button>
        </div>
    </form>

    <!-- Delete Confirmation Dialog -->
    <div id="delete-confirmation" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Delete Event</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500">
                            Are you sure you want to delete this event? This action cannot be undone.
                        </p>
                    </div>
                    <div class="flex gap-3 px-4 py-3">
                        <button type="button"
                                onclick="document.getElementById('delete-confirmation').classList.add('hidden')"
                                class="flex-1 px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50">
                            Cancel
                        </button>
                        <form method="post" action="{% url 'common:coordination_event_delete' object.id %}" class="flex-1">
                            {% csrf_token %}
                            <input type="hidden" name="confirm" value="yes">
                            <button type="submit"
                                    class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                                Delete
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const scopeSelector = document.getElementById('scope-selector');
    const editScopeHidden = document.getElementById('edit_scope_hidden');

    if (scopeSelector && editScopeHidden) {
        const radioButtons = scopeSelector.querySelectorAll('input[name="edit_scope"]');

        radioButtons.forEach(radio => {
            radio.addEventListener('change', function() {
                editScopeHidden.value = this.value;
            });
        });

        // Set initial value
        const checked = scopeSelector.querySelector('input[name="edit_scope"]:checked');
        if (checked) {
            editScopeHidden.value = checked.value;
        }
    }
});
</script>
{% endblock %}
