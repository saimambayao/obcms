{% extends 'base.html' %}
{% load humanize moa_rbac %}

{% block extra_css %}
{{ block.super }}
<style>
[x-cloak] { display: none !important; }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
{% endblock %}

{% block title %}{{ organization.name }}{% if organization.acronym %} ({{ organization.acronym }}){% endif %} - Coordination System{% endblock %}

{% block breadcrumb %}
{% if not user.is_moa_staff %}
<li>
    <a href="{% url 'common:dashboard' %}" class="text-neutral-500 hover:text-neutral-700">Dashboard</a>
</li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li>
    <a href="{% url 'common:coordination_home' %}" class="text-neutral-500 hover:text-neutral-700">Coordination</a>
</li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li>
    <a href="{% url 'common:coordination_organizations' %}" class="text-neutral-500 hover:text-neutral-700">Organizations</a>
</li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li class="text-neutral-800 font-semibold">{{ organization.name }}{% if organization.acronym %} ({{ organization.acronym }}){% endif %}</li>
{% endif %}
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-8">
    <header class="rounded-3xl bg-bangsamoro-gradient text-white shadow-xl overflow-hidden">
        <div class="flex flex-col lg:flex-row lg:items-stretch">
            <div class="flex-1 p-8 space-y-6">
                <div class="flex flex-wrap items-center gap-2 text-sm font-semibold text-white/90">
                    <span class="inline-flex items-center gap-2 rounded-full bg-white/15 px-3 py-1">
                        <i class="fas fa-building"></i>
                        {{ organization.get_organization_type_display|default:"Organization" }}
                    </span>
                    {% if organization.partnership_status %}
                    <span class="inline-flex items-center gap-2 rounded-full bg-white/15 px-3 py-1">
                        <i class="fas fa-handshake"></i>
                        Partnership: {{ organization.get_partnership_status_display|default:organization.partnership_status|title }}
                    </span>
                    {% endif %}
                    <span class="inline-flex items-center gap-2 rounded-full bg-white/15 px-3 py-1">
                        <i class="fas {% if organization.is_active %}fa-check-circle{% else %}fa-times-circle{% endif %}"></i>
                        {% if organization.is_active %}Active{% else %}Inactive{% endif %}
                    </span>
                    {% if organization.partnership_level %}
                    <span class="inline-flex items-center gap-2 rounded-full bg-white/15 px-3 py-1">
                        <i class="fas fa-layer-group"></i>
                        {{ organization.get_partnership_level_display|default:organization.partnership_level|title }}
                    </span>
                    {% endif %}
                    {% if organization.is_priority %}
                    <span class="inline-flex items-center gap-2 rounded-full bg-white/15 px-3 py-1">
                        <i class="fas fa-star"></i>
                        Priority Partner
                    </span>
                    {% endif %}
                </div>
                <div class="space-y-3">
                    <h1 class="text-3xl font-semibold leading-tight">
                        {{ organization.name }}
                        {% if organization.acronym %}
                        <span class="ml-2 text-emerald-100 text-base font-medium">({{ organization.acronym }})</span>
                        {% endif %}
                    </h1>
                    <p class="text-white/85 text-base max-w-2xl">
                        {{ organization.description|default:"Comprehensive partner profile with coordination history, PPAs, and implementation context." }}
                    </p>
                </div>
                <div class="flex flex-wrap gap-3 pt-2 text-sm text-white/90">
                    <div class="inline-flex items-center gap-2 rounded-xl bg-white/15 px-4 py-2">
                        <i class="fas fa-address-book"></i>
                        <span>{{ contacts|length }} total contacts</span>
                    </div>
                    <div class="inline-flex items-center gap-2 rounded-xl bg-white/15 px-4 py-2">
                        <i class="fas fa-handshake-simple"></i>
                        <span>{{ total_partnerships }} partnerships linked</span>
                    </div>
                    {% if organization.organization_type == 'bmoa' %}
                    <div class="inline-flex items-center gap-2 rounded-xl bg-white/15 px-4 py-2">
                        <i class="fas fa-clipboard-list"></i>
                        <span>{{ moa_ppas_count }} MOA PPAs recorded</span>
                    </div>
                    <div class="inline-flex items-center gap-2 rounded-xl bg-white/15 px-4 py-2">
                        <i class="fas fa-peso-sign"></i>
                        <span>Budget tracked: ₱{{ moa_ppas_total_budget|default:0|floatformat:0|intcomma }}</span>
                    </div>
                    {% endif %}
                    {% if moa_work_items_stats.total %}
                    <div class="inline-flex items-center gap-2 rounded-xl bg-white/15 px-4 py-2">
                        <i class="fas fa-tasks"></i>
                        <span>{{ moa_work_items_stats.total }} work items in progress</span>
                    </div>
                    {% endif %}
                </div>
                <div class="grid gap-3 pt-2 text-sm text-white/90 sm:grid-cols-2">
                    {% if organization.focal_person %}
                    <div class="flex items-start gap-3 rounded-2xl bg-white/12 px-4 py-3">
                        <span class="text-lg mt-1"><i class="fas fa-user-tie"></i></span>
                        <div class="space-y-0.5">
                            <p class="text-xs uppercase tracking-wide text-white/70">Focal Person</p>
                            <p class="text-sm font-semibold leading-tight">{{ organization.focal_person }}</p>
                            {% if organization.focal_person_position or organization.focal_person_contact or organization.focal_person_email %}
                            <p class="text-xs text-white/70 leading-tight">
                                {% with position=organization.focal_person_position email=organization.focal_person_email contact=organization.focal_person_contact %}
                                    {% if position %}
                                        {{ position }}{% if email or contact %} • {% endif %}
                                    {% endif %}
                                    {% if email %}
                                        {{ email }}
                                    {% elif contact %}
                                        {{ contact }}
                                    {% endif %}
                                {% endwith %}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% if organization.head_of_organization %}
                    <div class="flex items-start gap-3 rounded-2xl bg-white/12 px-4 py-3">
                        <span class="text-lg mt-1"><i class="fas fa-landmark"></i></span>
                        <div class="space-y-0.5">
                            <p class="text-xs uppercase tracking-wide text-white/70">Head of Organization</p>
                            <p class="text-sm font-semibold leading-tight">{{ organization.head_of_organization }}</p>
                            {% if organization.head_position %}
                            <p class="text-xs text-white/70 leading-tight">{{ organization.head_position }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="w-full lg:w-auto lg:max-w-sm bg-white/12 border-t lg:border-t-0 lg:border-l border-white/20 p-6 flex flex-col gap-4 justify-center">
                <div class="space-y-2 text-sm text-white/90">
                    <p class="font-semibold uppercase tracking-wide text-white/75">At a glance</p>
                    <div class="space-y-2">
                        <p class="flex items-center gap-2"><i class="fas fa-address-card"></i><span>{{ contacts|length }} contacts on file</span></p>
                        <p class="flex items-center gap-2"><i class="fas fa-handshake"></i><span>{{ total_partnerships }} partnerships linked</span></p>
                        {% if organization.organization_type == 'bmoa' %}
                        <p class="flex items-center gap-2"><i class="fas fa-database"></i><span>{{ moa_ppas_count }} MOA PPAs recorded</span></p>
                        <p class="flex items-center gap-2"><i class="fas fa-coins"></i><span>Total budget tracked: ₱{{ moa_ppas_total_budget|default:0|floatformat:0|intcomma }}</span></p>
                        {% endif %}
                    </div>
                </div>
                {% with is_moa_focal=user|is_moa_focal_user_filter %}
                <div class="flex flex-col gap-2">
                    {% if not is_moa_focal %}
                    <a href="{{ return_url }}" class="inline-flex items-center justify-center gap-2 rounded-2xl border border-white/30 bg-white/10 px-5 py-3 text-sm font-semibold text-white shadow-sm hover:bg-white/15 transition-all duration-200">
                        <i class="fas fa-arrow-left"></i>
                        Back to directory
                    </a>
                    {% endif %}
                    {% if is_moa_focal %}
                    <a href="{% url 'monitoring:moa_ppas' %}?implementing_moa={{ organization.id }}" class="inline-flex items-center justify-center gap-2 rounded-2xl bg-white text-emerald-600 font-semibold px-5 py-3 shadow-md hover:bg-emerald-50 transition-all duration-200">
                        <i class="fas fa-chart-line"></i>
                        View MOA PPA Dashboard
                    </a>
                    <a href="#moa-management" onclick="switchMOATab('work-items')" class="inline-flex items-center justify-center gap-2 rounded-2xl bg-white/15 border border-white/20 px-5 py-3 text-sm font-semibold text-white hover:bg-white/20 transition-all duration-200">
                        <i class="fas fa-tasks"></i>
                        Review Work Items
                    </a>
                    {% else %}
                        {% can_manage_moa user organization as can_edit %}
                        {% if can_edit and perms.coordination.change_organization %}
                        <a href="{% url 'common:coordination_organization_edit' organization.id %}" class="inline-flex items-center justify-center gap-2 rounded-2xl bg-white text-emerald-600 font-semibold px-5 py-3 shadow-md hover:bg-emerald-50 transition-all duration-200">
                            <i class="fas fa-edit"></i>
                            Edit details
                        </a>
                        {% endif %}
                        {% if can_edit and perms.coordination.delete_organization %}
                        <a href="{% url 'common:coordination_organization_delete' organization.id %}" class="inline-flex items-center justify-center gap-2 rounded-2xl bg-white/15 border border-white/20 px-5 py-3 text-sm font-semibold text-white hover:bg-white/20 transition-all duration-200">
                            <i class="fas fa-trash"></i>
                            Delete organization
                        </a>
                        {% endif %}
                    {% endif %}
                </div>
                {% endwith %}
            </div>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-6">
        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6">
            <p class="text-xs uppercase tracking-wider text-gray-500 font-semibold">Total Contacts</p>
            <p class="mt-2 text-3xl font-bold text-gray-900">{{ contacts|length }}</p>
            <p class="mt-3 text-sm text-gray-500">Primary and supporting contacts maintained for this organization.</p>
        </div>
        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6">
            <p class="text-xs uppercase tracking-wider text-gray-500 font-semibold">Related Partnerships</p>
            <p class="mt-2 text-3xl font-bold text-gray-900">{{ total_partnerships }}</p>
            <p class="mt-3 text-sm text-gray-500">{{ led_partnerships|length }} led • {{ member_partnerships|length }} participating</p>
        </div>
        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6">
            <p class="text-xs uppercase tracking-wider text-gray-500 font-semibold">MOA PPAs Recorded</p>
            <p class="mt-2 text-3xl font-bold text-gray-900">{{ moa_ppas_count }}</p>
            <p class="mt-3 text-sm text-gray-500">Projects and activities tagged under this MOA.</p>
        </div>
        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6">
            <p class="text-xs uppercase tracking-wider text-gray-500 font-semibold">Partnership Level</p>
            <p class="mt-2 text-3xl font-bold text-gray-900">{{ organization.get_partnership_level_display|default:"Not set" }}</p>
            {% if organization.partnership_start_date %}
            <p class="mt-3 text-sm text-gray-500">Since {{ organization.partnership_start_date }}</p>
            {% endif %}
        </div>
        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6">
            <p class="text-xs uppercase tracking-wider text-gray-500 font-semibold">Last Engagement</p>
            <p class="mt-2 text-3xl font-bold text-gray-900">{% if organization.last_engagement_date %}{{ organization.last_engagement_date }}{% else %}Not recorded{% endif %}</p>
            <p class="mt-3 text-sm text-gray-500">Engagement frequency: {{ organization.get_engagement_frequency_display|default:"Not set" }}</p>
        </div>
    </div>
    <div x-data="{ activeTab: 'overview' }" class="mt-8 space-y-6">
        <div class="flex flex-wrap gap-2 border border-gray-200 bg-white rounded-2xl shadow-sm px-4 py-3" role="tablist" aria-label="Organization detail tabs">
            <button type="button"
                    @click="activeTab = 'overview'"
                    :class="activeTab === 'overview' ? 'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-300' : 'text-gray-600 hover:text-emerald-600 hover:bg-emerald-50'"
                    class="inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2"
                    role="tab"
                    :aria-selected="activeTab === 'overview'"
                    :tabindex="activeTab === 'overview' ? 0 : -1"
                    id="org-tab-overview"
                    aria-controls="org-tabpanel-overview">
                <i class="fas fa-id-card"></i>
                Organization Overview
            </button>
            <button type="button"
                    @click="activeTab = 'mandate'"
                    :class="activeTab === 'mandate' ? 'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-300' : 'text-gray-600 hover:text-emerald-600 hover:bg-emerald-50'"
                    class="inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2"
                    role="tab"
                    :aria-selected="activeTab === 'mandate'"
                    :tabindex="activeTab === 'mandate' ? 0 : -1"
                    id="org-tab-mandate"
                    aria-controls="org-tabpanel-mandate">
                <i class="fas fa-gavel"></i>
                Mandate &amp; Functions
            </button>
            <button type="button"
                    @click="activeTab = 'contacts'"
                    :class="activeTab === 'contacts' ? 'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-300' : 'text-gray-600 hover:text-emerald-600 hover:bg-emerald-50'"
                    class="inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2"
                    role="tab"
                    :aria-selected="activeTab === 'contacts'"
                    :tabindex="activeTab === 'contacts' ? 0 : -1"
                    id="org-tab-contacts"
                    aria-controls="org-tabpanel-contacts">
                <i class="fas fa-users"></i>
                Contacts
            </button>
            <button type="button"
                    @click="activeTab = 'partnerships'"
                    :class="activeTab === 'partnerships' ? 'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-300' : 'text-gray-600 hover:text-emerald-600 hover:bg-emerald-50'"
                    class="inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2"
                    role="tab"
                    :aria-selected="activeTab === 'partnerships'"
                    :tabindex="activeTab === 'partnerships' ? 0 : -1"
                    id="org-tab-partnerships"
                    aria-controls="org-tabpanel-partnerships">
                <i class="fas fa-handshake"></i>
                Partnership Details
            </button>
        </div>

        <section x-show="activeTab === 'overview'" x-cloak class="bg-white border border-gray-200 rounded-2xl shadow-sm" id="org-tabpanel-overview" role="tabpanel" aria-labelledby="org-tab-overview">
        <header class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
            <div class="flex items-center gap-3">
                <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-id-card"></i>
                </span>
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Organization Overview</h2>
                    <p class="text-sm text-gray-500">Core profile, contact information, and operational notes.</p>
                </div>
            </div>
        </header>
        <div class="px-6 py-6 space-y-8">
            <dl class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <dt class="text-sm font-semibold text-gray-600">Full Name</dt>
                    <dd class="mt-1 text-base text-gray-900">{{ organization.name }}</dd>
                </div>
                <div>
                    <dt class="text-sm font-semibold text-gray-600">Acronym</dt>
                    <dd class="mt-1 text-base text-gray-900">{{ organization.acronym|default:"&mdash;" }}</dd>
                </div>
                <div>
                    <dt class="text-sm font-semibold text-gray-600">Primary Address</dt>
                    <dd class="mt-1 text-base text-gray-900">{{ organization.address|default:"&mdash;" }}</dd>
                </div>
                <div>
                    <dt class="text-sm font-semibold text-gray-600">Headquarters Location</dt>
                    <dd class="mt-1 text-base text-gray-900">{{ organization.location_display|default:"&mdash;" }}</dd>
                </div>
                <div>
                    <dt class="text-sm font-semibold text-gray-600">Mailing Address</dt>
                    <dd class="mt-1 text-base text-gray-900">{{ organization.mailing_address|default:"&mdash;" }}</dd>
                </div>
                <div>
                    <dt class="text-sm font-semibold text-gray-600">Email</dt>
                    <dd class="mt-1 text-base">
                        {% if organization.email %}
                        <a href="mailto:{{ organization.email }}" class="text-blue-600 hover:text-blue-700">{{ organization.email }}</a>
                        {% else %}
                        <span class="text-gray-900">&mdash;</span>
                        {% endif %}
                    </dd>
                </div>
                <div>
                    <dt class="text-sm font-semibold text-gray-600">Phone</dt>
                    <dd class="mt-1 text-base text-gray-900">{{ organization.phone|default:organization.mobile|default:"&mdash;" }}</dd>
                </div>
                <div>
                    <dt class="text-sm font-semibold text-gray-600">Website</dt>
                    <dd class="mt-1 text-base">
                        {% if organization.website %}
                        <a href="{{ organization.website }}" class="text-blue-600 hover:text-blue-700" target="_blank" rel="noopener">{{ organization.website }}</a>
                        {% else %}
                        <span class="text-gray-900">&mdash;</span>
                        {% endif %}
                    </dd>
                </div>
                <div>
                    <dt class="text-sm font-semibold text-gray-600">Geographic Coverage</dt>
                    <dd class="mt-1 text-base text-gray-900">{{ organization.geographic_coverage|default:"&mdash;" }}</dd>
                </div>
            </dl>

            <dl class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <dt class="text-sm font-semibold text-gray-600">Head of Organization</dt>
                    <dd class="mt-1 text-base text-gray-900">{{ organization.head_of_organization|default:"&mdash;" }}</dd>
                    {% if organization.head_position %}
                    <p class="text-sm text-gray-500">{{ organization.head_position }}</p>
                    {% endif %}
                </div>
                <div>
                    <dt class="text-sm font-semibold text-gray-600">OOBC Focal Person</dt>
                    <dd class="mt-1 text-base text-gray-900">{{ organization.focal_person|default:"&mdash;" }}</dd>
                    {% if organization.focal_person_position or organization.focal_person_contact %}
                    <p class="text-sm text-gray-500">{{ organization.focal_person_position|default:"" }}{% if organization.focal_person_contact %}{% if organization.focal_person_position %} • {% endif %}{{ organization.focal_person_contact }}{% endif %}</p>
                    {% endif %}
                    {% if organization.focal_person_email %}
                    <p class="text-sm"><a class="text-blue-600 hover:text-blue-700" href="mailto:{{ organization.focal_person_email }}">{{ organization.focal_person_email }}</a></p>
                    {% endif %}
                </div>
            </dl>

            <dl class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <dt class="text-sm font-semibold text-gray-600">Areas of Expertise</dt>
                    <dd class="mt-1 text-base text-gray-900 whitespace-pre-line">{{ organization.areas_of_expertise|default:"&mdash;" }}</dd>
                </div>
                <div>
                    <dt class="text-sm font-semibold text-gray-600">Target Beneficiaries</dt>
                    <dd class="mt-1 text-base text-gray-900 whitespace-pre-line">{{ organization.target_beneficiaries|default:"&mdash;" }}</dd>
                </div>
            </dl>

            <dl class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <dt class="text-sm font-semibold text-gray-600">Registration Number</dt>
                    <dd class="mt-1 text-base text-gray-900">{{ organization.registration_number|default:"&mdash;" }}</dd>
                </div>
                <div>
                    <dt class="text-sm font-semibold text-gray-600">Tax Identification Number</dt>
                    <dd class="mt-1 text-base text-gray-900">{{ organization.tax_identification_number|default:"&mdash;" }}</dd>
                </div>
            </dl>

            {% if organization.social_media %}
            <div>
                <dt class="text-sm font-semibold text-gray-600">Social Media</dt>
                <dd class="mt-2">
                    <ul class="space-y-2 text-sm text-gray-700">
                        {% for platform, link in organization.social_media.items %}
                        <li class="flex items-center gap-3">
                            <span class="inline-flex items-center px-3 py-1 rounded-full bg-gray-100 text-gray-700 uppercase tracking-wide text-xs font-semibold">{{ platform }}</span>
                            {% if link %}
                            <a href="{{ link }}" class="text-blue-600 hover:text-blue-700" target="_blank" rel="noopener">{{ link }}</a>
                            {% else %}
                            <span class="text-gray-500">Not provided</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </dd>
            </div>
            {% endif %}

            {% if organization_notes_display %}
            <div>
                <dt class="text-sm font-semibold text-gray-600">Notes</dt>
                <dd class="mt-2 text-sm text-gray-700 whitespace-pre-line">{{ organization_notes_display }}</dd>
            </div>
            {% endif %}
        </div>
    </section>

    <section x-show="activeTab === 'mandate'" x-cloak class="bg-white border border-gray-200 rounded-2xl shadow-sm" id="org-tabpanel-mandate" role="tabpanel" aria-labelledby="org-tab-mandate">
        <header class="flex items-center gap-3 px-6 py-4 border-b border-gray-200">
            <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-emerald-100 text-emerald-600">
                <i class="fas fa-balance-scale"></i>
            </span>
            <div>
                <h2 class="text-lg font-semibold text-gray-900">Mandate and Powers</h2>
                <p class="text-sm text-gray-500">Formal mandate statements and detailed powers and functions.</p>
            </div>
        </header>
        <div class="px-6 py-6 space-y-6">
            {% if organization_mandate_paragraphs or organization.mandate %}
            <section class="rounded-2xl border border-emerald-100 bg-white shadow-sm overflow-hidden">
                <header class="flex items-center gap-3 border-b border-emerald-100 bg-gradient-to-r from-emerald-500/10 via-emerald-500/5 to-transparent px-6 py-4">
                    <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-white/80 text-emerald-600 shadow-sm ring-1 ring-emerald-100">
                        <i class="fas fa-gavel"></i>
                    </span>
                    <div>
                        <p class="text-xs font-semibold uppercase tracking-wider text-emerald-600">Mandate</p>
                        <p class="text-sm text-emerald-900/70">Core purpose of the organization</p>
                    </div>
                </header>
                <div class="px-6 py-5">
                    <div class="prose prose-sm max-w-none text-gray-700 leading-relaxed space-y-3">
                        {% for paragraph in organization_mandate_paragraphs %}
                        <p>{{ paragraph }}</p>
                        {% empty %}
                            {% if organization.mandate %}
                            <p>{{ organization.mandate }}</p>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </section>
            {% endif %}

            {% if organization_powers_and_functions or organization.powers_and_functions %}
            <section class="rounded-2xl border border-cyan-100 bg-white shadow-sm overflow-hidden">
                <header class="flex items-center gap-3 border-b border-cyan-100 bg-gradient-to-r from-cyan-500/10 via-cyan-500/5 to-transparent px-6 py-4">
                    <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-white/80 text-cyan-600 shadow-sm ring-1 ring-cyan-100">
                        <i class="fas fa-list-check"></i>
                    </span>
                    <div>
                        <p class="text-xs font-semibold uppercase tracking-wider text-cyan-600">Powers and Functions</p>
                        <p class="text-sm text-cyan-900/70">Mandated responsibilities and authorities</p>
                    </div>
                </header>
                <div class="px-6 py-5">
                    {% if organization_powers_and_functions %}
                    <ol class="space-y-1">
                        {% for item in organization_powers_and_functions %}
                        <li class="group flex gap-2.5 rounded-lg border border-transparent bg-white py-1.5 px-2.5 transition-all duration-200 hover:border-cyan-200 hover:bg-cyan-50/60">
                            <span class="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-cyan-500/15 text-[11px] font-semibold text-cyan-600 ring-1 ring-inset ring-cyan-200/70">
                                {{ forloop.counter }}
                            </span>
                            <span class="text-sm text-gray-700 leading-relaxed">{{ item }}</span>
                        </li>
                        {% endfor %}
                    </ol>
                    {% elif organization.powers_and_functions %}
                    <div class="prose prose-sm max-w-none text-gray-700 leading-relaxed space-y-3">
                        <p>{{ organization.powers_and_functions }}</p>
                    </div>
                    {% endif %}
                </div>
            </section>
            {% endif %}
            {% if not organization_mandate_paragraphs and not organization.mandate and not organization_powers_and_functions and not organization.powers_and_functions %}
            <p class="text-sm text-gray-500">No mandate or powers information recorded for this organization.</p>
            {% endif %}
        </div>
    </section>

    <section x-show="activeTab === 'contacts'" x-cloak class="bg-white border border-gray-200 rounded-2xl shadow-sm" id="org-tabpanel-contacts" role="tabpanel" aria-labelledby="org-tab-contacts">
        <header class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
            <div class="flex items-center gap-3">
                <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-teal-100 text-teal-600">
                    <i class="fas fa-users"></i>
                </span>
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Contacts</h2>
                    <p class="text-sm text-gray-500">Primary and secondary contacts managing coordination touchpoints.</p>
                </div>
            </div>
            <a href="{% url 'common:coordination_organization_edit' organization.id %}#contacts-container" class="text-sm font-medium text-blue-600 hover:text-blue-700">Manage contacts</a>
        </header>
        <div class="px-6 py-6 space-y-6">
            {% if contacts %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for contact in contacts %}
                <article class="border border-gray-200 rounded-xl shadow-sm p-5 bg-gray-50">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">{{ contact.display_name }}</h3>
                            <p class="text-sm text-gray-500">{{ contact.position }}{% if contact.department %} • {{ contact.department }}{% endif %}</p>
                            <p class="mt-1 text-xs uppercase tracking-wide text-gray-500">{{ contact.get_contact_type_display }}</p>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            {% if contact.is_primary %}
                            <span class="inline-flex items-center px-3 py-1 text-xs font-semibold text-white bg-blue-600 rounded-full">Primary</span>
                            {% endif %}
                            {% if not contact.is_active %}
                            <span class="inline-flex items-center px-3 py-1 text-xs font-semibold text-white bg-gray-500 rounded-full">Inactive</span>
                            {% endif %}
                        </div>
                    </div>
                    <ul class="mt-4 space-y-2 text-sm text-gray-700">
                        {% if contact.email %}
                        <li><i class="fas fa-envelope mr-2 text-gray-400"></i><a href="mailto:{{ contact.email }}" class="text-blue-600 hover:text-blue-700">{{ contact.email }}</a></li>
                        {% endif %}
                        {% if contact.alternative_email %}
                        <li><i class="fas fa-at mr-2 text-gray-400"></i><a href="mailto:{{ contact.alternative_email }}" class="text-blue-600 hover:text-blue-700">{{ contact.alternative_email }}</a></li>
                        {% endif %}
                        {% if contact.phone %}
                        <li><i class="fas fa-phone mr-2 text-gray-400"></i>{{ contact.phone }}</li>
                        {% endif %}
                        {% if contact.mobile %}
                        <li><i class="fas fa-mobile-alt mr-2 text-gray-400"></i>{{ contact.mobile }}</li>
                        {% endif %}
                        {% if contact.preferred_communication_method %}
                        <li><i class="fas fa-comments mr-2 text-gray-400"></i>Prefers {{ contact.get_preferred_communication_method_display }}</li>
                        {% endif %}
                        {% if contact.best_contact_time %}
                        <li><i class="fas fa-clock mr-2 text-gray-400"></i>{{ contact.best_contact_time }}</li>
                        {% endif %}
                    </ul>
                    {% if contact.areas_of_responsibility %}
                    <p class="mt-4 text-sm text-gray-600"><span class="font-semibold">Responsibilities:</span> {{ contact.areas_of_responsibility }}</p>
                    {% endif %}
                    {% if contact.languages_spoken %}
                    <p class="mt-1 text-sm text-gray-600"><span class="font-semibold">Languages:</span> {{ contact.languages_spoken }}</p>
                    {% endif %}
                    {% if contact.notes %}
                    <p class="mt-1 text-sm text-gray-600"><span class="font-semibold">Notes:</span> {{ contact.notes }}</p>
                    {% endif %}
                </article>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-sm text-gray-500">No contacts recorded yet. Use the edit action to add contact information.</p>
            {% endif %}
        </div>
    </section>

    <section x-show="activeTab === 'partnerships'" x-cloak class="bg-white border border-gray-200 rounded-2xl shadow-sm" id="org-tabpanel-partnerships" role="tabpanel" aria-labelledby="org-tab-partnerships">
        <header class="flex items-center gap-3 px-6 py-4 border-b border-gray-200">
            <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-purple-100 text-purple-600">
                <i class="fas fa-handshake"></i>
            </span>
            <div>
                <h2 class="text-lg font-semibold text-gray-900">Partnerships</h2>
                <p class="text-sm text-gray-500">Active agreements and collaborations involving this organization.</p>
            </div>
        </header>
        <div class="px-6 py-6 space-y-6">
            <div>
                <h3 class="text-md font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-flag text-blue-500"></i>
                    Led partnerships
                </h3>
                {% if led_partnerships %}
                <ul class="mt-3 space-y-3">
                    {% for partnership in led_partnerships %}
                    <li class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                            <div>
                                <p class="text-base font-semibold text-gray-900">{{ partnership.title }}</p>
                                <p class="text-sm text-gray-500">Status: {{ partnership.get_status_display|default:partnership.status|title }}</p>
                            </div>
                            <a href="{% url 'common:coordination_partnerships' %}?search={{ partnership.title|urlencode }}" class="text-sm font-medium text-blue-600 hover:text-blue-700">View partnership</a>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="mt-2 text-sm text-gray-500">No partnerships led by this organization.</p>
                {% endif %}
            </div>

            <div>
                <h3 class="text-md font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-users text-green-500"></i>
                    Participating partnerships
                </h3>
                {% if member_partnerships %}
                <ul class="mt-3 space-y-3">
                    {% for partnership in member_partnerships %}
                    <li class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                            <div>
                                <p class="text-base font-semibold text-gray-900">{{ partnership.title }}</p>
                                <p class="text-sm text-gray-500">Lead: {{ partnership.lead_organization.display_name|default:partnership.lead_organization.name }}</p>
                            </div>
                            <a href="{% url 'common:coordination_partnerships' %}?search={{ partnership.title|urlencode }}" class="text-sm font-medium text-blue-600 hover:text-blue-700">View partnership</a>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="mt-2 text-sm text-gray-500">No additional partnerships recorded.</p>
                {% endif %}
            </div>
        </div>
    </section>

    </div>

    <!-- MOA Management Section: Gradient Header + Tabs (BEFORE Special Provisions) -->
    {% if organization.organization_type == 'bmoa' %}
    <section id="moa-management" class="mt-8">
        <!-- Gradient Header -->
        <div class="relative overflow-hidden rounded-t-3xl bg-gradient-to-r from-blue-600 via-teal-500 to-emerald-600 shadow-xl">
            <div class="absolute inset-0 bg-white/10 opacity-20 mix-blend-overlay"></div>
            <div class="absolute top-0 right-0 w-96 h-96 bg-white/10 rounded-full -mr-48 -mt-48"></div>

            <div class="relative px-6 sm:px-10 py-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center border border-white/30">
                        <i class="fas fa-sitemap text-2xl text-white"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-white">MOA Management</h2>
                        <p class="text-white/90 text-sm">Programmes, Projects, Activities, Work Items, Calendar, and Budget Tracking</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation and Content -->
        <div class="bg-white border border-gray-200 rounded-b-2xl shadow-sm overflow-hidden">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 px-6" aria-label="MOA Management Tabs">
                    <button type="button"
                            onclick="switchMOATab('ppa-database')"
                            id="moa-tab-ppa-database"
                            class="moa-tab border-b-2 border-blue-500 text-blue-600 py-4 px-1 text-sm font-medium">
                        <i class="fas fa-database mr-2"></i>
                        MOA PPA Database
                    </button>
                    <button type="button"
                            onclick="switchMOATab('work-items')"
                            id="moa-tab-work-items"
                            class="moa-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                        <i class="fas fa-tasks mr-2"></i>
                        Work Items
                    </button>
                    <button type="button"
                            onclick="switchMOATab('calendar')"
                            id="moa-tab-calendar"
                            class="moa-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                        <i class="fas fa-calendar-alt mr-2"></i>
                        Calendar
                    </button>
                    <button type="button"
                            onclick="switchMOATab('budget')"
                            id="moa-tab-budget"
                            class="moa-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                        <i class="fas fa-chart-pie mr-2"></i>
                        Budget Tracking
                    </button>
                </nav>
            </div>

            <!-- Tab Content Container -->
            <div id="moa-tab-content" class="p-6">
                <!-- PPA Database Tab (Default) -->
                <div id="moa-ppa-database-tab-content" class="moa-tab-content-panel">
                    {% include "coordination/partials/moa_ppa_database_tab.html" %}
                </div>

                <!-- Work Items Tab -->
                <div id="moa-work-items-tab-content"
                     class="moa-tab-content-panel hidden"
                     data-organization-id="{{ organization.id }}"
                     data-refresh-url="{% url 'common:coordination_organization_work_items_partial' organization_id=organization.id %}">
                    {% include "coordination/partials/moa_work_items_tab.html" %}
                </div>

                <!-- Calendar Tab -->
                <div id="moa-calendar-tab-content" class="moa-tab-content-panel hidden">
                    {% include "coordination/partials/moa_calendar_tab.html" %}
                </div>

                <!-- Budget Tab -->
                <div id="moa-budget-tab-content" class="moa-tab-content-panel hidden">
                    {% include "coordination/partials/moa_budget_tab.html" %}
                </div>
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Special Provisions Section (Standalone - AFTER MOA Management) -->
    {% if organization.organization_type == 'bmoa' and moa_special_provisions_text or ppa_special_provisions %}
    <section class="mt-8 bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
        <header class="bg-gradient-to-r from-indigo-500 to-blue-500 px-6 py-4 flex items-center gap-3 text-white">
            <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-white/20 text-2xl">
                <i class="fas fa-scroll"></i>
            </span>
            <div>
                <h2 class="text-lg font-semibold">Special Provisions</h2>
                <p class="text-sm text-white/80">Mapped directly from the FY2025 General Appropriations Act.</p>
            </div>
        </header>
        <div class="px-6 py-6 space-y-6">
            {% if moa_special_provisions_text %}
            <article class="border border-indigo-100 rounded-xl bg-indigo-50/60 p-5 shadow-sm">
                <h3 class="text-base font-semibold text-indigo-900 flex items-center gap-2">
                    <i class="fas fa-landmark"></i>
                    MOA-wide directives
                </h3>
                <div class="mt-3 text-sm text-indigo-900/90">
                    {{ moa_special_provisions_text|linebreaksbr }}
                </div>
            </article>
            {% endif %}

            {% if ppa_special_provisions %}
            <div class="space-y-4">
                {% for item in ppa_special_provisions %}
                <article class="border border-gray-200 rounded-xl p-5 shadow-sm bg-gray-50/80">
                    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                        <div>
                            <h3 class="text-sm font-semibold text-gray-900">{{ item.entry.title }}</h3>
                            <p class="mt-1 text-xs uppercase tracking-wide text-gray-500">Fiscal Year {{ item.entry.fiscal_year|default:"—" }}</p>
                        </div>
                        <a href="{% url 'monitoring:detail' item.entry.id %}" class="inline-flex items-center gap-2 text-xs font-semibold text-blue-600 hover:text-blue-700">
                            <i class="fas fa-external-link-alt"></i>
                            View PPA
                        </a>
                    </div>
                    <div class="mt-3 text-sm text-gray-700">
                        {{ item.text|linebreaksbr }}
                    </div>
                </article>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-sm text-gray-500">No PPA-level special provisions are recorded for this organization.</p>
            {% endif %}
        </div>
    </section>
    {% endif %}
</div>

<script>
// Tab switching for MOA profile page
function switchMOATab(tabName) {
    // Hide all tab panels
    document.querySelectorAll('.moa-tab-content-panel').forEach(panel => {
        panel.classList.add('hidden');
    });

    // Remove active state from all tabs
    document.querySelectorAll('.moa-tab').forEach(tab => {
        tab.classList.remove('border-blue-500', 'text-blue-600');
        tab.classList.add('border-transparent', 'text-gray-500');
    });

    // Show selected tab panel
    const selectedPanel = document.getElementById(`moa-${tabName}-tab-content`);
    if (selectedPanel) {
        selectedPanel.classList.remove('hidden');
    }

    // Activate selected tab
    const selectedTab = document.getElementById(`moa-tab-${tabName}`);
    if (selectedTab) {
        selectedTab.classList.remove('border-transparent', 'text-gray-500');
        selectedTab.classList.add('border-blue-500', 'text-blue-600');
    }
}

// Set default tab on page load
document.addEventListener('DOMContentLoaded', function() {
    switchMOATab('ppa-database');
});

var lastMoaRefreshMeta = {
    time: 0,
    workItemId: null,
    eventType: null,
};

function refreshMoaWorkItems(event) {
    const payload = (event && event.detail) ? event.detail : {};
    const eventType = (event && event.type) ? event.type : 'manual';
    const now = Date.now();

    if (
        payload.workItemId
        && lastMoaRefreshMeta.workItemId === payload.workItemId
        && lastMoaRefreshMeta.eventType !== eventType
        && now - lastMoaRefreshMeta.time < 250
    ) {
        return;
    }

    lastMoaRefreshMeta = {
        time: now,
        workItemId: payload.workItemId || null,
        eventType,
    };

    const tabContent = document.getElementById('moa-work-items-tab-content');
    if (!tabContent) {
        return;
    }

    const organizationId = payload.organizationId || tabContent.dataset.organizationId;
    const refreshUrl = tabContent.dataset.refreshUrl
        || (organizationId ? `/coordination/organizations/${organizationId}/work-items/partial/` : null);

    if (!window.htmx || !refreshUrl) {
        window.location.reload();
        return;
    }

    tabContent.setAttribute('aria-busy', 'true');
    tabContent.classList.add('opacity-50', 'pointer-events-none');

    htmx.ajax('GET', refreshUrl, {
        target: '#moa-work-items-tab-content',
        swap: 'innerHTML swap:300ms',
    }).then(() => {
        tabContent.classList.remove('opacity-50', 'pointer-events-none');
        tabContent.removeAttribute('aria-busy');

        const workItemId = payload.workItemId;
        if (workItemId) {
            const highlightRow = tabContent.querySelector(`[data-work-item-id="${workItemId}"]`);
            if (highlightRow) {
                highlightRow.classList.add('bg-emerald-50');
                highlightRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => highlightRow.classList.remove('bg-emerald-50'), 2000);
            }
        }
    }).catch(() => {
        tabContent.classList.remove('opacity-50', 'pointer-events-none');
        tabContent.removeAttribute('aria-busy');

        document.body.dispatchEvent(new CustomEvent('showToast', {
            detail: {
                message: 'Failed to refresh work items. Please reload the page.',
                level: 'error',
            },
        }));
    });
}

document.body.addEventListener('refreshMoaWorkItems', refreshMoaWorkItems);
document.body.addEventListener('workItemCreated', function(event) {
    const detail = (event && event.detail) ? event.detail : {};
    if (detail.context && detail.context !== 'moa') {
        return;
    }
    refreshMoaWorkItems(event);
});
</script>
{% endblock %}
