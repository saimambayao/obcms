{% load static humanize math_extras %}

<!-- MOA Budget Tracking Tab -->
<!-- Displays budget summary and tracking across all PPAs of this MOA -->

<div class="space-y-6">
    <!-- Budget Description -->
    <div class="bg-blue-50 border-l-4 border-blue-500 rounded-r-lg p-4">
        <div class="flex items-start">
            <i class="fas fa-info-circle text-blue-500 text-xl mt-0.5 mr-3"></i>
            <div class="text-sm text-blue-800">
                <p class="font-semibold mb-1">MOA Budget Overview</p>
                <p>This section provides a consolidated view of budget allocations, expenditures, and variance across all PPAs implemented by <strong>{{ organization.name }}</strong>.</p>
            </div>
        </div>
    </div>

    <!-- Budget Summary Stats -->
    <!-- Row 1: Budget metrics (3 columns) -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Total MOA Budget -->
        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs uppercase tracking-wider text-gray-500 font-semibold">Total MOA Budget</p>
                    <p class="mt-2 text-2xl font-bold text-gray-900">₱{{ moa_budget_stats.total_budget|floatformat:2|intcomma|default:"0.00" }}</p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-wallet text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Total PPA Budget -->
        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs uppercase tracking-wider text-gray-500 font-semibold">Total PPA Budget</p>
                    <p class="mt-2 text-2xl font-bold text-emerald-600">₱{{ moa_budget_stats.total_budget|floatformat:2|intcomma|default:"0.00" }}</p>
                </div>
                <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-hand-holding-usd text-emerald-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Total PPA Work Item Budget -->
        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6">
            <div class="flex items-center justify-between">
                {% if moa_budget_stats.has_work_item_budget %}
                <div>
                    <p class="text-xs uppercase tracking-wider text-gray-500 font-semibold">Total PPA Work Item Budget</p>
                    <p class="mt-2 text-2xl font-bold text-orange-600">₱{{ moa_budget_stats.total_work_item_budget|floatformat:2|intcomma|default:"0.00" }}</p>
                </div>
                {% else %}
                <div>
                    <p class="text-xs uppercase tracking-wider text-gray-500 font-semibold">Total PPA Work Item Budget</p>
                    <p class="mt-2 text-base font-semibold text-gray-500">No work item budgets recorded yet</p>
                </div>
                {% endif %}
                <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-tasks text-orange-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 2: Utilization metrics (2 columns) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Total Expenditure -->
        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs uppercase tracking-wider text-gray-500 font-semibold">Total Expenditure</p>
                    <p class="mt-2 text-2xl font-bold text-purple-600">₱{{ moa_budget_stats.total_expenditure|floatformat:2|intcomma|default:"0.00" }}</p>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-receipt text-purple-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Utilization Rate -->
        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs uppercase tracking-wider text-gray-500 font-semibold">Utilization Rate</p>
                    <p class="mt-2 text-2xl font-bold text-teal-600">{{ moa_budget_stats.utilization_rate|floatformat:1|default:"0.0" }}%</p>
                </div>
                <div class="w-12 h-12 bg-teal-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-chart-pie text-teal-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- PPAs Budget Breakdown -->
    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
                Budget Breakdown by PPA
            </h3>
            <p class="text-sm text-gray-500 mt-1">Budget allocation and expenditure details for each PPA</p>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gradient-to-r from-blue-600 to-emerald-600">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider">
                            PPA Title
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider">
                            Fiscal Year
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-semibold text-white uppercase tracking-wider">
                            Budget Allocation
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-semibold text-white uppercase tracking-wider">
                            Work Item Budget
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-semibold text-white uppercase tracking-wider">
                            Expenditure
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-semibold text-white uppercase tracking-wider">
                            Variance
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-semibold text-white uppercase tracking-wider">
                            Utilization
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-semibold text-white uppercase tracking-wider">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for ppa in moa_ppas %}
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">{{ ppa.title }}</div>
                            {% if ppa.program_code %}
                            <div class="text-xs text-gray-500">Code: {{ ppa.program_code }}</div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ ppa.fiscal_year|default:"—" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-gray-900">
                            ₱{{ ppa.budget_allocation|floatformat:2|intcomma|default:"0.00" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-700">
                            {% if ppa.has_work_item_budget %}
                            ₱{{ ppa.work_item_budget|floatformat:2|intcomma }}
                            {% else %}
                            —
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-purple-600">
                            ₱{{ ppa.total_expenditure|floatformat:2|intcomma|default:"0.00" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium {% if ppa.variance < 0 %}text-red-600{% elif ppa.variance > 0 %}text-emerald-600{% else %}text-gray-600{% endif %}">
                            {% if ppa.variance < 0 %}
                            -₱{{ ppa.variance|abs|floatformat:2|intcomma }}
                            {% elif ppa.variance > 0 %}
                            +₱{{ ppa.variance|floatformat:2|intcomma }}
                            {% else %}
                            ₱0.00
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <div class="flex items-center justify-end">
                                <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-gradient-to-r from-emerald-500 to-emerald-600 h-2 rounded-full" style="width: {{ ppa.utilization_rate }}%"></div>
                                </div>
                                <span class="text-sm text-gray-700">{{ ppa.utilization_rate|floatformat:0 }}%</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <a href="/monitoring/entry/{{ ppa.id }}/" class="text-blue-600 hover:text-blue-900">
                                <i class="fas fa-eye mr-1"></i> View
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="px-6 py-10 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl text-gray-400 mb-3"></i>
                            <p>No PPAs found for this MOA.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% if moa_ppas %}
                <tfoot class="bg-gray-50 border-t-2 border-gray-300">
                    <tr class="font-semibold">
                        <td colspan="2" class="px-6 py-4 text-sm text-gray-900">
                            TOTAL
                        </td>
                        <td class="px-6 py-4 text-right text-sm text-gray-900">
                            ₱{{ moa_budget_stats.total_budget|floatformat:2|intcomma|default:"0.00" }}
                        </td>
                        <td class="px-6 py-4 text-right text-sm text-gray-900">
                            {% if moa_budget_stats.has_work_item_budget %}
                            ₱{{ moa_budget_stats.total_work_item_budget|floatformat:2|intcomma|default:"0.00" }}
                            {% else %}
                            —
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-right text-sm text-purple-600">
                            ₱{{ moa_budget_stats.total_expenditure|floatformat:2|intcomma|default:"0.00" }}
                        </td>
                        <td class="px-6 py-4 text-right text-sm {% if moa_budget_stats.total_variance < 0 %}text-red-600{% elif moa_budget_stats.total_variance > 0 %}text-emerald-600{% else %}text-gray-600{% endif %}">
                            {% if moa_budget_stats.total_variance < 0 %}
                            -₱{{ moa_budget_stats.total_variance|abs|floatformat:2|intcomma }}
                            {% elif moa_budget_stats.total_variance > 0 %}
                            +₱{{ moa_budget_stats.total_variance|floatformat:2|intcomma }}
                            {% else %}
                            ₱0.00
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-right text-sm text-gray-900">
                            {{ moa_budget_stats.utilization_rate|floatformat:1 }}%
                        </td>
                        <td class="px-6 py-4"></td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>

    <!-- Budget Insights -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
            <h4 class="text-md font-semibold text-gray-900 flex items-center mb-4">
                <i class="fas fa-lightbulb text-amber-500 mr-2"></i>
                Budget Insights
            </h4>
            <ul class="space-y-3 text-sm text-gray-700">
                <li class="flex items-start">
                    <i class="fas fa-check-circle text-emerald-500 mr-2 mt-1"></i>
                    <span><strong>Budget Allocation:</strong> {{ moa_ppas|length }} PPA{{ moa_ppas|length|pluralize }} with total budget of ₱{{ moa_budget_stats.total_budget|floatformat:2|intcomma }}</span>
                </li>
                <li class="flex items-start">
                    <i class="fas fa-chart-line text-blue-500 mr-2 mt-1"></i>
                    <span><strong>Utilization:</strong> {{ moa_budget_stats.utilization_rate|floatformat:1 }}% of allocated budget has been utilized</span>
                </li>
                <li class="flex items-start">
                    {% if moa_budget_stats.total_variance < 0 %}
                    <i class="fas fa-exclamation-triangle text-red-500 mr-2 mt-1"></i>
                    <span><strong>Budget Variance:</strong> ₱{{ moa_budget_stats.total_variance|abs|floatformat:2|intcomma }} under budget</span>
                    {% elif moa_budget_stats.total_variance > 0 %}
                    <i class="fas fa-exclamation-circle text-amber-500 mr-2 mt-1"></i>
                    <span><strong>Budget Variance:</strong> ₱{{ moa_budget_stats.total_variance|floatformat:2|intcomma }} over budget</span>
                    {% else %}
                    <i class="fas fa-check-circle text-emerald-500 mr-2 mt-1"></i>
                    <span><strong>Budget Variance:</strong> On budget (no variance)</span>
                    {% endif %}
                </li>
            </ul>
        </div>

        <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
            <h4 class="text-md font-semibold text-gray-900 flex items-center mb-4">
                <i class="fas fa-tasks text-purple-500 mr-2"></i>
                Recommendations
            </h4>
            <ul class="space-y-3 text-sm text-gray-700">
                {% if moa_budget_stats.utilization_rate < 50 %}
                <li class="flex items-start">
                    <i class="fas fa-arrow-up text-amber-500 mr-2 mt-1"></i>
                    <span>Low budget utilization ({{ moa_budget_stats.utilization_rate|floatformat:1 }}%). Consider accelerating project activities or reallocating funds.</span>
                </li>
                {% elif moa_budget_stats.utilization_rate > 90 %}
                <li class="flex items-start">
                    <i class="fas fa-exclamation-circle text-red-500 mr-2 mt-1"></i>
                    <span>High budget utilization ({{ moa_budget_stats.utilization_rate|floatformat:1 }}%). Monitor closely to avoid overruns.</span>
                </li>
                {% else %}
                <li class="flex items-start">
                    <i class="fas fa-check-circle text-emerald-500 mr-2 mt-1"></i>
                    <span>Budget utilization ({{ moa_budget_stats.utilization_rate|floatformat:1 }}%) is within healthy range.</span>
                </li>
                {% endif %}
                <li class="flex items-start">
                    <i class="fas fa-sync text-blue-500 mr-2 mt-1"></i>
                    <span>Regularly update work item expenditures to maintain accurate budget tracking.</span>
                </li>
                <li class="flex items-start">
                    <i class="fas fa-chart-bar text-purple-500 mr-2 mt-1"></i>
                    <span>Review budget distribution across PPAs to ensure optimal resource allocation.</span>
                </li>
            </ul>
        </div>
    </div>
</div>
