{% load humanize %}
<section class="bg-white border border-gray-200 rounded-2xl shadow-lg overflow-hidden">
    <header class="bg-gradient-to-r from-indigo-500 to-blue-500 px-6 py-4 flex items-center gap-3 text-white">
        <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-white/20 text-2xl"><i class="fas fa-database"></i></span>
        <div>
            <h2 class="text-lg font-semibold">MOA PPA Database</h2>
            <p class="text-sm text-white/80">Programmes, projects, and activities implemented by this MOA.</p>
        </div>
    </header>
    <div class="px-6 py-4 text-sm text-gray-600 border-b border-gray-200 flex items-center justify-between flex-wrap gap-2">
        <span>{{ moa_ppas_count }} {{ moa_ppas_count|pluralize:"entry,entries" }} documented</span>
        <a href="{% url 'monitoring:create_moa' %}" class="inline-flex items-center gap-2 rounded-xl bg-white text-indigo-600 border border-white/50 px-4 py-2 font-semibold shadow-sm hover:bg-indigo-50 transition-all duration-200">
            <i class="fas fa-plus-circle"></i>
            Add MOA PPA
        </a>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-500">PPA</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-500">Budget</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-500">Budget Share for OBC</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-500">Fiscal Year</th>
                    <th scope="col" class="px-6 py-3 text-right text-xs font-semibold uppercase tracking-wide text-gray-500">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-100">
                {% for entry in moa_ppas %}
                <tr class="hover:bg-gray-50 transition-colors duration-150">
                    <td class="px-6 py-4 align-top">
                        <div class="flex gap-3">
                            <div class="hidden sm:flex h-10 w-10 items-center justify-center rounded-xl bg-blue-100 text-blue-600"><i class="fas fa-briefcase"></i></div>
                            <div class="space-y-1 max-w-xl">
                                <p class="text-sm font-semibold text-gray-900 break-words leading-tight">{{ entry.title }}</p>
                                <p class="text-xs text-gray-500 break-words">Implementing MOA: {{ entry.implementing_moa.name|default:organization.name }}</p>
                                {% if entry.summary %}
                                <p class="text-xs text-gray-400 break-words leading-snug">{{ entry.summary }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 align-top text-sm text-gray-800 whitespace-normal break-words">
                        {% if entry.budget_allocation %}
                            ₱{{ entry.budget_allocation|floatformat:2|intcomma }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 align-top text-sm text-gray-800 whitespace-normal break-words">
                        {% if entry.budget_obc_allocation %}
                            ₱{{ entry.budget_obc_allocation|floatformat:2|intcomma }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 align-top text-sm text-gray-800 whitespace-normal">{{ entry.fiscal_year|default:"—" }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center justify-end gap-2">
                            <a href="{% url 'monitoring:detail' entry.id %}" class="inline-flex items-center rounded-lg border border-blue-200 bg-blue-50 px-3 py-1.5 text-xs font-semibold text-blue-600 hover:bg-blue-100">
                                View
                            </a>
                            <a href="{% url 'project_central:moa_ppa_edit' entry.id %}" class="inline-flex items-center rounded-lg border border-indigo-200 bg-indigo-50 px-3 py-1.5 text-xs font-semibold text-indigo-600 hover:bg-indigo-100">
                                Edit
                            </a>
                            <button type="button" class="inline-flex items-center justify-center rounded-lg border border-rose-200 bg-rose-50 px-3 py-1.5 text-xs font-semibold text-rose-600 hover:bg-rose-100"
                                data-delete-preview="{% url 'project_central:moa_ppa_detail' entry.id %}?review_delete=1"
                                data-delete-message="Review this MOA PPA before confirming deletion.">
                                <i class="fas fa-trash"></i>
                                <span class="sr-only">Delete</span>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="px-6 py-10 text-center text-sm text-gray-500">No MOA PPAs are documented for this organization yet.</td>
                </tr>
                {% endfor %}
            </tbody>
            {% if moa_ppas_count %}
            <tfoot class="bg-gray-50 border-t border-gray-200">
                <tr>
                    <td class="px-6 py-3 text-sm font-semibold text-gray-900">Total budget</td>
                    <td class="px-6 py-3 text-sm font-semibold text-gray-900">
                        {% if moa_ppas_total_budget %}
                            ₱{{ moa_ppas_total_budget|floatformat:2|intcomma }}
                        {% else %}
                            ₱0.00
                        {% endif %}
                    </td>
                    <td class="px-6 py-3 text-sm text-gray-500">—</td>
                    <td class="px-6 py-3 text-sm text-gray-500">—</td>
                    <td class="px-6 py-3"></td>
                </tr>
            </tfoot>
            {% endif %}
        </table>
    </div>
</section>

{% if moa_special_text or ppa_special_items %}
<section class="mt-8 bg-white border border-gray-200 rounded-2xl shadow-lg overflow-hidden">
    <header class="bg-gradient-to-r from-indigo-500 to-blue-500 px-6 py-4 flex items-center gap-3 text-white">
        <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-white/20 text-2xl"><i class="fas fa-scroll"></i></span>
        <div>
            <h2 class="text-lg font-semibold">Special Provisions</h2>
            <p class="text-sm text-white/80">Mapped directly from the FY2025 General Appropriations Act.</p>
        </div>
    </header>
    <div class="px-6 py-6 space-y-6">
        {% if moa_special_text %}
        <article class="border border-indigo-100 rounded-xl bg-indigo-50/60 p-5 shadow-sm">
            <h3 class="text-base font-semibold text-indigo-900 flex items-center gap-2">
                <i class="fas fa-landmark"></i>
                MOA-wide directives
            </h3>
            <div class="mt-3 text-sm text-indigo-900/90">
                {{ moa_special_text|linebreaksbr }}
            </div>
        </article>
        {% endif %}

        {% if ppa_special_items %}
        <div class="space-y-4">
            {% for item in ppa_special_items %}
            <article class="border border-gray-200 rounded-xl p-5 shadow-sm bg-gray-50/80">
                <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-900">{{ item.entry.title }}</h3>
                        <p class="mt-1 text-xs uppercase tracking-wide text-gray-500">Fiscal Year {{ item.entry.fiscal_year|default:"—" }}</p>
                    </div>
                    <a href="{% url 'monitoring:detail' item.entry.id %}" class="inline-flex items-center gap-2 text-xs font-semibold text-blue-600 hover:text-blue-700">
                        <i class="fas fa-external-link-alt"></i>
                        View PPA
                    </a>
                </div>
                <div class="mt-3 text-sm text-gray-700">
                    {{ item.text|linebreaksbr }}
                </div>
            </article>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-sm text-gray-500">No PPA-level special provisions are recorded for this organization.</p>
        {% endif %}
    </div>
</section>
{% endif %}
