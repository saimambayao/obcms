{% extends "base.html" %}

{% block title %}{{ page_title|default:"Schedule Recurring Event" }}{% endblock %}

{% block breadcrumb %}
<li>
    <a href="{% url 'common:dashboard' %}" class="text-neutral-500 hover:text-neutral-700">Dashboard</a>
</li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li>
    <a href="{% url 'coordination:home' %}" class="text-neutral-500 hover:text-neutral-700">Coordination</a>
</li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li>
    <a href="{% url 'coordination:events' %}" class="text-neutral-500 hover:text-neutral-700">Events</a>
</li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li class="text-neutral-800 font-semibold">{{ page_heading|default:page_title|default:"Schedule Recurring" }}</li>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                <i class="fas fa-calendar-check text-emerald-600 mr-4"></i>
                {{ page_heading|default:"Schedule New Recurring Event" }}
            </h1>
            <p class="mt-2 text-gray-600 max-w-2xl">
                Create a recurring event with automated instance generation based on your schedule pattern.
            </p>
        </div>
        <a href="{{ return_url }}" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50">
            <i class="fas fa-arrow-left mr-2"></i>
            Back to events
        </a>
    </div>

    <form method="post" class="space-y-8" novalidate>
        {% csrf_token %}

        {% if event_form.non_field_errors or pattern_form.non_field_errors %}
        <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
            {{ event_form.non_field_errors|join:' ' }}
            {{ pattern_form.non_field_errors|join:' ' }}
        </div>
        {% endif %}

        <section class="bg-white border border-gray-200 rounded-2xl shadow-sm">
            <header class="bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-4 rounded-t-2xl text-white">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-info-circle mr-3"></i>
                    Basic Information
                </h2>
            </header>
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% include "components/form_field.html" with field=event_form.title %}
                    {% include "components/form_field.html" with field=event_form.event_type %}
                    {% include "components/form_field.html" with field=event_form.status %}
                    {% include "components/form_field.html" with field=event_form.priority %}
                    {% include "components/form_field.html" with field=event_form.description wrapper_class="md:col-span-2" %}
                    {% include "components/form_field.html" with field=event_form.objectives wrapper_class="md:col-span-2" %}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% include "components/form_field.html" with field=event_form.community %}
                    {% include "components/form_field.html" with field=event_form.organizations %}
                </div>
            </div>
        </section>

        <section class="bg-white border border-gray-200 rounded-2xl shadow-sm">
            <header class="bg-gradient-to-r from-emerald-500 to-teal-600 px-6 py-4 rounded-t-2xl text-white">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-clock mr-3"></i>
                    First Event Schedule
                </h2>
                <p class="text-emerald-50 text-sm mt-1">Configure the start date and time for the first occurrence</p>
            </header>
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    {% include "components/form_field.html" with field=event_form.start_date wrapper_class="md:col-span-2" %}
                    {% include "components/form_field.html" with field=event_form.start_time %}
                    {% include "components/form_field.html" with field=event_form.duration_hours %}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% include "components/form_field.html" with field=event_form.venue %}
                    {% include "components/form_field.html" with field=event_form.address wrapper_class="md:col-span-2" %}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {% include "components/form_field.html" with field=event_form.is_virtual %}
                    {% include "components/form_field.html" with field=event_form.virtual_platform %}
                    {% include "components/form_field.html" with field=event_form.virtual_link %}
                </div>
            </div>
        </section>

        <section class="bg-white border border-gray-200 rounded-2xl shadow-sm">
            <header class="bg-gradient-to-r from-amber-500 to-orange-500 px-6 py-4 rounded-t-2xl text-white">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-sync-alt mr-3"></i>
                    Recurrence Pattern (RFC 5545 Compatible)
                </h2>
                <p class="text-amber-50 text-sm mt-1">Define how often this event should repeat</p>
            </header>
            <div class="p-6 space-y-6">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <div class="flex">
                        <i class="fas fa-info-circle text-blue-600 mt-0.5 mr-3"></i>
                        <div class="text-sm text-blue-800">
                            <p class="font-semibold mb-1">Recurrence Pattern Guidelines</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li>The first event date/time will be used as the starting point for all recurrences</li>
                                <li>For weekly events, select which days of the week the event should occur</li>
                                <li>Choose either a specific number of occurrences or an end date</li>
                                <li>Event instances will be generated automatically by the system</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% include "components/form_field.html" with field=pattern_form.recurrence_type %}
                    {% include "components/form_field.html" with field=pattern_form.interval %}
                </div>

                <div id="weekly-options" class="border border-gray-200 rounded-lg p-4" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-3">
                        Repeat on days <span class="text-red-500">*</span>
                    </label>
                    {% include "components/form_field.html" with field=pattern_form.by_weekday hide_label=True %}
                </div>

                <div id="monthly-options" class="border border-gray-200 rounded-lg p-4" style="display: none;">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {% include "components/form_field.html" with field=pattern_form.by_monthday %}
                    </div>
                </div>

                <div id="yearly-options" class="border border-gray-200 rounded-lg p-4" style="display: none;">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {% include "components/form_field.html" with field=pattern_form.by_month %}
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">End Condition</h3>
                    <p class="text-sm text-gray-600 mb-4">Choose when the recurring series should stop</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {% include "components/form_field.html" with field=pattern_form.count %}
                        {% include "components/form_field.html" with field=pattern_form.until_date %}
                    </div>
                </div>

                <div id="preview-section" class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-eye text-emerald-600 mr-2"></i>
                        Preview Occurrences
                    </h3>
                    <div id="pattern-preview" class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-sm text-gray-600">
                        <p class="italic">Configure the pattern above to see a preview of the first 5 occurrences</p>
                    </div>
                    <button type="button" id="preview-btn" class="mt-3 px-4 py-2 text-sm font-medium text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-lg hover:bg-emerald-100">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Generate Preview
                    </button>
                </div>
            </div>
        </section>

        <section class="bg-white border border-gray-200 rounded-2xl shadow-sm">
            <header class="bg-gradient-to-r from-purple-500 to-indigo-600 px-6 py-4 rounded-t-2xl text-white">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-users mr-3"></i>
                    Team &amp; Participants
                </h2>
            </header>
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {% include "components/form_field.html" with field=event_form.organizer %}
                    {% include "components/form_field.html" with field=event_form.co_organizers %}
                    {% include "components/form_field.html" with field=event_form.facilitators %}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% include "components/form_field.html" with field=event_form.expected_participants %}
                    {% include "components/form_field.html" with field=event_form.target_audience wrapper_class="md:col-span-2" %}
                </div>
            </div>
        </section>

        <div class="flex items-center justify-end space-x-3">
            <a href="{{ return_url }}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                Cancel
            </a>
            <button type="submit" class="px-4 py-2 text-sm font-semibold text-white rounded-lg shadow btn-primary">
                <i class="fas fa-calendar-check mr-2"></i>
                {{ submit_label|default:"Create Recurring Event" }}
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const recurrenceTypeField = document.querySelector('[name="recurrence_type"]');
    const weeklyOptions = document.getElementById('weekly-options');
    const monthlyOptions = document.getElementById('monthly-options');
    const yearlyOptions = document.getElementById('yearly-options');

    function toggleRecurrenceOptions() {
        const type = recurrenceTypeField.value;
        weeklyOptions.style.display = (type === 'weekly') ? 'block' : 'none';
        monthlyOptions.style.display = (type === 'monthly') ? 'block' : 'none';
        yearlyOptions.style.display = (type === 'yearly') ? 'block' : 'none';
    }

    if (recurrenceTypeField) {
        recurrenceTypeField.addEventListener('change', toggleRecurrenceOptions);
        toggleRecurrenceOptions(); // Initial state
    }

    // Preview button handler
    const previewBtn = document.getElementById('preview-btn');
    const previewSection = document.getElementById('pattern-preview');

    if (previewBtn && previewSection) {
        previewBtn.addEventListener('click', function() {
            const startDate = document.querySelector('[name="start_date"]').value;
            const recurrenceType = recurrenceTypeField.value;
            const interval = document.querySelector('[name="interval"]').value || 1;

            if (!startDate || !recurrenceType) {
                previewSection.innerHTML = '<p class="italic text-red-600">Please select a start date and recurrence type first.</p>';
                return;
            }

            // Simple client-side preview (real preview would need server-side calculation)
            let previewText = `<p class="font-semibold text-gray-900 mb-2">First 5 occurrences:</p><ol class="list-decimal list-inside space-y-1 text-gray-700">`;

            const start = new Date(startDate);
            for (let i = 0; i < 5; i++) {
                const occurrence = new Date(start);

                if (recurrenceType === 'daily') {
                    occurrence.setDate(start.getDate() + (i * interval));
                } else if (recurrenceType === 'weekly') {
                    occurrence.setDate(start.getDate() + (i * 7 * interval));
                } else if (recurrenceType === 'monthly') {
                    occurrence.setMonth(start.getMonth() + (i * interval));
                } else if (recurrenceType === 'yearly') {
                    occurrence.setFullYear(start.getFullYear() + (i * interval));
                }

                previewText += `<li>${occurrence.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</li>`;
            }

            previewText += '</ol><p class="text-sm text-gray-500 mt-3 italic">Note: This is a simplified preview. Actual occurrences may vary based on weekday/monthday rules.</p>';
            previewSection.innerHTML = previewText;
        });
    }
});
</script>
{% endblock %}
