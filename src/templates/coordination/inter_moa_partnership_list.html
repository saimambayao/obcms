{% extends "base.html" %}
{% load static %}

{% block title %}Inter-MOA Partnerships · Coordination{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Inter-MOA Partnerships</h1>
            <p class="text-gray-600 mt-1 max-w-2xl">
                Collaborative initiatives across BARMM Ministries, Offices, and Agencies. View active partnerships,
                monitor progress, and launch new coordination efforts.
            </p>
        </div>
        <a href="{% url 'coordination:inter-moa-partnership-create' %}"
           class="inline-flex items-center justify-center px-5 py-3 rounded-lg bg-blue-600 text-white font-semibold shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <span class="mr-2 text-lg">+</span>
            New Partnership
        </a>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6">
            <p class="text-sm text-gray-500">Total Partnerships</p>
            <p class="text-3xl font-bold text-gray-900 mt-1">{{ stats.total }}</p>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6">
            <p class="text-sm text-gray-500">Active</p>
            <p class="text-3xl font-bold text-emerald-600 mt-1">{{ stats.active }}</p>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6">
            <p class="text-sm text-gray-500">Draft</p>
            <p class="text-3xl font-bold text-amber-600 mt-1">{{ stats.draft }}</p>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6">
            <p class="text-sm text-gray-500">Completed</p>
            <p class="text-3xl font-bold text-indigo-600 mt-1">{{ stats.completed }}</p>
        </div>
    </div>

    <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 mb-8">
        <form method="get" class="grid grid-cols-1 lg:grid-cols-5 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <select name="status" class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All statuses</option>
                    {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if current_filters.status == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                <select name="priority" class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All priorities</option>
                    {% for value, label in priority_choices %}
                        <option value="{{ value }}" {% if current_filters.priority == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Partnership type</label>
                <select name="partnership_type" class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All types</option>
                    {% for value, label in type_choices %}
                        <option value="{{ value }}" {% if current_filters.partnership_type == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Sort</label>
                <select name="sort" class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                    <option value="-created_at" {% if current_filters.sort == '-created_at' %}selected{% endif %}>Newest first</option>
                    <option value="created_at" {% if current_filters.sort == 'created_at' %}selected{% endif %}>Oldest first</option>
                    <option value="title" {% if current_filters.sort == 'title' %}selected{% endif %}>Title A → Z</option>
                    <option value="-title" {% if current_filters.sort == '-title' %}selected{% endif %}>Title Z → A</option>
                    <option value="start_date" {% if current_filters.sort == 'start_date' %}selected{% endif %}>Start date</option>
                    <option value="-start_date" {% if current_filters.sort == '-start_date' %}selected{% endif %}>Start date (latest)</option>
                    <option value="progress" {% if current_filters.sort == 'progress' %}selected{% endif %}>Progress (ascending)</option>
                    <option value="-progress" {% if current_filters.sort == '-progress' %}selected{% endif %}>Progress (descending)</option>
                </select>
            </div>
            <div class="flex items-end">
                <button type="submit"
                        class="w-full inline-flex items-center justify-center px-5 py-3 rounded-lg bg-gray-900 text-white font-semibold shadow-sm hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900">
                    Apply filters
                </button>
            </div>
        </form>
    </div>

    <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
            <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Partnership</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Lead MOA</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Participants</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Type</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Priority</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Progress</th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
            </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-100">
            {% for partnership in partnerships %}
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4">
                        <div class="text-sm font-semibold text-gray-900">{{ partnership.title }}</div>
                        <div class="text-sm text-gray-500">{{ partnership.get_partnership_type_display }}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-3 py-1 rounded-full bg-blue-100 text-blue-800 text-xs font-semibold">{{ partnership.lead_moa_code }}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-wrap gap-1">
                            {% if partnership.participating_moa_codes %}
                                {% for code in partnership.participating_moa_codes %}
                                    <span class="inline-flex items-center px-2 py-1 rounded bg-gray-100 text-gray-700 text-xs">{{ code }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-sm text-gray-400">No additional MOAs</span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-700">{{ partnership.get_partnership_type_display }}</td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold
                                     {% if partnership.status == 'active' %}bg-emerald-100 text-emerald-700
                                     {% elif partnership.status == 'draft' %}bg-amber-100 text-amber-700
                                     {% elif partnership.status == 'completed' %}bg-indigo-100 text-indigo-700
                                     {% else %}bg-gray-100 text-gray-700{% endif %}">
                            {{ partnership.get_status_display }}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold
                                     {% if partnership.priority == 'critical' %}bg-red-100 text-red-700
                                     {% elif partnership.priority == 'high' %}bg-orange-100 text-orange-700
                                     {% elif partnership.priority == 'medium' %}bg-amber-100 text-amber-700
                                     {% else %}bg-gray-100 text-gray-700{% endif %}">
                            {{ partnership.get_priority_display }}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <div class="w-24 h-2 rounded-full bg-gray-200 overflow-hidden">
                                <div class="h-2 bg-blue-500" style="width: {{ partnership.progress_percentage }}%"></div>
                            </div>
                            <span class="text-sm text-gray-600 font-semibold">{{ partnership.progress_percentage }}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right text-sm">
                        <a href="{% url 'coordination:inter-moa-partnership-detail' partnership.id %}"
                           class="text-blue-600 hover:text-blue-800 font-semibold">View</a>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                        <div class="max-w-lg mx-auto">
                            <p class="text-lg font-semibold text-gray-700">No partnerships yet.</p>
                            <p class="mt-2 text-gray-500">Create the first inter-MOA partnership to kick-start BARMM-wide coordination.</p>
                            <a href="{% url 'coordination:inter-moa-partnership-create' %}"
                               class="mt-4 inline-flex items-center px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700">Create partnership</a>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    {% if partnerships.paginator.num_pages > 1 %}
        <div class="flex items-center justify-between mt-6">
            <p class="text-sm text-gray-600">
                Showing {{ partnerships.start_index }}–{{ partnerships.end_index }} of {{ partnerships.paginator.count }} partnerships
            </p>
            <div class="flex items-center gap-2">
                {% if partnerships.has_previous %}
                    <a href="?page={{ partnerships.previous_page_number }}&status={{ current_filters.status }}&priority={{ current_filters.priority }}&partnership_type={{ current_filters.partnership_type }}&sort={{ current_filters.sort }}"
                       class="px-3 py-2 text-sm border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Previous</a>
                {% else %}
                    <span class="px-3 py-2 text-sm border border-gray-200 rounded-lg text-gray-400">Previous</span>
                {% endif %}
                <span class="px-3 py-2 text-sm text-gray-600">Page {{ partnerships.number }} of {{ partnerships.paginator.num_pages }}</span>
                {% if partnerships.has_next %}
                    <a href="?page={{ partnerships.next_page_number }}&status={{ current_filters.status }}&priority={{ current_filters.priority }}&partnership_type={{ current_filters.partnership_type }}&sort={{ current_filters.sort }}"
                       class="px-3 py-2 text-sm border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Next</a>
                {% else %}
                    <span class="px-3 py-2 text-sm border border-gray-200 rounded-lg text-gray-400">Next</span>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}
