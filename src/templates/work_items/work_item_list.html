{% extends "base.html" %}
{% load static %}

{% block title %}Work Items - Hierarchical View{% endblock %}

{% block breadcrumb %}
<li><a href="{% url 'common:dashboard' %}" class="text-neutral-500 hover:text-neutral-700">Dashboard</a></li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li><a href="{% url 'common:oobc_management_home' %}" class="text-neutral-500 hover:text-neutral-700">OOBC Management</a></li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li class="text-neutral-800 font-semibold">Work Items</li>
{% endblock %}

{% block extra_head %}
<!-- Alpine.js for modal functionality -->
<script src="//unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
{% endblock %}

{% block extra_css %}
<style>
    /* HTMX Loading Indicator - Hidden by Default */
    .htmx-indicator {
        display: none;
    }

    /* Show loading spinner during HTMX request */
    .htmx-request .htmx-indicator {
        display: inline-block;
    }

    /* Hide chevron when loading */
    .htmx-request .toggle-icon {
        display: none;
    }

    /* Smooth transitions for skeleton rows */
    .skeleton-row {
        transition: opacity 200ms ease-in-out;
    }

    /* Pulsing animation for skeleton placeholders */
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }

    .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-8">

    {# Hero Section #}
    <section class="relative overflow-hidden rounded-3xl bg-gradient-to-r from-emerald-600 via-teal-500 to-cyan-600 shadow-2xl">
        <div class="absolute inset-0 bg-white/10 opacity-20 mix-blend-overlay"></div>
        <div class="absolute top-0 right-0 w-96 h-96 bg-white/10 rounded-full -mr-48 -mt-48"></div>

        <div class="relative px-6 sm:px-10 py-8 sm:py-10">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-8">
                <div class="flex-1 space-y-4">
                    <div class="inline-flex items-center rounded-lg bg-white/20 backdrop-blur-sm px-3 py-1.5 text-sm font-semibold text-white border border-white/30">
                        <i class="fas fa-sitemap mr-2"></i>
                        HIERARCHICAL VIEW
                    </div>

                    <h1 class="text-3xl sm:text-4xl font-bold text-white leading-tight">
                        Work Items
                    </h1>

                    <p class="text-white/90 text-base sm:text-lg max-w-2xl leading-relaxed">
                        Manage Projects, Activities, and Tasks in a hierarchical tree view with full tracking and progress monitoring
                    </p>
                </div>

                <div class="flex-shrink-0">
                    <div class="flex flex-col gap-3 min-w-[220px]">
                        <a href="{% url 'common:work_item_create' %}" class="flex items-center justify-center gap-2 px-5 py-3 rounded-xl bg-white text-emerald-600 font-semibold shadow-lg hover:bg-emerald-50 hover:shadow-xl transition-all duration-200">
                            <i class="fas fa-plus-circle"></i>
                            <span>Create Work Item</span>
                        </a>
                        <a href="{% url 'common:oobc_calendar' %}" class="flex items-center justify-center gap-2 px-5 py-3 rounded-xl bg-white/20 backdrop-blur-sm text-white font-semibold border border-white/30 hover:bg-white/30 transition-all duration-200">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Calendar View</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    {# Statistics Cards - 3D Milk White Design #}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Total Projects -->
        <div class="relative overflow-hidden bg-gradient-to-br from-[#FEFDFB] to-[#FBF9F5] rounded-2xl transform hover:-translate-y-2 transition-all duration-300"
             style="box-shadow: 0 8px 20px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.06), inset 0 -2px 4px rgba(0,0,0,0.02), inset 0 2px 4px rgba(255,255,255,0.9);">
            <div class="absolute inset-0 bg-gradient-to-br from-white/60 via-transparent to-gray-100/20"></div>
            <div class="relative p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-semibold uppercase tracking-wide">Total Projects</p>
                        <p class="text-4xl font-extrabold text-gray-800 mt-1">{{ work_items|length }}</p>
                    </div>
                    <div class="w-16 h-16 rounded-2xl flex items-center justify-center"
                         style="background: linear-gradient(135deg, #FFFFFF 0%, #F5F3F0 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 4px rgba(0,0,0,0.05), inset 0 2px 4px rgba(255,255,255,0.8);">
                        <i class="fas fa-project-diagram text-2xl text-blue-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Activities -->
        <div class="relative overflow-hidden bg-gradient-to-br from-[#FEFDFB] to-[#FBF9F5] rounded-2xl transform hover:-translate-y-2 transition-all duration-300"
             style="box-shadow: 0 8px 20px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.06), inset 0 -2px 4px rgba(0,0,0,0.02), inset 0 2px 4px rgba(255,255,255,0.9);">
            <div class="absolute inset-0 bg-gradient-to-br from-white/60 via-transparent to-gray-100/20"></div>
            <div class="relative p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-semibold uppercase tracking-wide">Active Activities</p>
                        <p class="text-4xl font-extrabold text-gray-800 mt-1">0</p>
                    </div>
                    <div class="w-16 h-16 rounded-2xl flex items-center justify-center"
                         style="background: linear-gradient(135deg, #FFFFFF 0%, #F5F3F0 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 4px rgba(0,0,0,0.05), inset 0 2px 4px rgba(255,255,255,0.8);">
                        <i class="fas fa-clipboard-list text-2xl text-emerald-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Tasks -->
        <div class="relative overflow-hidden bg-gradient-to-br from-[#FEFDFB] to-[#FBF9F5] rounded-2xl transform hover:-translate-y-2 transition-all duration-300"
             style="box-shadow: 0 8px 20px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.06), inset 0 -2px 4px rgba(0,0,0,0.02), inset 0 2px 4px rgba(255,255,255,0.9);">
            <div class="absolute inset-0 bg-gradient-to-br from-white/60 via-transparent to-gray-100/20"></div>
            <div class="relative p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-semibold uppercase tracking-wide">Pending Tasks</p>
                        <p class="text-4xl font-extrabold text-gray-800 mt-1">0</p>
                    </div>
                    <div class="w-16 h-16 rounded-2xl flex items-center justify-center"
                         style="background: linear-gradient(135deg, #FFFFFF 0%, #F5F3F0 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 4px rgba(0,0,0,0.05), inset 0 2px 4px rgba(255,255,255,0.8);">
                        <i class="fas fa-check-square text-2xl text-purple-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overall Progress -->
        <div class="relative overflow-hidden bg-gradient-to-br from-[#FEFDFB] to-[#FBF9F5] rounded-2xl transform hover:-translate-y-2 transition-all duration-300"
             style="box-shadow: 0 8px 20px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.06), inset 0 -2px 4px rgba(0,0,0,0.02), inset 0 2px 4px rgba(255,255,255,0.9);">
            <div class="absolute inset-0 bg-gradient-to-br from-white/60 via-transparent to-gray-100/20"></div>
            <div class="relative p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-semibold uppercase tracking-wide">Overall Progress</p>
                        <p class="text-4xl font-extrabold text-gray-800 mt-1">0%</p>
                    </div>
                    <div class="w-16 h-16 rounded-2xl flex items-center justify-center"
                         style="background: linear-gradient(135deg, #FFFFFF 0%, #F5F3F0 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 4px rgba(0,0,0,0.05), inset 0 2px 4px rgba(255,255,255,0.8);">
                        <i class="fas fa-chart-line text-2xl text-amber-600"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Search and Filter Section #}
    <div class="bg-white rounded-xl border border-gray-200 shadow-md p-6">
        <div class="flex items-center gap-3 mb-5">
            <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                <i class="fas fa-filter text-blue-600"></i>
            </div>
            <div>
                <h2 class="text-xl font-semibold text-gray-900">Search & Filter</h2>
                <p class="text-sm text-gray-600">Find and filter work items</p>
            </div>
        </div>

        <form method="get" class="space-y-4">
            <!-- All Filters in One Row: Search (40%) + Type/Status/Priority (20% each) -->
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Search Input (40%) -->
                <div class="md:w-[40%]">
                    <label for="search" class="block text-sm font-medium text-gray-700 mb-2">
                        Search
                    </label>
                    <input type="text" id="search" name="q" value="{{ search_query }}"
                           class="block w-full py-3 px-4 text-base rounded-xl border border-gray-200 shadow-sm focus:ring-emerald-500 focus:border-emerald-500 min-h-[48px] transition-all duration-200"
                           placeholder="Search by title or description...">
                </div>

                <!-- Work Type Filter (20%) -->
                <div class="md:w-[20%]">
                    <label for="work_type" class="block text-sm font-medium text-gray-700 mb-2">
                        Type
                    </label>
                    <div class="relative">
                        <select id="work_type" name="work_type"
                                class="block w-full py-3 px-4 text-base rounded-xl border border-gray-200 shadow-sm focus:ring-emerald-500 focus:border-emerald-500 min-h-[48px] appearance-none pr-12 bg-white transition-all duration-200">
                            <option value="">All Types</option>
                            {% for value, label in work_type_choices %}
                                <option value="{{ value }}" {% if work_type_filter == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                        <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-4">
                            <i class="fas fa-chevron-down text-gray-400 text-sm"></i>
                        </span>
                    </div>
                </div>

                <!-- Status Filter (20%) -->
                <div class="md:w-[20%]">
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
                        Status
                    </label>
                    <div class="relative">
                        <select id="status" name="status"
                                class="block w-full py-3 px-4 text-base rounded-xl border border-gray-200 shadow-sm focus:ring-emerald-500 focus:border-emerald-500 min-h-[48px] appearance-none pr-12 bg-white transition-all duration-200">
                            <option value="">All Statuses</option>
                            {% for value, label in status_choices %}
                                <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                        <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-4">
                            <i class="fas fa-chevron-down text-gray-400 text-sm"></i>
                        </span>
                    </div>
                </div>

                <!-- Priority Filter (20%) -->
                <div class="md:w-[20%]">
                    <label for="priority" class="block text-sm font-medium text-gray-700 mb-2">
                        Priority
                    </label>
                    <div class="relative">
                        <select id="priority" name="priority"
                                class="block w-full py-3 px-4 text-base rounded-xl border border-gray-200 shadow-sm focus:ring-emerald-500 focus:border-emerald-500 min-h-[48px] appearance-none pr-12 bg-white transition-all duration-200">
                            <option value="">All Priorities</option>
                            {% for value, label in priority_choices %}
                                <option value="{{ value }}" {% if priority_filter == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                        <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-4">
                            <i class="fas fa-chevron-down text-gray-400 text-sm"></i>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons Row -->
            <div class="flex flex-col sm:flex-row justify-between items-center gap-3 pt-2">
                <div class="flex gap-3 w-full sm:w-auto">
                    <button type="submit" class="flex-1 sm:flex-initial inline-flex items-center justify-center px-6 py-3 bg-gradient-to-r from-blue-600 to-emerald-600 text-white rounded-xl font-semibold hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300">
                        <i class="fas fa-filter mr-2"></i>
                        Apply Filters
                    </button>
                    <a href="{% url 'common:work_item_list' %}" class="flex-1 sm:flex-initial inline-flex items-center justify-center px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl font-semibold hover:bg-gray-50 transition-colors duration-200">
                        <i class="fas fa-times mr-2"></i>
                        Clear Filters
                    </a>
                </div>
                <a href="{% url 'common:work_item_create' %}" class="w-full sm:w-auto inline-flex items-center justify-center px-6 py-3 bg-gradient-to-r from-blue-600 to-emerald-600 text-white rounded-xl font-semibold hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300">
                    <i class="fas fa-plus mr-2"></i>
                    Create Work Item
                </a>
            </div>
        </form>
    </div>

    <!-- Work Items Tree -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        {# Tree Controls #}
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="text-sm font-semibold text-gray-700">
                    <i class="fas fa-sitemap text-blue-600 mr-2"></i>
                    Hierarchical Tree View
                </div>
                <div class="text-xs text-gray-600">
                    {{ work_items|length }} items displayed
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button id="expand-all-btn"
                        class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors duration-150">
                    <i class="fas fa-expand-alt mr-1.5"></i>
                    Expand All
                </button>
                <button id="collapse-all-btn"
                        class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-150">
                    <i class="fas fa-compress-alt mr-1.5"></i>
                    Collapse All
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full divide-y divide-gray-200 border-collapse" style="table-layout: fixed; min-width: 1200px;">
                <colgroup>
                    <col style="width: 40%;">  <!-- Title & Hierarchy -->
                    <col style="width: 10%;">  <!-- Type -->
                    <col style="width: 10%;">  <!-- Status -->
                    <col style="width: 8%;">   <!-- Priority -->
                    <col style="width: 12%;">  <!-- Progress -->
                    <col style="width: 12%;">  <!-- Dates -->
                    <col style="width: 8%;">   <!-- Actions -->
                </colgroup>
                <thead class="bg-gradient-to-r from-blue-600 to-teal-600">
                    <tr>
                        <th scope="col" class="px-4 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">
                            <div class="flex items-center">
                                <i class="fas fa-stream mr-2"></i>
                                Title & Hierarchy
                            </div>
                        </th>
                        <th scope="col" class="px-3 py-4 text-left text-xs font-bold text-white uppercase tracking-wider whitespace-nowrap">
                            Type
                        </th>
                        <th scope="col" class="px-3 py-4 text-left text-xs font-bold text-white uppercase tracking-wider whitespace-nowrap">
                            Status
                        </th>
                        <th scope="col" class="px-3 py-4 text-left text-xs font-bold text-white uppercase tracking-wider whitespace-nowrap">
                            Priority
                        </th>
                        <th scope="col" class="px-3 py-4 text-left text-xs font-bold text-white uppercase tracking-wider whitespace-nowrap">
                            Progress
                        </th>
                        <th scope="col" class="px-3 py-4 text-left text-xs font-bold text-white uppercase tracking-wider whitespace-nowrap">
                            Dates
                        </th>
                        <th scope="col" class="px-3 py-4 text-right text-xs font-bold text-white uppercase tracking-wider whitespace-nowrap">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for item in work_items %}
                        {% include 'work_items/_work_item_tree_row.html' with work_item=item %}
                    {% empty %}
                        <tr>
                            <td colspan="7" class="px-6 py-16 text-center">
                                <div class="flex flex-col items-center justify-center">
                                    <div class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center mb-4">
                                        <i class="fas fa-inbox text-4xl text-gray-400"></i>
                                    </div>
                                    <p class="text-lg font-semibold text-gray-900 mb-2">No work items found</p>
                                    <p class="text-sm text-gray-600 mb-6">Create your first work item to get started with project tracking</p>
                                    <a href="{% url 'common:work_item_create' %}" class="inline-flex items-center px-5 py-2.5 bg-gradient-to-r from-blue-600 to-teal-600 text-white rounded-lg hover:from-blue-700 hover:to-teal-700 transition-all duration-200 shadow-sm">
                                        <i class="fas fa-plus mr-2"></i>
                                        Create Work Item
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {# Delete Modal Container - HTMX will inject modal content here #}
    <div id="delete-modal-container" aria-live="polite" role="region" aria-label="Delete confirmation modal"></div>
</div>

<!-- Right Sidebar Panel -->
<aside id="work-item-sidebar"
       class="fixed top-0 right-0 h-full w-96 bg-white border-l border-gray-200 shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50">
    <div class="h-full flex flex-col">
        <!-- Sidebar Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Work Item Details</h2>
            <button id="sidebar-close-btn"
                    onclick="closeSidebar()"
                    class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-colors"
                    aria-label="Close sidebar">
                <i class="fas fa-times text-gray-600"></i>
            </button>
        </div>

        <!-- Sidebar Content (HTMX target) -->
        <div id="sidebar-content" class="flex-1 overflow-y-auto p-6">
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-tasks text-4xl mb-3"></i>
                <p>Click an action button to view details</p>
            </div>
        </div>
    </div>
</aside>

<!-- Sidebar Backdrop -->
<div id="sidebar-backdrop"
     class="fixed inset-0 bg-black/50 z-40 opacity-0 pointer-events-none transition-opacity duration-300"
     onclick="closeSidebar()"></div>

<script>
/**
 * Work Items Hierarchical Tree Navigation
 *
 * Features:
 * - State-machine based node management (UNLOADED → LOADING → EXPANDED ⇄ COLLAPSED)
 * - HTMX-powered lazy loading of children
 * - Optimistic UI updates (< 50ms feedback)
 * - Expand All / Collapse All functionality
 * - Error handling with UI rollback
 *
 * State Machine Diagram:
 *
 *   ┌──────────┐  User Click   ┌─────────┐  HTMX Success  ┌──────────┐
 *   │ UNLOADED │──────────────>│ LOADING │───────────────>│ EXPANDED │
 *   └──────────┘               └─────────┘                └──────────┘
 *                                   │                           │  ▲
 *                                   │ Error                     │  │
 *                                   ▼                           │  │
 *                              ┌──────────┐                     │  │
 *                              │ UNLOADED │                     │  │
 *                              └──────────┘                     │  │
 *                                                               │  │
 *                                                         Click │  │ Click
 *                                                               ▼  │
 *                                                         ┌───────────┐
 *                                                         │ COLLAPSED │
 *                                                         └───────────┘
 *
 * Event Flow:
 *   1. User clicks expand button
 *   2. htmx:beforeRequest → Check state, show optimistic UI (chevron, skeleton)
 *   3. HTMX loads children from server
 *   4. htmx:afterSwap → Hide skeleton, mark as EXPANDED, remove placeholder & HTMX attrs
 *   5. Subsequent clicks toggle EXPANDED ⇄ COLLAPSED (no HTMX)
 */
(function() {
    'use strict';

    // ============================================================================
    // STATE MACHINE
    // ============================================================================

    /**
     * Node states in the tree navigation
     * @enum {string}
     */
    const NodeState = {
        /** Children never loaded, button ready to trigger HTMX load */
        UNLOADED: 'unloaded',
        /** HTMX request in flight, skeleton showing */
        LOADING: 'loading',
        /** Children loaded and visible */
        EXPANDED: 'expanded',
        /** Children loaded but hidden */
        COLLAPSED: 'collapsed'
    };

    /**
     * State storage: itemId → NodeState
     * @type {Map<string, string>}
     */
    const nodeStates = new Map();

    // ============================================================================
    // STATE MANAGEMENT
    // ============================================================================

    /**
     * Get current state of a node
     * @param {string} itemId - Work item ID
     * @returns {string} Current NodeState
     */
    function getNodeState(itemId) {
        return nodeStates.get(itemId) || NodeState.UNLOADED;
    }

    /**
     * Set state of a node with logging
     * @param {string} itemId - Work item ID
     * @param {string} newState - New NodeState
     */
    function setNodeState(itemId, newState) {
        const oldState = getNodeState(itemId);
        nodeStates.set(itemId, newState);
        console.log(`[Tree] Node ${itemId}: ${oldState} → ${newState}`);
    }

    /**
     * Check if node has children loaded
     * @param {string} itemId - Work item ID
     * @returns {boolean} True if children are loaded
     */
    function isChildrenLoaded(itemId) {
        const state = getNodeState(itemId);
        return state === NodeState.EXPANDED || state === NodeState.COLLAPSED;
    }

    /**
     * Check if node is expanded
     * @param {string} itemId - Work item ID
     * @returns {boolean} True if node is expanded
     */
    function isNodeExpanded(itemId) {
        return getNodeState(itemId) === NodeState.EXPANDED;
    }

    // ============================================================================
    // UI UPDATES - Chevron
    // ============================================================================

    /**
     * Update chevron icon to match expansion state
     * @param {string} itemId - Work item ID
     * @param {boolean} expanded - True for down chevron, false for right
     */
    function updateChevron(itemId, expanded) {
        const button = document.querySelector(`[data-item-id="${itemId}"]`);
        if (!button) return;

        const icon = button.querySelector('.toggle-icon');
        if (!icon) return;

        if (expanded) {
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-down');
        } else {
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-right');
        }
    }

    // ============================================================================
    // UI UPDATES - Skeleton Loading
    // ============================================================================

    /**
     * Show skeleton loading row
     * @param {string} itemId - Work item ID
     */
    function showSkeleton(itemId) {
        const skeletonRow = document.getElementById(`skeleton-row-${itemId}`);
        if (skeletonRow) {
            skeletonRow.style.display = '';
        }
    }

    /**
     * Hide skeleton loading row
     * @param {string} itemId - Work item ID
     */
    function hideSkeleton(itemId) {
        const skeletonRow = document.getElementById(`skeleton-row-${itemId}`);
        if (skeletonRow) {
            skeletonRow.style.display = 'none';
        }
    }

    // ============================================================================
    // CHILDREN VISIBILITY MANAGEMENT
    // ============================================================================

    /**
     * Get all descendant rows (children, grandchildren, etc.)
     * @param {string} itemId - Work item ID
     * @returns {HTMLElement[]} Array of descendant row elements
     */
    function getAllDescendantRows(itemId) {
        const rows = [];
        const parentRow = document.querySelector(`[data-work-item-id="${itemId}"]`);
        if (!parentRow) return rows;

        const parentLevel = parseInt(parentRow.dataset.level || '0');
        let currentRow = parentRow.nextElementSibling;

        while (currentRow) {
            // Skip placeholder and skeleton rows (they don't have data-work-item-id)
            if (!currentRow.dataset.workItemId) {
                currentRow = currentRow.nextElementSibling;
                continue;
            }

            const level = parseInt(currentRow.dataset.level || '0');

            // Stop if we hit a sibling or parent (same or lower level)
            if (level <= parentLevel) {
                break;
            }

            rows.push(currentRow);
            currentRow = currentRow.nextElementSibling;
        }

        return rows;
    }

    /**
     * Show children rows (EXPANDED state)
     * @param {string} itemId - Work item ID
     */
    function showChildren(itemId) {
        const parentRow = document.querySelector(`[data-work-item-id="${itemId}"]`);
        if (!parentRow) return;

        const parentLevel = parseInt(parentRow.dataset.level || '0');
        const childRows = getAllDescendantRows(itemId);

        // Only show direct children (level = parentLevel + 1)
        childRows.forEach(row => {
            const rowLevel = parseInt(row.dataset.level);
            if (rowLevel === parentLevel + 1) {
                row.style.display = '';
            }
        });

        updateChevron(itemId, true);
        setNodeState(itemId, NodeState.EXPANDED);
    }

    /**
     * Hide children rows (COLLAPSED state)
     * @param {string} itemId - Work item ID
     */
    function hideChildren(itemId) {
        const childRows = getAllDescendantRows(itemId);

        // Hide ALL descendants (children, grandchildren, etc.)
        childRows.forEach(row => {
            row.style.display = 'none';

            // Recursively collapse child nodes
            const childButton = row.querySelector('[data-item-id]');
            if (childButton) {
                const childItemId = childButton.dataset.itemId;
                if (isNodeExpanded(childItemId)) {
                    setNodeState(childItemId, NodeState.COLLAPSED);
                    updateChevron(childItemId, false);
                }
            }
        });

        updateChevron(itemId, false);
        setNodeState(itemId, NodeState.COLLAPSED);
    }

    // ============================================================================
    // PLACEHOLDER MANAGEMENT
    // ============================================================================

    /**
     * Remove placeholder row after children are loaded
     * @param {string} itemId - Work item ID
     */
    function removePlaceholder(itemId) {
        const placeholder = document.getElementById(`children-placeholder-${itemId}`);
        if (placeholder) {
            placeholder.remove();
            console.log(`[Tree] Removed placeholder for ${itemId}`);
        }
    }

    /**
     * Remove HTMX attributes after first load to prevent duplicate requests
     * @param {string} itemId - Work item ID
     */
    function removeHtmxAttributes(itemId) {
        const button = document.querySelector(`[data-item-id="${itemId}"]`);
        if (!button) return;

        button.removeAttribute('hx-get');
        button.removeAttribute('hx-target');
        button.removeAttribute('hx-swap');
        button.removeAttribute('hx-trigger');
        button.removeAttribute('hx-indicator');
        button.removeAttribute('hx-disabled-elt');

        console.log(`[Tree] Removed HTMX attributes for ${itemId}`);
    }

    // ============================================================================
    // HTMX EVENT VALIDATION
    // ============================================================================

    /**
     * Check if HTMX event is for tree expansion
     * @param {CustomEvent} event - HTMX event
     * @returns {boolean} True if this is a tree expansion event
     */
    function isTreeExpansionEvent(event) {
        const targetId = event.detail.target?.id;
        return targetId && targetId.startsWith('children-placeholder-');
    }

    /**
     * Extract item ID from HTMX event
     * @param {CustomEvent} event - HTMX event
     * @returns {string|null} Item ID or null if not found
     */
    function extractItemId(event) {
        const targetId = event.detail.target?.id;
        if (!targetId) return null;
        return targetId.replace('children-placeholder-', '');
    }

    // ============================================================================
    // HTMX EVENT HANDLERS
    // ============================================================================

    /**
     * HTMX beforeRequest: Validate request and show optimistic UI
     */
    document.body.addEventListener('htmx:beforeRequest', function(event) {
        if (!isTreeExpansionEvent(event)) return;

        const itemId = extractItemId(event);
        if (!itemId) return;

        const state = getNodeState(itemId);

        // SAFETY: Prevent duplicate load if already loaded
        if (isChildrenLoaded(itemId)) {
            event.preventDefault();
            console.warn(`[Tree] Prevented duplicate load for ${itemId} (state: ${state})`);
            console.warn('[Tree] HTMX attributes should have been removed - this is unexpected');
            return;
        }

        // SAFETY: Verify target exists
        const target = event.detail.target;
        if (!target || !document.body.contains(target)) {
            event.preventDefault();
            console.error(`[Tree] Target element missing: ${target?.id}`);
            return;
        }

        // OPTIMISTIC UI: Show loading state (< 50ms)
        console.log(`[Tree] Loading children for ${itemId}`);
        setNodeState(itemId, NodeState.LOADING);
        updateChevron(itemId, true);
        showSkeleton(itemId);
    });

    /**
     * HTMX afterSwap: Hide skeleton, mark as loaded
     */
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (!isTreeExpansionEvent(event)) return;

        const itemId = extractItemId(event);
        if (!itemId) return;

        console.log(`[Tree] Children loaded for ${itemId}`);
        hideSkeleton(itemId);
        setNodeState(itemId, NodeState.EXPANDED);
        removePlaceholder(itemId);
        removeHtmxAttributes(itemId);
    });

    /**
     * HTMX sendError: Network error, revert UI
     */
    document.body.addEventListener('htmx:sendError', function(event) {
        if (!isTreeExpansionEvent(event)) return;

        const itemId = extractItemId(event);
        if (!itemId) return;

        console.error(`[Tree] Network error loading ${itemId}`);
        updateChevron(itemId, false);
        hideSkeleton(itemId);
        setNodeState(itemId, NodeState.UNLOADED);
    });

    /**
     * HTMX responseError: Server error, revert UI
     */
    document.body.addEventListener('htmx:responseError', function(event) {
        if (!isTreeExpansionEvent(event)) return;

        const itemId = extractItemId(event);
        if (!itemId) return;

        console.error(`[Tree] Server error loading ${itemId}`);
        updateChevron(itemId, false);
        hideSkeleton(itemId);
        setNodeState(itemId, NodeState.UNLOADED);
    });

    /**
     * HTMX swapError: Swap failed, revert UI
     */
    document.body.addEventListener('htmx:swapError', function(event) {
        console.error('[Tree] HTMX Swap Error:', event.detail);
    });

    /**
     * HTMX targetError: Target missing, revert UI
     */
    document.body.addEventListener('htmx:targetError', function(event) {
        console.error('[Tree] HTMX Target Error:', event.detail);

        const elt = event.detail.elt;
        const itemId = elt?.dataset?.itemId;

        if (itemId) {
            console.log(`[Tree] Reverting UI for ${itemId}`);
            updateChevron(itemId, false);
            hideSkeleton(itemId);
            setNodeState(itemId, NodeState.UNLOADED);
        }
    });

    // ============================================================================
    // USER INTERACTIONS - Click Handler
    // ============================================================================

    /**
     * Handle expand/collapse button clicks
     *
     * Flow:
     * - UNLOADED → Let HTMX load children
     * - LOADING → Ignore (request in flight)
     * - EXPANDED → Collapse (hide children)
     * - COLLAPSED → Expand (show children)
     */
    document.body.addEventListener('click', function(event) {
        const button = event.target.closest('[data-item-id]');
        if (!button) return;

        const itemId = button.dataset.itemId;
        const state = getNodeState(itemId);

        console.log(`[Tree] Click on ${itemId} (state: ${state})`);

        switch (state) {
            case NodeState.UNLOADED:
                // Let HTMX handle the load
                console.log(`[Tree] Allowing HTMX to load ${itemId}`);
                break;

            case NodeState.LOADING:
                // Ignore clicks during load
                event.preventDefault();
                event.stopPropagation();
                console.log(`[Tree] Ignored click during loading: ${itemId}`);
                break;

            case NodeState.EXPANDED:
                // Collapse (hide children)
                event.preventDefault();
                event.stopPropagation();
                console.log(`[Tree] Collapsing ${itemId}`);
                hideChildren(itemId);
                break;

            case NodeState.COLLAPSED:
                // Expand (show children)
                event.preventDefault();
                event.stopPropagation();
                console.log(`[Tree] Expanding ${itemId}`);
                showChildren(itemId);
                break;

            default:
                console.warn(`[Tree] Unknown state for ${itemId}: ${state}`);
        }
    });

    // ============================================================================
    // BULK OPERATIONS - Expand All / Collapse All
    // ============================================================================

    /**
     * Expand All button handler
     */
    document.getElementById('expand-all-btn')?.addEventListener('click', function() {
        console.log('[Tree] Expand All triggered');
        const allButtons = document.querySelectorAll('[data-item-id]');
        const unloadedButtons = [];

        // First pass: expand already-loaded nodes, collect unloaded nodes
        allButtons.forEach(button => {
            const itemId = button.dataset.itemId;
            const state = getNodeState(itemId);

            if (state === NodeState.UNLOADED) {
                unloadedButtons.push(button);
            } else if (state === NodeState.COLLAPSED) {
                showChildren(itemId);
            }
        });

        // Second pass: sequentially load unloaded nodes (avoid server overload)
        if (unloadedButtons.length > 0) {
            console.log(`[Tree] Loading ${unloadedButtons.length} unloaded nodes`);
            let index = 0;
            const loadNext = () => {
                if (index < unloadedButtons.length) {
                    unloadedButtons[index].click();
                    index++;
                    setTimeout(loadNext, 100); // 100ms delay between requests
                }
            };
            loadNext();
        }

        // Visual feedback
        const icon = this.querySelector('i');
        icon.classList.add('fa-spin');
        setTimeout(() => icon.classList.remove('fa-spin'), 500);
    });

    /**
     * Collapse All button handler
     */
    document.getElementById('collapse-all-btn')?.addEventListener('click', function() {
        console.log('[Tree] Collapse All triggered');
        const allButtons = document.querySelectorAll('[data-item-id]');

        allButtons.forEach(button => {
            const itemId = button.dataset.itemId;
            const state = getNodeState(itemId);

            if (state === NodeState.EXPANDED) {
                hideChildren(itemId);
            }
        });

        // Visual feedback
        const icon = this.querySelector('i');
        icon.classList.add('fa-spin');
        setTimeout(() => icon.classList.remove('fa-spin'), 500);
    });

    // ============================================================================
    // INITIALIZATION
    // ============================================================================

    console.log('✅ Work Items tree navigation initialized');
    console.log('   - State machine: UNLOADED → LOADING → EXPANDED ⇄ COLLAPSED');
    console.log('   - Optimistic UI: < 50ms feedback on user interactions');
    console.log('   - HTMX "click once" trigger: Prevents duplicate requests');
    console.log('   - HTMX attributes removed after first load for instant toggle');

    // ============================================================================
    // TOAST NOTIFICATION SYSTEM
    // ============================================================================

    /**
     * Display toast notification
     * @param {string} message - Notification message
     * @param {string} level - Notification level (success, error, warning, info)
     */
    function showToast(message, level = 'info') {
        // Remove existing toasts
        const existingToast = document.getElementById('work-item-toast');
        if (existingToast) existingToast.remove();

        // Create toast element
        const toast = document.createElement('div');
        toast.id = 'work-item-toast';
        toast.className = 'fixed top-20 right-4 z-[9999] px-6 py-4 rounded-xl shadow-2xl transform transition-all duration-300 ease-out';

        // Color schemes based on level
        const colors = {
            success: 'bg-emerald-600 text-white',
            error: 'bg-red-600 text-white',
            warning: 'bg-amber-600 text-white',
            info: 'bg-blue-600 text-white'
        };

        const icons = {
            success: 'fa-check-circle',
            error: 'fa-times-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };

        toast.className += ' ' + (colors[level] || colors.info);

        toast.innerHTML = `
            <div class="flex items-center gap-3">
                <i class="fas ${icons[level] || icons.info} text-xl"></i>
                <span class="font-medium">${message}</span>
                <button onclick="this.closest('#work-item-toast').remove()" class="ml-4 text-white/80 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        // Add to DOM with animation
        document.body.appendChild(toast);
        setTimeout(() => toast.style.transform = 'translateY(0)', 10);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            toast.style.transform = 'translateY(-100%)';
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    /**
     * Listen for showToast events from HTMX responses
     */
    document.body.addEventListener('showToast', function(event) {
        const { message, level } = event.detail;
        showToast(message, level);
    });

    console.log('✅ Toast notification system initialized');

    // ============================================================================
    // SIDEBAR PANEL FUNCTIONALITY
    // ============================================================================

    /**
     * Open the sidebar panel with smooth transition
     */
    window.openSidebar = function() {
        const sidebar = document.getElementById('work-item-sidebar');
        const backdrop = document.getElementById('sidebar-backdrop');

        if (sidebar && backdrop) {
            sidebar.classList.remove('translate-x-full');
            backdrop.classList.remove('opacity-0', 'pointer-events-none');
            backdrop.classList.add('opacity-100', 'pointer-events-auto');
            console.log('[Sidebar] Opened');
        }
    };

    /**
     * Open sidebar and load content via HTMX
     * @param {HTMLElement} button - Button element with data-hx-get and data-hx-target attributes
     */
    window.openSidebarAndLoad = function(button) {
        // First, open the sidebar
        openSidebar();

        // Get HTMX attributes from button
        const url = button.getAttribute('data-hx-get');
        const target = button.getAttribute('data-hx-target');

        if (!url || !target) {
            console.error('[Sidebar] Missing data-hx-get or data-hx-target attribute');
            return;
        }

        // Wait a tiny bit for sidebar animation to start, then trigger HTMX
        setTimeout(() => {
            htmx.ajax('GET', url, {
                target: target,
                swap: 'innerHTML'
            });
        }, 50);
    };

    /**
     * Close the sidebar panel and clear content
     */
    window.closeSidebar = function() {
        const sidebar = document.getElementById('work-item-sidebar');
        const backdrop = document.getElementById('sidebar-backdrop');

        if (sidebar && backdrop) {
            sidebar.classList.add('translate-x-full');
            backdrop.classList.remove('opacity-100', 'pointer-events-auto');
            backdrop.classList.add('opacity-0', 'pointer-events-none');
            console.log('[Sidebar] Closed');
        }
    };

    /**
     * Listen for HTMX afterSwap to process loaded content in sidebar
     */
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'sidebar-content') {
            console.log('[Sidebar] Content loaded');
            // Process HTMX attributes in the new content
            htmx.process(event.detail.target);
        }
    });

    /**
     * Listen for HTMX oobBeforeSwap to log OOB swap events
     */
    document.body.addEventListener('htmx:oobBeforeSwap', function(event) {
        console.log('[OOB] Before swap:', {
            target: event.detail.target,
            fragment: event.detail.fragment,
            shouldSwap: event.detail.shouldSwap
        });
    });

    /**
     * Listen for HTMX oobAfterSwap to confirm OOB swap success
     */
    document.body.addEventListener('htmx:oobAfterSwap', function(event) {
        console.log('[OOB] After swap:', {
            target: event.detail.target,
            fragment: event.detail.fragment
        });
        // Visual feedback: briefly highlight the updated row
        if (event.detail.target && event.detail.target.tagName === 'TR') {
            const row = event.detail.target;
            row.style.backgroundColor = '#d1fae5'; // Emerald-100
            setTimeout(() => {
                row.style.backgroundColor = '';
            }, 1000);
        }
    });

    /**
     * Listen for workItemCreated event to close sidebar and refresh tree
     * Note: workItemSaved no longer used - edit form stays open with instant row update
     */
    document.body.addEventListener('workItemCreated', function(event) {
        console.log('[Sidebar] Work item created, closing sidebar and reloading');
        closeSidebar();
        // Reload page to show new item in tree (create needs full refresh for hierarchy)
        window.location.reload();
    });

    /**
     * Listen for custom close event from backend
     */
    document.body.addEventListener('closeSidebar', function(event) {
        console.log('[Sidebar] Close event triggered');
        closeSidebar();
    });

    /**
     * Listen for showToast event from HX-Trigger headers
     */
    document.body.addEventListener('showToast', function(event) {
        console.log('[Toast] Showing notification:', event.detail);
        if (event.detail && event.detail.message) {
            showToast(event.detail.message, event.detail.level || 'info');
        }
    });

    console.log('✅ Sidebar panel functionality initialized');
})();
</script>
{% endblock %}
