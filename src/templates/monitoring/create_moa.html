{% extends "base.html" %}

{% block title %}Log MOA PPA{% endblock %}

{% block breadcrumb %}
<li><a href="{% url 'monitoring:home' %}" class="text-neutral-500 hover:text-neutral-700">Monitoring &amp; Evaluation</a></li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li class="text-neutral-800 font-semibold">Log MOA PPA</li>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-8">
    <header class="rounded-2xl bg-gradient-to-r from-blue-500 via-indigo-500 to-cyan-500 text-white shadow-lg p-6">
        <div class="flex items-center gap-4">
            <span class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center text-2xl"><i class="fas fa-building-columns"></i></span>
            <div>
                <h1 class="text-2xl font-semibold">Log MOA Project / Program / Activity</h1>
                <p class="text-white/80">Document a ministry-led initiative that OBC communities can access.</p>
            </div>
        </div>
    </header>

    <form method="post" class="obc-form space-y-8">
        {% csrf_token %}

        <section class="bg-white border border-neutral-200 rounded-2xl shadow-sm p-6 space-y-6">
            <div class="flex items-center gap-3">
                <span class="w-9 h-9 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fas fa-info"></i></span>
                <div>
                    <h2 class="text-lg font-semibold text-neutral-800">PPA Overview</h2>
                    <p class="text-sm text-neutral-500">Outline the core details of the programme or activity.</p>
                </div>
            </div>
            <div class="grid gap-5 md:grid-cols-2">
                {% include "monitoring/includes/form_field.html" with field=form.implementing_moa %}
                {% include "monitoring/includes/form_field.html" with field=form.title label_override="PPA Title" %}
                <div class="md:col-span-2">
                    {% include "monitoring/includes/form_field.html" with field=form.summary label_override="PPA Description" %}
                </div>
                {% include "monitoring/includes/form_field.html" with field=form.budget_allocation label_override="PPA Approved Budget" %}
                {% include "monitoring/includes/form_field.html" with field=form.budget_obc_allocation label_override="Budget Allocation for OBCs" %}
                {% include "monitoring/includes/form_field.html" with field=form.total_slots label_override="Total Number of Slots" %}
                {% include "monitoring/includes/form_field.html" with field=form.obc_slots label_override="Number of Slots for OBCs" %}
            </div>
        </section>

        <section class="bg-white border border-neutral-200 rounded-2xl shadow-sm p-6 space-y-6">
            <div class="flex items-center gap-3">
                <span class="w-9 h-9 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center"><i class="fas fa-map-marker-alt"></i></span>
                <div>
                    <h2 class="text-lg font-semibold text-neutral-800">Geographic Coverage</h2>
                    <p class="text-sm text-neutral-500">Identify the areas where the PPA is available to OBCs.</p>
                </div>
            </div>
            <div class="grid gap-5 md:grid-cols-2 lg:grid-cols-4">
                {% include "monitoring/includes/form_field.html" with field=form.coverage_region label_override="Region" %}
                {% include "monitoring/includes/form_field.html" with field=form.coverage_province label_override="Province" %}
                {% include "monitoring/includes/form_field.html" with field=form.coverage_municipality label_override="Municipality / City" %}
                {% include "monitoring/includes/form_field.html" with field=form.coverage_barangay label_override="Barangay" %}
            </div>
            <div class="md:col-span-2">
                {% include "monitoring/includes/form_field.html" with field=form.obcs_benefited label_override="OBCs Benefited from the PPA" %}
            </div>
        </section>

        <section class="bg-white border border-neutral-200 rounded-2xl shadow-sm p-6 space-y-6">
            <div class="flex items-center gap-3">
                <span class="w-9 h-9 rounded-lg bg-sky-100 text-sky-600 flex items-center justify-center"><i class="fas fa-calendar"></i></span>
                <div>
                    <h2 class="text-lg font-semibold text-neutral-800">Timeline &amp; Resources</h2>
                    <p class="text-sm text-neutral-500">Track implementation progress and resource allocation.</p>
                </div>
            </div>
            <div class="grid gap-5 md:grid-cols-2">
                {% include "monitoring/includes/form_field.html" with field=form.status %}
                {% include "monitoring/includes/form_field.html" with field=form.progress %}
                {% include "monitoring/includes/form_field.html" with field=form.start_date %}
                {% include "monitoring/includes/form_field.html" with field=form.target_end_date %}
            </div>
        </section>

        <div class="flex justify-end gap-3">
            <a href="{% url 'monitoring:home' %}" class="px-4 py-2 rounded-lg border border-neutral-300 text-neutral-600 hover:bg-neutral-100">Cancel</a>
            <button type="submit" class="px-4 py-2 rounded-lg btn-primary font-semibold">Save MOA PPA</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
{{ location_data|json_script:"location-data" }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const dataElement = document.getElementById('location-data');
    if (!dataElement) {
        return;
    }

    let locationData;
    try {
        locationData = JSON.parse(dataElement.textContent);
    } catch (error) {
        console.error('Unable to parse location data for coverage selectors.', error);
        return;
    }

    const regionSelect = document.getElementById('id_coverage_region');
    const provinceSelect = document.getElementById('id_coverage_province');
    const municipalitySelect = document.getElementById('id_coverage_municipality');
    const barangaySelect = document.getElementById('id_coverage_barangay');

    if (!regionSelect) {
        return;
    }

    const getAttr = (el, key, fallback = '') =>
        el && el.dataset && el.dataset[key] !== undefined ? el.dataset[key] : fallback;

    const regionPlaceholder = getAttr(regionSelect, 'placeholder', 'Select region...');
    const provincePlaceholder = getAttr(provinceSelect, 'placeholder', 'Select province...');
    const municipalityPlaceholder = getAttr(
        municipalitySelect,
        'placeholder',
        'Select municipality / city...'
    );
    const barangayPlaceholder = getAttr(barangaySelect, 'placeholder', 'Select barangay...');

    const initialRegion = getAttr(regionSelect, 'initial', '');
    const initialProvince = getAttr(provinceSelect, 'initial', '');
    const initialMunicipality = getAttr(municipalitySelect, 'initial', '');
    const initialBarangay = getAttr(barangaySelect, 'initial', '');

    const provincesByRegion = new Map();
    (locationData.provinces || []).forEach(province => {
        const key = String(province.region_id);
        if (!provincesByRegion.has(key)) {
            provincesByRegion.set(key, []);
        }
        provincesByRegion.get(key).push(province);
    });

    const municipalitiesByProvince = new Map();
    (locationData.municipalities || []).forEach(municipality => {
        const key = String(municipality.province_id);
        if (!municipalitiesByProvince.has(key)) {
            municipalitiesByProvince.set(key, []);
        }
        municipalitiesByProvince.get(key).push(municipality);
    });

    const barangaysByMunicipality = new Map();
    (locationData.barangays || []).forEach(barangay => {
        const key = String(barangay.municipality_id);
        if (!barangaysByMunicipality.has(key)) {
            barangaysByMunicipality.set(key, []);
        }
        barangaysByMunicipality.get(key).push(barangay);
    });

    const toStringId = value => (value === null || value === undefined ? '' : String(value));

    const setOptions = (select, options, placeholder, selectedValue, labelFn) => {
        if (!select) {
            return;
        }

        const desired = toStringId(selectedValue);
        select.innerHTML = '';

        const placeholderOption = document.createElement('option');
        placeholderOption.value = '';
        placeholderOption.textContent = placeholder;
        select.appendChild(placeholderOption);

        const normalisedOptions = options || [];
        normalisedOptions.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = String(option.id);
            optionElement.textContent = labelFn ? labelFn(option) : option.name;
            select.appendChild(optionElement);
        });

        const hasDesired = normalisedOptions.some(option => String(option.id) === desired);
        select.value = hasDesired ? desired : '';
    };

    const regionLabel = region =>
        region && region.code ? `Region ${region.code} - ${region.name}` : region.name;

    const updateProvinceOptions = (regionId, selectedValue) => {
        const options = regionId ? provincesByRegion.get(toStringId(regionId)) || [] : [];
        setOptions(provinceSelect, options, provincePlaceholder, selectedValue);
    };

    const updateMunicipalityOptions = (provinceId, selectedValue) => {
        const options = provinceId ? municipalitiesByProvince.get(toStringId(provinceId)) || [] : [];
        setOptions(municipalitySelect, options, municipalityPlaceholder, selectedValue);
    };

    const updateBarangayOptions = (municipalityId, selectedValue) => {
        const options = municipalityId ? barangaysByMunicipality.get(toStringId(municipalityId)) || [] : [];
        setOptions(barangaySelect, options, barangayPlaceholder, selectedValue);
    };

    setOptions(regionSelect, locationData.regions || [], regionPlaceholder, initialRegion, regionLabel);
    updateProvinceOptions(initialRegion, initialProvince);
    updateMunicipalityOptions(initialProvince, initialMunicipality);
    updateBarangayOptions(initialMunicipality, initialBarangay);

    regionSelect.addEventListener('change', () => {
        updateProvinceOptions(regionSelect.value, '');
        updateMunicipalityOptions('', '');
        updateBarangayOptions('', '');
    });

    if (provinceSelect) {
        provinceSelect.addEventListener('change', () => {
            updateMunicipalityOptions(provinceSelect.value, '');
            updateBarangayOptions('', '');
        });
    }

    if (municipalitySelect) {
        municipalitySelect.addEventListener('change', () => {
            updateBarangayOptions(municipalitySelect.value, '');
        });
    }
});
</script>
{% endblock %}
