{% load humanize %}

<!-- Budget Distribution Modal -->
<div
    x-data="budgetDistributor({
        totalBudget: {{ entry.allocated_budget|default:0 }},
        workItems: {{ work_items_json|safe }},
        entryId: {{ entry.id }}
    })"
    x-show="true"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 z-50 overflow-y-auto"
    aria-labelledby="modal-title"
    role="dialog"
    aria-modal="true"
    @keydown.escape.window="$el.dispatchEvent(new CustomEvent('close-modal'))"
>
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity"></div>

    <!-- Modal Container -->
    <div class="flex min-h-screen items-center justify-center p-4">
        <div
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
            x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
            x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
            class="relative w-full max-w-4xl bg-white rounded-xl shadow-2xl overflow-hidden"
            @click.away="$el.dispatchEvent(new CustomEvent('close-modal'))"
        >
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-teal-500 px-6 py-5">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h3 class="text-xl font-semibold text-white" id="modal-title">
                            Distribute Budget
                        </h3>
                        <p class="mt-1 text-sm text-blue-100">
                            {{ entry.title|truncatewords:10 }}
                        </p>
                        <div class="mt-3 flex items-center space-x-2">
                            <span class="text-xs font-medium text-blue-100">Total Budget:</span>
                            <span class="text-2xl font-bold text-white" x-text="formatCurrency(totalBudget)"></span>
                        </div>
                    </div>
                    <button
                        type="button"
                        @click="$el.dispatchEvent(new CustomEvent('close-modal'))"
                        class="ml-4 rounded-lg p-2 text-white/80 hover:bg-white/10 hover:text-white transition-colors"
                        aria-label="Close modal"
                    >
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Body -->
            <div class="px-6 py-6">
                <!-- Step 1: Method Selection -->
                <div class="mb-8">
                    <label class="block text-sm font-medium text-gray-700 mb-4">
                        Distribution Method <span class="text-red-500">*</span>
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Equal Distribution -->
                        <label
                            class="relative flex flex-col p-4 border-2 rounded-xl cursor-pointer transition-all duration-200 hover:shadow-md"
                            :class="method === 'equal' ? 'border-emerald-500 bg-emerald-50' : 'border-gray-200 hover:border-emerald-300'"
                        >
                            <input
                                type="radio"
                                name="distribution_method"
                                value="equal"
                                x-model="method"
                                @change="calculateDistribution()"
                                class="sr-only"
                            >
                            <div class="flex items-center space-x-3 mb-2">
                                <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                                    <i class="fas fa-equals text-blue-600"></i>
                                </div>
                                <div class="flex-1">
                                    <span class="block text-sm font-semibold text-gray-900">Equal Distribution</span>
                                </div>
                                <div
                                    class="flex-shrink-0 w-5 h-5 rounded-full border-2 flex items-center justify-center"
                                    :class="method === 'equal' ? 'border-emerald-500 bg-emerald-500' : 'border-gray-300'"
                                >
                                    <i x-show="method === 'equal'" class="fas fa-check text-white text-xs"></i>
                                </div>
                            </div>
                            <p class="text-xs text-gray-600 mb-2">
                                Split budget equally across all work items
                            </p>
                            <div x-show="method === 'equal'" class="mt-2 pt-2 border-t border-emerald-200">
                                <p class="text-xs font-medium text-emerald-700">
                                    Each of <span x-text="workItems.length"></span> work items gets
                                    <span x-text="formatCurrency(totalBudget / workItems.length)"></span>
                                </p>
                            </div>
                        </label>

                        <!-- Weighted Distribution -->
                        <label
                            class="relative flex flex-col p-4 border-2 rounded-xl cursor-pointer transition-all duration-200 hover:shadow-md"
                            :class="method === 'weighted' ? 'border-emerald-500 bg-emerald-50' : 'border-gray-200 hover:border-emerald-300'"
                        >
                            <input
                                type="radio"
                                name="distribution_method"
                                value="weighted"
                                x-model="method"
                                @change="calculateDistribution()"
                                class="sr-only"
                            >
                            <div class="flex items-center space-x-3 mb-2">
                                <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center">
                                    <i class="fas fa-percentage text-purple-600"></i>
                                </div>
                                <div class="flex-1">
                                    <span class="block text-sm font-semibold text-gray-900">Weighted Distribution</span>
                                </div>
                                <div
                                    class="flex-shrink-0 w-5 h-5 rounded-full border-2 flex items-center justify-center"
                                    :class="method === 'weighted' ? 'border-emerald-500 bg-emerald-500' : 'border-gray-300'"
                                >
                                    <i x-show="method === 'weighted'" class="fas fa-check text-white text-xs"></i>
                                </div>
                            </div>
                            <p class="text-xs text-gray-600 mb-2">
                                Assign percentage weights to each work item
                            </p>
                            <div x-show="method === 'weighted'" class="mt-2 pt-2 border-t border-emerald-200">
                                <div class="flex items-center justify-between">
                                    <p class="text-xs font-medium" :class="isWeightValid() ? 'text-emerald-700' : 'text-red-600'">
                                        Total: <span x-text="totalWeight()"></span>%
                                    </p>
                                    <i class="fas text-xs" :class="isWeightValid() ? 'fa-check-circle text-emerald-600' : 'fa-exclamation-circle text-red-600'"></i>
                                </div>
                            </div>
                        </label>

                        <!-- Manual Distribution -->
                        <label
                            class="relative flex flex-col p-4 border-2 rounded-xl cursor-pointer transition-all duration-200 hover:shadow-md"
                            :class="method === 'manual' ? 'border-emerald-500 bg-emerald-50' : 'border-gray-200 hover:border-emerald-300'"
                        >
                            <input
                                type="radio"
                                name="distribution_method"
                                value="manual"
                                x-model="method"
                                @change="calculateDistribution()"
                                class="sr-only"
                            >
                            <div class="flex items-center space-x-3 mb-2">
                                <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center">
                                    <i class="fas fa-hand-pointer text-orange-600"></i>
                                </div>
                                <div class="flex-1">
                                    <span class="block text-sm font-semibold text-gray-900">Manual Allocation</span>
                                </div>
                                <div
                                    class="flex-shrink-0 w-5 h-5 rounded-full border-2 flex items-center justify-center"
                                    :class="method === 'manual' ? 'border-emerald-500 bg-emerald-500' : 'border-gray-300'"
                                >
                                    <i x-show="method === 'manual'" class="fas fa-check text-white text-xs"></i>
                                </div>
                            </div>
                            <p class="text-xs text-gray-600 mb-2">
                                Manually set budget amount for each work item
                            </p>
                            <div x-show="method === 'manual'" class="mt-2 pt-2 border-t border-emerald-200">
                                <div class="flex items-center justify-between">
                                    <p class="text-xs font-medium" :class="isManualValid() ? 'text-emerald-700' : 'text-red-600'">
                                        Allocated: <span x-text="formatCurrency(totalAllocated())"></span>
                                    </p>
                                    <i class="fas text-xs" :class="isManualValid() ? 'fa-check-circle text-emerald-600' : 'fa-exclamation-circle text-red-600'"></i>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Step 2: Work Items Configuration -->
                <div x-show="method !== null" x-transition class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-4">
                        Work Items Allocation
                    </label>

                    <!-- Work Items Table -->
                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gradient-to-r from-blue-600 to-teal-500">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                                            Work Item
                                        </th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                                            Current Budget
                                        </th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                                            <span x-show="method === 'weighted'">Weight (%)</span>
                                            <span x-show="method === 'manual'">Allocated Amount</span>
                                            <span x-show="method === 'equal'">New Amount</span>
                                        </th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                                            Preview
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <template x-for="(item, index) in workItems" :key="item.id">
                                        <tr class="hover:bg-gray-50 transition-colors">
                                            <!-- Work Item Title -->
                                            <td class="px-4 py-3">
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-sm font-medium text-gray-900" x-text="item.title"></span>
                                                    <span
                                                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                                                        :class="getWorkTypeBadgeClass(item.work_type)"
                                                        x-text="item.work_type_display"
                                                    ></span>
                                                </div>
                                            </td>

                                            <!-- Current Budget -->
                                            <td class="px-4 py-3">
                                                <span class="text-sm text-gray-600" x-text="formatCurrency(item.current_budget || 0)"></span>
                                            </td>

                                            <!-- Input Field (method-dependent) -->
                                            <td class="px-4 py-3">
                                                <!-- Equal: Disabled, shows calculated -->
                                                <input
                                                    x-show="method === 'equal'"
                                                    type="text"
                                                    :value="formatCurrency(totalBudget / workItems.length)"
                                                    disabled
                                                    class="block w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-600 cursor-not-allowed"
                                                >

                                                <!-- Weighted: Percentage input -->
                                                <div x-show="method === 'weighted'" class="space-y-2">
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        max="100"
                                                        step="0.01"
                                                        x-model.number="distribution[item.id].weight"
                                                        @input="calculateWeightedAmount(item.id)"
                                                        class="block w-full px-3 py-2 border rounded-lg text-sm min-h-[40px] focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all"
                                                        :class="isWeightValid() ? 'border-emerald-300' : 'border-red-300'"
                                                        placeholder="0.00"
                                                    >
                                                    <input
                                                        type="range"
                                                        min="0"
                                                        max="100"
                                                        step="0.1"
                                                        x-model.number="distribution[item.id].weight"
                                                        @input="calculateWeightedAmount(item.id)"
                                                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                                                    >
                                                </div>

                                                <!-- Manual: Currency input -->
                                                <div x-show="method === 'manual'" class="relative">
                                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                        <span class="text-gray-500 text-sm">₱</span>
                                                    </div>
                                                    <input
                                                        type="text"
                                                        x-model="distribution[item.id].displayAmount"
                                                        @input="handleManualInput(item.id, $event.target.value)"
                                                        @blur="formatManualInput(item.id)"
                                                        class="block w-full pl-8 pr-3 py-2 border rounded-lg text-sm min-h-[40px] focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all"
                                                        :class="isManualValid() ? 'border-emerald-300' : 'border-red-300'"
                                                        placeholder="0.00"
                                                    >
                                                </div>
                                            </td>

                                            <!-- Preview -->
                                            <td class="px-4 py-3">
                                                <span class="text-sm font-medium text-emerald-600" x-text="formatCurrency(distribution[item.id].amount)"></span>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Validation Summary -->
                    <div class="mt-4 p-4 rounded-lg border-2" :class="isValid() ? 'border-emerald-200 bg-emerald-50' : 'border-red-200 bg-red-50'">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                <i class="fas text-xl" :class="isValid() ? 'fa-check-circle text-emerald-600' : 'fa-exclamation-circle text-red-600'"></i>
                            </div>
                            <div class="flex-1 space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium" :class="isValid() ? 'text-emerald-900' : 'text-red-900'">
                                        Total Budget:
                                    </span>
                                    <span class="text-base font-bold" :class="isValid() ? 'text-emerald-900' : 'text-red-900'" x-text="formatCurrency(totalBudget)"></span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium" :class="isValid() ? 'text-emerald-900' : 'text-red-900'">
                                        Total Allocated:
                                    </span>
                                    <span class="text-base font-bold" :class="isValid() ? 'text-emerald-900' : 'text-red-900'" x-text="formatCurrency(totalAllocated())"></span>
                                </div>
                                <div class="flex items-center justify-between pt-2 border-t" :class="isValid() ? 'border-emerald-200' : 'border-red-200'">
                                    <span class="text-sm font-medium" :class="isValid() ? 'text-emerald-900' : 'text-red-900'">
                                        <span x-show="method === 'weighted'">Weight Remaining:</span>
                                        <span x-show="method === 'manual'">Unallocated:</span>
                                        <span x-show="method === 'equal'">Status:</span>
                                    </span>
                                    <span class="text-base font-bold" :class="isValid() ? 'text-emerald-900' : 'text-red-900'">
                                        <span x-show="method === 'weighted'" x-text="(100 - totalWeight()).toFixed(2) + '%'"></span>
                                        <span x-show="method === 'manual'" x-text="formatCurrency(totalBudget - totalAllocated())"></span>
                                        <span x-show="method === 'equal'">Valid <i class="fas fa-check ml-1"></i></span>
                                    </span>
                                </div>

                                <!-- Error Messages -->
                                <div x-show="!isValid()" class="pt-2 space-y-1">
                                    <p x-show="method === 'weighted' && totalWeight() !== 100" class="text-xs text-red-700">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                        Weight percentages must sum to exactly 100%
                                    </p>
                                    <p x-show="method === 'manual' && Math.abs(totalBudget - totalAllocated()) > 0.01" class="text-xs text-red-700">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                        Total allocated amount must equal the PPA budget
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="bg-gray-50 px-6 py-4 flex items-center justify-between border-t border-gray-200">
                <button
                    type="button"
                    @click="$el.dispatchEvent(new CustomEvent('close-modal'))"
                    class="px-6 py-2.5 border-2 border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 hover:border-gray-400 transition-all duration-200"
                >
                    Cancel
                </button>

                <button
                    type="button"
                    @click="submitDistribution()"
                    :disabled="!isValid() || isSubmitting"
                    class="px-6 py-2.5 rounded-lg text-sm font-medium text-white transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    :class="isValid() && !isSubmitting ? 'bg-gradient-to-r from-blue-600 to-teal-500 hover:from-blue-700 hover:to-teal-600 shadow-md hover:shadow-lg' : 'bg-gray-400'"
                >
                    <span x-show="!isSubmitting" class="flex items-center space-x-2">
                        <i class="fas fa-paper-plane"></i>
                        <span>Distribute Budget</span>
                    </span>
                    <span x-show="isSubmitting" class="flex items-center space-x-2">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Distributing...</span>
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Alpine.js Component -->
<script>
function budgetDistributor(config) {
    return {
        totalBudget: config.totalBudget,
        workItems: config.workItems,
        entryId: config.entryId,
        method: null,
        distribution: {},
        isSubmitting: false,

        init() {
            // Initialize distribution object for each work item
            this.workItems.forEach(item => {
                this.distribution[item.id] = {
                    weight: 0,
                    amount: 0,
                    displayAmount: '0.00'
                };
            });
        },

        calculateDistribution() {
            if (this.method === 'equal') {
                const equalAmount = this.totalBudget / this.workItems.length;
                this.workItems.forEach(item => {
                    this.distribution[item.id].amount = equalAmount;
                });
            } else if (this.method === 'weighted') {
                // Reset weights when switching to weighted
                this.workItems.forEach(item => {
                    this.distribution[item.id].weight = 0;
                    this.distribution[item.id].amount = 0;
                });
            } else if (this.method === 'manual') {
                // Reset amounts when switching to manual
                this.workItems.forEach(item => {
                    this.distribution[item.id].amount = 0;
                    this.distribution[item.id].displayAmount = '0.00';
                });
            }
        },

        calculateWeightedAmount(itemId) {
            const weight = this.distribution[itemId].weight || 0;
            this.distribution[itemId].amount = (this.totalBudget * weight) / 100;
        },

        handleManualInput(itemId, value) {
            // Remove non-numeric characters except decimal point
            const cleanValue = value.replace(/[^\d.]/g, '');
            const numericValue = parseFloat(cleanValue) || 0;
            this.distribution[itemId].amount = numericValue;
            this.distribution[itemId].displayAmount = cleanValue;
        },

        formatManualInput(itemId) {
            const amount = this.distribution[itemId].amount;
            this.distribution[itemId].displayAmount = this.formatNumber(amount);
        },

        totalWeight() {
            return this.workItems.reduce((sum, item) => {
                return sum + (this.distribution[item.id].weight || 0);
            }, 0);
        },

        totalAllocated() {
            return this.workItems.reduce((sum, item) => {
                return sum + (this.distribution[item.id].amount || 0);
            }, 0);
        },

        isWeightValid() {
            if (this.method !== 'weighted') return true;
            const total = this.totalWeight();
            return Math.abs(total - 100) < 0.01; // Allow 0.01% tolerance
        },

        isManualValid() {
            if (this.method !== 'manual') return true;
            const variance = Math.abs(this.totalBudget - this.totalAllocated());
            return variance < 0.01; // Allow ₱0.01 tolerance
        },

        isValid() {
            if (!this.method) return false;
            if (this.method === 'equal') return true;
            if (this.method === 'weighted') return this.isWeightValid();
            if (this.method === 'manual') return this.isManualValid();
            return false;
        },

        getDistributionData() {
            const data = {};
            this.workItems.forEach(item => {
                data[item.id] = this.distribution[item.id].amount;
            });
            return data;
        },

        formatCurrency(amount) {
            return '₱' + this.formatNumber(amount);
        },

        formatNumber(num) {
            return new Intl.NumberFormat('en-PH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num || 0);
        },

        getWorkTypeBadgeClass(workType) {
            const classes = {
                'staff_task': 'bg-blue-100 text-blue-800',
                'event': 'bg-purple-100 text-purple-800',
                'project_workflow': 'bg-emerald-100 text-emerald-800'
            };
            return classes[workType] || 'bg-gray-100 text-gray-800';
        },

        async submitDistribution() {
            if (!this.isValid() || this.isSubmitting) return;

            this.isSubmitting = true;

            try {
                const response = await fetch(`/monitoring/entries/${this.entryId}/distribute-budget/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        method: this.method,
                        distribution: this.getDistributionData()
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Trigger success events
                    window.dispatchEvent(new CustomEvent('budget-distributed', {
                        detail: data
                    }));

                    // Show success toast
                    this.showToast('Budget distributed successfully', 'success');

                    // Close modal
                    this.$el.dispatchEvent(new CustomEvent('close-modal'));

                    // Refresh page stats (if using HTMX)
                    if (window.htmx) {
                        window.htmx.trigger(document.body, 'refresh-stats');
                    }
                } else {
                    // Show error message
                    this.showToast(data.error || 'Failed to distribute budget', 'error');
                }
            } catch (error) {
                console.error('Distribution error:', error);
                this.showToast('Network error. Please try again.', 'error');
            } finally {
                this.isSubmitting = false;
            }
        },

        getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        },

        showToast(message, type) {
            // Dispatch custom event for toast notification system
            window.dispatchEvent(new CustomEvent('show-toast', {
                detail: { message, type }
            }));
        }
    };
}
</script>
