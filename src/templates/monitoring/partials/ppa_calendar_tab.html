{% load static %}

<!-- PPA Calendar Tab -->
<!-- Displays calendar events from work items belonging to this specific PPA -->

<div class="space-y-6">
    <!-- Calendar Description -->
    <div class="bg-blue-50 border-l-4 border-blue-500 rounded-r-lg p-4">
        <div class="flex items-start">
            <i class="fas fa-info-circle text-blue-500 text-xl mt-0.5 mr-3"></i>
            <div class="text-sm text-blue-800">
                <p class="font-semibold mb-1">PPA Calendar View</p>
                <p>This calendar shows all work items (projects, activities, tasks, and subtasks) linked to this specific MOA PPA.</p>
            </div>
        </div>
    </div>

    <!-- Calendar Container -->
    <div id="ppaCalendarContainer" class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
        <!-- Calendar will be rendered here -->
        <div id="ppaFullCalendar" style="padding: 1.5rem; min-height: 700px;"></div>
    </div>
</div>

<!-- Calendar Initialization Script -->
<link href="{% static 'common/vendor/fullcalendar/main.min.css' %}" rel="stylesheet">
<script src="{% static 'common/vendor/fullcalendar/index.global.min.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Only initialize calendar when the calendar tab becomes visible
    const calendarTab = document.getElementById('tab-calendar');
    let calendarInitialized = false;

    function initializePPACalendar() {
        if (calendarInitialized) return;

        const calendarEl = document.getElementById('ppaFullCalendar');
        if (!calendarEl) {
            console.error('Calendar element not found');
            return;
        }

        console.log('Initializing PPA calendar...');

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            buttonText: {
                today: 'Today',
                month: 'Month',
                week: 'Week',
                day: 'Day',
                list: 'List'
            },
            height: 'auto',
            contentHeight: 650,
            expandRows: true,
            slotMinTime: '06:00:00',
            slotMaxTime: '22:00:00',
            nowIndicator: true,
            navLinks: true,
            editable: false,
            selectable: true,
            selectMirror: true,
            dayMaxEvents: true,
            weekends: true,
            themeSystem: 'standard',

            // Fetch events from PPA-specific endpoint
            events: {
                url: '{% url "monitoring:ppa_calendar_feed" entry.id %}',
                failure: function(error) {
                    console.error('Failed to load calendar events:', error);
                    alert('Error loading calendar events for this PPA. Please check console for details.');
                }
            },

            // Loading indicator
            loading: function(isLoading) {
                if (isLoading) {
                    console.log('Loading calendar events...');
                } else {
                    console.log('Calendar events loaded');
                }
            },

            // Event rendering
            eventContent: function(arg) {
                let iconClass = 'fa-tasks';
                if (arg.event.extendedProps.work_type === 'project') iconClass = 'fa-folder';
                else if (arg.event.extendedProps.work_type === 'activity') iconClass = 'fa-list-check';
                else if (arg.event.extendedProps.work_type === 'task') iconClass = 'fa-check-square';
                else if (arg.event.extendedProps.work_type === 'subtask') iconClass = 'fa-check';

                return {
                    html: `
                        <div class="fc-event-main-frame p-1">
                            <div class="fc-event-title-container">
                                <div class="fc-event-title fc-sticky text-xs font-medium">
                                    <i class="fas ${iconClass} mr-1"></i>
                                    ${arg.event.title}
                                </div>
                            </div>
                        </div>
                    `
                };
            },

            // Click handler
            eventClick: function(info) {
                const workItemId = info.event.extendedProps.work_item_id;
                if (workItemId) {
                    // Open work item detail in modal or navigate
                    window.location.href = `/oobc-management/work-items/${workItemId}/`;
                }
            },

            // Date click handler
            dateClick: function(info) {
                console.log('Date clicked:', info.dateStr);
            }
        });

        try {
            calendar.render();
            calendarInitialized = true;
            console.log('PPA calendar rendered successfully');
        } catch (error) {
            console.error('Error rendering calendar:', error);
        }
    }

    // Initialize calendar when tab is clicked
    if (calendarTab) {
        calendarTab.addEventListener('click', function() {
            console.log('Calendar tab clicked, initializing...');
            setTimeout(initializePPACalendar, 100);
        });
    } else {
        console.warn('Calendar tab button not found');
    }
});
</script>

<style>
/* Calendar customizations */
#ppaFullCalendar {
    padding: 1rem;
}

#ppaFullCalendar .fc-toolbar {
    margin-bottom: 1.5rem;
}

#ppaFullCalendar .fc-button {
    background: linear-gradient(to right, #2563eb, #10b981);
    border: none;
    text-transform: capitalize;
    font-weight: 500;
}

#ppaFullCalendar .fc-button:hover {
    background: linear-gradient(to right, #1d4ed8, #059669);
}

#ppaFullCalendar .fc-button-active {
    background: linear-gradient(to right, #1e40af, #047857);
}

#ppaFullCalendar .fc-event {
    cursor: pointer;
    border-radius: 4px;
    transition: transform 0.2s, box-shadow 0.2s;
}

#ppaFullCalendar .fc-event:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

#ppaFullCalendar .fc-daygrid-day-number {
    font-weight: 600;
    color: #374151;
}

#ppaFullCalendar .fc-col-header-cell {
    background: linear-gradient(to bottom, #f3f4f6, #e5e7eb);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    color: #4b5563;
}
</style>
