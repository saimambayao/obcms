<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{% block title %}OBC Management System{% endblock %}</title>
    
    <!-- Tailwind CSS (Production Build) -->
    <link rel="stylesheet" href="{% static 'css/output.css' %}">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <style>
        /* PRIMARY COLOR SYSTEM - Based on Blue-to-Teal Gradient */
        :root {
            /* Primary Gradient Colors */
            --primary-blue: #1e40af;
            --primary-teal: #059669;
            --primary-blue-light: #3b82f6;
            --primary-blue-lighter: #60a5fa;
            --primary-blue-lightest: #93c5fd;
            --primary-blue-dark: #1d4ed8;
            --primary-blue-darker: #1e3a8a;
            --primary-teal-light: #10b981;
            --primary-teal-lighter: #34d399;
            --primary-teal-lightest: #6ee7b7;
            --primary-teal-dark: #047857;
            --primary-teal-darker: #065f46;
            
            /* Secondary Colors */
            --secondary-coral: #f472b6;
            --secondary-coral-light: #f9a8d4;
            --secondary-coral-dark: #ec4899;
            --secondary-purple: #8b5cf6;
            --secondary-purple-light: #a78bfa;
            --secondary-purple-dark: #7c3aed;
            
            /* Tertiary Colors */
            --tertiary-amber: #f59e0b;
            --tertiary-amber-light: #fbbf24;
            --tertiary-amber-dark: #d97706;
            --success-green: #10b981;
            --error-red: #ef4444;
            --warning-yellow: #f59e0b;
            
            /* Neutral Colors */
            --neutral-50: #f9fafb;
            --neutral-100: #f3f4f6;
            --neutral-200: #e5e7eb;
            --neutral-300: #d1d5db;
            --neutral-400: #9ca3af;
            --neutral-500: #6b7280;
            --neutral-600: #4b5563;
            --neutral-700: #374151;
            --neutral-800: #1f2937;
            --neutral-900: #111827;
        }

        /* Primary Gradient Classes */
        .bg-bangsamoro,
        .bg-bangsamoro-gradient {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-teal) 100%);
        }
        
        .bg-bangsamoro-reverse {
            background: linear-gradient(135deg, var(--primary-teal) 0%, var(--primary-blue) 100%);
        }
        
        .bg-bangsamoro-radial {
            background: radial-gradient(circle at center, var(--primary-blue) 0%, var(--primary-teal) 100%);
        }

        /* Text Colors */
        .text-bangsamoro {
            color: var(--primary-blue);
        }
        .text-bangsamoro-teal {
            color: var(--primary-teal);
        }
        .text-bangsamoro-light {
            color: var(--primary-blue-light);
        }
        .text-bangsamoro-gradient {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-teal) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Button Classes */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-teal) 100%);
            color: white;
            border: none;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-blue-dark) 0%, var(--primary-teal-dark) 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(30, 64, 175, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-coral) 0%, var(--secondary-purple) 100%);
            color: white;
            border: none;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, var(--secondary-coral-dark) 0%, var(--secondary-purple-dark) 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(244, 114, 182, 0.3);
        }
        
        .btn-tertiary {
            background: var(--tertiary-amber);
            color: white;
            border: none;
            transition: all 0.3s ease;
        }
        .btn-tertiary:hover {
            background: var(--tertiary-amber-dark);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
        }

        /* Background Classes */
        .bg-primary-light {
            background-color: var(--primary-blue-lightest);
        }
        .bg-primary-teal-light {
            background-color: var(--primary-teal-lightest);
        }
        .bg-secondary-light {
            background-color: var(--secondary-coral-light);
        }
        .bg-tertiary-light {
            background-color: var(--tertiary-amber-light);
        }

        /* Border Classes */
        .border-bangsamoro {
            border-color: var(--primary-blue);
        }
        .border-bangsamoro-teal {
            border-color: var(--primary-teal);
        }
        .border-bangsamoro-gradient {
            border: 2px solid transparent;
            background: linear-gradient(white, white) padding-box,
                        linear-gradient(135deg, var(--primary-blue), var(--primary-teal)) border-box;
        }

        /* Interactive Effects */
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .hover-gradient:hover {
            background: linear-gradient(135deg, var(--primary-blue-light) 0%, var(--primary-teal-light) 100%);
            transition: all 0.3s ease;
        }
        
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        /* Card and Component Styles */
        .card-gradient {
            background: linear-gradient(135deg, var(--neutral-50) 0%, var(--primary-blue-lightest) 100%);
            border: 1px solid var(--primary-blue-lighter);
        }
        
        .card-teal-gradient {
            background: linear-gradient(135deg, var(--neutral-50) 0%, var(--primary-teal-lightest) 100%);
            border: 1px solid var(--primary-teal-lighter);
        }

        /* Status and Alert Colors */
        .status-success {
            background-color: var(--success-green);
            color: white;
        }
        .status-error {
            background-color: var(--error-red);
            color: white;
        }
        .status-warning {
            background-color: var(--warning-yellow);
            color: white;
        }
        .status-info {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-teal) 100%);
            color: white;
        }

        /* Modern select styling for Barangay & Municipal OBC forms */
        .obc-form select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding: 0.9rem 3rem 0.9rem 1rem;
            min-height: 3.25rem;
            border-radius: 0.75rem;
            border: 1px solid var(--neutral-300);
            background-color: #fff;
            background-image:
                linear-gradient(45deg, transparent 50%, var(--neutral-500) 50%),
                linear-gradient(135deg, var(--neutral-500) 50%, transparent 50%),
                linear-gradient(to right, var(--neutral-200), var(--neutral-200));
            background-position:
                calc(100% - 1.35rem) calc(50% - 0.35rem),
                calc(100% - 1.05rem) calc(50% - 0.35rem),
                calc(100% - 2.5rem) 50%;
            background-size: 0.5rem 0.5rem, 0.5rem 0.5rem, 1px 65%;
            background-repeat: no-repeat;
            font-size: 1rem;
            line-height: 1.5;
            color: var(--neutral-800);
            box-shadow: 0 8px 16px rgba(15, 23, 42, 0.05);
            transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
        }

        .obc-form select:hover {
            border-color: var(--neutral-400);
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08);
        }

        .obc-form select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.18);
            transform: translateY(-1px);
        }

        .obc-form select:disabled {
            background-color: var(--neutral-100);
            color: var(--neutral-500);
            cursor: not-allowed;
            box-shadow: none;
        }

        .obc-form select[multiple],
        .obc-form select[size]:not([size="1"]) {
            background-image: none;
            padding-right: 1rem;
            min-height: 6rem;
        }

        .obc-form select option {
            color: var(--neutral-800);
        }

        .obc-form select option[disabled] {
            color: var(--neutral-400);
        }

        /* Animation Classes */
        .gradient-shift {
            background: linear-gradient(270deg, var(--primary-blue), var(--primary-teal), var(--secondary-purple), var(--primary-blue));
            background-size: 800% 800%;
            animation: gradientShift 8s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Focus States */
        .focus-bangsamoro:focus {
            outline: none;
            ring: 2px solid var(--primary-blue);
            border-color: var(--primary-blue);
        }

        .focus-bangsamoro-teal:focus {
            outline: none;
            ring: 2px solid var(--primary-teal);
            border-color: var(--primary-teal);
        }

        /* Placeholder Contrast Fix - WCAG AA Compliance (4.5:1 ratio) */
        ::placeholder {
            color: var(--neutral-500); /* gray-500 #6b7280 instead of gray-400 #9ca3af */
            opacity: 1;
        }
        :-ms-input-placeholder {
            color: var(--neutral-500);
        }
        ::-ms-input-placeholder {
            color: var(--neutral-500);
        }

        /* Mobile Responsive Utilities */
        @media (max-width: 475px) {
            .xs\:hidden { display: none; }
            .xs\:block { display: block; }
            .xs\:flex { display: flex; }
        }

        /* Enhanced Dropdown Styles */
        .user-dropdown-menu {
            min-width: 12rem;
            border: 1px solid var(--neutral-200);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .user-dropdown-menu.opacity-100 {
            opacity: 1;
        }

        .user-dropdown-menu.opacity-0 {
            opacity: 0;
        }

        .user-dropdown-menu.scale-100 {
            transform: scale(1);
        }

        .user-dropdown-menu.scale-95 {
            transform: scale(0.95);
        }

        /* Mobile Navigation Enhancements */
        @media (max-width: 1023px) {
            .mobile-nav-item {
                position: relative;
                overflow: hidden;
            }

            .mobile-nav-item::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
                transition: left 0.5s;
            }

            .mobile-nav-item:hover::before {
                left: 100%;
            }
        }

        /* Touch Device Optimizations */
        .touch-device .nav-item {
            padding: 0.75rem 1rem;
        }

        .touch-device .user-dropdown button {
            width: 2.5rem;
            height: 2.5rem;
        }

        /* Navbar Responsiveness */
        @media (max-width: 1024px) {
            nav .max-w-7xl {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
        }

        @media (max-width: 768px) {
            nav h1 {
                font-size: 1rem;
            }
            
            nav .text-xs {
                font-size: 0.625rem;
            }
        }

        @media (max-width: 640px) {
            nav .flex.justify-between {
                padding: 0 0.25rem;
            }
        }

        /* Smooth transitions for all interactive elements */
        .nav-item,
        .mobile-nav-item,
        .user-dropdown button,
        .user-dropdown-menu a {
            transition: all 0.2s ease-in-out;
        }

        /* Print styles */
        @media print {
            nav,
            .user-dropdown,
            #mobileMenu {
                display: none !important;
            }
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-gray-50 min-h-screen flex flex-col" data-location-api="{{ LOCATION_DATA_API_URL }}">
    <!-- Navigation Bar -->
    {% include 'common/navbar.html' %}

    <!-- Breadcrumb -->
    {% if user.is_authenticated %}
    <div class="bg-white border-b border-gray-200 sticky top-16 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2">
            <nav class="flex" aria-label="Breadcrumb">
                <ol class="flex items-center space-x-2 text-sm">
                    {% block breadcrumb %}{% endblock %}
                </ol>
            </nav>
        </div>
    </div>
    {% endif %}

    <!-- Main Content -->
    <main class="flex-1 w-full">
        <!-- Messages -->
        {% if messages %}
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} bg-{% if message.tags == 'error' %}red{% elif message.tags == 'success' %}green{% elif message.tags == 'warning' %}yellow{% else %}blue{% endif %}-100 border border-{% if message.tags == 'error' %}red{% elif message.tags == 'success' %}green{% elif message.tags == 'warning' %}yellow{% else %}blue{% endif %}-400 text-{% if message.tags == 'error' %}red{% elif message.tags == 'success' %}green{% elif message.tags == 'warning' %}yellow{% else %}blue{% endif %}-700 px-4 py-3 rounded mb-4 flex items-center space-x-2">
                <i class="fas fa-{% if message.tags == 'error' %}exclamation-triangle{% elif message.tags == 'success' %}check-circle{% elif message.tags == 'warning' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
                <span>{{ message }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% block content %}
        {% endblock %}
    </main>

    <!-- AI Chat Assistant - Fixed bottom-right -->
    {% if user.is_authenticated %}
    {% include 'components/ai_chat_widget.html' %}
    {% endif %}

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <div class="flex justify-center items-center space-x-2 mb-2">
                    <i class="fas fa-mosque text-xl text-green-400"></i>
                    <p class="text-lg font-semibold">BANGSAMORO KA, SAAN KA MAN!</p>
                </div>
                <p class="text-sm text-gray-300">Office for Other Bangsamoro Communities (OOBC)</p>
                <p class="text-sm text-gray-300">Office of the Chief Minister (OCM)</p>
                <p class="text-sm text-gray-300">Bangsamoro Autonomous Region in Muslim Mindanao (BARMM)</p>
                <div class="mt-4 text-xs text-gray-400">
                    <p>&copy; {% now "Y" %} BARMM - All rights reserved</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('hidden');
        }

        // Initialize navbar functionality when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // User dropdown hover functionality
            const userDropdown = document.querySelector('.user-dropdown');
            const userDropdownMenu = document.querySelector('.user-dropdown-menu');
            let hoverTimeout;

            if (userDropdown && userDropdownMenu) {
                // Show dropdown on mouseenter
                userDropdown.addEventListener('mouseenter', function() {
                    clearTimeout(hoverTimeout);
                    userDropdownMenu.classList.remove('hidden');
                    // Add smooth transition classes
                    setTimeout(() => {
                        userDropdownMenu.classList.remove('opacity-0', 'scale-95');
                        userDropdownMenu.classList.add('opacity-100', 'scale-100');
                    }, 10);
                });

                // Hide dropdown on mouseleave with delay
                userDropdown.addEventListener('mouseleave', function() {
                    hoverTimeout = setTimeout(() => {
                        userDropdownMenu.classList.remove('opacity-100', 'scale-100');
                        userDropdownMenu.classList.add('opacity-0', 'scale-95');
                        setTimeout(() => {
                            userDropdownMenu.classList.add('hidden');
                        }, 200);
                    }, 150); // Small delay before hiding
                });

                // Keep dropdown open when hovering over the menu itself
                userDropdownMenu.addEventListener('mouseenter', function() {
                    clearTimeout(hoverTimeout);
                });

                userDropdownMenu.addEventListener('mouseleave', function() {
                    hoverTimeout = setTimeout(() => {
                        userDropdownMenu.classList.remove('opacity-100', 'scale-100');
                        userDropdownMenu.classList.add('opacity-0', 'scale-95');
                        setTimeout(() => {
                            userDropdownMenu.classList.add('hidden');
                        }, 200);
                    }, 150);
                });

                // Click functionality for touch devices
                const userButton = userDropdown.querySelector('button');
                userButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (userDropdownMenu.classList.contains('hidden')) {
                        userDropdownMenu.classList.remove('hidden');
                        setTimeout(() => {
                            userDropdownMenu.classList.remove('opacity-0', 'scale-95');
                            userDropdownMenu.classList.add('opacity-100', 'scale-100');
                        }, 10);
                    } else {
                        userDropdownMenu.classList.remove('opacity-100', 'scale-100');
                        userDropdownMenu.classList.add('opacity-0', 'scale-95');
                        setTimeout(() => {
                            userDropdownMenu.classList.add('hidden');
                        }, 200);
                    }
                });
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(event) {
                if (userDropdownMenu && !userDropdown.contains(event.target)) {
                    clearTimeout(hoverTimeout);
                    userDropdownMenu.classList.remove('opacity-100', 'scale-100');
                    userDropdownMenu.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => {
                        userDropdownMenu.classList.add('hidden');
                    }, 200);
                }

                // Close mobile menu when clicking outside
                const mobileMenu = document.getElementById('mobileMenu');
                const mobileButton = document.querySelector('button[onclick="toggleMobileMenu()"]');
                if (mobileMenu && mobileButton && !mobileMenu.contains(event.target) && !mobileButton.contains(event.target)) {
                    mobileMenu.classList.add('hidden');
                }
            });

            // Handle escape key
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    // Close user dropdown
                    if (userDropdownMenu) {
                        clearTimeout(hoverTimeout);
                        userDropdownMenu.classList.remove('opacity-100', 'scale-100');
                        userDropdownMenu.classList.add('opacity-0', 'scale-95');
                        setTimeout(() => {
                            userDropdownMenu.classList.add('hidden');
                        }, 200);
                    }
                    
                    // Close mobile menu
                    const mobileMenu = document.getElementById('mobileMenu');
                    if (mobileMenu) {
                        mobileMenu.classList.add('hidden');
                    }
                }
            });

            // Mobile menu close on item click
            const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
            mobileNavLinks.forEach(link => {
                link.addEventListener('click', function() {
                    const mobileMenu = document.getElementById('mobileMenu');
                    if (mobileMenu) {
                        mobileMenu.classList.add('hidden');
                    }
                });
            });

            const mobileSectionToggles = document.querySelectorAll('.mobile-section-toggle');
            mobileSectionToggles.forEach(toggle => {
                const targetId = toggle.getAttribute('data-target');
                const target = targetId ? document.getElementById(targetId) : null;

                if (!target) {
                    return;
                }

                toggle.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();

                    const expanded = toggle.getAttribute('aria-expanded') === 'true';
                    const newState = !expanded;
                    toggle.setAttribute('aria-expanded', newState.toString());
                    target.classList.toggle('hidden', !newState);

                    const icon = toggle.querySelector('.mobile-section-icon');
                    if (icon) {
                        icon.classList.toggle('rotate-180', newState);
                    }

                    if (newState) {
                        mobileSectionToggles.forEach(otherToggle => {
                            if (otherToggle === toggle) {
                                return;
                            }
                            const otherId = otherToggle.getAttribute('data-target');
                            const otherTarget = otherId ? document.getElementById(otherId) : null;
                            if (!otherTarget) {
                                return;
                            }
                            otherToggle.setAttribute('aria-expanded', 'false');
                            otherTarget.classList.add('hidden');
                            const otherIcon = otherToggle.querySelector('.mobile-section-icon');
                            if (otherIcon) {
                                otherIcon.classList.remove('rotate-180');
                            }
                        });
                    }
                });
            });

            // Handle window resize
            window.addEventListener('resize', function() {
                const mobileMenu = document.getElementById('mobileMenu');
                if (window.innerWidth >= 1024 && mobileMenu) { // lg breakpoint
                    mobileMenu.classList.add('hidden');
                }
            });

            // Improve touch interactions on mobile
            if ('ontouchstart' in window) {
                document.body.classList.add('touch-device');
            }
        });
    </script>

    <script src="{% static 'vendor/htmx/htmx.min.js' %}" defer></script>
    <script>
        // Ensure HTMX is available even if the static asset fails to load
        window.addEventListener('DOMContentLoaded', function () {
            if (!window.htmx) {
                const fallback = document.createElement('script');
                fallback.src = 'https://unpkg.com/htmx.org@1.9.12';
                fallback.defer = true;
                document.head.appendChild(fallback);
            }
        });
    </script>

    <!-- HTMX Configuration: Enable Template Fragments -->
    <script>
        // Enable processing of <template> tags for out-of-band swaps
        // This is required for HTMX to correctly handle table rows (<tr>) in OOB swaps
        // because browsers strip <tr> elements when they appear outside <table> context
        window.addEventListener('DOMContentLoaded', function() {
            if (window.htmx) {
                htmx.config.useTemplateFragments = true;
            }
        });
    </script>

    <script src="{% static 'common/js/location_data_loader.js' %}"></script>
    <script src="{% static 'common/js/htmx-focus-management.js' %}"></script>

    <!-- HTMX CSRF Token Configuration -->
    <script>
    document.body.addEventListener('htmx:configRequest', function(event) {
        // Get CSRF token from multiple sources (in order of preference)
        function getCsrfToken() {
            // 1. Try from meta tag
            var metaTag = document.querySelector('meta[name="csrf-token"]');
            if (metaTag && metaTag.content) {
                return metaTag.content;
            }

            // 2. Try from cookie
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, 10) === 'csrftoken=') {
                        return decodeURIComponent(cookie.substring(10));
                    }
                }
            }

            // 3. Try from form input (for the triggering element)
            if (event.detail.elt) {
                var form = event.detail.elt.closest('form');
                if (form) {
                    var input = form.querySelector('input[name="csrfmiddlewaretoken"]');
                    if (input && input.value) {
                        return input.value;
                    }
                }
            }

            return null;
        }

        var csrfToken = getCsrfToken();

        // Add CSRF token to all state-changing requests (POST, PUT, PATCH, DELETE)
        if (['POST', 'PUT', 'PATCH', 'DELETE'].indexOf(event.detail.verb.toUpperCase()) !== -1) {
            if (csrfToken) {
                event.detail.headers['X-CSRFToken'] = csrfToken;
                console.log('✅ CSRF token added to', event.detail.verb.toUpperCase(), 'request');
            } else {
                console.error('❌ CSRF token not found! Request may fail.');
            }
        }
    });
    </script>

    <div id="toast-root" class="fixed top-6 right-6 z-50 space-y-2 pointer-events-none"></div>
    <script>
    (function () {
        const root = document.getElementById('toast-root');
        if (!root) return;

        function showToast(detail, levelOverride) {
            let payload;

            if (typeof detail === 'string' && levelOverride) {
                payload = { message: detail, level: levelOverride };
            } else if (detail && typeof detail === 'object') {
                payload = Object.assign({}, detail);
                if (levelOverride && !payload.level) {
                    payload.level = levelOverride;
                }
            } else if (typeof detail === 'string') {
                payload = detail;
            } else {
                payload = {};
            }

            const message = typeof payload === 'string'
                ? payload
                : (payload.message || 'Action completed');

            const level = (
                typeof payload === 'string'
                    ? (levelOverride || 'success')
                    : (payload.level || levelOverride || 'success')
            ).toLowerCase();
            const palette = {
                success: 'from-emerald-500 to-emerald-600',
                info: 'from-sky-500 to-blue-600',
                warning: 'from-amber-400 to-orange-500',
                error: 'from-rose-500 to-rose-600'
            };

            const toast = document.createElement('div');
            toast.className = 'pointer-events-auto transition-all duration-300 transform translate-y-0 opacity-100';
            toast.innerHTML = `
                <div class="flex items-center gap-3 rounded-xl bg-gradient-to-r ${palette[level] || palette.success} text-white shadow-lg px-4 py-3 min-w-[220px]">
                    <span class="text-sm font-medium">${message}</span>
                </div>
            `;

            root.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
            }, 3800);

            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 4500);
        }

        document.body.addEventListener('showToast', function (event) {
            const payload = event?.detail ?? event?.value;
            showToast(payload);
            if (event) {
                if (typeof event.preventDefault === 'function') {
                    event.preventDefault();
                }
                if (typeof event.stopImmediatePropagation === 'function') {
                    event.stopImmediatePropagation();
                }
                if (typeof event.stopPropagation === 'function') {
                    event.stopPropagation();
                }
            }
        }, true);

        document.body.addEventListener('show-toast', function (event) {
            const payload = event?.detail ?? event?.value;
            showToast(payload);
            if (event) {
                if (typeof event.preventDefault === 'function') {
                    event.preventDefault();
                }
                if (typeof event.stopImmediatePropagation === 'function') {
                    event.stopImmediatePropagation();
                }
                if (typeof event.stopPropagation === 'function') {
                    event.stopPropagation();
                }
            }
        }, true);

        // Global HTMX error handler for better user feedback
        document.body.addEventListener('htmx:responseError', function(event) {
            console.error('HTMX Error:', event.detail);
            showToast({
                message: 'An error occurred. Please try again or contact support.',
                level: 'error'
            });
        });

        document.body.addEventListener('htmx:sendError', function(event) {
            console.error('HTMX Network Error:', event.detail);
            showToast({
                message: 'Network error. Please check your connection and try again.',
                level: 'error'
            });
        });

        document.body.addEventListener('htmx:timeout', function(event) {
            console.error('HTMX Timeout:', event.detail);
            showToast({
                message: 'Request timed out. Please try again.',
                level: 'warning'
            });
        });

        // Expose showToast globally for use in other scripts
        window.showToast = showToast;
    })();
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
