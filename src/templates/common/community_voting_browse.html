{% extends 'base.html' %}

{% load text_extras %}

{% block title %}Community Voting - OBC Management System{% endblock %}

{% block breadcrumb %}
<li><a href="{% url 'common:dashboard' %}" class="text-neutral-500 hover:text-neutral-700">Dashboard</a></li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li class="text-neutral-800 font-semibold">Community Voting</li>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-8">
    <!-- Header -->
    <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
        <div class="space-y-3">
            <h1 class="text-3xl font-bold text-gray-900">Vote for Community Priorities</h1>
            <p class="text-lg text-gray-600 max-w-4xl">
                Help prioritize community needs by voting. Your vote helps decision-makers understand which needs matter most to the community.
            </p>
        </div>
        <a href="{% url 'common:community_voting_results' %}" class="inline-flex items-center justify-center gap-2 rounded-xl border border-emerald-600 bg-emerald-600 px-5 py-3 text-sm font-semibold text-white shadow-sm hover:bg-emerald-700">
            <i class="fas fa-chart-bar"></i>
            View Results
        </a>
    </div>

    <!-- Top Voted Sidebar -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2">
            <!-- Filters -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <form method="get" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="space-y-1">
                        <label for="region" class="block text-sm font-medium text-gray-700">Region</label>
                        <select name="region" id="region" class="block w-full py-2 px-3 rounded-lg border border-gray-300 focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="">All Regions</option>
                            {% for region in regions %}
                            <option value="{{ region.id }}">{{ region.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="space-y-1">
                        <label for="sort" class="block text-sm font-medium text-gray-700">Sort By</label>
                        <select name="sort" id="sort" class="block w-full py-2 px-3 rounded-lg border border-gray-300 focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="votes">Most Voted</option>
                            <option value="recent">Most Recent</option>
                            <option value="priority">Highest Priority</option>
                        </select>
                    </div>

                    <div class="space-y-1">
                        <label class="block text-sm font-medium text-gray-700">&nbsp;</label>
                        <button type="submit" class="w-full inline-flex items-center justify-center gap-2 rounded-lg border border-emerald-600 bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700">
                            <i class="fas fa-filter"></i> Apply
                        </button>
                    </div>
                </form>
            </div>

            <!-- Needs List -->
            <div class="space-y-4">
                {% for need in needs %}
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">{{ need.title }}</h3>
                            <div class="text-sm text-gray-600 mb-3">
                                {% if need.barangay %}
                                <i class="fas fa-map-marker-alt text-gray-400"></i> {{ need.barangay.name }}, {{ need.barangay.municipality.name }}
                                {% endif %}
                            </div>
                            {% if need.description %}
                            <p class="text-sm text-gray-700 mb-3">{{ need.description|truncatewords:30 }}</p>
                            {% endif %}
                            <div class="flex items-center gap-2 text-sm text-gray-600">
                                <i class="fas fa-thumbs-up text-emerald-600"></i>
                                <span class="font-semibold" id="vote-count-{{ need.id }}">{{ need.community_votes }}</span> votes
                            </div>
                        </div>

                        <!-- Vote Button -->
                        <div class="flex flex-col items-end gap-2">
                            {% if need.id in user_votes %}
                            <div class="text-sm text-emerald-600 font-semibold">
                                <i class="fas fa-check-circle"></i> You voted ({{ user_votes|get_item:need.id }}‚≠ê)
                            </div>
                            <button onclick="voteNeed('{{ need.id }}', {{ user_votes|get_item:need.id }})" class="text-sm text-blue-600 hover:text-blue-800">
                                Change vote
                            </button>
                            {% else %}
                            <button onclick="voteNeed('{{ need.id }}')" class="inline-flex items-center gap-2 rounded-lg border border-emerald-600 bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700">
                                <i class="fas fa-thumbs-up"></i> Vote
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
                    <i class="fas fa-inbox text-4xl text-gray-300 mb-3"></i>
                    <p class="text-lg font-semibold text-gray-900">No needs available for voting</p>
                    <p class="text-sm text-gray-500">Check back later or adjust your filters.</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Sidebar: Top Voted -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 sticky top-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">üèÜ Top Community Priorities</h2>
                <div class="space-y-3">
                    {% for need in top_voted|slice:":5" %}
                    <div class="flex items-start gap-3">
                        <div class="flex h-8 w-8 items-center justify-center rounded-full bg-emerald-100 text-emerald-700 font-bold text-sm">
                            {{ forloop.counter }}
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900">{{ need.title|truncatewords:8 }}</p>
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-thumbs-up"></i> {{ need.community_votes }} votes
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vote Modal -->
<div id="voteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-6">
        <h3 class="text-xl font-bold text-gray-900 mb-4">Cast Your Vote</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Vote Weight (1-5 stars)</label>
                <div class="flex gap-2">
                    <button onclick="selectWeight(1)" class="vote-weight-btn px-4 py-2 rounded-lg border border-gray-300 hover:bg-emerald-50 hover:border-emerald-500">‚≠ê 1</button>
                    <button onclick="selectWeight(2)" class="vote-weight-btn px-4 py-2 rounded-lg border border-gray-300 hover:bg-emerald-50 hover:border-emerald-500">‚≠ê 2</button>
                    <button onclick="selectWeight(3)" class="vote-weight-btn px-4 py-2 rounded-lg border border-gray-300 hover:bg-emerald-50 hover:border-emerald-500">‚≠ê 3</button>
                    <button onclick="selectWeight(4)" class="vote-weight-btn px-4 py-2 rounded-lg border border-gray-300 hover:bg-emerald-50 hover:border-emerald-500">‚≠ê 4</button>
                    <button onclick="selectWeight(5)" class="vote-weight-btn px-4 py-2 rounded-lg border border-gray-300 hover:bg-emerald-50 hover:border-emerald-500">‚≠ê 5</button>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Comment (Optional)</label>
                <textarea id="voteComment" rows="3" class="block w-full rounded-lg border border-gray-300 px-3 py-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="Why is this need important to you?"></textarea>
            </div>
            <div class="flex gap-3">
                <button onclick="closeVoteModal()" class="flex-1 px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">Cancel</button>
                <button onclick="submitVote()" class="flex-1 px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Submit Vote</button>
            </div>
        </div>
        <div id="voteError" class="mt-4 hidden text-sm text-red-600"></div>
    </div>
</div>

<script>
let currentNeedId = null;
let selectedWeight = 1;

function voteNeed(needId, currentWeight = 1) {
    currentNeedId = needId;
    selectedWeight = currentWeight;
    selectWeight(currentWeight);
    document.getElementById('voteModal').classList.remove('hidden');
    document.getElementById('voteModal').classList.add('flex');
}

function closeVoteModal() {
    document.getElementById('voteModal').classList.add('hidden');
    document.getElementById('voteModal').classList.remove('flex');
    document.getElementById('voteComment').value = '';
    document.getElementById('voteError').classList.add('hidden');
}

function selectWeight(weight) {
    selectedWeight = weight;
    document.querySelectorAll('.vote-weight-btn').forEach((btn, idx) => {
        if (idx + 1 <= weight) {
            btn.classList.add('bg-emerald-100', 'border-emerald-500');
        } else {
            btn.classList.remove('bg-emerald-100', 'border-emerald-500');
        }
    });
}

function submitVote() {
    const comment = document.getElementById('voteComment').value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch('{% url "common:community_voting_vote" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: new URLSearchParams({
            'need_id': currentNeedId,
            'vote_weight': selectedWeight,
            'comment': comment
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update vote count
            document.getElementById(`vote-count-${currentNeedId}`).textContent = data.total_votes;
            closeVoteModal();
            // Show success message
            alert(data.message);
            // Reload page to update UI
            window.location.reload();
        } else {
            document.getElementById('voteError').textContent = data.error || 'Failed to vote';
            document.getElementById('voteError').classList.remove('hidden');
        }
    })
    .catch(error => {
        document.getElementById('voteError').textContent = 'Network error. Please try again.';
        document.getElementById('voteError').classList.remove('hidden');
    });
}
</script>

{% csrf_token %}
{% endblock %}
