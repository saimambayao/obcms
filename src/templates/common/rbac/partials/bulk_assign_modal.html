{% load static %}

<div class="bg-white rounded-2xl shadow-2xl max-w-3xl mx-auto">
    <!-- Modal Header -->
    <div class="bg-gradient-to-r from-blue-800 to-emerald-600 px-6 py-4 rounded-t-2xl flex items-center justify-between">
        <div class="flex items-center space-x-3">
            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                <i class="fas fa-users-cog text-white text-xl"></i>
            </div>
            <div>
                <h2 id="rbac-modal-title" class="text-xl font-bold text-white">
                    Bulk Role Assignment
                </h2>
                <p class="text-sm text-blue-100">
                    Assign role to {{ selected_users|length }} selected user{{ selected_users|length|pluralize }}
                </p>
            </div>
        </div>
        <button type="button"
                onclick="closeRbacModal()"
                class="text-white hover:text-gray-200 transition-colors duration-200"
                aria-label="Close modal">
            <i class="fas fa-times text-2xl"></i>
        </button>
    </div>

    <!-- Form Body -->
    <form hx-post="{% url 'common:rbac_bulk_assign' %}"
          hx-target="#users-grid"
          hx-swap="outerHTML"
          hx-indicator="#bulk-assign-loading"
          class="p-6 space-y-6">
        {% csrf_token %}

        <!-- Selected Users Preview -->
        <div class="bg-blue-50 border-l-4 border-blue-500 rounded-r-lg p-4">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-500 text-xl"></i>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="text-sm font-semibold text-blue-900 mb-2">Selected Users ({{ selected_users|length }})</h3>
                    <div class="flex flex-wrap gap-2">
                        {% for user in selected_users %}
                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-white text-blue-800 border border-blue-200">
                            {{ user.get_full_name|default:user.username }}
                        </span>
                        <input type="hidden" name="user_ids" value="{{ user.id }}">
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Role Selection -->
        <div>
            <label for="bulk-role-select" class="block text-sm font-medium text-gray-700 mb-2">
                Role to Assign <span class="text-red-500">*</span>
            </label>
            <div class="relative">
                <select id="bulk-role-select"
                        name="role_id"
                        required
                        class="block w-full py-3 px-4 text-base rounded-xl border border-gray-200 shadow-sm focus:ring-emerald-500 focus:border-emerald-500 min-h-[48px] appearance-none pr-12 bg-white transition-all duration-200">
                    <option value="">Select a role...</option>
                    {% for role in available_roles %}
                    <option value="{{ role.id }}"
                            data-description="{{ role.description|default:'' }}"
                            data-permissions-count="{{ role.permissions.count }}">
                        {{ role.name }} ({{ role.permissions.count }} permissions)
                    </option>
                    {% endfor %}
                </select>
                <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-4">
                    <i class="fas fa-chevron-down text-gray-400 text-sm"></i>
                </span>
            </div>
            <p class="mt-1 text-sm text-gray-500" id="bulk-role-description">
                Select a role to view its description
            </p>
        </div>

        <!-- Organization Context -->
        {% if organizations %}
        <div>
            <label for="bulk-organization-select" class="block text-sm font-medium text-gray-700 mb-2">
                Organization Context <span class="text-gray-400">(Optional)</span>
            </label>
            <div class="relative">
                <select id="bulk-organization-select"
                        name="organization_id"
                        class="block w-full py-3 px-4 text-base rounded-xl border border-gray-200 shadow-sm focus:ring-emerald-500 focus:border-emerald-500 min-h-[48px] appearance-none pr-12 bg-white transition-all duration-200">
                    <option value="">All Organizations</option>
                    {% for org in organizations %}
                    <option value="{{ org.id }}">{{ org.name }}</option>
                    {% endfor %}
                </select>
                <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-4">
                    <i class="fas fa-chevron-down text-gray-400 text-sm"></i>
                </span>
            </div>
            <p class="mt-1 text-sm text-gray-500">
                Limit role to specific organization (BMMS only)
            </p>
        </div>
        {% endif %}

        <!-- Options -->
        <div class="bg-amber-50 border-l-4 border-amber-500 rounded-r-lg p-4">
            <h4 class="text-sm font-semibold text-amber-900 mb-3 flex items-center">
                <i class="fas fa-cog mr-2"></i>
                Assignment Options
            </h4>
            <div class="space-y-3">
                <label class="flex items-start">
                    <input type="checkbox"
                           name="replace_existing"
                           class="h-5 w-5 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500 mt-0.5">
                    <span class="ml-3 text-sm text-amber-900">
                        <strong>Replace existing roles</strong>
                        <span class="block text-xs text-amber-700 mt-1">Remove all current roles before assigning new role</span>
                    </span>
                </label>
                <label class="flex items-start">
                    <input type="checkbox"
                           name="send_notification"
                           checked
                           class="h-5 w-5 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500 mt-0.5">
                    <span class="ml-3 text-sm text-amber-900">
                        <strong>Send email notification</strong>
                        <span class="block text-xs text-amber-700 mt-1">Notify users about their new role assignment</span>
                    </span>
                </label>
            </div>
        </div>

        <!-- Confirmation Warning -->
        <div class="bg-red-50 border-l-4 border-red-500 rounded-r-lg p-4">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-semibold text-red-900">Important</h3>
                    <p class="text-sm text-red-700 mt-1">
                        This action will affect {{ selected_users|length }} user{{ selected_users|length|pluralize }}.
                        Please review your selection carefully before proceeding.
                    </p>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 pt-4 border-t border-gray-200">
            <button type="button"
                    onclick="closeRbacModal()"
                    class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl font-semibold hover:bg-gray-50 transition-colors duration-200 min-h-[48px]">
                <i class="fas fa-times mr-2"></i>
                Cancel
            </button>
            <button type="submit"
                    class="bg-gradient-to-r from-blue-600 to-emerald-600 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg hover:-translate-y-1 transition-all duration-300 min-h-[48px] disabled:opacity-50 disabled:cursor-not-allowed">
                <span id="bulk-assign-loading" class="htmx-indicator">
                    <i class="fas fa-spinner fa-spin mr-2"></i>
                </span>
                <i class="fas fa-users-cog mr-2"></i>
                Assign to {{ selected_users|length }} User{{ selected_users|length|pluralize }}
            </button>
        </div>
    </form>
</div>

<script>
// Role selection with description preview
document.getElementById('bulk-role-select').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const description = selectedOption.getAttribute('data-description') || 'No description available';

    document.getElementById('bulk-role-description').textContent = description;
});

// Auto-close modal after successful submission
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'users-grid') {
        closeRbacModal();
        // Clear checkboxes
        document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = false);
        updateSelectedCount();
        // Show success toast (implementation depends on toast system)
        alert('Role assigned successfully to ' + {{ selected_users|length }} + ' user(s)');
    }
});
</script>
