{% extends 'base.html' %}

{% block title %}Planning & Budgeting - OBC Management System{% endblock %}

{% block breadcrumb %}
<li>
    <a href="{% url 'common:dashboard' %}" class="text-neutral-500 hover:text-neutral-700">Dashboard</a>
</li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li>
    <a href="{% url 'common:oobc_management_home' %}" class="text-neutral-500 hover:text-neutral-700">OOBC Management</a>
</li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li class="text-neutral-800 font-semibold">Planning &amp; Budgeting</li>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-8">
    <!-- Header -->
    <div class="space-y-3">
        <h1 class="text-3xl font-bold text-gray-900">Planning &amp; Budgeting</h1>
        <p class="text-lg text-gray-600 max-w-4xl">
            Review PPA pipelines, funding allocations, and milestone schedules across OOBC-led and MOA-supported initiatives
            to keep investments aligned with community priorities.
        </p>
    </div>

    {% if is_empty_state and empty_state_links %}
    <div class="rounded-2xl border border-dashed border-emerald-200 bg-emerald-50 px-6 py-6 shadow-inner">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
            <div class="flex items-start gap-4">
                <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-emerald-500 text-white shadow-lg">
                    <i class="fas fa-chart-line text-xl"></i>
                </div>
                <div class="space-y-1">
                    <h2 class="text-xl font-semibold text-emerald-900">No planning entries recorded yet</h2>
                    <p class="text-sm text-emerald-800 max-w-2xl">
                        Capture at least one MOA project, OOBC initiative, or community request to unlock the full planning and budget analytics.
                        Use the quick actions below to get started or import data from recent reports.
                    </p>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 w-full lg:w-auto">
                {% for link in empty_state_links %}
                <a href="{{ link.url }}" class="group flex flex-col rounded-xl border border-emerald-100 bg-white px-4 py-3 shadow-sm transition hover:border-emerald-300 hover:shadow-md">
                    <div class="flex items-center gap-2 text-emerald-600">
                        <i class="fas {{ link.icon }} text-sm"></i>
                        <span class="text-sm font-semibold">{{ link.label }}</span>
                    </div>
                    <p class="mt-2 text-xs text-emerald-700 leading-snug">{{ link.description }}</p>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Totals Row 1 -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="px-4 py-5 bg-gradient-to-r from-emerald-500 to-green-500 text-white">
                <p class="text-sm uppercase tracking-wide text-emerald-100">Total Budget</p>
                <p class="mt-2 text-3xl font-semibold">₱{{ totals.budget_total|floatformat:2 }}</p>
            </div>
            <p class="px-4 py-3 text-sm text-gray-600">Aggregate allocation recorded across all monitoring entries.</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="px-4 py-5 bg-gradient-to-r from-blue-500 to-sky-500 text-white">
                <p class="text-sm uppercase tracking-wide text-blue-100">OBC Allocation</p>
                <p class="mt-2 text-3xl font-semibold">₱{{ totals.budget_obc_total|floatformat:2 }}</p>
            </div>
            <p class="px-4 py-3 text-sm text-gray-600">Funding earmarked specifically for Other Bangsamoro Communities.</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="px-4 py-5 bg-gradient-to-r from-purple-500 to-indigo-500 text-white">
                <p class="text-sm uppercase tracking-wide text-purple-100">Projects</p>
                <p class="mt-2 text-3xl font-semibold">{{ totals.projects|default:0 }}</p>
            </div>
            <p class="px-4 py-3 text-sm text-gray-600">Active entries across OOBC PPAs, MOA PPAs, and OBC requests.</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="px-4 py-5 bg-gradient-to-r from-teal-500 to-cyan-500 text-white">
                <p class="text-sm uppercase tracking-wide text-cyan-100">Average Progress</p>
                <p class="mt-2 text-3xl font-semibold">{{ totals.avg_progress|floatformat:0 }}%</p>
            </div>
            <p class="px-4 py-3 text-sm text-gray-600">Overall completion across all monitored initiatives.</p>
        </div>
    </div>

    <!-- Totals Row 2 -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="px-4 py-5 bg-gradient-to-r from-amber-500 to-yellow-500 text-white">
                <p class="text-sm uppercase tracking-wide text-amber-100">Budget Ceiling</p>
                <p class="mt-2 text-3xl font-semibold">₱{{ totals.budget_ceiling_total|floatformat:2 }}</p>
            </div>
            <p class="px-4 py-3 text-sm text-gray-600">Aggregate ceilings assigned per funding source for scenario planning.</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="px-4 py-5 bg-gradient-to-r from-emerald-500 to-lime-500 text-white">
                <p class="text-sm uppercase tracking-wide text-emerald-100">Recorded Allocations</p>
                <p class="mt-2 text-3xl font-semibold">₱{{ totals.allocation_total|floatformat:2 }}</p>
            </div>
            <p class="px-4 py-3 text-sm text-gray-600">Tranches tagged as allocations across funding flows.</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="px-4 py-5 bg-gradient-to-r from-indigo-500 to-blue-600 text-white">
                <p class="text-sm uppercase tracking-wide text-indigo-100">Recorded Obligations</p>
                <p class="mt-2 text-3xl font-semibold">₱{{ totals.obligation_total|floatformat:2 }}</p>
            </div>
            <p class="px-4 py-3 text-sm text-gray-600">Obligations booked against programmed PPAs.</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="px-4 py-5 bg-gradient-to-r from-sky-500 to-cyan-500 text-white">
                <p class="text-sm uppercase tracking-wide text-sky-100">Recorded Disbursements</p>
                <p class="mt-2 text-3xl font-semibold">₱{{ totals.disbursement_total|floatformat:2 }}</p>
            </div>
            <p class="px-4 py-3 text-sm text-gray-600">Disbursements reported through funding flow entries.</p>
        </div>
    </div>

    <!-- Category & Status -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 bg-gradient-to-r from-emerald-500 to-green-500 text-white">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-project-diagram mr-3"></i>
                    Category Breakdown
                </h2>
            </div>
            <div class="p-6 space-y-4">
                {% if category_breakdown %}
                    {% for category in category_breakdown %}
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-base font-semibold text-gray-900">{{ category.label }}</p>
                                <p class="text-sm text-gray-500">{{ category.projects }} project{{ category.projects|pluralize }} • Avg progress {{ category.avg_progress|floatformat:0 }}%</p>
                            </div>
                            <span class="text-sm font-medium text-emerald-600">₱{{ category.total_budget|floatformat:2 }}</span>
                        </div>
                    {% endfor %}
                {% elif is_empty_state %}
                    <div class="flex flex-col items-center justify-center text-center space-y-2 py-8 text-emerald-700">
                        <i class="fas fa-folder-open text-2xl"></i>
                        <p class="text-base font-semibold">No PPAs captured yet</p>
                        <p class="text-sm text-emerald-600 max-w-xs">Start logging PPAs so you can compare MOA, OOBC, and community-driven initiatives side by side.</p>
                    </div>
                {% else %}
                    <p class="text-sm text-gray-600">No monitoring entries are available yet.</p>
                {% endif %}
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 bg-gradient-to-r from-blue-500 to-indigo-500 text-white">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-stream mr-3"></i>
                    Implementation Status
                </h2>
            </div>
            <div class="p-6 space-y-4">
                {% if status_breakdown %}
                    {% for status in status_breakdown %}
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-base font-semibold text-gray-900">{{ status.label }}</p>
                                <p class="text-sm text-gray-500">{{ status.projects }} project{{ status.projects|pluralize }}</p>
                            </div>
                            <span class="text-sm font-medium text-indigo-600">₱{{ status.budget|floatformat:2 }}</span>
                        </div>
                    {% endfor %}
                {% elif is_empty_state %}
                    <div class="flex flex-col items-center justify-center text-center space-y-2 py-8 text-indigo-600">
                        <i class="fas fa-clipboard-list text-2xl"></i>
                        <p class="text-base font-semibold">Statuses will appear here</p>
                        <p class="text-sm text-indigo-500 max-w-xs">Track whether PPAs are under planning, ongoing, or completed once entries are encoded.</p>
                    </div>
                {% else %}
                    <p class="text-sm text-gray-600">No implementation status data captured yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sector, Appropriation, Funding -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 bg-gradient-to-r from-teal-500 to-emerald-500 text-white">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-layer-group mr-3"></i>
                    Sector Mix
                </h2>
            </div>
            <div class="p-6 space-y-4">
                {% if sector_breakdown %}
                    {% for sector in sector_breakdown %}
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="text-base font-semibold text-gray-900">{{ sector.label }}</p>
                                <p class="text-sm text-gray-500">{{ sector.projects }} project{{ sector.projects|pluralize }}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-medium text-teal-600">₱{{ sector.budget|floatformat:2 }}</p>
                                <p class="text-xs text-gray-400">Ceiling ₱{{ sector.ceiling|floatformat:2 }}</p>
                            </div>
                        </div>
                    {% endfor %}
                {% elif is_empty_state %}
                    <div class="flex flex-col items-center justify-center text-center space-y-2 py-8 text-emerald-700">
                        <i class="fas fa-seedling text-2xl"></i>
                        <p class="text-base font-semibold">No PPAs tagged to sectors yet</p>
                        <p class="text-sm text-emerald-600 max-w-xs">Once you encode PPAs, classify them by sector to analyse where resources are flowing.</p>
                    </div>
                {% else %}
                    <p class="text-sm text-gray-600">Sector tags will appear once PPAs are classified.</p>
                {% endif %}
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 bg-gradient-to-r from-rose-500 to-pink-500 text-white">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-file-invoice mr-3"></i>
                    Appropriation Class
                </h2>
            </div>
            <div class="p-6 space-y-4">
                {% if appropriation_breakdown %}
                    {% for app in appropriation_breakdown %}
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-base font-semibold text-gray-900">{{ app.label }}</p>
                                <p class="text-sm text-gray-500">{{ app.projects }} project{{ app.projects|pluralize }}</p>
                            </div>
                            <span class="text-sm font-medium text-rose-600">₱{{ app.budget|floatformat:2 }}</span>
                        </div>
                    {% endfor %}
                {% elif is_empty_state %}
                    <div class="flex flex-col items-center justify-center text-center space-y-2 py-8 text-rose-600">
                        <i class="fas fa-coins text-2xl"></i>
                        <p class="text-base font-semibold">Budget classes pending</p>
                        <p class="text-sm text-rose-500 max-w-xs">Categorise spending into PS, MOOE, or CO once allocations are recorded so the mix graph lights up.</p>
                    </div>
                {% else %}
                    <p class="text-sm text-gray-600">Classifications into PS, MOOE, or CO will surface here.</p>
                {% endif %}
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 bg-gradient-to-r from-sky-500 to-blue-500 text-white">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-funnel-dollar mr-3"></i>
                    Funding Sources
                </h2>
            </div>
            <div class="p-6 space-y-4">
                {% if funding_breakdown %}
                    {% for funding in funding_breakdown %}
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-base font-semibold text-gray-900">{{ funding.label }}</p>
                                <p class="text-sm text-gray-500">{{ funding.projects }} project{{ funding.projects|pluralize }}</p>
                            </div>
                            <span class="text-sm font-medium text-blue-600">₱{{ funding.budget|floatformat:2 }}</span>
                        </div>
                    {% endfor %}
                {% elif is_empty_state %}
                    <div class="flex flex-col items-center justify-center text-center space-y-2 py-8 text-blue-600">
                        <i class="fas fa-wallet text-2xl"></i>
                        <p class="text-base font-semibold">No funding tagged yet</p>
                        <p class="text-sm text-blue-500 max-w-xs">Record whether PPAs draw from GAA, the BARMM block grant, LGU counterparts, or partners to compare sources.</p>
                    </div>
                {% else %}
                    <p class="text-sm text-gray-600">Record funding sources to surface analytics here.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Compliance & Workflow -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 bg-gradient-to-r from-indigo-500 to-purple-500 text-white">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-check-circle mr-3"></i>
                    Compliance Snapshot
                </h2>
            </div>
            <div class="p-6">
                {% with total=compliance_summary.total|default:0 %}
                <dl class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="bg-indigo-50 border border-indigo-100 rounded-lg px-4 py-3">
                        <dt class="text-xs uppercase tracking-wide text-indigo-700">GAD Tagged</dt>
                        <dd class="mt-1 text-lg font-semibold text-indigo-900">{{ compliance_summary.gad|default:0 }}</dd>
                        <p class="text-xs text-indigo-600">{{ compliance_summary.gad_pct|floatformat:1 }}% of portfolio</p>
                    </div>
                    <div class="bg-sky-50 border border-sky-100 rounded-lg px-4 py-3">
                        <dt class="text-xs uppercase tracking-wide text-sky-700">Climate (CCET)</dt>
                        <dd class="mt-1 text-lg font-semibold text-sky-900">{{ compliance_summary.ccet|default:0 }}</dd>
                        <p class="text-xs text-sky-600">{{ compliance_summary.ccet_pct|floatformat:1 }}% of portfolio</p>
                    </div>
                    <div class="bg-emerald-50 border border-emerald-100 rounded-lg px-4 py-3">
                        <dt class="text-xs uppercase tracking-wide text-emerald-700">Indigenous Peoples</dt>
                        <dd class="mt-1 text-lg font-semibold text-emerald-900">{{ compliance_summary.ip|default:0 }}</dd>
                        <p class="text-xs text-emerald-600">{{ compliance_summary.ip_pct|floatformat:1 }}% of portfolio</p>
                    </div>
                    <div class="bg-rose-50 border border-rose-100 rounded-lg px-4 py-3">
                        <dt class="text-xs uppercase tracking-wide text-rose-700">Peace Agenda</dt>
                        <dd class="mt-1 text-lg font-semibold text-rose-900">{{ compliance_summary.peace|default:0 }}</dd>
                        <p class="text-xs text-rose-600">{{ compliance_summary.peace_pct|floatformat:1 }}% of portfolio</p>
                    </div>
                    <div class="bg-amber-50 border border-amber-100 rounded-lg px-4 py-3 sm:col-span-2">
                        <dt class="text-xs uppercase tracking-wide text-amber-700">SDG Aligned</dt>
                        <dd class="mt-1 text-lg font-semibold text-amber-900">{{ compliance_summary.sdg|default:0 }}</dd>
                        <p class="text-xs text-amber-600">{{ compliance_summary.sdg_pct|floatformat:1 }}% of portfolio</p>
                    </div>
                </dl>
                {% if not total %}
                    <p class="text-sm text-gray-600 mt-4">Tag PPAs for required national mandates to populate this dashboard.</p>
                {% endif %}
                {% endwith %}
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 bg-gradient-to-r from-cyan-500 to-blue-600 text-white">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-route mr-3"></i>
                    Workflow Snapshot
                </h2>
            </div>
            <div class="p-6 space-y-4">
                {% if workflow_summary %}
                    {% for stage in workflow_summary %}
                        <div class="border border-blue-100 rounded-lg p-4 bg-blue-50">
                            <div class="flex items-center justify-between">
                                <p class="text-base font-semibold text-blue-900">{{ stage.label }}</p>
                                <span class="text-xs font-medium text-blue-600 uppercase">{{ stage.total }} stage update{{ stage.total|pluralize }}</span>
                            </div>
                            <div class="mt-3 grid grid-cols-2 gap-2">
                                {% for status in stage.statuses %}
                                    <div class="bg-white rounded-md border border-blue-100 px-3 py-2 text-xs text-blue-700 flex items-center justify-between">
                                        <span>{{ status.label }}</span>
                                        <span class="font-semibold text-blue-900">{{ status.count }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                {% elif is_empty_state %}
                    <div class="flex flex-col items-center justify-center text-center space-y-2 py-8 text-blue-600">
                        <i class="fas fa-sitemap text-2xl"></i>
                        <p class="text-base font-semibold">Budget workflow not started</p>
                        <p class="text-sm text-blue-500 max-w-xs">Each PPA will show its stage once you begin encoding Budget Call, Formulation, and Execution updates.</p>
                    </div>
                {% else %}
                    <p class="text-sm text-gray-600">Encode workflow stages to monitor budget cycle compliance.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Funding Timeline & Needs Coverage -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 bg-gradient-to-r from-emerald-500 to-lime-500 text-white">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-timeline mr-3"></i>
                    Funding Timeline
                </h2>
            </div>
            <div class="p-6 space-y-4">
                {% if funding_timeline %}
                    {% for tranche in funding_timeline %}
                        <div class="border border-emerald-100 rounded-lg p-4 bg-emerald-50">
                            <p class="text-xs uppercase tracking-wide text-emerald-600">{% if tranche.scheduled_date %}{{ tranche.scheduled_date|date:"M d, Y" }}{% else %}TBD{% endif %}</p>
                            <p class="text-base font-semibold text-emerald-900">{{ tranche.entry.title }}</p>
                            <p class="text-sm text-emerald-700">{{ tranche.get_tranche_type_display }} • ₱{{ tranche.amount|floatformat:2 }}</p>
                            {% if tranche.remarks %}
                                <p class="text-xs text-emerald-600 mt-2">{{ tranche.remarks }}</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% elif is_empty_state %}
                    <div class="flex flex-col items-center justify-center text-center space-y-2 py-8 text-emerald-700">
                        <i class="fas fa-calendar-plus text-2xl"></i>
                        <p class="text-base font-semibold">No tranches scheduled yet</p>
                        <p class="text-sm text-emerald-600 max-w-xs">Add allocation, obligation, or disbursement records to see upcoming cash flow milestones.</p>
                    </div>
                {% else %}
                    <p class="text-sm text-gray-600">Record upcoming allocation, obligation, and disbursement tranches to populate the timeline.</p>
                {% endif %}
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-exclamation-triangle mr-3"></i>
                    Needs Coverage Gaps
                </h2>
            </div>
            <div class="p-6 space-y-4">
                {% if needs_gap_entries %}
                    {% for item in needs_gap_entries %}
                        <div class="border border-amber-100 rounded-lg p-4 bg-amber-50 space-y-2">
                            <div class="flex items-center justify-between">
                                <p class="text-base font-semibold text-amber-900">{{ item.title }}</p>
                                <span class="text-xs uppercase text-amber-600 font-semibold">{{ item.get_priority_display }}</span>
                            </div>
                            <p class="text-sm text-amber-700">{{ item.summary|default:"No summary provided." }}</p>
                            <p class="text-xs text-amber-600">Assessment linked: {% if item.related_assessment %}Yes{% else %}Pending{% endif %} • Strategic tags: {% if item.goal_alignment %}{{ item.goal_alignment|join:", " }}{% else %}Not tagged{% endif %}</p>
                        </div>
                    {% endfor %}
                {% elif is_empty_state %}
                    <div class="flex flex-col items-center justify-center text-center space-y-2 py-8 text-amber-600">
                        <i class="fas fa-lightbulb text-2xl"></i>
                        <p class="text-base font-semibold">Priorities will surface here</p>
                        <p class="text-sm text-amber-500 max-w-xs">Link assessments and tag strategic goals so the system can spotlight unmet needs.</p>
                    </div>
                {% else %}
                    <p class="text-sm text-gray-600">Link PPAs to assessments and strategic tags to monitor priority coverage.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Top allocations -->
    <div class="bg-white rounded-xl shadow-xl border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white flex items-center justify-between">
            <h2 class="text-xl font-semibold flex items-center">
                <i class="fas fa-coins mr-3"></i>
                Highest Allocations
            </h2>
            <span class="text-sm text-amber-100">Top 10 budgeted initiatives</span>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Title</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Category</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Lead</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Budget</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Progress</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for entry in top_allocations %}
                    <tr class="hover:bg-amber-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ entry.title }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ entry.get_category_display }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if entry.lead_organization %}
                                {{ entry.lead_organization.name }}
                            {% elif entry.submitted_by_community %}
                                {{ entry.submitted_by_community.name }}
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">₱{{ entry.budget_allocation|floatformat:2 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ entry.progress }}%</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-6 py-6 text-center text-sm text-gray-500">No budget information recorded.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Upcoming milestones -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 bg-gradient-to-r from-teal-500 to-cyan-500 text-white flex items-center justify-between">
            <h2 class="text-xl font-semibold flex items-center">
                <i class="fas fa-calendar-check mr-3"></i>
                Upcoming Milestones
            </h2>
            <span class="text-sm text-cyan-100">As of {{ today|date:"M d, Y" }}</span>
        </div>
        <div class="p-6">
            {% if upcoming_milestones %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for entry in upcoming_milestones %}
                <div class="border border-cyan-100 rounded-lg p-4 bg-cyan-50">
                    <p class="text-sm text-cyan-600 font-semibold uppercase">{{ entry.next_milestone_date|date:"M d, Y" }}</p>
                    <h3 class="mt-1 text-lg font-semibold text-gray-900">{{ entry.title }}</h3>
                    <p class="text-sm text-gray-600">{{ entry.get_category_display }} • Progress {{ entry.progress }}%</p>
                    {% if entry.oobc_unit %}
                        <p class="text-xs text-gray-500 mt-2">OOBC Unit: {{ entry.oobc_unit }}</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-10">
                <i class="fas fa-calendar-times text-3xl text-cyan-400"></i>
                <p class="mt-3 text-sm text-gray-600">No upcoming milestones scheduled.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
