<!-- DEBUG: view_mode={{ view_mode }}, group_by={{ group_by }}, pipeline_count={{ pipeline|length }} -->
{% load task_tags %}
{% if pipeline %}
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6" data-board data-group-by="{{ group_by }}" data-update-url="{{ update_url }}">
    {% for column in pipeline %}
    <div class="bg-gray-50 border border-gray-200 rounded-2xl shadow-sm flex flex-col" data-board-column data-column-value="{{ column.status_key }}">
        <div class="px-4 py-3 bg-white border-b border-gray-200 rounded-t-2xl flex items-center justify-between">
            <div>
                <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">{{ column.status_label }}</h3>
                {% if group_by == 'team' and column.status_key == 'unassigned' %}
                <p class="text-xs text-gray-400">Tasks without team ownership</p>
                {% endif %}
            </div>
            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 text-xs font-semibold text-gray-600" data-column-count>{{ column.count }}</span>
        </div>
        <div class="flex-1 p-4 space-y-4 overflow-y-auto" style="max-height: 44rem;" data-drop-zone>
            <div class="space-y-4" data-task-list>
                {% for task in column.tasks %}
                {% task_action_url task 'detail' as task_modal_url %}
                <article class="task-card bg-white border border-gray-200 rounded-xl shadow-sm p-4 space-y-4 hover:border-emerald-300 transition-shadow transition-transform duration-200 hover:scale-[1.02]" data-task-id="{{ task.id }}" data-task-status="{{ task.status }}" data-task-priority="{{ task.priority }}" data-task-team="{{ task.team.slug|default:'unassigned' }}" data-modal-url="{{ task_modal_url }}" draggable="true">
                    <div class="flex items-start justify-between gap-3">
                        <div class="space-y-1">
                            <h4 class="text-sm font-semibold text-gray-900">{{ task.title }}</h4>
                            {% if task.impact %}
                            <p class="text-xs text-gray-500">{{ task.impact }}</p>
                            {% endif %}
                        </div>
                        <span class="priority-chip inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold
                            {% if task.priority == 'critical' %}bg-rose-100 text-rose-700
                            {% elif task.priority == 'high' %}bg-amber-100 text-amber-700
                            {% elif task.priority == 'low' %}bg-gray-100 text-gray-600
                            {% else %}bg-blue-100 text-blue-700{% endif %}"
                            data-base-class="priority-chip inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold">
                            <span class="priority-label">{{ task.get_priority_display }}</span>
                        </span>
                    </div>
                    {% if task.description %}
                    <p class="text-xs text-gray-500 leading-relaxed">{{ task.description|truncatechars:140 }}</p>
                    {% endif %}

                    <!-- Context Badges and Project/Activity Links -->
                    <div class="flex flex-wrap items-center gap-2 mb-2">
                        {% if task.task_context == 'project_activity' %}
                            <span class="inline-flex items-center gap-1 px-2.5 py-1 bg-purple-100 text-purple-700 text-xs font-medium rounded-full">
                                <i class="fas fa-project-diagram"></i>
                                Project Activity
                            </span>
                        {% elif task.task_context == 'project' %}
                            <span class="inline-flex items-center gap-1 px-2.5 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded-full">
                                <i class="fas fa-folder"></i>
                                Project
                            </span>
                        {% elif task.task_context == 'activity' %}
                            <span class="inline-flex items-center gap-1 px-2.5 py-1 bg-emerald-100 text-emerald-700 text-xs font-medium rounded-full">
                                <i class="fas fa-calendar-check"></i>
                                Activity
                            </span>
                        {% endif %}
                    </div>

                    <!-- Project/Activity Links -->
                    {% if task.linked_workflow or task.linked_event %}
                    <div class="space-y-1.5 text-xs mb-3">
                        {% if task.linked_workflow %}
                            <div class="flex items-center gap-1.5 text-blue-600 hover:text-blue-700">
                                <i class="fas fa-folder text-blue-500"></i>
                                <a href="{{ task.linked_workflow.get_absolute_url }}" class="hover:underline" onclick="event.stopPropagation()">
                                    {{ task.linked_workflow.primary_need.title|truncatewords:6 }}
                                </a>
                            </div>
                        {% endif %}

                        {% if task.linked_event %}
                            <div class="flex items-center gap-1.5 text-emerald-600 hover:text-emerald-700">
                                <i class="fas fa-calendar text-emerald-500"></i>
                                <a href="{% url 'coordination:event_detail' task.linked_event.id %}" class="hover:underline" onclick="event.stopPropagation()">
                                    {{ task.linked_event.title|truncatewords:6 }}
                                </a>
                            </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <div class="flex flex-wrap items-center gap-2 text-xs text-gray-500">
                        <span class="team-chip inline-flex items-center gap-1 bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">
                            <i class="fas fa-users"></i>
                            <span class="team-label">
                                {% if task.team %}
                                {{ task.team.name }}
                                {% else %}
                                No team
                                {% endif %}
                            </span>
                        </span>
                        <span class="inline-flex items-center gap-1 bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">
                            <i class="fas fa-user"></i>
                            {{ task.assignee_display_name }}
                        </span>
                        <span class="status-chip inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold
                            {% if task.status == 'completed' %}bg-emerald-100 text-emerald-700
                            {% elif task.status == 'at_risk' %}bg-rose-100 text-rose-700
                            {% elif task.status == 'not_started' %}bg-amber-100 text-amber-700
                            {% elif task.status == 'in_progress' %}bg-blue-100 text-blue-700
                            {% else %}bg-gray-100 text-gray-600{% endif %}"
                            data-base-class="status-chip inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold">
                            <i class="fas fa-signal"></i>
                            <span class="status-label">{{ task.get_status_display }}</span>
                        </span>
                    </div>
                    <div class="space-y-2">
                        <div class="progress-bar h-1.5 w-full bg-gray-100 rounded-full overflow-hidden">
                        <div class="progress-bar-fill h-full rounded-full {% if task.status == 'completed' %}bg-emerald-500{% elif task.status == 'at_risk' %}bg-rose-500{% elif task.status == 'not_started' %}bg-amber-400{% else %}bg-blue-500{% endif %}"
                                data-base-class="progress-bar-fill h-full rounded-full" style="width: {{ task.progress }}%;"></div>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span class="progress-label">Progress {{ task.progress }}%</span>
                            {% if task.due_date %}
                            <span class="inline-flex items-center gap-1 {% if task.is_overdue %}text-rose-600 font-semibold{% elif task.status == 'completed' %}text-emerald-600{% else %}text-gray-500{% endif %}">
                                <i class="fas fa-calendar-day"></i>
                                {{ task.due_date|date:"M d, Y" }}
                            </span>
                            {% else %}
                            <span class="inline-flex items-center gap-1 text-gray-400">
                                <i class="fas fa-calendar-day"></i>
                                No due date
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </article>
                {% endfor %}
            </div>
            <div class="bg-white border border-dashed border-gray-300 rounded-xl p-6 text-center text-sm text-gray-400 {% if column.tasks %}hidden{% endif %}" data-empty-placeholder>
                No tasks in this group yet.
            </div>
        </div>
        <div class="px-4 pt-2 pb-4">
            {% if group_by == 'priority' %}
                {% with modal_query='?priority='|add:column.status_key|add:'&group='|add:group_by %}
                <a href="{% url 'common:work_item_create' %}{{ modal_query }}" data-modal-link class="w-full inline-flex items-center justify-center gap-2 px-3 py-2 text-sm font-semibold text-emerald-600 bg-emerald-50 hover:bg-emerald-100 border border-emerald-200 rounded-lg transition-colors">
                    <i class="fas fa-plus"></i>
                    Add Task
                </a>
                {% endwith %}
            {% elif group_by == 'team' %}
                {% with modal_query='?team='|add:column.status_key|add:'&group='|add:group_by %}
                <a href="{% url 'common:work_item_create' %}{{ modal_query }}" data-modal-link class="w-full inline-flex items-center justify-center gap-2 px-3 py-2 text-sm font-semibold text-emerald-600 bg-emerald-50 hover:bg-emerald-100 border border-emerald-200 rounded-lg transition-colors">
                    <i class="fas fa-plus"></i>
                    Add Task
                </a>
                {% endwith %}
            {% else %}
                {% with modal_query='?status='|add:column.status_key|add:'&group='|add:group_by %}
                <a href="{% url 'common:work_item_create' %}{{ modal_query }}" data-modal-link class="w-full inline-flex items-center justify-center gap-2 px-3 py-2 text-sm font-semibold text-emerald-600 bg-emerald-50 hover:bg-emerald-100 border border-emerald-200 rounded-lg transition-colors">
                    <i class="fas fa-plus"></i>
                    Add Task
                </a>
                {% endwith %}
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center py-16">
    <div class="max-w-md mx-auto">
        <i class="fas fa-exclamation-triangle text-4xl text-amber-500 mb-4"></i>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">No Board Data Available</h3>
        <p class="text-gray-600 mb-4">The Kanban board is not loading data properly.</p>
        <p class="text-xs text-gray-500">Debug: view_mode={{ view_mode }}, group_by={{ group_by }}, pipeline_count={{ pipeline|length }}</p>
        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">
            Reload Page
        </button>
    </div>
</div>
{% endif %}
