{% extends 'base.html' %}
{% load static %}

{% block title %}Staff Task Board - OBC Management System{% endblock %}

{% block breadcrumb %}
<li class="flex items-center space-x-2">
    <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
    <a href="{% url 'common:oobc_management_home' %}" class="text-gray-600 hover:text-gray-900">OOBC Management</a>
</li>
<li class="flex items-center space-x-2">
    <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
    <a href="{% url 'common:staff_management' %}" class="text-gray-600 hover:text-gray-900">Staff Hub</a>
</li>
<li class="flex items-center space-x-2">
    <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
    <span class="text-gray-500 font-medium">Task Board</span>
</li>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-10">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
                <i class="fas fa-tasks text-emerald-600"></i>
                <span>Staff Task Board</span>
            </h1>
            <p class="mt-2 text-lg text-gray-600 max-w-4xl">
                Switch between board and table workspaces, slice tasks with saved filters, and keep progress in sync without leaving the page.
            </p>
        </div>
        <div class="flex flex-wrap items-center gap-3">
            <a href="{% url 'common:staff_task_modal_create' %}" data-modal-link class="inline-flex items-center bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                <i class="fas fa-plus mr-2"></i>
                New task
            </a>
            <a href="{% url 'common:staff_profiles_list' %}" class="inline-flex items-center bg-white border border-gray-200 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg font-semibold transition-colors">
                <i class="fas fa-id-card-alt mr-2"></i>
                Staff profiles
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-5">
            <p class="text-sm font-semibold text-gray-500 uppercase">Total tasks</p>
            <p class="mt-2 text-3xl font-bold text-gray-900">{{ metrics.total }}</p>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-5">
            <p class="text-sm font-semibold text-emerald-600 uppercase">Completion rate</p>
            <p class="mt-2 text-3xl font-bold text-emerald-600">{{ metrics.completion_rate }}%</p>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-5">
            <p class="text-sm font-semibold text-blue-600 uppercase">Upcoming (7 days)</p>
            <p class="mt-2 text-3xl font-bold text-blue-600">{{ metrics.upcoming }}</p>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-5">
            <p class="text-sm font-semibold text-rose-600 uppercase">At risk</p>
            <p class="mt-2 text-3xl font-bold text-rose-600">{{ metrics.at_risk }}</p>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-xl border border-gray-200 overflow-hidden">
        <div class="bg-gradient-to-r from-gray-800 to-gray-700 px-6 py-4 flex items-center justify-between">
            <h2 class="text-xl font-semibold text-white flex items-center">
                <i class="fas fa-filter mr-3"></i>
                Filters & focus
            </h2>
            {% if filters.status or filters.team or filters.assignee or filters.priority or filters.q %}
            <a href="{% url 'common:staff_task_board' %}" class="text-sm text-emerald-200 hover:text-white">Reset filters</a>
            {% endif %}
        </div>
        <div class="p-6">
            <form method="get" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-12 gap-4">
                <input type="hidden" name="view" value="{{ view_mode }}">
                <input type="hidden" name="group" value="{{ group_by }}">
                <input type="hidden" name="sort" value="{{ sort_field }}">
                <input type="hidden" name="order" value="{{ sort_order }}">
                <div class="xl:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                    <select name="status" class="w-full rounded-lg border-gray-300 focus:border-emerald-500 focus:ring-emerald-500">
                        <option value="">All</option>
                        {% for key,label in status_labels.items %}
                        <option value="{{ key }}" {% if filters.status == key %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="xl:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Priority</label>
                    <select name="priority" class="w-full rounded-lg border-gray-300 focus:border-emerald-500 focus:ring-emerald-500">
                        <option value="">All</option>
                        {% for key,label in priority_labels.items %}
                        <option value="{{ key }}" {% if filters.priority == key %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="xl:col-span-3">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Team</label>
                    <select name="team" class="w-full rounded-lg border-gray-300 focus:border-emerald-500 focus:ring-emerald-500">
                        <option value="">All teams</option>
                        {% for team in team_options %}
                        <option value="{{ team.slug }}" {% if filters.team == team.slug %}selected{% endif %}>{{ team.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="xl:col-span-3">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Assignee</label>
                    <select name="assignee" class="w-full rounded-lg border-gray-300 focus:border-emerald-500 focus:ring-emerald-500">
                        <option value="">All staff</option>
                        {% for user in assignee_options %}
                        <option value="{{ user.id }}" {% if filters.assignee == user.id|stringformat:"s" %}selected{% endif %}>{{ user.get_full_name|default:user.username }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="xl:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Search</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400"><i class="fas fa-search"></i></span>
                        <input type="search" name="q" value="{{ filters.q }}" placeholder="Title, notes, or description" class="pl-10 w-full rounded-lg border-gray-300 focus:border-emerald-500 focus:ring-emerald-500" />
                    </div>
                </div>
                <div class="xl:col-span-2 flex items-end">
                    <button type="submit" class="w-full inline-flex justify-center items-center bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                        Apply
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="bg-white border border-gray-200 rounded-xl shadow-sm px-6 py-4 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div class="flex items-center gap-3 flex-wrap">
            <span class="text-xs font-semibold text-gray-500 uppercase tracking-wide">View</span>
            <div class="inline-flex bg-gray-100 rounded-lg p-1 shadow-inner" id="taskViewSwitcher" role="tablist" aria-label="Task view modes">
                {% for option in view_options %}
                <form method="get" class="inline" data-view-toggle-form="true">
                    {% for key,value in filters.items %}
                        {% if value and key != 'view' %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                        {% endif %}
                    {% endfor %}
                    <input type="hidden" name="view" value="{{ option.value }}">
                    <button type="submit"
                            hx-get="?view={{ option.value }}{% for key,value in filters.items %}{% if key != 'view' and value %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                            hx-target="#taskViewPanels"
                            hx-swap="innerHTML"
                            class="px-3 py-1.5 text-sm font-semibold rounded-md flex items-center gap-2 transition-colors focus:outline-none focus:ring-2 focus:ring-emerald-200
                                {% if view_mode == option.value %}bg-white text-emerald-600 shadow{% else %}text-gray-600 hover:text-gray-900{% endif %}"
                            role="tab"
                            id="view-{{ option.value }}-tab"
                            aria-controls="view-{{ option.value }}-panel"
                            data-view-target="{{ option.value }}"
                            {% if view_mode == option.value %}aria-selected="true" tabindex="0"{% else %}aria-selected="false" tabindex="-1"{% endif %}>
                        <i class="fas {{ option.icon }} {% if view_mode == option.value %}text-emerald-600{% else %}text-gray-500{% endif %}"></i>
                        {{ option.label }}
                    </button>
                </form>
                {% endfor %}
            </div>
        </div>
        <div class="flex flex-wrap items-center gap-3" id="taskViewControls">
            <div class="flex items-center gap-2 {% if view_mode != 'board' %}hidden{% endif %}" data-view-only="board">
                <form method="get" class="flex items-center gap-2">
                    {% for key,value in filters.items %}
                        {% if value and key != 'group' %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                        {% endif %}
                    {% endfor %}
                    <label for="group-by" class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Group</label>
                    <select id="group-by" name="group" class="rounded-md border-gray-300 text-sm focus:border-emerald-500 focus:ring-emerald-500" onchange="this.form.submit()">
                        {% for option in group_options %}
                        <option value="{{ option.value }}" {% if group_by == option.value %}selected{% endif %}>{{ option.label }}</option>
                        {% endfor %}
                    </select>
                </form>
            </div>
            <div class="flex items-center gap-2 {% if view_mode != 'table' %}hidden{% endif %}" data-view-only="table">
                <form method="get" class="flex items-center gap-2">
                    {% for key,value in filters.items %}
                        {% if value and key != 'sort' and key != 'order' %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                        {% endif %}
                    {% endfor %}
                    <label for="sort-by" class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Sort</label>
                    <select id="sort-by" name="sort" class="rounded-md border-gray-300 text-sm focus:border-emerald-500 focus:ring-emerald-500" onchange="this.form.submit()">
                        {% for option in sort_options %}
                        <option value="{{ option.value }}" {% if sort_field == option.value %}selected{% endif %}>{{ option.label }}</option>
                        {% endfor %}
                    </select>
                    <input type="hidden" name="order" value="{{ sort_order }}">
                </form>
                <form method="get" class="inline">
                    {% for key,value in filters.items %}
                        {% if value and key != 'order' %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                        {% endif %}
                    {% endfor %}
                    <input type="hidden" name="order" value="{% if sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                    <button type="submit" class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-md bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors">
                        <i class="fas fa-sort-amount-{% if sort_order == 'asc' %}down{% else %}up{% endif %}"></i>
                        {% if sort_order == 'asc' %}Asc{% else %}Desc{% endif %}
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="space-y-8" id="taskViewPanels" data-active-view="{{ view_mode }}">
        <div class="space-y-8 {% if view_mode != 'board' %}hidden{% endif %}" id="view-board-panel" data-view-panel="board" role="tabpanel" aria-labelledby="view-board-tab" aria-hidden="{% if view_mode != 'board' %}true{% else %}false{% endif %}">
            {% include 'common/partials/staff_task_board_wrapper.html' %}
        </div>
        <div class="space-y-8 {% if view_mode != 'table' %}hidden{% endif %}" id="view-table-panel" data-view-panel="table" role="tabpanel" aria-labelledby="view-table-tab" aria-hidden="{% if view_mode != 'table' %}true{% else %}false{% endif %}">
            {% include 'common/partials/staff_task_table_wrapper.html' %}
        </div>
    </div>
</div>

<div id="taskModal"
     class="fixed inset-0 hidden z-50 flex items-center justify-center px-4 sm:px-6"
     role="dialog"
     aria-modal="true"
     aria-labelledby="modal-title"
     aria-describedby="modal-description">
    <div class="absolute inset-0 bg-gray-900 bg-opacity-50" data-modal-backdrop aria-hidden="true"></div>
    <div class="relative max-h-[90vh] w-full sm:w-auto overflow-y-auto" id="taskModalContent" hx-target="this" hx-swap="innerHTML"></div>
</div>

<template id="new-task-row-template">
    {% include 'common/partials/staff_task_table_row_new.html' with form=new_task_form %}
</template>
{% endblock %}

{% block extra_js %}
<script src="{% static 'common/js/task_modal_enhancements.js' %}"></script>
<script>
    function generateNewBlankRowIfNeeded() {
        const tableBody = document.querySelector('[data-notion-table] tbody');
        if (!tableBody) return;

        const existingBlankRow = tableBody.querySelector('[data-blank-task-row]');
        if (existingBlankRow) return;

        const template = document.getElementById('new-task-row-template');
        if (template) {
            const newRow = template.content.cloneNode(true);
            tableBody.appendChild(newRow);
            initializeBlankRowBehavior();
        }
    }

    document.addEventListener('DOMContentLoaded', function () {

    });
</script>
<style>
/* Notion-style table view */
[data-notion-table] {
    font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 0.875rem;
}

[data-notion-table] td {
    word-wrap: break-word;
    word-break: break-word;
    white-space: normal;
    vertical-align: top;
}

[data-notion-table] [contenteditable="true"]:focus {
    outline: 2px solid #10b981;
    outline-offset: -2px;
    border-radius: 4px;
}

[data-notion-table] [data-field]:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

[data-notion-table] [data-editing="true"] {
    background-color: white;
    box-shadow: 0 0 0 2px #10b981;
    border-radius: 4px;
}
</style>
<script>
if (!window.htmx) {
    var htmxScript = document.createElement('script');
    htmxScript.src = 'https://unpkg.com/htmx.org@1.9.10';
    htmxScript.defer = true;
    document.head.appendChild(htmxScript);
}
</script>
<script>
(function () {
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) {
            return parts.pop().split(';').shift();
        }
        return null;
    }

    const modal = document.getElementById('taskModal');
    const modalContent = document.getElementById('taskModalContent');

    const statusPillStyles = {
        completed: 'bg-emerald-50 text-emerald-700 border border-emerald-200',
        at_risk: 'bg-rose-50 text-rose-700 border border-rose-200',
        in_progress: 'bg-blue-50 text-blue-700 border border-blue-200',
        not_started: 'bg-slate-100 text-slate-600 border border-slate-200',
        default: 'bg-slate-100 text-slate-600 border border-slate-200',
    };
    const priorityPillStyles = {
        critical: 'bg-rose-50 text-rose-700 border border-rose-200',
        high: 'bg-amber-50 text-amber-700 border border-amber-200',
        medium: 'bg-blue-50 text-blue-700 border border-blue-200',
        low: 'bg-slate-100 text-slate-600 border border-slate-200',
        default: 'bg-slate-100 text-slate-600 border border-slate-200',
    };
    const neutralPillStyle = 'bg-white text-slate-600 border border-slate-200';
    const statusDotStyles = {
        completed: 'bg-emerald-500',
        at_risk: 'bg-rose-500 animate-pulse',
        in_progress: 'bg-blue-500',
        not_started: 'bg-slate-300',
        default: 'bg-slate-300',
    };
    const progressFillVariants = {
        high: 'bg-emerald-500',
        medium: 'bg-amber-500',
        low: 'bg-rose-500',
    };
    const progressFillClasses = Object.values(progressFillVariants);

    function debounce(fn, wait) {
        let timeoutId;
        return function (...args) {
            window.clearTimeout(timeoutId);
            timeoutId = window.setTimeout(() => fn.apply(this, args), wait);
        };
    }

    function triggerFormSave(form) {
        if (!form || form.dataset.saving === 'true') {
            return;
        }
        form.dataset.saving = 'true';
        if (window.htmx) {
            htmx.trigger(form, 'submit');
        } else if (typeof form.requestSubmit === 'function') {
            form.requestSubmit();
        } else {
            form.submit();
        }
    }

    function initializeNotionTable(context) {
        let tableElement = null;
        if (!context) {
            tableElement = document.querySelector('[data-notion-table]');
        } else if (context.matches && context.matches('[data-notion-table]')) {
            tableElement = context;
        } else if (context.matches && context.matches('[data-task-id]')) {
            tableElement = context.closest('[data-notion-table]');
        } else if (context.querySelector) {
            tableElement = context.querySelector('[data-notion-table]');
        }

        if (!tableElement) {
            return;
        }

        // Initialize contenteditable cells
        function initializeEditableCells() {
            const editableCells = tableElement.querySelectorAll('[contenteditable="true"]');

            editableCells.forEach(function(cell) {
                if (cell.dataset.initialized === 'true') return;

                cell.addEventListener('focus', function() {
                    this.dataset.editing = 'true';
                    this.dataset.originalValue = this.textContent.trim();
                });

                cell.addEventListener('blur', function() {
                    this.dataset.editing = 'false';
                    const newValue = this.textContent.trim();
                    const originalValue = this.dataset.originalValue;

                    if (newValue !== originalValue) {
                        saveCell(this);
                    }
                });

                cell.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.blur();
                    }
                    if (e.key === 'Escape') {
                        this.textContent = this.dataset.originalValue;
                        this.blur();
                    }
                });

                cell.dataset.initialized = 'true';
            });
        }

        // Initialize clickable cells (for dropdowns/selects)
        function initializeClickableCells() {
            const clickableCells = tableElement.querySelectorAll('[data-field]:not([contenteditable="true"])');

            clickableCells.forEach(function(cell) {
                if (cell.dataset.initialized === 'true') return;

                cell.addEventListener('click', function() {
                    const field = this.dataset.field;
                    const taskId = this.dataset.taskId;

                    if (field === 'assignees') {
                        showAssigneeDropdown(this, taskId);
                    } else if (field === 'teams') {
                        showTeamDropdown(this, taskId);
                    } else if (field === 'status') {
                        showStatusDropdown(this, taskId);
                    } else if (field === 'priority') {
                        showPriorityDropdown(this, taskId);
                    } else if (field === 'start_date' || field === 'due_date') {
                        showDatePicker(this, taskId, field);
                    }
                });

                cell.dataset.initialized = 'true';
            });
        }

        // Save cell data
        function saveCell(cell) {
            const taskId = cell.dataset.taskId;
            const field = cell.dataset.field;
            let value = cell.textContent.trim();

            // Show saving indicator
            const savingIndicator = document.getElementById(`saving-${taskId}`);
            if (savingIndicator) {
                savingIndicator.classList.remove('hidden');
            }

            // Handle progress field specially (remove % sign)
            if (field === 'progress') {
                value = value.replace('%', '');
                if (isNaN(value) || value < 0 || value > 100) {
                    value = cell.dataset.originalValue.replace('%', '');
                    cell.textContent = value + '%';
                    return;
                }
                cell.textContent = value + '%';
            }

            // Send update to server
            fetch(`/oobc-management/staff/tasks/${taskId}/update-field/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify({
                    field: field,
                    value: value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update progress bar if it's a progress field
                    if (field === 'progress') {
                        const progressBar = cell.closest('tr').querySelector('.bg-emerald-500');
                        if (progressBar) {
                            progressBar.style.width = value + '%';
                        }
                    }
                    // Update status indicator if it's a status field
                    if (field === 'status') {
                        updateStatusIndicator(taskId, value);
                    }
                } else {
                    // Revert on error
                    cell.textContent = cell.dataset.originalValue;
                    console.error('Save failed:', data.error);
                }
            })
            .catch(error => {
                // Revert on error
                cell.textContent = cell.dataset.originalValue;
                console.error('Save error:', error);
            })
            .finally(() => {
                // Hide saving indicator
                if (savingIndicator) {
                    savingIndicator.classList.add('hidden');
                }
            });
        }

        // Dropdown functions
        function createDropdownOverlay() {
            let overlay = document.getElementById('notion-dropdown-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'notion-dropdown-overlay';
                overlay.className = 'fixed inset-0 z-50 bg-black bg-opacity-25';
                overlay.style.display = 'none';
                document.body.appendChild(overlay);

                // Close dropdown when clicking outside
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        hideAllDropdowns();
                    }
                });

                // Close dropdown when pressing Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        hideAllDropdowns();
                    }
                });
            }
            return overlay;
        }

        function hideAllDropdowns() {
            const overlay = document.getElementById('notion-dropdown-overlay');
            if (overlay) {
                overlay.style.display = 'none';
                overlay.innerHTML = '';
            }
        }

        function positionDropdown(dropdown, cell) {
            const cellRect = cell.getBoundingClientRect();
            dropdown.style.position = 'absolute';
            dropdown.style.left = cellRect.left + 'px';
            dropdown.style.top = (cellRect.bottom + 4) + 'px';
            dropdown.style.minWidth = cellRect.width + 'px';
            dropdown.style.maxWidth = '300px';
        }

        function showAssigneeDropdown(cell, taskId) {
            const overlay = createDropdownOverlay();
            const currentValues = cell.dataset.originalValue.split(',').filter(v => v.trim());

            const dropdown = document.createElement('div');
            dropdown.className = 'bg-white border border-gray-200 rounded-lg shadow-lg p-2 max-h-64 overflow-y-auto';

            // Create dropdown content
            dropdown.innerHTML = `
                <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Select Assignees</div>
                <div class="space-y-1" data-assignee-options>
                    <div class="text-sm text-gray-500">Loading...</div>
                </div>
            `;

            positionDropdown(dropdown, cell);
            overlay.appendChild(dropdown);
            overlay.style.display = 'block';

            // Load staff options
            loadStaffOptions(dropdown, currentValues, taskId, cell);
        }

        function showTeamDropdown(cell, taskId) {
            const overlay = createDropdownOverlay();
            const currentValues = cell.dataset.originalValue.split(',').filter(v => v.trim());

            const dropdown = document.createElement('div');
            dropdown.className = 'bg-white border border-gray-200 rounded-lg shadow-lg p-2 max-h-64 overflow-y-auto';

            dropdown.innerHTML = `
                <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Select Teams</div>
                <div class="space-y-1" data-team-options>
                    <div class="text-sm text-gray-500">Loading...</div>
                </div>
            `;

            positionDropdown(dropdown, cell);
            overlay.appendChild(dropdown);
            overlay.style.display = 'block';

            // Load team options
            loadTeamOptions(dropdown, currentValues, taskId, cell);
        }

        function showStatusDropdown(cell, taskId) {
            const overlay = createDropdownOverlay();
            const currentValue = cell.dataset.originalValue;

            const statusOptions = [
                { value: 'not_started', label: 'Not Started', color: 'bg-gray-50 text-gray-700' },
                { value: 'in_progress', label: 'In Progress', color: 'bg-blue-50 text-blue-700' },
                { value: 'at_risk', label: 'At Risk', color: 'bg-red-50 text-red-700' },
                { value: 'completed', label: 'Completed', color: 'bg-green-50 text-green-700' }
            ];

            const dropdown = document.createElement('div');
            dropdown.className = 'bg-white border border-gray-200 rounded-lg shadow-lg p-2';

            const optionsHtml = statusOptions.map(option => `
                <div class="flex items-center p-2 rounded hover:bg-gray-50 cursor-pointer ${currentValue === option.value ? 'bg-emerald-50' : ''}"
                     data-status-option="${option.value}">
                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-md text-xs ${option.color} mr-2">
                        ${option.label}
                    </span>
                </div>
            `).join('');

            dropdown.innerHTML = `
                <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Status</div>
                <div class="space-y-1">${optionsHtml}</div>
            `;

            positionDropdown(dropdown, cell);
            overlay.appendChild(dropdown);
            overlay.style.display = 'block';

            // Handle option selection
            dropdown.querySelectorAll('[data-status-option]').forEach(option => {
                option.addEventListener('click', () => {
                    const newValue = option.dataset.statusOption;
                    updateTaskField(taskId, 'status', newValue, cell);
                    hideAllDropdowns();
                });
            });
        }

        function showPriorityDropdown(cell, taskId) {
            const overlay = createDropdownOverlay();
            const currentValue = cell.dataset.originalValue;

            const priorityOptions = [
                { value: 'low', label: 'Low', color: 'bg-gray-50 text-gray-700' },
                { value: 'medium', label: 'Medium', color: 'bg-blue-50 text-blue-700' },
                { value: 'high', label: 'High', color: 'bg-orange-50 text-orange-700' },
                { value: 'critical', label: 'Critical', color: 'bg-red-50 text-red-700' }
            ];

            const dropdown = document.createElement('div');
            dropdown.className = 'bg-white border border-gray-200 rounded-lg shadow-lg p-2';

            const optionsHtml = priorityOptions.map(option => `
                <div class="flex items-center p-2 rounded hover:bg-gray-50 cursor-pointer ${currentValue === option.value ? 'bg-emerald-50' : ''}"
                     data-priority-option="${option.value}">
                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-md text-xs ${option.color} mr-2">
                        ${option.label}
                    </span>
                </div>
            `).join('');

            dropdown.innerHTML = `
                <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Priority</div>
                <div class="space-y-1">${optionsHtml}</div>
            `;

            positionDropdown(dropdown, cell);
            overlay.appendChild(dropdown);
            overlay.style.display = 'block';

            dropdown.querySelectorAll('[data-priority-option]').forEach(option => {
                option.addEventListener('click', () => {
                    const newValue = option.dataset.priorityOption;
                    updateTaskField(taskId, 'priority', newValue, cell);
                    hideAllDropdowns();
                });
            });
        }

        function showDatePicker(cell, taskId, field) {
            const overlay = createDropdownOverlay();
            const currentValue = cell.dataset.originalValue;

            const dropdown = document.createElement('div');
            dropdown.className = 'bg-white border border-gray-200 rounded-lg shadow-lg p-3';

            dropdown.innerHTML = `
                <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">${field === 'start_date' ? 'Start Date' : 'Due Date'}</div>
                <input type="date" value="${currentValue}" class="w-full px-3 py-2 border border-gray-300 rounded focus:border-emerald-500 focus:ring-emerald-500" data-date-input>
                <div class="text-xs text-gray-500 mt-1">
                    ${field === 'start_date' ? 'When should this task begin?' : 'When should this task be completed?'}
                </div>
            `;

            positionDropdown(dropdown, cell);
            overlay.appendChild(dropdown);
            overlay.style.display = 'block';

            // Focus the input
            const dateInput = dropdown.querySelector('[data-date-input]');
            dateInput.focus();

            // Implement autosave on date change
            dateInput.addEventListener('change', () => {
                const newValue = dateInput.value;
                updateTaskField(taskId, field, newValue, cell);
                setTimeout(() => { hideAllDropdowns(); }, 200);
            });

            // Close on blur (when clicking outside)
            dateInput.addEventListener('blur', () => {
                setTimeout(() => { hideAllDropdowns(); }, 200);
            });
        }

        // Helper functions for loading options and autosaving selections
        function loadStaffOptions(dropdown, currentValues, taskId, cell) {
            fetch('/oobc-management/staff/api/assignees/', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                // Cache staff data for optimistic updates
                window.lastLoadedStaffData = data.staff;

                const optionsContainer = dropdown.querySelector('[data-assignee-options]');
                const optionsHtml = data.staff.map(staff => {
                    const isSelected = currentValues.includes(staff.id.toString());
                    return `
                        <label class="flex items-center p-2 rounded hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" value="${staff.id}" ${isSelected ? 'checked' : ''}
                                   class="rounded border-gray-300 text-emerald-600 focus:ring-emerald-500"
                                   data-staff-checkbox>
                            <div class="ml-3 flex items-center">
                                <div class="w-6 h-6 rounded-full bg-emerald-100 text-emerald-800 text-xs font-medium flex items-center justify-center">
                                    ${staff.initials}
                                </div>
                                <span class="ml-2 text-sm text-gray-900">${staff.name}</span>
                            </div>
                        </label>
                    `;
                }).join('');

                optionsContainer.innerHTML = optionsHtml;

                // Add change event listeners for autosave
                optionsContainer.querySelectorAll('[data-staff-checkbox]').forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const selectedValues = Array.from(dropdown.querySelectorAll('input[type="checkbox"]:checked'))
                            .map(cb => cb.value);
                        updateTaskField(taskId, 'assignees', selectedValues.join(','), cell);
                        // Dropdown stays open - user can click outside to close
                    });
                });
            })
            .catch(error => {
                console.error('Error loading staff options:', error);
                const optionsContainer = dropdown.querySelector('[data-assignee-options]');
                optionsContainer.innerHTML = '<div class="text-sm text-red-500">Error loading staff members</div>';
            });
        }

        function loadTeamOptions(dropdown, currentValues, taskId, cell) {
            fetch('/oobc-management/staff/api/teams/', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                // Cache teams data for optimistic updates
                window.lastLoadedTeamsData = data.teams;

                const optionsContainer = dropdown.querySelector('[data-team-options]');
                const optionsHtml = data.teams.map(team => {
                    const isSelected = currentValues.includes(team.id.toString());
                    return `
                        <label class="flex items-center p-2 rounded hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" value="${team.id}" ${isSelected ? 'checked' : ''}
                                   class="rounded border-gray-300 text-emerald-600 focus:ring-emerald-500"
                                   data-team-checkbox>
                            <div class="ml-3 flex items-center">
                                <span class="inline-flex items-center px-2 py-1 rounded-md text-xs ${team.color}">
                                    ${team.name}
                                </span>
                            </div>
                        </label>
                    `;
                }).join('');

                optionsContainer.innerHTML = optionsHtml;

                // Add change event listeners for autosave
                optionsContainer.querySelectorAll('[data-team-checkbox]').forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const selectedValues = Array.from(dropdown.querySelectorAll('input[type="checkbox"]:checked'))
                            .map(cb => cb.value);
                        updateTaskField(taskId, 'teams', selectedValues.join(','), cell);
                        // Dropdown stays open - user can click outside to close
                    });
                });
            })
            .catch(error => {
                console.error('Error loading team options:', error);
                const optionsContainer = dropdown.querySelector('[data-team-options]');
                optionsContainer.innerHTML = '<div class="text-sm text-red-500">Error loading teams</div>';
            });
        }

        function updateTaskField(taskId, field, value, cell) {
            // Handle blank rows differently
            if (taskId === 'new') {
                // For blank rows, just update the display and trigger the field-updated event
                updateCellDisplayOptimistic(cell, field, value);
                const row = cell.closest('[data-blank-task-row]');
                if (row) {
                    row.dispatchEvent(new CustomEvent('field-updated', {
                        detail: { field, value }
                    }));
                }
                return;
            }

            // Optimistically update the UI immediately for better UX
            updateCellDisplayOptimistic(cell, field, value);

            // Show subtle saving indicator
            const savingIndicator = document.getElementById(`saving-${taskId}`);
            if (savingIndicator) {
                savingIndicator.classList.remove('hidden');
            }

            // Send update to server immediately (instant saving)
            fetch(`/oobc-management/staff/tasks/${taskId}/update-field/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify({
                    field: field,
                    value: value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('Save failed:', data.error);
                    // Could revert optimistic update here if needed
                }
            })
            .catch(error => {
                console.error('Save error:', error);
                // Could revert optimistic update here if needed
            })
            .finally(() => {
                // Hide saving indicator immediately after response
                if (savingIndicator) {
                    savingIndicator.classList.add('hidden');
                }
            });
        }

        function updateCellDisplayOptimistic(cell, field, value) {
            // Update the cell display immediately for better UX
            cell.dataset.originalValue = value;

            if (field === 'assignees') {
                // Update assignees display optimistically
                updateAssigneesDisplay(cell, value);
            } else if (field === 'teams') {
                // Update teams display optimistically
                updateTeamsDisplay(cell, value);
            } else if (field === 'status' || field === 'priority') {
                // Update the status/priority pills
                const statusLabels = {
                    'not_started': 'Not Started',
                    'in_progress': 'In Progress',
                    'at_risk': 'At Risk',
                    'completed': 'Completed'
                };
                const priorityLabels = {
                    'low': 'Low',
                    'medium': 'Medium',
                    'high': 'High',
                    'critical': 'Critical'
                };

                const statusColors = {
                    'not_started': 'bg-gray-50 text-gray-700',
                    'in_progress': 'bg-blue-50 text-blue-700',
                    'at_risk': 'bg-red-50 text-red-700',
                    'completed': 'bg-green-50 text-green-700'
                };
                const priorityColors = {
                    'low': 'bg-gray-50 text-gray-700',
                    'medium': 'bg-blue-50 text-blue-700',
                    'high': 'bg-orange-50 text-orange-700',
                    'critical': 'bg-red-50 text-red-700'
                };

                if (field === 'status') {
                    const statusColor = statusColors[value] || 'bg-gray-50 text-gray-700';
                    cell.innerHTML = `<span class="inline-flex items-center px-1.5 py-0.5 rounded-md text-xs ${statusColor}">${statusLabels[value] || value}</span>`;
                } else if (field === 'priority') {
                    const priorityColor = priorityColors[value] || 'bg-gray-50 text-gray-700';
                    cell.innerHTML = `<span class="inline-flex items-center px-1.5 py-0.5 rounded-md text-xs ${priorityColor}">${priorityLabels[value] || value}</span>`;
                }
            } else if (field === 'start_date' || field === 'due_date') {
                // Update date display
                if (value) {
                    const date = new Date(value);
                    const options = { year: 'numeric', month: 'short', day: 'numeric' };
                    const formattedDate = date.toLocaleDateString('en-US', options);
                    cell.innerHTML = `<div><div class="font-medium">${formattedDate}</div></div>`;
                } else {
                    cell.innerHTML = `<span class="text-slate-400">No ${field === 'start_date' ? 'start' : 'due'} date</span>`;
                }
            }
        }

        function updateAssigneesDisplay(cell, selectedIds) {
            if (!selectedIds || selectedIds === '') {
                cell.innerHTML = '<span class="text-slate-400">Unassigned</span>';
                return;
            }

            const ids = selectedIds.split(',').filter(id => id.trim());
            if (ids.length === 0) {
                cell.innerHTML = '<span class="text-slate-400">Unassigned</span>';
                return;
            }

            // Get staff data from the last loaded dropdown or fetch it
            let staffData = window.lastLoadedStaffData || [];

            if (staffData.length === 0) {
                // Fallback display while we don't have staff data
                cell.innerHTML = `<div class="flex flex-wrap gap-1">
                    ${ids.map(id => `<span class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-blue-50 text-blue-700 text-xs font-medium">Staff ${id}</span>`).join('')}
                </div>`;
                return;
            }

            const selectedStaff = staffData.filter(staff => ids.includes(staff.id.toString()));
            if (selectedStaff.length > 0) {
                cell.innerHTML = `<div class="flex flex-wrap gap-1">
                    ${selectedStaff.map(staff => `<span class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-blue-50 text-blue-700 text-xs font-medium">${staff.name}</span>`).join('')}
                </div>`;
            } else {
                cell.innerHTML = '<span class="text-slate-400">Unassigned</span>';
            }
        }

        function updateTeamsDisplay(cell, selectedIds) {
            if (!selectedIds || selectedIds === '') {
                cell.innerHTML = '<span class="text-slate-400">No teams</span>';
                return;
            }

            const ids = selectedIds.split(',').filter(id => id.trim());
            if (ids.length === 0) {
                cell.innerHTML = '<span class="text-slate-400">No teams</span>';
                return;
            }

            // Get teams data from the last loaded dropdown or fetch it
            let teamsData = window.lastLoadedTeamsData || [];

            if (teamsData.length === 0) {
                // Fallback display while we don't have teams data
                cell.innerHTML = `<div class="flex flex-wrap gap-1">
                    ${ids.map(id => `<span class="inline-flex items-center px-1.5 py-0.5 rounded-md text-xs bg-blue-50 text-blue-700">Team ${id}</span>`).join('')}
                </div>`;
                return;
            }

            const selectedTeams = teamsData.filter(team => ids.includes(team.id.toString()));
            if (selectedTeams.length > 0) {
                cell.innerHTML = `<div class="flex flex-wrap gap-1">
                    ${selectedTeams.map(team => `<span class="inline-flex items-center px-1.5 py-0.5 rounded-md text-xs bg-blue-50 text-blue-700">${team.name}</span>`).join('')}
                </div>`;
            } else {
                cell.innerHTML = '<span class="text-slate-400">No teams</span>';
            }
        }

        function updateStatusIndicator(taskId, status) {
            const row = tableElement.querySelector(`[data-task-id="${taskId}"]`);
            if (row) {
                const indicator = row.querySelector('.w-2\\.5.h-2\\.5.rounded-full');
                if (indicator) {
                    indicator.classList.remove(
                        'bg-emerald-500',
                        'bg-blue-500',
                        'bg-rose-500',
                        'bg-amber-400',
                        'bg-slate-300',
                        'bg-green-500',
                        'bg-red-500',
                        'bg-yellow-500',
                        'bg-gray-300'
                    );

                    if (status === 'completed') {
                        indicator.classList.add('bg-emerald-500');
                    } else if (status === 'in_progress') {
                        indicator.classList.add('bg-blue-500');
                    } else if (status === 'at_risk') {
                        indicator.classList.add('bg-rose-500');
                    } else if (status === 'not_started') {
                        indicator.classList.add('bg-amber-400');
                    } else {
                        indicator.classList.add('bg-slate-300');
                    }
                }
            }
        }

        // Initialize all interactive elements
        initializeEditableCells();
        initializeClickableCells();

        // Save all button functionality
        const saveAllButton = document.querySelector('[data-table-save]');
        if (saveAllButton && saveAllButton.dataset.bound !== 'true') {
            saveAllButton.addEventListener('click', function () {
                // Hide any open dropdowns first
                hideAllDropdowns();

                // Trigger save for all editing cells
                const editingCells = tableElement.querySelectorAll('[data-editing="true"]');
                editingCells.forEach(cell => cell.blur());

                // Show feedback
                const button = this;
                const originalText = button.querySelector('span').textContent;
                button.querySelector('span').textContent = 'Saved!';
                button.classList.add('bg-green-50', 'text-green-600', 'border-green-300');
                button.classList.remove('bg-emerald-50', 'text-emerald-600', 'border-emerald-300');

                setTimeout(() => {
                    button.querySelector('span').textContent = originalText;
                    button.classList.remove('bg-green-50', 'text-green-600', 'border-green-300');
                    button.classList.add('bg-emerald-50', 'text-emerald-600', 'border-emerald-300');
                }, 1500);
            });
            saveAllButton.dataset.bound = 'true';
        }
    }

    function refreshBoardContainer() {
        const container = document.querySelector('[data-board-container]');
        if (!container || !window.htmx) {
            return;
        }
        const refreshUrl = container.dataset.refreshUrl || container.getAttribute('hx-get');
        if (refreshUrl) {
            htmx.ajax('GET', refreshUrl, { target: container, swap: 'outerHTML' });
        }
    }

    function closeTaskModal() {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        if (modalContent) {
            modalContent.innerHTML = '';
        }
    }

    function openTaskModal(modalUrl) {
        if (!modal || !modalContent || !modalUrl) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
        modalContent.innerHTML = '<div class="bg-white rounded-2xl shadow-2xl max-w-3xl mx-auto p-8 text-center text-sm text-gray-500">Loading task details...</div>';

        const performRequest = function () {
            if (!window.htmx) {
                window.setTimeout(performRequest, 50);
                return;
            }
            htmx.ajax('GET', modalUrl, { target: modalContent, swap: 'innerHTML' });
        };

        performRequest();
    }

    function initializeTaskBoard() {
        const board = document.querySelector('[data-board]');
        if (!board || board.dataset.dndReady === 'true') {
            return;
        }

        board.dataset.dndReady = 'true';
        board.dataset.dragging = 'false';

        const groupBy = board.dataset.groupBy;
        const updateUrl = board.dataset.updateUrl;
        const csrftoken = getCookie('csrftoken');
        const datasetKeyMap = {
            status: 'taskStatus',
            priority: 'taskPriority',
            team: 'taskTeam',
        };
        const priorityVariants = [
            'bg-rose-100',
            'text-rose-700',
            'bg-amber-100',
            'text-amber-700',
            'bg-blue-100',
            'text-blue-700',
            'bg-gray-100',
            'text-gray-600',
        ];
        const statusChipVariants = [
            'bg-emerald-100',
            'text-emerald-700',
            'bg-rose-100',
            'text-rose-700',
            'bg-blue-100',
            'text-blue-700',
            'bg-gray-100',
            'text-gray-600',
        ];
        const progressVariants = ['bg-emerald-500', 'bg-rose-500', 'bg-blue-500'];
        const priorityStyles = {
            critical: 'bg-rose-100 text-rose-700',
            high: 'bg-amber-100 text-amber-700',
            medium: 'bg-blue-100 text-blue-700',
            low: 'bg-gray-100 text-gray-600',
        };
        const statusStyles = {
            completed: { chip: 'bg-emerald-100 text-emerald-700', bar: 'bg-emerald-500' },
            at_risk: { chip: 'bg-rose-100 text-rose-700', bar: 'bg-rose-500' },
            in_progress: { chip: 'bg-blue-100 text-blue-700', bar: 'bg-blue-500' },
            not_started: { chip: 'bg-gray-100 text-gray-600', bar: 'bg-blue-500' },
        };

        function swapClasses(element, variants, targetClasses) {
            variants.forEach(function (cls) {
                element.classList.remove(cls);
            });
            targetClasses.split(' ').forEach(function (cls) {
                if (cls) {
                    element.classList.add(cls);
                }
            });
        }

        function updateColumnState(column) {
            if (!column) {
                return;
            }
            const list = column.querySelector('[data-task-list]');
            const placeholder = column.querySelector('[data-empty-placeholder]');
            const count = column.querySelector('[data-column-count]');
            if (!list) {
                return;
            }
            const visibleTasks = list.querySelectorAll('.task-card');
            if (placeholder) {
                placeholder.classList.toggle('hidden', !!visibleTasks.length);
            }
            if (count) {
                count.textContent = visibleTasks.length;
            }
        }

        function highlightZone(zone, active) {
            if (!zone) {
                return;
            }
            const highlightClasses = ['ring-2', 'ring-emerald-400', 'ring-offset-2'];
            highlightClasses.forEach(function (cls) {
                zone.classList.toggle(cls, active);
            });
            zone.classList.toggle('bg-emerald-50', active);
        }

        function applyStatus(card, payload) {
            const status = payload.status;
            const statusLabel = payload.status_label;
            const progress = payload.progress;
            const style = statusStyles[status] || statusStyles.not_started;
            const chip = card.querySelector('.status-chip');
            if (chip) {
                swapClasses(chip, statusChipVariants, style.chip);
                const labelEl = chip.querySelector('.status-label');
                if (labelEl) {
                    labelEl.textContent = statusLabel;
                }
            }
            const progressLabel = card.querySelector('.progress-label');
            if (progressLabel) {
                progressLabel.textContent = `Progress ${progress}%`;
            }
            const progressFill = card.querySelector('.progress-bar-fill');
            if (progressFill) {
                swapClasses(progressFill, progressVariants, style.bar);
                progressFill.style.width = `${progress}%`;
            }
            const statusSelect = card.querySelector('.status-select');
            if (statusSelect) {
                statusSelect.value = status;
            }
            const progressInput = card.querySelector('.progress-input');
            if (progressInput) {
                progressInput.value = progress;
            }
            card.dataset.taskStatus = status;
        }

        function applyPriority(card, payload) {
            const priority = payload.priority;
            const label = payload.priority_label;
            const chip = card.querySelector('.priority-chip');
            const style = priorityStyles[priority] || priorityStyles.medium;
            if (chip) {
                swapClasses(chip, priorityVariants, style);
                const labelEl = chip.querySelector('.priority-label');
                if (labelEl) {
                    labelEl.textContent = label;
                }
            }
            card.dataset.taskPriority = priority;
        }

        function applyTeam(card, payload) {
            const chip = card.querySelector('.team-chip .team-label');
            if (chip) {
                chip.textContent = payload.team || 'No team';
            }
            card.dataset.taskTeam = payload.team_slug;
        }

        function getColumnOrder(column) {
            const list = column?.querySelector('[data-task-list]');
            if (!list) {
                return [];
            }
            return Array.from(list.querySelectorAll('.task-card')).map(function (node) {
                return Number(node.dataset.taskId);
            });
        }

        function getDragAfterElement(container, y, excludedId) {
            if (!container) {
                return null;
            }
            const elements = Array.from(container.querySelectorAll('.task-card')).filter(function (child) {
                return child.dataset.taskId !== excludedId;
            });
            return elements.reduce(function (closest, child) {
                const box = child.getBoundingClientRect();
                const offset = y - (box.top + box.height / 2);
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                }
                return closest;
            }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
        }

        function attachCardHandlers(card) {
            card.addEventListener('click', function (event) {
                if (board.dataset.dragging === 'true' || card.dataset.draggingActive === 'true') {
                    return;
                }
                if (event.target.closest('button, a, form, select, input, textarea')) {
                    return;
                }
                const modalUrl = card.dataset.modalUrl;
                if (modalUrl) {
                    event.preventDefault();
                    openTaskModal(modalUrl);
                }
            });
            card.addEventListener('dragstart', function (event) {
                if (event.target && event.target.closest('form')) {
                    event.preventDefault();
                    return;
                }
                const sourceColumn = card.closest('[data-board-column]');
                board.dataset.draggingTaskId = card.dataset.taskId;
                board.dataset.dragging = 'true';
                card.dataset.draggingActive = 'true';
                board.dataset.sourceColumn = sourceColumn ? sourceColumn.dataset.columnValue || '' : '';
                event.dataTransfer.setData('text/plain', card.dataset.taskId || '');
                event.dataTransfer.effectAllowed = 'move';
                card.classList.add('opacity-60');
            });
            card.addEventListener('dragend', function () {
                card.classList.remove('opacity-60');
                delete board.dataset.draggingTaskId;
                delete board.dataset.sourceColumn;
                board.dataset.dragging = 'false';
                window.setTimeout(function () {
                    delete card.dataset.draggingActive;
                }, 120);
            });
        }

        function handleDrop(event) {
            event.preventDefault();
            const zone = event.currentTarget;
            highlightZone(zone, false);

            const column = zone.closest('[data-board-column]');
            const targetValue = column?.dataset.columnValue;
            const datasetKey = datasetKeyMap[groupBy];
            if (!column || !targetValue || !datasetKey) {
                return;
            }

            const taskId = board.dataset.draggingTaskId || event.dataTransfer.getData('text/plain');
            if (!taskId) {
                return;
            }

            const card = board.querySelector(`.task-card[data-task-id="${taskId}"]`);
            if (!card) {
                return;
            }

            const list = column.querySelector('[data-task-list]');
            const afterElement = getDragAfterElement(zone, event.clientY, taskId);
            const sourceColumnValue = board.dataset.sourceColumn || card.dataset[datasetKey] || '';
            const sourceColumn = sourceColumnValue ? board.querySelector(`[data-board-column][data-column-value="${sourceColumnValue}"]`) : column;
            const sourceList = card.parentElement;
            const nextSibling = card.nextElementSibling;

            if (afterElement === null) {
                list.appendChild(card);
            } else {
                list.insertBefore(card, afterElement);
            }

            updateColumnState(sourceColumn);
            updateColumnState(column);
            card.classList.add('opacity-50');

            const targetOrder = getColumnOrder(column);
            const sourceOrder = sourceColumn && sourceColumn !== column ? getColumnOrder(sourceColumn) : [];

            const payload = {
                task_id: Number(taskId),
                group: groupBy,
                value: targetValue,
                order: targetOrder,
            };

            if (sourceColumnValue) {
                payload.source_value = sourceColumnValue;
            }
            if (sourceOrder.length) {
                payload.source_order = sourceOrder;
            }

            fetch(updateUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken || '',
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin',
                body: JSON.stringify(payload),
            })
                .then(function (response) {
                    if (!response.ok) {
                        throw new Error('Network response was not ok.');
                    }
                    return response.json();
                })
                .then(function (data) {
                    if (!data.ok) {
                        throw new Error(data.error || 'Unable to update task.');
                    }
                    if (groupBy === 'status') {
                        applyStatus(card, data.task);
                    } else if (groupBy === 'priority') {
                        applyPriority(card, data.task);
                    } else if (groupBy === 'team') {
                        applyTeam(card, data.task);
                    }
                    updateColumnState(sourceColumn);
                    updateColumnState(column);
                })
                .catch(function (error) {
                    if (nextSibling && nextSibling.parentElement === sourceList) {
                        sourceList.insertBefore(card, nextSibling);
                    } else if (sourceList) {
                        sourceList.appendChild(card);
                    }
                    updateColumnState(sourceColumn);
                    updateColumnState(column);
                    if (window.console) {
                        window.console.error(error);
                    }
                    window.alert('Unable to update the task. Please try again.');
                })
                .finally(function () {
                    card.classList.remove('opacity-50');
                });
        }

        board.querySelectorAll('.task-card').forEach(attachCardHandlers);

        board.querySelectorAll('[data-drop-zone]').forEach(function (zone) {
            zone.addEventListener('dragover', function (event) {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'move';
                highlightZone(zone, true);
            });
            zone.addEventListener('dragleave', function (event) {
                if (!zone.contains(event.relatedTarget)) {
                    highlightZone(zone, false);
                }
            });
            zone.addEventListener('drop', handleDrop);
        });
    }

    document.addEventListener('DOMContentLoaded', initializeTaskBoard);
    document.addEventListener('DOMContentLoaded', function () {
        initializeNotionTable(document);
    });
    document.body.addEventListener('htmx:afterSwap', function (event) {
        if (event.target && event.target.matches('[data-board-container]')) {
            initializeTaskBoard();
        }
        if (
            event.target
            && (event.target.matches('[data-task-id]')
                || event.target.matches('[data-notion-table-container]'))
        ) {
            initializeNotionTable(event.target);
        }
        if (event.target && event.target.id === 'taskModalContent') {
            if (window.taskModalEnhancer && typeof window.taskModalEnhancer.init === 'function') {
                window.taskModalEnhancer.init(event.target);
            }
        }
    });
    document.body.addEventListener('htmx:configRequest', function (event) {
        if (event.target && event.target.matches('[data-board-container]')) {
            const boardInstance = document.querySelector('[data-board]');
            if (boardInstance && boardInstance.dataset.dragging === 'true') {
                event.preventDefault();
            }
        }
    });

    document.body.addEventListener('click', function (event) {
        if (event.target.closest('[data-close-modal]') || event.target.matches('[data-modal-backdrop]')) {
            event.preventDefault();
            closeTaskModal();
            return;
        }
        if (event.target.closest('[data-delete-trigger]')) {
            event.preventDefault();
            if (modalContent) {
                const confirmBox = modalContent.querySelector('[data-delete-confirm]');
                if (confirmBox) {
                    confirmBox.classList.remove('hidden');
                }
            }
            return;
        }
        if (event.target.closest('[data-delete-cancel]')) {
            event.preventDefault();
            if (modalContent) {
                const confirmBox = modalContent.querySelector('[data-delete-confirm]');
                if (confirmBox) {
                    confirmBox.classList.add('hidden');
                }
            }
        }
        const modalLink = event.target.closest('[data-modal-link]');
        if (modalLink) {
            event.preventDefault();
            const href = modalLink.getAttribute('href');
            if (href) {
                openTaskModal(href);
            }
        }
    });

    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closeTaskModal();
        }
    });

    document.body.addEventListener('task-modal-close', function () {
        closeTaskModal();
    });

    document.body.addEventListener('task-board-refresh', function () {
        refreshBoardContainer();
    });

    // Notion-style blank row functionality
    function initializeBlankRowBehavior() {
        const blankRows = document.querySelectorAll('[data-blank-task-row]:not([data-blank-initialized])');
        if (blankRows.length > 0) {
            console.log('Initializing', blankRows.length, 'blank rows');
        }

        blankRows.forEach(function(row) {
            row.dataset.blankInitialized = 'true';

            // Initialize clickable cells for dropdowns (similar to existing rows)
            initializeBlankRowDropdowns(row);

            // Handle placeholder text behavior
            initializePlaceholderBehavior(row);

            // Handle auto-save on changes
            initializeBlankRowAutoSave(row);
        });
    }

    function initializeBlankRowDropdowns(row) {
        const clickableCells = row.querySelectorAll('[data-field]:not([contenteditable="true"])');

        clickableCells.forEach(function(cell) {
            if (cell.dataset.initialized === 'true') return;

            cell.addEventListener('click', function() {
                const field = this.dataset.field;
                const taskId = this.dataset.taskId;
                console.log('Clicked field:', field, 'taskId:', taskId);

                if (field === 'assignees') {
                    showAssigneeDropdown(this, taskId);
                } else if (field === 'teams') {
                    showTeamDropdown(this, taskId);
                } else if (field === 'status') {
                    showStatusDropdown(this, taskId);
                } else if (field === 'priority') {
                    showPriorityDropdown(this, taskId);
                } else if (field === 'start_date' || field === 'due_date') {
                    showDatePicker(this, taskId, field);
                }
            });

            cell.dataset.initialized = 'true';
        });
    }

    function initializePlaceholderBehavior(row) {
        const titleCell = row.querySelector('[data-field="title"][contenteditable="true"]');
        if (!titleCell) return;

        const placeholder = titleCell.dataset.placeholder || 'Enter task title...';

        function updatePlaceholderState() {
            const content = titleCell.textContent.trim();
            if (content === '' || content === placeholder) {
                titleCell.textContent = placeholder;
                titleCell.classList.add('text-slate-400');
                titleCell.classList.remove('text-slate-900');
            } else {
                titleCell.classList.remove('text-slate-400');
                titleCell.classList.add('text-slate-900');
            }
        }

        titleCell.addEventListener('focus', function() {
            if (titleCell.textContent.trim() === placeholder) {
                titleCell.textContent = '';
                titleCell.classList.remove('text-slate-400');
                titleCell.classList.add('text-slate-900');
            }
        });

        titleCell.addEventListener('blur', function() {
            updatePlaceholderState();
        });

        // Initialize state
        updatePlaceholderState();
    }

    function initializeBlankRowAutoSave(row) {
        let isSaving = false;
        let hasBeenModified = false;

        function saveTask() {
            if (isSaving) return;

            const titleCell = row.querySelector('[data-field="title"][contenteditable="true"]');
            const content = titleCell ? titleCell.textContent.trim() : '';
            const placeholder = titleCell ? titleCell.dataset.placeholder || 'Enter task title...' : '';

            // Only save if there's actual content and it has been modified
            if (content && content !== placeholder && hasBeenModified) {
                isSaving = true;
                saveBlankRowAsTask(row);
            }
        }

        // Monitor title changes - this is the main trigger
        const titleCell = row.querySelector('[data-field="title"][contenteditable="true"]');
        if (titleCell) {
            // Generate new blank row when this one is clicked
            titleCell.addEventListener('focus', function() {
                generateNewBlankRowIfNeeded();
            });

            // Track modifications but don't save yet
            titleCell.addEventListener('input', function() {
                const content = titleCell.textContent.trim();
                const placeholder = titleCell.dataset.placeholder || 'Enter task title...';
                if (content && content !== placeholder) {
                    hasBeenModified = true;
                    syncFieldToHiddenInput(row, 'title', content);
                }
            });

            // Save when user leaves the title cell
            titleCell.addEventListener('blur', function() {
                saveTask();
            });
        }

        // Monitor progress changes
        const progressCell = row.querySelector('[data-field="progress"][contenteditable="true"]');
        if (progressCell) {
            progressCell.addEventListener('input', function() {
                const value = progressCell.textContent.trim().replace('%', '');
                progressCell.dataset.originalValue = value;
                syncFieldToHiddenInput(row, 'progress', value);
                hasBeenModified = true;
            });

            progressCell.addEventListener('blur', function() {
                saveTask();
            });
        }

        // Monitor dropdown changes - save immediately since these are explicit user actions
        row.addEventListener('field-updated', function(event) {
            const { field, value } = event.detail;
            syncFieldToHiddenInput(row, field, value);
            hasBeenModified = true;

            // For dropdown changes, save immediately since it's an explicit user action
            setTimeout(saveTask, 100); // Small delay to ensure the change is processed
        });

        // Also save when user clicks outside the row entirely
        document.addEventListener('click', function(event) {
            const clickedRow = event.target.closest('[data-task-row], [data-blank-task-row]');
            if (clickedRow !== row && hasBeenModified) {
                saveTask();
            }
        });

        // Reset saving flag when done
        row.addEventListener('task-saved', function() {
            isSaving = false;
            hasBeenModified = false;
        });
    }

    function syncFieldToHiddenInput(row, fieldName, value) {
        const hiddenInput = row.querySelector(`input[name="${fieldName}"]`);
        if (hiddenInput) {
            hiddenInput.value = value;
        }
    }

    function saveBlankRowAsTask(row) {
        const titleCell = row.querySelector('[data-field="title"][contenteditable="true"]');
        if (!titleCell) return;

        const title = titleCell.textContent.trim();
        const placeholder = titleCell.dataset.placeholder || 'Enter task title...';

        if (!title || title === placeholder) {
            return;
        }

        // Show saving indicator
        const savingIndicator = row.querySelector('#saving-new');
        if (savingIndicator) {
            savingIndicator.classList.remove('hidden');
        }

        // Collect all data from the row
        const formData = new FormData();
        formData.append('form_name', 'create_task');
        formData.append('title', title);
        formData.append('status', row.querySelector('[data-field="status"]')?.dataset.originalValue || 'not_started');
        formData.append('priority', row.querySelector('[data-field="priority"]')?.dataset.originalValue || 'medium');

        const progress = row.querySelector('[data-field="progress"]')?.dataset.originalValue || '0';
        formData.append('progress', progress.toString().replace('%', ''));

        const assigneeIds = row.querySelector('[data-field="assignees"]')?.dataset.originalValue || '';
        console.log('DEBUG: Assignee IDs collected:', assigneeIds);
        if (assigneeIds) {
            assigneeIds.split(',').filter(id => id.trim()).forEach(id => {
                formData.append('assignees', id.trim());
            });
        }

        const teamIds = row.querySelector('[data-field="teams"]')?.dataset.originalValue || '';
        console.log('DEBUG: Team IDs collected:', teamIds);
        if (teamIds) {
            teamIds.split(',').filter(id => id.trim()).forEach(id => {
                formData.append('teams', id.trim());
            });
        }

        const startDate = row.querySelector('[data-field="start_date"]')?.dataset.originalValue || '';
        console.log('DEBUG: Start date collected:', startDate);
        if (startDate) {
            formData.append('start_date', startDate);
        }

        const dueDate = row.querySelector('[data-field="due_date"]')?.dataset.originalValue || '';
        console.log('DEBUG: Due date collected:', dueDate);
        if (dueDate) {
            formData.append('due_date', dueDate);
        }

        // Add CSRF token
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            formData.append('csrfmiddlewaretoken', csrfInput.value);
        }

        // Debug: Log all form data being sent
        console.log('DEBUG: FormData contents:');
        for (let pair of formData.entries()) {
            console.log(pair[0], '=', pair[1]);
        }

        // Create the task via AJAX using existing endpoint
        fetch(window.location.pathname, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData
        })
        .then(response => response.text())
        .then(html => {
            const newRow = document.createElement('tbody');
            newRow.innerHTML = html;
            const newRowElement = newRow.firstChild;
            row.parentNode.replaceChild(newRowElement, row);

            // Re-initialize interactive elements on the new row
            initializeNotionTable(newRowElement);

            // Add a new blank row for the next task
            generateNewBlankRowIfNeeded();

            // Fire event to reset saving flag
            row.dispatchEvent(new CustomEvent('task-saved'));

            // Hide saving indicator
            if (savingIndicator) {
                savingIndicator.classList.add('hidden');
            }

            console.log('Task created successfully and UI updated.');
        })
        .catch(error => {
            console.error('Error creating task:', error);

            // Hide saving indicator on error
            if (savingIndicator) {
                savingIndicator.classList.add('hidden');
            }

            // Fire event to reset saving flag
            row.dispatchEvent(new CustomEvent('task-saved'));

            // Show error message
            alert('Failed to create task: ' + error.message);
        });
    }

    function convertBlankRowToTaskRow(blankRow, taskData) {
        // Remove blank row specific attributes
        blankRow.removeAttribute('data-blank-task-row');
        blankRow.removeAttribute('data-new-task-row');
        blankRow.removeAttribute('data-blank-initialized');

        // Add regular task row attributes
        blankRow.setAttribute('data-task-row', '');
        blankRow.setAttribute('data-task-id', taskData.id);

        // Update the title cell to remove placeholder behavior
        const titleCell = blankRow.querySelector('[data-field="title"]');
        if (titleCell) {
            titleCell.dataset.taskId = taskData.id;
            titleCell.dataset.originalValue = taskData.title;
            titleCell.classList.remove('text-slate-400');
            titleCell.classList.add('text-slate-900');
            titleCell.textContent = taskData.title;
        }

        // Update all other cells with task data
        const cells = blankRow.querySelectorAll('[data-field]');
        cells.forEach(cell => {
            cell.dataset.taskId = taskData.id;
        });

        // Update status indicator dot
        const statusDot = blankRow.querySelector('.w-2\\.5.h-2\\.5.rounded-full');
        if (statusDot) {
            statusDot.classList.remove(
                'bg-emerald-500',
                'bg-blue-500',
                'bg-rose-500',
                'bg-amber-400',
                'bg-slate-300',
                'bg-green-500',
                'bg-red-500',
                'bg-yellow-500',
                'bg-gray-300'
            );
            const dotClass = {
                completed: 'bg-emerald-500',
                in_progress: 'bg-blue-500',
                at_risk: 'bg-rose-500',
                not_started: 'bg-amber-400',
            }[taskData.status] || 'bg-slate-300';
            statusDot.classList.add(dotClass);
        }

        // Update saving indicator ID
        const savingIndicator = blankRow.querySelector('#saving-new');
        if (savingIndicator) {
            savingIndicator.id = `saving-${taskData.id}`;
        }

        // Remove hidden form fields that were only for blank row
        const hiddenInputs = blankRow.querySelectorAll('input[type="hidden"]');
        hiddenInputs.forEach(input => {
            if (!input.name.includes('csrf')) {
                input.remove();
            }
        });

        // Update Actions cell to include View/Edit/Delete buttons
        const actionsCell = blankRow.querySelector('td:last-child');
        if (actionsCell) {
            actionsCell.innerHTML = `
                <div class="flex flex-wrap gap-2">
                    <a href="/oobc-management/staff/tasks/${taskData.id}/modal/"
                       class="bg-white border border-blue-200 text-blue-600 hover:bg-blue-50 px-3 py-1 rounded text-xs font-medium transition-colors duration-200"
                       data-modal-link
                       title="View task details">
                        <i class="fas fa-eye mr-1"></i>
                        View
                    </a>
                    <a href="/oobc-management/staff/tasks/${taskData.id}/modal/"
                       class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs font-medium transition-colors duration-200"
                       data-modal-link
                       title="Edit task">
                        <i class="fas fa-edit mr-1"></i>
                        Edit
                    </a>
                    <button type="button"
                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-medium transition-colors duration-200"
                            data-delete-task="${taskData.id}"
                            data-confirm="Are you sure you want to delete this task? This action cannot be undone."
                            title="Delete task">
                        <i class="fas fa-trash-alt mr-1"></i>
                        Delete
                    </button>
                    <div class="w-4 h-4 hidden" id="saving-${taskData.id}">
                        <i class="fas fa-spinner fa-spin text-xs text-emerald-600"></i>
                    </div>
                </div>
            `;
        }

        // Initialize this row as a regular task row
        initializeNotionTable(blankRow);

        console.log('Converted blank row to task:', taskData.title);
    }

    function generateNewBlankRowIfNeeded() {
        const tableBody = document.querySelector('[data-notion-table] tbody');
        const existingBlankRow = tableBody?.querySelector('[data-blank-task-row]');

        if (!tableBody || existingBlankRow) {
            return; // Don't create if table not found or blank row already exists
        }

        generateNewBlankRow();
    }

    function generateNewBlankRow() {
        const tableBody = document.querySelector('[data-notion-table] tbody');
        if (!tableBody) return;

        // Create a new blank row element
        const blankRow = document.createElement('tr');
        blankRow.className = 'group relative hover:bg-slate-50/30 transition-colors border-b border-slate-100';
        blankRow.setAttribute('data-blank-task-row', '');
        blankRow.setAttribute('data-new-task-row', '');

        // Generate a unique ID for this blank row
        const uniqueId = 'new-' + Date.now();

        blankRow.innerHTML = `
            <!-- Task Title Cell -->
            <td class="px-5 py-3 border-r border-slate-100 min-w-[13rem]">
                <div class="flex items-start gap-2.5">
                    <span class="w-2.5 h-2.5 mt-0.5 rounded-full bg-amber-400"></span>
                    <div
                        class="flex-1 min-h-[38px] flex items-center px-3 py-2 rounded-md hover:bg-slate-100 cursor-text text-sm leading-snug text-slate-400"
                        contenteditable="true"
                        data-field="title"
                        data-task-id="new"
                        data-original-value=""
                        data-placeholder="Enter task title..."
                    >Enter task title...</div>
                </div>
            </td>

            <!-- Assignee Cell -->
            <td class="px-4 py-3 border-r border-slate-100 min-w-[10rem]">
                <div
                    class="min-h-[38px] flex items-center px-2.5 py-1.5 rounded-md hover:bg-slate-100 cursor-pointer text-sm"
                    data-field="assignees"
                    data-task-id="new"
                    data-original-value=""
                    data-display-value=""
                >
                    <span class="text-slate-400">Unassigned</span>
                </div>
            </td>

            <!-- Teams Cell -->
            <td class="px-4 py-3 border-r border-slate-100 min-w-[9rem]">
                <div
                    class="min-h-[38px] flex items-center px-2.5 py-1.5 rounded-md hover:bg-slate-100 cursor-pointer text-sm"
                    data-field="teams"
                    data-task-id="new"
                    data-original-value=""
                    data-display-value=""
                >
                    <span class="text-slate-400">No teams</span>
                </div>
            </td>

            <!-- Start Date Cell -->
            <td class="px-4 py-2 border-r border-slate-100">
                <div
                    class="min-h-[32px] flex items-center px-2 py-1 rounded hover:bg-slate-100 cursor-pointer text-sm"
                    data-field="start_date"
                    data-task-id="new"
                    data-original-value=""
                >
                    <span class="text-slate-400">No start date</span>
                </div>
            </td>

            <!-- Due Date Cell -->
            <td class="px-4 py-2 border-r border-slate-100">
                <div
                    class="min-h-[32px] flex items-center px-2 py-1 rounded hover:bg-slate-100 cursor-pointer text-sm"
                    data-field="due_date"
                    data-task-id="new"
                    data-original-value=""
                >
                    <span class="text-slate-400">No due date</span>
                </div>
            </td>

            <!-- Status Cell -->
            <td class="px-2 py-2 border-r border-slate-100">
                <div
                    class="min-h-[32px] flex items-center px-1 py-1 rounded hover:bg-slate-100 cursor-pointer text-sm"
                    data-field="status"
                    data-task-id="new"
                    data-original-value="not_started"
                >
                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-md text-xs bg-gray-50 text-gray-700">Not Started</span>
                </div>
            </td>

            <!-- Priority Cell -->
            <td class="px-2 py-2 border-r border-slate-100 min-w-[5rem] w-[5rem]">
                <div
                    class="min-h-[32px] flex items-center px-1 py-1 rounded hover:bg-slate-100 cursor-pointer text-sm"
                    data-field="priority"
                    data-task-id="new"
                    data-original-value="medium"
                >
                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-md text-xs bg-blue-50 text-blue-700">Medium</span>
                </div>
            </td>

            <!-- Progress Cell -->
            <td class="px-4 py-2 border-r border-slate-100">
                <div class="min-h-[32px] flex items-center px-2 py-1 rounded hover:bg-slate-100 cursor-pointer text-sm">
                    <div class="flex items-center gap-2 w-full">
                        <div class="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
                            <div
                                class="h-full bg-emerald-500 transition-all duration-300"
                                style="width: 0%"
                            ></div>
                        </div>
                        <span
                            class="text-xs font-medium text-slate-600 min-w-[30px]"
                            contenteditable="true"
                            data-field="progress"
                            data-task-id="new"
                            data-original-value="0"
                        >0%</span>
                    </div>
                </div>
            </td>

            <!-- Actions Cell -->
            <td class="px-4 py-2">
                <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <div class="w-4 h-4 hidden" id="saving-${uniqueId}">
                        <i class="fas fa-spinner fa-spin text-xs text-emerald-600"></i>
                    </div>
                </div>
            </td>
        `;

        // Update the saving indicator ID to be unique
        const savingIndicator = blankRow.querySelector(`#saving-${uniqueId}`);
        if (savingIndicator) {
            savingIndicator.id = 'saving-new';
        }

        // Append to table body
        tableBody.appendChild(blankRow);

        // Initialize the new blank row
        initializeBlankRowBehavior();

        console.log('Generated new blank row');
    }

    // Initialize blank row behavior on page load and after HTMX swaps
    document.addEventListener('DOMContentLoaded', function() {
        initializeBlankRowBehavior();
    });

    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.target && (
            event.target.matches('[data-notion-table-container]') ||
            event.target.matches('[data-task-row]') ||
            event.target.matches('[data-blank-task-row]')
        )) {
            initializeBlankRowBehavior();
        }
    });

    // Handle HTMX triggers for modal close and toast notifications
    document.body.addEventListener('task-modal-close', function() {
        const modal = document.getElementById('taskModal');
        if (modal) {
            modal.classList.add('hidden');
        }
    });

    document.body.addEventListener('show-toast', function(event) {
        const message = event.detail.value;
        // Create and show a toast notification
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
        toast.textContent = message;
        document.body.appendChild(toast);

        // Animate in
        setTimeout(() => {
            toast.classList.remove('translate-x-full');
        }, 10);

        // Remove after 3 seconds
        setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 3000);
    });

    // Handle delete button clicks in table view
    document.addEventListener('click', function(event) {
        const deleteButton = event.target.closest('[data-delete-task]');
        if (deleteButton) {
            event.preventDefault();
            const taskId = deleteButton.getAttribute('data-delete-task');
            const confirmMessage = deleteButton.getAttribute('data-confirm') || 'Are you sure you want to delete this task?';

            if (window.confirm(confirmMessage)) {
                // Create and submit the delete form with HTMX
                const form = document.createElement('form');
                form.setAttribute('hx-post', `/oobc-management/staff/tasks/${taskId}/delete/`);
                form.setAttribute('hx-target', `[data-task-id='${taskId}']`);
                form.setAttribute('hx-swap', 'delete swap:300ms');
                form.setAttribute('hx-trigger', 'submit');

                // Add CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                if (csrfToken) {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrfmiddlewaretoken';
                    csrfInput.value = csrfToken.value;
                    form.appendChild(csrfInput);
                }

                // Add confirmation input
                const confirmInput = document.createElement('input');
                confirmInput.type = 'hidden';
                confirmInput.name = 'confirm';
                confirmInput.value = 'yes';
                form.appendChild(confirmInput);

                // Add to document and submit
                document.body.appendChild(form);
                htmx.process(form);
                htmx.trigger(form, 'submit');

                // Clean up
                setTimeout(() => {
                    if (form.parentNode) {
                        form.parentNode.removeChild(form);
                    }
                }, 1000);
            }
        }
    });
})();
</script>
{% endblock %}
